<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SocketIO Integration Example - The Arcane Codex</title>

    <!-- Socket.IO Client Library -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

    <!-- SocketIO Client Module -->
    <script src="/static/socketio_client.js"></script>

    <!-- SocketIO Styles -->
    <link rel="stylesheet" href="/static/socketio_styles.css">

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a2e;
            color: #eee;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: #FFD700;
            text-align: center;
        }

        .demo-section {
            background: rgba(42, 36, 30, 0.8);
            border: 2px solid #8B7355;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .demo-section h2 {
            color: #D4AF37;
            margin-top: 0;
        }

        button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #D4AF37, #B8860B);
            border: none;
            border-radius: 6px;
            color: #2A1810;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: linear-gradient(135deg, #FFD700, #D4AF37);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .log-container {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .log-entry {
            margin-bottom: 5px;
        }

        .log-entry.info { color: #0ff; }
        .log-entry.success { color: #0f0; }
        .log-entry.error { color: #f00; }
        .log-entry.warning { color: #ff0; }

        input {
            padding: 8px;
            border: 2px solid #8B7355;
            background: rgba(0, 0, 0, 0.5);
            color: #D4AF37;
            border-radius: 4px;
            margin: 5px;
        }
    </style>
</head>
<body>
    <h1>SocketIO Integration Example</h1>

    <!-- Connection Status Indicator -->
    <div id="connection-status" class="disconnected">Disconnected</div>

    <!-- Demo: Connection Management -->
    <div class="demo-section">
        <h2>1. Connection Management</h2>
        <p>Initialize SocketIO and test connection:</p>

        <label>Game Code: <input type="text" id="input-game-code" value="ABC123" /></label>
        <label>Player ID: <input type="text" id="input-player-id" value="player_test_123" /></label>

        <br><br>
        <button id="btn-init">Initialize SocketIO</button>
        <button id="btn-join-room" disabled>Join Game Room</button>
        <button id="btn-ping" disabled>Ping Server</button>
        <button id="btn-disconnect">Disconnect</button>

        <div class="log-container" id="log-connection"></div>
    </div>

    <!-- Demo: Player Events -->
    <div class="demo-section">
        <h2>2. Player Events</h2>
        <p>Simulate player actions:</p>

        <button id="btn-emit-choice" disabled>Emit Choice Submitted</button>
        <button id="btn-emit-typing-start" disabled>Start Typing</button>
        <button id="btn-emit-typing-stop" disabled>Stop Typing</button>

        <div class="log-container" id="log-players"></div>
    </div>

    <!-- Demo: Presence Tracking -->
    <div class="demo-section">
        <h2>3. Presence Tracking</h2>
        <p>Track online/offline players:</p>

        <button id="btn-request-presence" disabled>Request Presence Update</button>

        <div id="players-list" style="margin-top: 15px;">
            <!-- Players will be dynamically added here -->
        </div>

        <div class="log-container" id="log-presence"></div>
    </div>

    <!-- Demo: Notifications -->
    <div class="demo-section">
        <h2>4. Notifications</h2>
        <p>Test notification system:</p>

        <button onclick="testNotification('info')">Info Notification</button>
        <button onclick="testNotification('success')">Success Notification</button>
        <button onclick="testNotification('warning')">Warning Notification</button>
        <button onclick="testNotification('error')">Error Notification</button>
        <button onclick="testReconnectionOverlay()">Test Reconnection Overlay</button>
    </div>

    <!-- Notification Container (for toast notifications) -->
    <div class="notification-container" id="notification-container"></div>

    <script>
        // ================================================================
        // DEMO SCRIPT
        // ================================================================

        let gameCode = null;
        let playerId = null;

        // Logging functions
        function log(container, message, type = 'info') {
            const logDiv = document.getElementById(container);
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Enable/disable buttons based on connection
        function updateButtons(connected) {
            document.getElementById('btn-join-room').disabled = !connected;
            document.getElementById('btn-ping').disabled = !connected;
            document.getElementById('btn-emit-choice').disabled = !connected;
            document.getElementById('btn-emit-typing-start').disabled = !connected;
            document.getElementById('btn-emit-typing-stop').disabled = !connected;
            document.getElementById('btn-request-presence').disabled = !connected;
        }

        // ================================================================
        // DEMO 1: CONNECTION MANAGEMENT
        // ================================================================

        document.getElementById('btn-init').addEventListener('click', () => {
            gameCode = document.getElementById('input-game-code').value;
            playerId = document.getElementById('input-player-id').value;

            log('log-connection', `Initializing SocketIO for game ${gameCode}...`);

            try {
                window.SocketIOClient.init({
                    gameCode: gameCode,
                    playerId: playerId
                });

                log('log-connection', 'SocketIO initialized!', 'success');

                // Set up event listeners
                setupEventListeners();

            } catch (error) {
                log('log-connection', `Error: ${error.message}`, 'error');
            }
        });

        document.getElementById('btn-join-room').addEventListener('click', () => {
            log('log-connection', `Joining room ${gameCode}...`);
            window.SocketIOClient.joinGameRoom(gameCode);
        });

        document.getElementById('btn-ping').addEventListener('click', () => {
            log('log-connection', 'Sending ping...');
            window.SocketIOClient.ping();
        });

        document.getElementById('btn-disconnect').addEventListener('click', () => {
            const socket = window.SocketIOClient.getSocket();
            if (socket) {
                socket.disconnect();
                log('log-connection', 'Disconnected manually', 'warning');
            }
        });

        // ================================================================
        // DEMO 2: PLAYER EVENTS
        // ================================================================

        document.getElementById('btn-emit-choice').addEventListener('click', () => {
            log('log-players', 'Emitting choice submitted event...');
            window.SocketIOClient.emitChoiceSubmitted();
            log('log-players', 'Choice submitted event emitted!', 'success');
        });

        document.getElementById('btn-emit-typing-start').addEventListener('click', () => {
            log('log-players', 'Starting typing indicator...');
            window.SocketIOClient.emitTyping(true);
        });

        document.getElementById('btn-emit-typing-stop').addEventListener('click', () => {
            log('log-players', 'Stopping typing indicator...');
            window.SocketIOClient.emitTyping(false);
        });

        // ================================================================
        // DEMO 3: PRESENCE TRACKING
        // ================================================================

        document.getElementById('btn-request-presence').addEventListener('click', () => {
            log('log-presence', 'Requesting presence update...');
            window.SocketIOClient.requestPresence();
        });

        function updatePlayersList(players) {
            const container = document.getElementById('players-list');
            container.innerHTML = '<h3 style="color: #FFD700;">Players:</h3>';

            players.forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = `player-item ${player.online ? '' : 'offline'}`;
                playerDiv.setAttribute('data-player-id', player.player_id);
                playerDiv.innerHTML = `
                    <span class="presence-indicator ${player.online ? 'online' : 'offline'}"></span>
                    <strong>${player.player_name}</strong> - ${player.player_id}
                `;
                container.appendChild(playerDiv);
            });
        }

        // ================================================================
        // EVENT LISTENERS SETUP
        // ================================================================

        function setupEventListeners() {
            // Connection events
            window.SocketIOClient.on('onConnectionChange', (data) => {
                log('log-connection', `Connection ${data.connected ? 'established' : 'lost'}`,
                    data.connected ? 'success' : 'error');
                updateButtons(data.connected);
            });

            // Player events
            window.SocketIOClient.on('onPlayerJoined', (data) => {
                log('log-players', `${data.player_name} joined the game`, 'info');
            });

            window.SocketIOClient.on('onPlayerLeft', (data) => {
                log('log-players', `${data.player_name} left the game`, 'warning');
            });

            window.SocketIOClient.on('onPlayerReconnected', (data) => {
                log('log-players', `${data.player_name} reconnected`, 'success');
            });

            window.SocketIOClient.on('onChoiceSubmitted', (data) => {
                log('log-players',
                    `${data.player_name} submitted choice (${data.choices_submitted}/${data.total_players})`,
                    'info');

                if (data.all_submitted) {
                    log('log-players', 'All players have chosen!', 'success');
                }
            });

            // Presence events
            window.SocketIOClient.on('onPresenceUpdate', (data) => {
                log('log-presence',
                    `Presence update: ${data.online_players.length}/${data.total_players} online`,
                    'info');

                if (data.players) {
                    updatePlayersList(data.players);
                }
            });

            // Scenario events
            window.SocketIOClient.on('onNewScenario', (data) => {
                log('log-players', `New scenario: ${data.theme} (Turn ${data.turn_number})`, 'success');
            });

            window.SocketIOClient.on('onTurnResolved', (data) => {
                log('log-players', `Turn ${data.turn_number} resolved! Trust: ${data.trust_change}`, 'success');
            });

            // Error events
            window.SocketIOClient.on('onError', (data) => {
                log('log-connection', `Error [${data.code}]: ${data.message}`, 'error');
            });
        }

        // ================================================================
        // DEMO 4: NOTIFICATIONS
        // ================================================================

        let notificationId = 0;

        function testNotification(type) {
            const messages = {
                info: 'This is an info notification',
                success: 'Operation completed successfully!',
                warning: 'This is a warning message',
                error: 'An error occurred!'
            };

            showNotification(messages[type], type);
        }

        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            const id = `notification-${notificationId++}`;

            const notif = document.createElement('div');
            notif.id = id;
            notif.className = `notification ${type}`;
            notif.innerHTML = `
                <div class="notification-title">${type.toUpperCase()}</div>
                <div class="notification-message">${message}</div>
                <button class="notification-close" onclick="closeNotification('${id}')">Ã—</button>
            `;

            container.appendChild(notif);

            // Auto-close after 3 seconds
            setTimeout(() => {
                closeNotification(id);
            }, 3000);
        }

        function closeNotification(id) {
            const notif = document.getElementById(id);
            if (notif) {
                notif.classList.add('fadeOut');
                setTimeout(() => notif.remove(), 300);
            }
        }

        function testReconnectionOverlay() {
            const overlay = document.createElement('div');
            overlay.id = 'test-reconnection-overlay';
            overlay.className = 'reconnection-overlay';
            overlay.style.display = 'flex';
            overlay.innerHTML = `
                <div class="reconnection-content">
                    <div class="reconnection-spinner"></div>
                    <h3>Connection Lost</h3>
                    <p id="reconnection-status">Attempting to reconnect...</p>
                    <button onclick="document.getElementById('test-reconnection-overlay').remove()">
                        Close (Demo)
                    </button>
                </div>
            `;
            document.body.appendChild(overlay);

            // Simulate reconnection attempts
            let attempts = 0;
            const interval = setInterval(() => {
                attempts++;
                const status = document.getElementById('reconnection-status');
                if (status) {
                    status.textContent = `Reconnecting... (Attempt ${attempts}/10)`;
                }
                if (attempts >= 10) {
                    clearInterval(interval);
                    if (status) {
                        status.textContent = 'Max reconnection attempts reached';
                    }
                }
            }, 1000);
        }

        // ================================================================
        // INITIAL STATE
        // ================================================================

        log('log-connection', 'Demo ready. Click "Initialize SocketIO" to start.');
        log('log-players', 'Waiting for initialization...');
        log('log-presence', 'Waiting for initialization...');
    </script>
</body>
</html>
