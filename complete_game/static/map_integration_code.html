<!-- MAP OVERLAY INTEGRATION CODE -->
<!-- Replace the existing map-overlay section (lines 4992-5047) with this enhanced version -->

<!-- 5. Enhanced Map Overlay -->
<div id="map-overlay" class="overlay">
    <style>
        /* Enhanced Map Styles */
        #map-overlay.active {
            display: flex !important;
            flex-direction: column;
            background: rgba(0, 0, 0, 0.95);
        }

        #map-overlay .map-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: linear-gradient(180deg, rgba(26, 22, 18, 0.95) 0%, transparent 100%);
            border-bottom: 2px solid #8B7355;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        #map-overlay .map-title {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 28px;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            letter-spacing: 2px;
        }

        #map-overlay .close-btn {
            background: radial-gradient(circle, #8B7355 0%, #6B5745 100%);
            border: 2px solid #D4AF37;
            color: #E8D7C3;
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #map-overlay .close-btn:hover {
            transform: rotate(90deg) scale(1.1);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
        }

        /* Map Container */
        #map-overlay .map-container {
            flex: 1;
            display: flex;
            position: relative;
            padding: 20px;
            gap: 20px;
        }

        #map-overlay .world-map {
            flex: 1;
            position: relative;
            background: linear-gradient(135deg, #E8D7C3 0%, #D4C4B0 50%, #C8B49C 100%);
            border: 5px solid #8B7355;
            border-radius: 10px;
            box-shadow: inset 0 0 50px rgba(0, 0, 0, 0.5), 0 10px 30px rgba(0, 0, 0, 0.8);
            overflow: hidden;
        }

        #map-overlay .minimap-container {
            position: absolute;
            bottom: 30px;
            right: 30px;
            width: 250px;
            height: 200px;
            background: rgba(26, 22, 18, 0.95);
            border: 3px solid #D4AF37;
            border-radius: 10px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
            overflow: hidden;
            z-index: 200;
        }

        #map-overlay .map-controls {
            position: absolute;
            top: 100px;
            left: 30px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #map-overlay .control-group {
            background: rgba(26, 22, 18, 0.9);
            border: 2px solid #8B7355;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.7);
        }

        #map-overlay .filter-btn {
            background: linear-gradient(135deg, rgba(139, 115, 85, 0.3) 0%, rgba(139, 115, 85, 0.1) 100%);
            border: 1px solid #8B7355;
            color: #E8D7C3;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
        }

        #map-overlay .filter-btn:hover {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.3) 0%, rgba(212, 175, 55, 0.1) 100%);
            transform: translateX(3px);
        }

        #map-overlay .filter-btn.active {
            background: linear-gradient(135deg, #D4AF37 0%, #8B7355 100%);
            color: #1a1612;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
        }

        /* Map Legend */
        #map-overlay .map-legend {
            position: absolute;
            bottom: 30px;
            left: 30px;
            background: rgba(26, 22, 18, 0.95);
            border: 2px solid #8B7355;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.7);
            z-index: 150;
        }

        #map-overlay .legend-title {
            font-size: 14px;
            color: #FFD700;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid #8B7355;
            padding-bottom: 5px;
        }

        #map-overlay .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
            color: #E8D7C3;
            margin-bottom: 5px;
        }

        /* Quest Indicator */
        #map-overlay .quest-indicator {
            position: absolute;
            top: 250px;
            right: 30px;
            background: linear-gradient(135deg, #8B7355 0%, #6B5745 100%);
            border: 2px solid #FFD700;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
            z-index: 150;
            max-width: 200px;
        }
    </style>

    <!-- Map Header -->
    <div class="map-header">
        <div class="map-title">
            <span>üó∫Ô∏è</span>
            <span>The Realm of Arcanum</span>
        </div>
        <button class="close-btn">&times;</button>
    </div>

    <!-- Map Controls -->
    <div class="map-controls">
        <div class="control-group">
            <button class="filter-btn active" data-filter="all">
                <span>üëÅÔ∏è</span> All
            </button>
            <button class="filter-btn" data-filter="cities">
                <span>üè∞</span> Cities
            </button>
            <button class="filter-btn" data-filter="quests">
                <span>‚≠ê</span> Quests
            </button>
            <button class="filter-btn" data-filter="shops">
                <span>üè™</span> Shops
            </button>
            <button class="filter-btn" data-filter="dungeons">
                <span>‚öîÔ∏è</span> Dungeons
            </button>
        </div>
        <div class="control-group">
            <button class="filter-btn" onclick="mapSystem.zoomIn()">üîç +</button>
            <button class="filter-btn" onclick="mapSystem.zoomOut()">üîç ‚àí</button>
            <button class="filter-btn" onclick="mapSystem.resetView()">‚Üª Reset</button>
        </div>
    </div>

    <!-- Main Map Container -->
    <div class="map-container">
        <!-- World Map Canvas -->
        <div class="world-map">
            <canvas id="world-map-canvas"></canvas>
        </div>

        <!-- Minimap -->
        <div class="minimap-container">
            <div style="background: linear-gradient(90deg, #8B7355 0%, #6B5745 100%); padding: 5px 10px; font-size: 12px; text-transform: uppercase; color: #FFD700; border-bottom: 1px solid #D4AF37;">
                üìç Current Area
            </div>
            <canvas id="minimap-canvas"></canvas>
        </div>

        <!-- Map Legend -->
        <div class="map-legend">
            <div class="legend-title">Map Legend</div>
            <div class="legend-item">
                <span>üè∞</span>
                <span>Major City</span>
            </div>
            <div class="legend-item">
                <span>‚≠ê</span>
                <span>Quest Objective</span>
            </div>
            <div class="legend-item">
                <span>üè™</span>
                <span>Merchant</span>
            </div>
            <div class="legend-item">
                <span>‚öîÔ∏è</span>
                <span>Dungeon</span>
            </div>
            <div class="legend-item">
                <span>üå≤</span>
                <span>Forest</span>
            </div>
        </div>

        <!-- Quest Indicator -->
        <div class="quest-indicator">
            <div style="color: #FFD700; font-size: 12px; text-transform: uppercase; margin-bottom: 8px;">
                üìú Active Quest
            </div>
            <div style="color: #E8D7C3; font-size: 13px; line-height: 1.4;">
                <strong>The Duke's Request</strong><br>
                Travel to the Duke's Warehouse
            </div>
        </div>
    </div>
</div>

<script>
    // Enhanced Map System
    const mapSystem = {
        // Map data
        locations: [
            {
                id: 'valdria',
                name: 'Valdria',
                type: 'city',
                icon: 'üè∞',
                x: 400, y: 300,
                description: 'The grand capital city',
                discovered: true,
                visited: true,
                current: true
            },
            {
                id: 'warehouse',
                name: "Duke's Warehouse",
                type: 'quest',
                icon: '‚≠ê',
                x: 520, y: 250,
                description: 'Mysterious warehouse',
                discovered: true,
                visited: false,
                quest: true
            },
            {
                id: 'forest',
                name: 'Forest of Whispers',
                type: 'forest',
                icon: 'üå≤',
                x: 600, y: 200,
                description: 'Ancient dark forest',
                discovered: false,
                visited: false
            },
            {
                id: 'trading_post',
                name: 'Trading Post',
                type: 'shop',
                icon: 'üè™',
                x: 280, y: 400,
                description: 'Merchant gathering place',
                discovered: true,
                visited: false
            },
            {
                id: 'ruins',
                name: 'Ancient Ruins',
                type: 'dungeon',
                icon: '‚öîÔ∏è',
                x: 650, y: 150,
                description: 'Forgotten dungeon',
                discovered: false,
                visited: false
            }
        ],

        // Canvas references
        worldCanvas: null,
        worldCtx: null,
        minimapCanvas: null,
        minimapCtx: null,

        // Map state
        scale: 1,
        offsetX: 0,
        offsetY: 0,
        isDragging: false,
        activeFilter: 'all',

        // Initialize map system
        init() {
            this.worldCanvas = document.getElementById('world-map-canvas');
            this.minimapCanvas = document.getElementById('minimap-canvas');

            if (!this.worldCanvas || !this.minimapCanvas) return;

            this.worldCtx = this.worldCanvas.getContext('2d');
            this.minimapCtx = this.minimapCanvas.getContext('2d');

            this.setupCanvas();
            this.setupEvents();
            this.render();
            this.renderMinimap();
        },

        setupCanvas() {
            // Set canvas size
            const container = this.worldCanvas.parentElement;
            this.worldCanvas.width = container.clientWidth;
            this.worldCanvas.height = container.clientHeight;

            const minimapContainer = this.minimapCanvas.parentElement;
            this.minimapCanvas.width = minimapContainer.clientWidth;
            this.minimapCanvas.height = minimapContainer.clientHeight - 30;
        },

        setupEvents() {
            // Filter buttons
            document.querySelectorAll('#map-overlay .filter-btn[data-filter]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('#map-overlay .filter-btn').forEach(b =>
                        b.classList.remove('active'));
                    e.target.classList.add('active');
                    this.activeFilter = e.target.dataset.filter;
                    this.render();
                });
            });

            // Canvas dragging
            this.worldCanvas.addEventListener('mousedown', (e) => this.startDrag(e));
            this.worldCanvas.addEventListener('mousemove', (e) => this.drag(e));
            this.worldCanvas.addEventListener('mouseup', () => this.endDrag());
            this.worldCanvas.addEventListener('mouseleave', () => this.endDrag());
        },

        render() {
            const ctx = this.worldCtx;
            const canvas = this.worldCanvas;

            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Apply transformations
            ctx.save();
            ctx.translate(this.offsetX, this.offsetY);
            ctx.scale(this.scale, this.scale);

            // Draw parchment background
            const gradient = ctx.createRadialGradient(
                canvas.width/2, canvas.height/2, 100,
                canvas.width/2, canvas.height/2, canvas.width
            );
            gradient.addColorStop(0, '#F4E9DC');
            gradient.addColorStop(0.5, '#E8D7C3');
            gradient.addColorStop(1, '#D4C4B0');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw grid texture
            ctx.globalAlpha = 0.1;
            ctx.strokeStyle = '#8B7355';
            for (let i = 0; i < canvas.width; i += 50) {
                for (let j = 0; j < canvas.height; j += 50) {
                    ctx.strokeRect(i, j, 50, 50);
                }
            }
            ctx.globalAlpha = 1;

            // Draw paths between locations
            this.drawPaths(ctx);

            // Draw locations
            this.locations.forEach(loc => {
                if (this.shouldShowLocation(loc)) {
                    this.drawLocation(ctx, loc);
                }
            });

            // Draw fog of war
            this.drawFogOfWar(ctx);

            ctx.restore();
        },

        drawPaths(ctx) {
            // Draw quest path
            const current = this.locations.find(l => l.current);
            const quest = this.locations.find(l => l.quest);

            if (current && quest) {
                ctx.beginPath();
                ctx.moveTo(current.x, current.y);
                ctx.lineTo(quest.x, quest.y);
                ctx.strokeStyle = '#FFD700';
                ctx.lineWidth = 3;
                ctx.setLineDash([10, 5]);
                ctx.shadowColor = 'rgba(255, 215, 0, 0.5)';
                ctx.shadowBlur = 10;
                ctx.stroke();
                ctx.setLineDash([]);
                ctx.shadowBlur = 0;
            }
        },

        drawLocation(ctx, location) {
            if (!location.discovered && !location.current) return;

            const x = location.x;
            const y = location.y;

            // Location circle
            ctx.beginPath();
            ctx.arc(x, y, 15, 0, Math.PI * 2);
            ctx.fillStyle = location.visited ? '#FFD700' : '#8B7355';
            ctx.fill();
            ctx.strokeStyle = location.current ? '#FFD700' : '#D4AF37';
            ctx.lineWidth = location.current ? 3 : 2;
            ctx.stroke();

            // Icon
            ctx.font = '18px serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(location.icon, x, y);

            // Name
            ctx.font = '12px Georgia';
            ctx.fillStyle = '#1a1612';
            ctx.fillText(location.name, x, y + 25);

            // Quest pulse
            if (location.quest) {
                const time = Date.now() / 1000;
                const scale = 1 + Math.sin(time * 3) * 0.2;
                ctx.save();
                ctx.translate(x, y);
                ctx.scale(scale, scale);
                ctx.translate(-x, -y);
                ctx.strokeStyle = '#FFD700';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(0, 0, 20, 0, Math.PI * 2);
                ctx.stroke();
                ctx.restore();
            }
        },

        drawFogOfWar(ctx) {
            this.locations.forEach(loc => {
                if (!loc.discovered) {
                    ctx.fillStyle = 'rgba(26, 22, 18, 0.7)';
                    ctx.beginPath();
                    ctx.arc(loc.x, loc.y, 60, 0, Math.PI * 2);
                    ctx.fill();
                }
            });
        },

        renderMinimap() {
            const ctx = this.minimapCtx;
            const canvas = this.minimapCanvas;

            // Clear and draw background
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'rgba(26, 22, 18, 0.8)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Scale for minimap
            const scale = Math.min(canvas.width / 800, canvas.height / 600) * 0.8;

            ctx.save();
            ctx.scale(scale, scale);

            // Draw simplified locations
            this.locations.forEach(loc => {
                if (loc.discovered) {
                    ctx.fillStyle = loc.current ? '#FFD700' :
                                   loc.quest ? '#FF6B6B' : '#8B7355';
                    ctx.beginPath();
                    ctx.arc(loc.x, loc.y, loc.current ? 8 : 5, 0, Math.PI * 2);
                    ctx.fill();
                }
            });

            ctx.restore();
        },

        shouldShowLocation(location) {
            if (this.activeFilter === 'all') return true;
            if (this.activeFilter === 'cities' && location.type === 'city') return true;
            if (this.activeFilter === 'quests' && location.quest) return true;
            if (this.activeFilter === 'shops' && location.type === 'shop') return true;
            if (this.activeFilter === 'dungeons' && location.type === 'dungeon') return true;
            return false;
        },

        startDrag(e) {
            this.isDragging = true;
            this.dragStartX = e.clientX - this.offsetX;
            this.dragStartY = e.clientY - this.offsetY;
        },

        drag(e) {
            if (this.isDragging) {
                this.offsetX = e.clientX - this.dragStartX;
                this.offsetY = e.clientY - this.dragStartY;
                this.render();
            }
        },

        endDrag() {
            this.isDragging = false;
        },

        zoomIn() {
            if (this.scale < 2) {
                this.scale *= 1.2;
                this.render();
            }
        },

        zoomOut() {
            if (this.scale > 0.5) {
                this.scale /= 1.2;
                this.render();
            }
        },

        resetView() {
            this.scale = 1;
            this.offsetX = 0;
            this.offsetY = 0;
            this.render();
        }
    };

    // Initialize map when overlay opens
    document.addEventListener('DOMContentLoaded', () => {
        // Watch for map overlay to be shown
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.target.id === 'map-overlay' &&
                    mutation.target.classList.contains('active')) {
                    setTimeout(() => mapSystem.init(), 100);
                }
            });
        });

        const mapOverlay = document.getElementById('map-overlay');
        if (mapOverlay) {
            observer.observe(mapOverlay, {
                attributes: true,
                attributeFilter: ['class']
            });
        }
    });

    // Animation loop for quest markers
    setInterval(() => {
        if (document.getElementById('map-overlay')?.classList.contains('active')) {
            mapSystem.render();
            mapSystem.renderMinimap();
        }
    }, 100);
</script>