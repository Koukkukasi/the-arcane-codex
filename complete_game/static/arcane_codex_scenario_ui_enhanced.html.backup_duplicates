<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data:; connect-src 'self';">
    <title>The Arcane Codex - Enhanced Scenario Interface</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&family=Yrsa:wght@300;400;500;600;700&display=swap');

        :root {
            /* Primary Color Palette */
            --gold-bright: #FFD700;
            --gold-medium: #D4AF37;
            --gold-dark: #B8860B;
            --bronze-light: #8B7355;
            --bronze-medium: #5C4A3A;
            --bronze-dark: #3E342A;
            
            /* Background Colors */
            --bg-dark: #0A0908;
            --bg-panel: rgba(42, 36, 30, 0.95);
            --bg-panel-secondary: rgba(26, 22, 18, 0.95);
            
            /* Accent Colors */
            --whisper-purple: #7B5A8B;
            --whisper-purple-light: #9B7AAB;
            --whisper-bg: rgba(123, 90, 139, 0.15);
            
            /* Spacing Scale */
            --space-xs: 6px;
            --space-sm: 10px;
            --space-md: 15px;
            --space-lg: 20px;
            --space-xl: 30px;
            
            /* Animation Timings */
            --transition-fast: 0.15s ease;
            --transition-normal: 0.3s ease;
            --transition-slow: 0.5s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }

        body {
            font-family: 'Yrsa', serif;
            background: #000;
            color: #D4AF37;
            overflow: hidden;
            height: 100vh;
        }

        .game-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: linear-gradient(180deg, #0A0812 0%, #1A1425 100%);
        }

        /* Top HUD Bar - KEPT FROM ORIGINAL */
        .top-hud {
            height: 80px;
            background: linear-gradient(180deg, rgba(42, 36, 30, 0.98) 0%, rgba(26, 22, 18, 0.95) 100%);
            border-bottom: 3px solid;
            border-image: linear-gradient(90deg, #5C4A3A, #8B7355, #D4AF37, #8B7355, #5C4A3A) 1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            z-index: 100;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.8);
        }

        .player-status {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .portrait-frame {
            width: 64px;
            height: 64px;
            background: radial-gradient(circle at 30% 30%, rgba(255, 215, 0, 0.2), transparent 60%),
                        linear-gradient(135deg, #8B7355 0%, #2A1810 100%);
            border: 3px solid #D4AF37;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.5), 0 0 20px rgba(212, 175, 55, 0.3);
            position: relative;
        }

        .level-badge {
            position: absolute;
            bottom: -5px;
            right: -5px;
            width: 24px;
            height: 24px;
            background: #D4AF37;
            border: 2px solid #2A1810;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Cinzel', serif;
            font-size: 10px;
            font-weight: 700;
            color: #2A1810;
        }

        .player-bars {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .resource-bar {
            width: 180px;
            height: 18px;
            background: linear-gradient(180deg, rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.6));
            border: 2px solid #3E342A;
            border-radius: 9px;
            overflow: hidden;
            position: relative;
        }

        .health-fill {
            height: 100%;
            width: 85%;
            background: linear-gradient(90deg, #660000, #CC0000, #FF3333, #CC0000);
            box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.3);
        }

        .mana-fill {
            height: 100%;
            width: 60%;
            background: linear-gradient(90deg, #000066, #0066CC, #3399FF, #0066CC);
            box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.3);
        }

        .bar-text {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 700;
            color: white;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
        }

        .game-title {
            font-family: 'Cinzel', serif;
            font-size: 36px;
            font-weight: 900;
            background: linear-gradient(180deg, #FFD700, #B8860B, #FFD700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 10px rgba(212, 175, 55, 0.5);
            letter-spacing: 3px;
        }


        /* Game Area */
        .game-area {
            flex: 1;
            display: flex;
            position: relative;
            min-height: 0;
            overflow: hidden;
        }

        .left-panel {
            width: 80px;
            background: linear-gradient(90deg, rgba(26, 22, 18, 0.95) 0%, rgba(26, 22, 18, 0.4) 100%);
            display: flex !important; /* Ensure visibility */
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
            gap: 15px;
            z-index: 50;
            flex-shrink: 0; /* Prevent collapsing */
            min-width: 80px; /* Ensure minimum width */
        }

        .side-btn {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, rgba(42, 36, 30, 0.9) 0%, rgba(26, 22, 18, 0.9) 100%);
            border: 2px solid #8B7355;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 22px;
            position: relative;
        }

        .side-btn:hover {
            transform: scale(1.1);
            border-color: #D4AF37;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.4), inset 0 0 15px rgba(212, 175, 55, 0.2);
        }

        .tooltip {
            position: absolute;
            left: 60px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #D4AF37;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 16px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }

        .side-btn:hover .tooltip {
            opacity: 1;
        }

        /* ========================================
           SCENARIO SCENE CONTAINER
           ======================================== */
        .game-board {
            flex: 1;
            display: flex !important; /* Ensure visibility */
            padding: 20px;
            gap: 15px;
            min-height: 0;
            min-width: 0; /* Allow shrinking properly */
            overflow: hidden; /* Prevent overflow */
        }

        /* Left Sidebar */
        .left-sidebar {
            width: 80px;
            display: flex !important;
            flex-direction: column !important;
            visibility: visible !important;
            opacity: 1 !important;
            background: linear-gradient(135deg, rgba(42, 36, 30, 0.95) 0%, rgba(26, 22, 18, 0.95) 100%);
            border: 3px solid #8B7355;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8), inset 0 0 20px rgba(0, 0, 0, 0.5);
            padding: 10px;
            gap: 10px;
            flex-shrink: 0;
        }

        .sidebar-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .sidebar-btn:hover {
            background: rgba(212, 175, 55, 0.1);
            border-color: #D4AF37;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(212, 175, 55, 0.3);
        }

        .sidebar-icon {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .sidebar-label {
            font-size: 10px;
            color: #D4AF37;
            text-align: center;
            font-family: 'Cinzel', serif;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Main Scenario Scene */
        .scenario-container {
            flex: 1;
            position: relative;
            background: #0A0908;
            border: 4px solid;
            border-image: linear-gradient(135deg, #5C4A3A, #8B7355, #D4AF37, #8B7355, #5C4A3A) 1;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.9), inset 0 0 60px rgba(0, 0, 0, 0.8);
            overflow: hidden;
            min-width: 0; /* Allow proper flex shrinking */
            max-width: calc(100% - 430px); /* Account for sidebars */
        }

        /* Right Side Panel */
        .party-panel {
            width: 350px;
            display: flex !important; /* Ensure visibility */
            flex-direction: column !important;
            visibility: visible !important;
            opacity: 1 !important;
            gap: 15px;
            flex-shrink: 0; /* Prevent collapsing */
            min-width: 320px; /* Ensure minimum width */
            max-width: 400px; /* Limit maximum width */
        }

        /* Panel Section Styles */
        .panel-section {
            background: linear-gradient(135deg, rgba(42, 36, 30, 0.95) 0%, rgba(26, 22, 18, 0.95) 100%);
            border: 3px solid #8B7355;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8), inset 0 0 20px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }

        .panel-header {
            background: linear-gradient(90deg, #8B7355, #D4AF37, #8B7355);
            padding: 10px 15px;
            font-family: 'Cinzel', serif;
            font-size: 18px;
            font-weight: 700;
            color: #2A1810;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        .panel-content {
            padding: 15px;
        }
n        /* Reduce padding for objectives panel */
        .panel-section:has(.objectives-list) .panel-content {
            padding: 10px;
        }

        /* Party Trust Section */
        .trust-display {
            text-align: center;
            margin-bottom: 15px;
        }

        .trust-value {
            font-family: 'Cinzel', serif;
            font-size: 32px;
            font-weight: 700;
            color: #FFD700;
            text-shadow: 0 2px 10px rgba(255, 215, 0, 0.5);
        }

        .trust-label {
            font-size: 18px;
            color: #8B7355;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 5px;
        }

        .trust-bar {
            width: 100%;
            height: 24px;
            background: linear-gradient(180deg, rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.6));
            border: 2px solid #3E342A;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            margin: 15px 0;
        }

        .trust-fill {
            height: 100%;
            width: 55%;
            background: linear-gradient(90deg, #FFD700, #FFA500, #FFD700);
            box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.3);
            transition: width 0.5s ease;
        }

        .trust-bar-text {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 700;
            color: white;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
        }

        .trust-tier {
            font-size: 16px;
            color: #D4AF37;
            font-style: italic;
            text-align: center;
        }

        /* Party Members */
        .party-members {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .party-member {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid #8B7355;
            border-radius: 8px;
            padding: 6px;
            transition: all 0.3s ease;
        }

        .party-member:hover {
            border-color: #D4AF37;
            background: rgba(212, 175, 55, 0.1);
        }

        .member-portrait {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #8B7355 0%, #2A1810 100%);
            border: 2px solid #D4AF37;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
        }

        .member-info {
            flex: 1;
        }

        .member-name {
            font-family: 'Cinzel', serif;
            font-size: 18px;
            font-weight: 600;
            color: #FFD700;
        }

        .member-class {
            font-size: 18px;
            color: #8B7355;
        }

        .member-hp {
            font-size: 10px;
            color: #D4AF37;
        }

        /* Quest/Objectives Section */
        .objectives-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-height: 400px;
            overflow-y: auto;
        }

        .objective-item {
            background: rgba(0, 0, 0, 0.4);
            border-left: 3px solid #D4AF37;
            padding: 5px;
            border-radius: 5px;
        }

        .objective-item.completed {
            border-left-color: #00FF00;
            opacity: 0.6;
        }

        .objective-title {
            font-family: 'Cinzel', serif;
            font-size: 18px;
            font-weight: 600;
            color: #FFD700;
            margin-bottom: 5px;
        }

        .objective-desc {
            font-size: 16px;
            color: #D4AF37;
            line-height: 1.4;
        }

        .turn-counter {
            text-align: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #8B7355;
            font-family: 'Cinzel', serif;
            font-size: 16px;
            color: #D4AF37;
        }

        .scenario-scene {
            position: absolute;
            inset: 0;
        }

        /* Narrative Panel (Full Width) */
        .scene-narrative-panel {
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, rgba(26, 22, 18, 0.98) 0%, rgba(42, 36, 30, 0.98) 100%);
            padding: 30px;
            overflow-y: auto;
        }

        .act-header {
            font-family: 'Cinzel', serif;
            font-size: 24px;
            font-weight: 700;
            color: #FFD700;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #8B7355;
        }

        .narrative-text {
            font-size: 20px;
            line-height: 1.7;
            color: #D4AF37;
            margin-bottom: 15px;
        }

        .narrative-text em {
            color: #8B7355;
            font-style: italic;
        }

        .whisper-box {
            background: linear-gradient(135deg, rgba(139, 69, 139, 0.2), rgba(75, 0, 130, 0.2));
            border: 2px solid #8B458B;
            border-radius: 8px;
            padding: 12px;
            margin: 15px 0;
        }

        .whisper-header {
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Cinzel', serif;
            font-size: 18px;
            color: #DA70D6;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 8px;
        }

        .whisper-header .rune-icon {
            width: 24px;
            height: 24px;
            opacity: 0.8;
            filter: drop-shadow(0 0 6px #DA70D6);
        }

        .whisper-text {
            font-size: 18px;
            line-height: 1.6;
            color: #D4AF37;
        }

        /* Choice Buttons */
        .choice-section {
            margin-top: 20px;
        }

        .choice-label {
            font-family: 'Cinzel', serif;
            font-size: 16px;
            color: #8B7355;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .choice-btn {
            width: 100%;
            background: linear-gradient(135deg, rgba(42, 36, 30, 0.8) 0%, rgba(26, 22, 18, 0.8) 100%);
            border: 2px solid #8B7355;
            border-radius: 6px;
            padding: 10px 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Yrsa', serif;
            font-size: 20px;
            color: #D4AF37;
            text-align: left;
        }

        .choice-btn:hover {
            border-color: #D4AF37;
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.3) 0%, rgba(139, 115, 85, 0.3) 100%);
            transform: translateX(5px);
            box-shadow: 0 3px 15px rgba(212, 175, 55, 0.4);
        }

        /* Divine Council as Colored Narrative Text */
        .god-speech {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            border-left: 4px solid #D4AF37;
            border-radius: 6px;
            padding: 12px 15px;
            margin: 12px 0;
            background: rgba(212, 175, 55, 0.1);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .god-speech .god-icon {
            width: 48px;
            height: 48px;
            flex-shrink: 0;
            border: 2px solid var(--gold-medium);
            border-radius: 50%;
            padding: 6px;
            background: rgba(0, 0, 0, 0.6);
            filter: drop-shadow(0 0 10px rgba(212, 175, 55, 0.4));
        }

        .god-speech .god-content {
            flex: 1;
        }

        .god-speech .god-name {
            font-family: 'Cinzel', serif;
            font-weight: 700;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 6px;
        }

        .god-speech .god-text {
            font-size: 20px;
            line-height: 1.6;
        }

        /* VALDRIS - Order/Law (Blue, Formal Capitals) */
        .god-speech.valdris {
            border-left-color: #4169E1;
            background: rgba(65, 105, 225, 0.15);
        }
        .god-speech.valdris .god-name {
            color: #87CEEB;
        }
        .god-speech.valdris .god-text {
            color: #B0C4DE;
            font-family: 'Cinzel', serif;
            font-size: 16px;
            letter-spacing: 0.5px;
        }

        /* KAITHA - Chaos/Freedom (Orange-Red, Italic Wild) */
        .god-speech.kaitha {
            border-left-color: #FF4500;
            background: rgba(255, 69, 0, 0.15);
        }
        .god-speech.kaitha .god-name {
            color: #FF8C00;
        }
        .god-speech.kaitha .god-text {
            color: #FFA07A;
            font-style: italic;
            font-weight: 500;
        }

        /* MORVANE - Survival/Pragmatism (Grey, Bold Condensed) */
        .god-speech.morvane {
            border-left-color: #2F4F4F;
            background: rgba(47, 79, 79, 0.15);
        }
        .god-speech.morvane .god-name {
            color: #708090;
        }
        .god-speech.morvane .god-text {
            color: #A9A9A9;
            font-weight: 600;
            letter-spacing: -0.3px;
        }

        /* SYLARA - Nature/Life (Green, Flowing Serif) */
        .god-speech.sylara {
            border-left-color: #228B22;
            background: rgba(34, 139, 34, 0.15);
        }
        .god-speech.sylara .god-name {
            color: #90EE90;
        }
        .god-speech.sylara .god-text {
            color: #98FB98;
            font-family: 'Yrsa', serif;
            font-style: italic;
            font-weight: 400;
        }

        /* KORVAN - War/Courage (Crimson, Bold Aggressive) */
        .god-speech.korvan {
            border-left-color: #DC143C;
            background: rgba(220, 20, 60, 0.15);
        }
        .god-speech.korvan .god-name {
            color: #CD5C5C;
        }
        .god-speech.korvan .god-text {
            color: #F08080;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 16px;
            letter-spacing: 0.8px;
        }

        /* ATHENA - Wisdom/Knowledge (Purple, Scholarly) */
        .god-speech.athena {
            border-left-color: #9370DB;
            background: rgba(147, 112, 219, 0.15);
        }
        .god-speech.athena .god-name {
            color: #BA55D3;
        }
        .god-speech.athena .god-text {
            color: #DDA0DD;
            font-family: 'Yrsa', serif;
            font-weight: 500;
        }

        /* MERCUS - Commerce/Value (Gold, Business-like) */
        .god-speech.mercus {
            border-left-color: #FFD700;
            background: rgba(255, 215, 0, 0.15);
        }
        .god-speech.mercus .god-name {
            color: #F0E68C;
        }
        .god-speech.mercus .god-text {
            color: #EEE8AA;
            font-weight: 500;
            letter-spacing: 0.3px;
        }

        /* DRAKMOR - Power/Dominance (Dark Red, Imposing) */
        .god-speech.drakmor {
            border-left-color: #8B0000;
            background: rgba(139, 0, 0, 0.15);
        }
        .god-speech.drakmor .god-name {
            color: #DC143C;
        }
        .god-speech.drakmor .god-text {
            color: #CD5C5C;
            font-family: 'Cinzel', serif;
            font-weight: 700;
            font-size: 18px;
        }

        /* Council Judgment Summary */
        .council-judgment {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.2), rgba(139, 115, 85, 0.2));
            border: 2px solid #D4AF37;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }

        .council-judgment .judgment-header {
            font-family: 'Cinzel', serif;
            font-size: 18px;
            font-weight: 700;
            color: #FFD700;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 10px;
        }

        .council-judgment .judgment-result {
            font-size: 16px;
            color: #D4AF37;
            line-height: 1.8;
        }

        /* Bottom Action Bar - KEPT FROM ORIGINAL */
        .bottom-hud {
            height: 100px;
            background: linear-gradient(180deg, rgba(26, 22, 18, 0.95) 0%, rgba(42, 36, 30, 0.98) 100%);
            border-top: 3px solid;
            border-image: linear-gradient(90deg, #5C4A3A, #8B7355, #D4AF37, #8B7355, #5C4A3A) 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            z-index: 100;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.8);
        }

        .action-slots {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #8B7355;
            border-radius: 10px;
        }

        .action-slot {
            width: 54px;
            height: 54px;
            background: radial-gradient(circle at center, rgba(212, 175, 55, 0.05) 0%, transparent 70%),
                        linear-gradient(135deg, #2A1810 0%, #1A0F08 100%);
            border: 2px solid #8B7355;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            font-size: 26px;
        }

        .action-slot:hover {
            transform: translateY(-3px);
            border-color: #D4AF37;
            box-shadow: 0 5px 15px rgba(212, 175, 55, 0.4);
        }

        .slot-key {
            position: absolute;
            top: 2px;
            left: 4px;
            font-family: 'Cinzel', serif;
            font-size: 10px;
            font-weight: 700;
            color: #FFD700;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
        }

        /* Scrollbar */
        .scene-narrative-panel::-webkit-scrollbar {
            width: 6px;
        }

        .scene-narrative-panel::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 3px;
        }

        .scene-narrative-panel::-webkit-scrollbar-thumb {
            background: #8B7355;
            border-radius: 3px;
        }

        .scene-narrative-panel::-webkit-scrollbar-thumb:hover {
            background: #D4AF37;
        }

        .choice-btn:active {
            transform: translateX(3px) scale(0.98);
            box-shadow: 0 1px 8px rgba(212, 175, 55, 0.6);
        }

        .action-slot:active {
            transform: scale(0.85) translateY(-3px);
        }

        .side-btn:active {
            transform: scale(0.95);
        }

        .party-member:active {
            transform: scale(0.98);
        }


        /* Tooltip for choice buttons - appears below */
        .choice-btn {
            position: relative;
        }

        .choice-btn .tooltip {
            position: absolute;
            bottom: auto;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-top: 5px;
            z-index: 1000;
        }

        .choice-btn:hover .tooltip {
            opacity: 1;
        }

        /* Tooltip for party members - appears on right */
        .party-member {
            position: relative;
        }

        .party-member .tooltip {
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            margin-left: 10px;
            z-index: 1000;
            max-width: 250px;
            white-space: normal;
        }

        .party-member:hover .tooltip {
            opacity: 1;
        }

        /* Tooltip for action slots - appears above */
        .action-slot {
            position: relative;
        }

        .action-slot .tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 5px;
            z-index: 1000;
        }

        .action-slot:hover .tooltip {
            opacity: 1;
        }

        /* ========================================
           OVERLAY SYSTEM STYLES
           ======================================== */

        .overlay {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 200;
        }

        .game-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .overlay-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            cursor: pointer;
            transition: opacity 0.3s ease;
        }

        .overlay-content {
            position: relative;
            z-index: 201;
            background: linear-gradient(135deg, rgba(42, 36, 30, 0.98) 0%, rgba(26, 22, 18, 0.98) 100%);
            border: 3px solid #D4AF37;
            border-radius: 15px;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.9), 0 0 40px rgba(212, 175, 55, 0.3);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .overlay-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(90deg, #8B7355, #D4AF37, #8B7355);
            padding: 20px;
            border-bottom: 2px solid #D4AF37;
            border-radius: 12px 12px 0 0;
        }

        .overlay-header h2 {
            font-family: 'Cinzel', serif;
            font-size: 28px;
            font-weight: 700;
            color: #2A1810;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin: 0;
        }

        .close-btn {
            background: rgba(42, 42, 42, 0.7);
            border: 2px solid #D4AF37;
            color: #D4AF37;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-family: Arial, sans-serif;
            padding: 0;
        }

        .close-btn:hover {
            background: #D4AF37;
            color: #2A1810;
            transform: scale(1.1);
        }

        .overlay-body {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
        }

        /* Character Info Styling */
        .character-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .char-stat {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid #8B7355;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .char-stat label {
            font-family: 'Cinzel', serif;
            font-size: 14px;
            color: #8B7355;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .char-stat span {
            font-size: 18px;
            color: #FFD700;
            font-weight: 600;
        }

        /* Inventory Grid Styling */
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .inventory-slot {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid #8B7355;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .inventory-slot:hover {
            border-color: #D4AF37;
            background: rgba(212, 175, 55, 0.1);
            transform: translateY(-3px);
        }

        .slot-icon {
            font-size: 32px;
        }

        .slot-name {
            font-size: 14px;
            color: #D4AF37;
            font-weight: 600;
        }

        /* Skills List Styling */
        .skills-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .skill-item {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid #8B7355;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .skill-item:hover {
            border-color: #D4AF37;
            background: rgba(212, 175, 55, 0.1);
        }

        .skill-name {
            font-family: 'Cinzel', serif;
            font-size: 18px;
            color: #FFD700;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .skill-level {
            font-size: 12px;
            color: #8B7355;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .skill-desc {
            font-size: 14px;
            color: #D4AF37;
            line-height: 1.5;
        }

        /* Quests List Styling */
        .quests-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .quest-item {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid #8B7355;
            border-left: 4px solid #D4AF37;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .quest-item.completed {
            border-left-color: #00FF00;
            opacity: 0.7;
        }

        .quest-item:hover {
            border-color: #D4AF37;
            background: rgba(212, 175, 55, 0.1);
        }

        .quest-title {
            font-family: 'Cinzel', serif;
            font-size: 16px;
            color: #FFD700;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .quest-progress {
            font-size: 12px;
            color: #8B7355;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .quest-desc {
            font-size: 14px;
            color: #D4AF37;
            line-height: 1.5;
        }

        /* Map Container Styling */
        .map-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .map-location {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid #8B7355;
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .map-location:hover {
            border-color: #D4AF37;
            background: rgba(212, 175, 55, 0.1);
            transform: scale(1.05);
        }

        .map-location.active {
            border-color: #FFD700;
            background: rgba(255, 215, 0, 0.15);
        }

        .location-marker {
            font-size: 36px;
        }

        .location-name {
            font-family: 'Cinzel', serif;
            font-size: 14px;
            color: #D4AF37;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Settings List Styling */
        .settings-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .setting-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid #8B7355;
            border-radius: 8px;
        }

        .setting-item label {
            font-family: 'Cinzel', serif;
            font-size: 14px;
            color: #D4AF37;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .setting-item.checkbox {
            flex-direction: row;
            gap: 10px;
            cursor: pointer;
        }

        .setting-item.checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #D4AF37;
        }

        .setting-item input[type="range"] {
            flex: 1;
            cursor: pointer;
            accent-color: #D4AF37;
        }

        /* Scrollbar for Overlay Body */
        .overlay-body::-webkit-scrollbar {
            width: 8px;
        }

        .overlay-body::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 4px;
        }

        .overlay-body::-webkit-scrollbar-thumb {
            background: #8B7355;
            border-radius: 4px;
        }

        .overlay-body::-webkit-scrollbar-thumb:hover {
            background: #D4AF37;
        }

        /* ========================================
           CHARACTER SHEET OVERLAY STYLES
           ======================================== */
 section in head -->
<style>
    /* ========================================
       CHARACTER SHEET OVERLAY STYLES
       ======================================== */
    .character-sheet-content {
        max-width: 650px;
        max-height: 85vh;
    }

    .character-sheet-body {
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 20px;
        overflow-y: auto;
        max-height: calc(85vh - 60px);
    }

    /* CHARACTER INFO SECTION */
    .character-info-section {
        display: flex;
        align-items: center;
        gap: 20px;
        padding: 15px;
        background: linear-gradient(135deg, rgba(0, 0, 0, 0.3), transparent);
        border: 2px solid #8B7355;
        border-radius: 8px;
    }

    .character-portrait-large {
        width: 100px;
        height: 100px;
        background: radial-gradient(circle at 30% 30%, rgba(255, 215, 0, 0.3), transparent 60%),
                    linear-gradient(135deg, #8B7355 0%, #2A1810 100%);
        border: 3px solid #D4AF37;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 48px;
        box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.5), 0 0 25px rgba(212, 175, 55, 0.4);
        flex-shrink: 0;
    }

    .character-header {
        flex: 1;
    }

    .character-name {
        font-family: 'Cinzel', serif;
        font-size: 32px;
        font-weight: 700;
        color: #FFD700;
        text-transform: uppercase;
        letter-spacing: 2px;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.7);
    }

    .character-class-title {
        font-size: 18px;
        color: #D4AF37;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-top: 5px;
    }

    /* XP BAR */
    .xp-bar-container {
        padding: 0 5px;
    }

    .xp-bar-label {
        font-family: 'Cinzel', serif;
        font-size: 14px;
        color: #D4AF37;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 8px;
        font-weight: 600;
    }

    .xp-bar {
        width: 100%;
        height: 28px;
        background: linear-gradient(180deg, rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.6));
        border: 2px solid #3E342A;
        border-radius: 14px;
        overflow: hidden;
        position: relative;
    }

    .xp-fill {
        height: 100%;
        background: linear-gradient(90deg, #8B7355, #D4AF37, #FFD700, #D4AF37);
        box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.3);
        transition: width 0.5s ease;
    }

    .xp-text {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 700;
        color: white;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
    }

    /* STATS SECTION */
    .stats-section {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .stats-header {
        font-family: 'Cinzel', serif;
        font-size: 16px;
        color: #FFD700;
        text-transform: uppercase;
        letter-spacing: 1.5px;
        font-weight: 700;
        padding-bottom: 8px;
        border-bottom: 2px solid #8B7355;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
    }

    .stat-card {
        background: linear-gradient(135deg, rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.2));
        border: 2px solid #8B7355;
        border-radius: 8px;
        padding: 12px;
        text-align: center;
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        border-color: #D4AF37;
        background: linear-gradient(135deg, rgba(212, 175, 55, 0.2), rgba(212, 175, 55, 0.1));
        box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
    }

    .stat-icon {
        font-size: 24px;
        margin-bottom: 6px;
    }

    .stat-name {
        font-family: 'Cinzel', serif;
        font-size: 12px;
        color: #D4AF37;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
        margin-bottom: 6px;
    }

    .stat-value {
        font-family: 'Cinzel', serif;
        font-size: 24px;
        font-weight: 700;
        color: #FFD700;
        text-shadow: 0 2px 8px rgba(0, 0, 0, 0.6);
    }

    /* DIVINE FAVOR SECTION */
    .divine-favor-section {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .divine-favor-header {
        font-family: 'Cinzel', serif;
        font-size: 16px;
        color: #FFD700;
        text-transform: uppercase;
        letter-spacing: 1.5px;
        font-weight: 700;
        padding-bottom: 8px;
        border-bottom: 2px solid #8B7355;
    }

    .divine-god {
        display: flex;
        align-items: center;
        gap: 10px;
        background: rgba(0, 0, 0, 0.3);
        padding: 8px;
        border-radius: 6px;
    }

    .divine-icon {
        width: 32px;
        height: 32px;
        border: 2px solid var(--gold-medium);
        border-radius: 50%;
        padding: 4px;
        background: rgba(0, 0, 0, 0.5);
        transition: all 0.3s ease;
    }

    .divine-icon:hover {
        transform: scale(1.1);
        border-color: var(--gold-bright);
        box-shadow: 0 0 15px rgba(212, 175, 55, 0.5);
        filter: drop-shadow(0 0 8px rgba(212, 175, 55, 0.6));
    }

    .divine-name {
        font-family: 'Cinzel', serif;
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        width: 90px;
        text-align: left;
    }

    /* God-specific colors for divine names */
    .valdris-name {
        color: #87CEEB;
    }

    .kaitha-name {
        color: #FF8C00;
    }

    .morvane-name {
        color: #708090;
    }

    .sylara-name {
        color: #90EE90;
    }

    .korvan-name {
        color: #CD5C5C;
    }

    .athena-name {
        color: #BA55D3;
    }

    .mercus-name {
        color: #F0E68C;
    }

    .divine-bar {
        flex: 1;
        height: 20px;
        background: linear-gradient(180deg, rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.6));
        border: 1px solid #3E342A;
        border-radius: 10px;
        overflow: hidden;
        position: relative;
    }

    .divine-fill {
        height: 100%;
        box-shadow: inset 0 1px 3px rgba(255, 255, 255, 0.2);
    }

    /* God-specific bar colors */
    .valdris-bar {
        background: linear-gradient(90deg, #4169E1, #87CEEB, #4169E1);
    }

    .kaitha-bar {
        background: linear-gradient(90deg, #FF4500, #FF8C00, #FF4500);
    }

    .morvane-bar {
        background: linear-gradient(90deg, #2F4F4F, #708090, #2F4F4F);
    }

    .sylara-bar {
        background: linear-gradient(90deg, #228B22, #90EE90, #228B22);
    }

    .korvan-bar {
        background: linear-gradient(90deg, #DC143C, #CD5C5C, #DC143C);
    }

    .athena-bar {
        background: linear-gradient(90deg, #9370DB, #BA55D3, #9370DB);
    }

    .mercus-bar {
        background: linear-gradient(90deg, #FFD700, #F0E68C, #FFD700);
    }

    .divine-value {
        font-family: 'Cinzel', serif;
        font-size: 12px;
        font-weight: 700;
        color: #FFD700;
        width: 45px;
        text-align: right;
        min-width: 45px;
    }

    .divine-value.negative {
        color: #FF6B6B;
    }

    /* ABILITIES SECTION */
    .abilities-section {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .abilities-header {
        font-family: 'Cinzel', serif;
        font-size: 16px;
        color: #FFD700;
        text-transform: uppercase;
        letter-spacing: 1.5px;
        font-weight: 700;
        padding-bottom: 8px;
        border-bottom: 2px solid #8B7355;
    }

    .abilities-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .ability-item {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        background: rgba(0, 0, 0, 0.3);
        border: 2px solid #8B7355;
        border-radius: 8px;
        padding: 12px;
        transition: all 0.3s ease;
    }

    .ability-item:hover {
        border-color: #D4AF37;
        background: rgba(212, 175, 55, 0.15);
        box-shadow: 0 0 15px rgba(212, 175, 55, 0.2);
    }

    .ability-icon {
        font-size: 28px;
        flex-shrink: 0;
        margin-top: 2px;
    }

    .ability-info {
        flex: 1;
    }

    .ability-name {
        font-family: 'Cinzel', serif;
        font-size: 14px;
        color: #FFD700;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 600;
        margin-bottom: 4px;
    }

    .ability-desc {
        font-size: 13px;
        color: #D4AF37;
        line-height: 1.4;
    }

    /* Scrollbar styling for character sheet */
    .character-sheet-body::-webkit-scrollbar {
        width: 6px;
    }

    .character-sheet-body::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.3);
        border-radius: 3px;
    }

    .character-sheet-body::-webkit-scrollbar-thumb {
        background: #8B7355;
        border-radius: 3px;
    }

    .character-sheet-body::-webkit-scrollbar-thumb:hover {
        background: #D4AF37;
    }


        /* ========================================
           INVENTORY OVERLAY STYLES
           ======================================== */

    /* ========================================
       INVENTORY OVERLAY STYLES
       ======================================== */
    #inventory-overlay {
        display: none;
        position: fixed;
        inset: 0;
        z-index: 2000;
    }

    #inventory-overlay.active {
        display: flex;
    }

    .game-overlay {
        display: flex;
        position: fixed;
        inset: 0;
        align-items: center;
        justify-content: center;
        z-index: 2000;
    }

    .overlay-backdrop {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(4px);
    }

    .overlay-panel {
        position: relative;
        z-index: 2001;
        background: linear-gradient(135deg, rgba(42, 36, 30, 0.98) 0%, rgba(26, 22, 18, 0.98) 100%);
        border: 4px solid;
        border-image: linear-gradient(135deg, #5C4A3A, #8B7355, #D4AF37, #8B7355, #5C4A3A) 1;
        border-radius: 12px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.95), inset 0 0 30px rgba(0, 0, 0, 0.7);
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .inventory-panel {
        width: 1200px;
        max-height: 85vh;
    }

    .overlay-header {
        background: linear-gradient(90deg, #8B7355, #D4AF37, #8B7355);
        padding: 15px 25px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 3px solid #5C4A3A;
        flex-shrink: 0;
    }

    .overlay-title {
        font-family: 'Cinzel', serif;
        font-size: 28px;
        font-weight: 700;
        color: #2A1810;
        text-transform: uppercase;
        letter-spacing: 2px;
    }

    .capacity-info {
        display: flex;
        align-items: center;
        gap: 10px;
        font-family: 'Cinzel', serif;
        font-size: 16px;
        color: #2A1810;
        font-weight: 600;
    }

    .capacity-label {
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .capacity-value {
        font-size: 18px;
        font-weight: 700;
    }

    .close-btn {
        width: 36px;
        height: 36px;
        background: rgba(0, 0, 0, 0.3);
        border: 2px solid #2A1810;
        border-radius: 50%;
        font-size: 28px;
        color: #2A1810;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
    }

    .close-btn:hover {
        background: rgba(255, 215, 0, 0.3);
        border-color: #FFD700;
        transform: rotate(90deg);
    }

    /* Inventory Filters */
    .inventory-filters {
        display: flex;
        gap: 10px;
        padding: 15px 20px;
        background: rgba(0, 0, 0, 0.3);
        border-bottom: 2px solid #8B7355;
        flex-shrink: 0;
    }

    .filter-btn {
        padding: 8px 16px;
        background: linear-gradient(135deg, rgba(42, 36, 30, 0.8) 0%, rgba(26, 22, 18, 0.8) 100%);
        border: 2px solid #8B7355;
        border-radius: 6px;
        color: #D4AF37;
        font-family: 'Cinzel', serif;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .filter-btn:hover {
        border-color: #D4AF37;
        background: linear-gradient(135deg, rgba(212, 175, 55, 0.3) 0%, rgba(139, 115, 85, 0.3) 100%);
        color: #FFD700;
    }

    .filter-btn.active {
        border-color: #FFD700;
        background: linear-gradient(135deg, rgba(212, 175, 55, 0.4) 0%, rgba(139, 115, 85, 0.4) 100%);
        color: #FFD700;
        box-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
    }

    /* Inventory Content */
    .inventory-content {
        display: flex;
        gap: 20px;
        padding: 20px;
        flex: 1;
        overflow-y: auto;
    }

    /* Equipment Section */
    .equipment-section {
        display: flex;
        flex-direction: column;
        gap: 15px;
        min-width: 250px;
    }

    .equipment-header {
        font-family: 'Cinzel', serif;
        font-size: 16px;
        font-weight: 700;
        color: #FFD700;
        text-transform: uppercase;
        letter-spacing: 2px;
        padding-bottom: 10px;
        border-bottom: 2px solid #8B7355;
    }

    .equipment-slots {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }

    .equipment-slot {
        display: flex;
        flex-direction: column;
        gap: 6px;
        align-items: center;
    }

    .slot-label {
        font-family: 'Cinzel', serif;
        font-size: 12px;
        color: #8B7355;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
    }

    .slot-item {
        width: 100%;
        aspect-ratio: 1;
        background: linear-gradient(135deg, rgba(42, 36, 30, 0.9) 0%, rgba(26, 22, 18, 0.9) 100%);
        border: 3px solid #8B7355;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 32px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
    }

    .slot-item.equipped {
        border-color: #D4AF37;
        box-shadow: 0 0 15px rgba(212, 175, 55, 0.4), inset 0 0 10px rgba(212, 175, 55, 0.1);
    }

    .slot-item:hover {
        border-color: #D4AF37;
        background: linear-gradient(135deg, rgba(212, 175, 55, 0.2) 0%, rgba(139, 115, 85, 0.2) 100%);
        transform: scale(1.05);
    }

    /* Grid Section */
    .grid-section {
        display: flex;
        flex-direction: column;
        gap: 12px;
        flex: 1;
        min-width: 600px;
    }

    .grid-header {
        font-family: 'Cinzel', serif;
        font-size: 16px;
        font-weight: 700;
        color: #FFD700;
        text-transform: uppercase;
        letter-spacing: 2px;
        padding-bottom: 10px;
        border-bottom: 2px solid #8B7355;
    }

    .inventory-grid {
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        gap: 10px;
        flex: 1;
    }

    .inventory-slot {
        aspect-ratio: 1;
        background: linear-gradient(135deg, rgba(42, 36, 30, 0.85) 0%, rgba(26, 22, 18, 0.85) 100%);
        border: 2px solid #8B7355;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        min-height: 60px;
    }

    .inventory-slot:hover {
        border-color: #D4AF37;
        background: linear-gradient(135deg, rgba(212, 175, 55, 0.2) 0%, rgba(139, 115, 85, 0.2) 100%);
        transform: scale(1.08);
        box-shadow: 0 0 12px rgba(212, 175, 55, 0.3);
    }

    .grid-item {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        position: relative;
        cursor: grab;
        user-select: none;
    }

    .grid-item:active {
        cursor: grabbing;
    }

    .item-quantity {
        position: absolute;
        bottom: 2px;
        right: 4px;
        background: rgba(212, 175, 55, 0.9);
        color: #2A1810;
        font-family: 'Cinzel', serif;
        font-size: 10px;
        font-weight: 700;
        padding: 2px 4px;
        border-radius: 3px;
        min-width: 16px;
        text-align: center;
    }

    /* Item Details Panel */
    .item-details {
        background: rgba(0, 0, 0, 0.3);
        border-top: 2px solid #8B7355;
        padding: 15px 20px;
        min-height: 100px;
        flex-shrink: 0;
    }

    .details-title {
        font-family: 'Cinzel', serif;
        font-size: 14px;
        font-weight: 700;
        color: #FFD700;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 10px;
    }

    .details-content {
        font-size: 14px;
        color: #D4AF37;
        line-height: 1.6;
    }

    .details-placeholder {
        color: #8B7355;
        font-style: italic;
    }

    /* Tooltip/Hover Details */
    [data-tooltip] {
        position: relative;
    }

    [data-tooltip]:hover::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 120%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.95);
        color: #D4AF37;
        padding: 8px 12px;
        border: 2px solid #8B7355;
        border-radius: 6px;
        font-family: 'Yrsa', serif;
        font-size: 12px;
        white-space: nowrap;
        z-index: 3000;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.8);
    }

    /* Inventory Scrollbar */
    .inventory-content::-webkit-scrollbar {
        width: 8px;
    }

    .inventory-content::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.5);
        border-radius: 4px;
    }

    .inventory-content::-webkit-scrollbar-thumb {
        background: #8B7355;
        border-radius: 4px;
    }

    .inventory-content::-webkit-scrollbar-thumb:hover {
        background: #D4AF37;
    }



        /* ========================================
           CHARACTER SHEET OVERLAY STYLES - INTEGRATED
           ======================================== */
section in head -->
<style>
    /* ========================================
       CHARACTER SHEET OVERLAY STYLES
       ======================================== */
    .character-sheet-content {
        max-width: 650px;
        max-height: 85vh;
    }

    .character-sheet-body {
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 20px;
        overflow-y: auto;
        max-height: calc(85vh - 60px);
    }

    /* CHARACTER INFO SECTION */
    .character-info-section {
        display: flex;
        align-items: center;
        gap: 20px;
        padding: 15px;
        background: linear-gradient(135deg, rgba(0, 0, 0, 0.3), transparent);
        border: 2px solid #8B7355;
        border-radius: 8px;
    }

    .character-portrait-large {
        width: 100px;
        height: 100px;
        background: radial-gradient(circle at 30% 30%, rgba(255, 215, 0, 0.3), transparent 60%),
                    linear-gradient(135deg, #8B7355 0%, #2A1810 100%);
        border: 3px solid #D4AF37;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 48px;
        box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.5), 0 0 25px rgba(212, 175, 55, 0.4);
        flex-shrink: 0;
    }

    .character-header {
        flex: 1;
    }

    .character-name {
        font-family: 'Cinzel', serif;
        font-size: 32px;
        font-weight: 700;
        color: #FFD700;
        text-transform: uppercase;
        letter-spacing: 2px;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.7);
    }

    .character-class-title {
        font-size: 18px;
        color: #D4AF37;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-top: 5px;
    }

    /* XP BAR */
    .xp-bar-container {
        padding: 0 5px;
    }

    .xp-bar-label {
        font-family: 'Cinzel', serif;
        font-size: 14px;
        color: #D4AF37;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 8px;
        font-weight: 600;
    }

    .xp-bar {
        width: 100%;
        height: 28px;
        background: linear-gradient(180deg, rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.6));
        border: 2px solid #3E342A;
        border-radius: 14px;
        overflow: hidden;
        position: relative;
    }

    .xp-fill {
        height: 100%;
        background: linear-gradient(90deg, #8B7355, #D4AF37, #FFD700, #D4AF37);
        box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.3);
        transition: width 0.5s ease;
    }

    .xp-text {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 700;
        color: white;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
    }

    /* STATS SECTION */
    .stats-section {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .stats-header {
        font-family: 'Cinzel', serif;
        font-size: 16px;
        color: #FFD700;
        text-transform: uppercase;
        letter-spacing: 1.5px;
        font-weight: 700;
        padding-bottom: 8px;
        border-bottom: 2px solid #8B7355;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
    }

    .stat-card {
        background: linear-gradient(135deg, rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.2));
        border: 2px solid #8B7355;
        border-radius: 8px;
        padding: 12px;
        text-align: center;
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        border-color: #D4AF37;
        background: linear-gradient(135deg, rgba(212, 175, 55, 0.2), rgba(212, 175, 55, 0.1));
        box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
    }

    .stat-icon {
        font-size: 24px;
        margin-bottom: 6px;
    }

    .stat-name {
        font-family: 'Cinzel', serif;
        font-size: 12px;
        color: #D4AF37;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
        margin-bottom: 6px;
    }

    .stat-value {
        font-family: 'Cinzel', serif;
        font-size: 24px;
        font-weight: 700;
        color: #FFD700;
        text-shadow: 0 2px 8px rgba(0, 0, 0, 0.6);
    }

    /* DIVINE FAVOR SECTION */
    .divine-favor-section {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .divine-favor-header {
        font-family: 'Cinzel', serif;
        font-size: 16px;
        color: #FFD700;
        text-transform: uppercase;
        letter-spacing: 1.5px;
        font-weight: 700;
        padding-bottom: 8px;
        border-bottom: 2px solid #8B7355;
    }

    .divine-god {
        display: flex;
        align-items: center;
        gap: 10px;
        background: rgba(0, 0, 0, 0.3);
        padding: 8px;
        border-radius: 6px;
    }

    .divine-icon {
        width: 32px;
        height: 32px;
        border: 2px solid var(--gold-medium);
        border-radius: 50%;
        padding: 4px;
        background: rgba(0, 0, 0, 0.5);
        transition: all 0.3s ease;
    }

    .divine-icon:hover {
        transform: scale(1.1);
        border-color: var(--gold-bright);
        box-shadow: 0 0 15px rgba(212, 175, 55, 0.5);
        filter: drop-shadow(0 0 8px rgba(212, 175, 55, 0.6));
    }

    .divine-name {
        font-family: 'Cinzel', serif;
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        width: 90px;
        text-align: left;
    }

    /* God-specific colors for divine names */
    .valdris-name {
        color: #87CEEB;
    }

    .kaitha-name {
        color: #FF8C00;
    }

    .morvane-name {
        color: #708090;
    }

    .sylara-name {
        color: #90EE90;
    }

    .korvan-name {
        color: #CD5C5C;
    }

    .athena-name {
        color: #BA55D3;
    }

    .mercus-name {
        color: #F0E68C;
    }

    .divine-bar {
        flex: 1;
        height: 20px;
        background: linear-gradient(180deg, rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.6));
        border: 1px solid #3E342A;
        border-radius: 10px;
        overflow: hidden;
        position: relative;
    }

    .divine-fill {
        height: 100%;
        box-shadow: inset 0 1px 3px rgba(255, 255, 255, 0.2);
    }

    /* God-specific bar colors */
    .valdris-bar {
        background: linear-gradient(90deg, #4169E1, #87CEEB, #4169E1);
    }

    .kaitha-bar {
        background: linear-gradient(90deg, #FF4500, #FF8C00, #FF4500);
    }

    .morvane-bar {
        background: linear-gradient(90deg, #2F4F4F, #708090, #2F4F4F);
    }

    .sylara-bar {
        background: linear-gradient(90deg, #228B22, #90EE90, #228B22);
    }

    .korvan-bar {
        background: linear-gradient(90deg, #DC143C, #CD5C5C, #DC143C);
    }

    .athena-bar {
        background: linear-gradient(90deg, #9370DB, #BA55D3, #9370DB);
    }

    .mercus-bar {
        background: linear-gradient(90deg, #FFD700, #F0E68C, #FFD700);
    }

    .divine-value {
        font-family: 'Cinzel', serif;
        font-size: 12px;
        font-weight: 700;
        color: #FFD700;
        width: 45px;
        text-align: right;
        min-width: 45px;
    }

    .divine-value.negative {
        color: #FF6B6B;
    }

    /* ABILITIES SECTION */
    .abilities-section {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .abilities-header {
        font-family: 'Cinzel', serif;
        font-size: 16px;
        color: #FFD700;
        text-transform: uppercase;
        letter-spacing: 1.5px;
        font-weight: 700;
        padding-bottom: 8px;
        border-bottom: 2px solid #8B7355;
    }

    .abilities-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .ability-item {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        background: rgba(0, 0, 0, 0.3);
        border: 2px solid #8B7355;
        border-radius: 8px;
        padding: 12px;
        transition: all 0.3s ease;
    }

    .ability-item:hover {
        border-color: #D4AF37;
        background: rgba(212, 175, 55, 0.15);
        box-shadow: 0 0 15px rgba(212, 175, 55, 0.2);
    }

    .ability-icon {
        font-size: 28px;
        flex-shrink: 0;
        margin-top: 2px;
    }

    .ability-info {
        flex: 1;
    }

    .ability-name {
        font-family: 'Cinzel', serif;
        font-size: 14px;
        color: #FFD700;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 600;
        margin-bottom: 4px;
    }

    .ability-desc {
        font-size: 13px;
        color: #D4AF37;
        line-height: 1.4;
    }

    /* Scrollbar styling for character sheet */
    .character-sheet-body::-webkit-scrollbar {
        width: 6px;
    }

    .character-sheet-body::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.3);
        border-radius: 3px;
    }

    .character-sheet-body::-webkit-scrollbar-thumb {
        background: #8B7355;
        border-radius: 3px;
    }

    .character-sheet-body::-webkit-scrollbar-thumb:hover {
        background: #D4AF37;
    }

        /* ========================================
           INVENTORY OVERLAY STYLES - INTEGRATED
           ======================================== */
/* ========================================
       INVENTORY OVERLAY STYLES
       ======================================== */
    #inventory-overlay {
        display: none;
        position: fixed;
        inset: 0;
        z-index: 2000;
    }

    #inventory-overlay.active {
        display: flex;
    }

    .game-overlay {
        display: flex;
        position: fixed;
        inset: 0;
        align-items: center;
        justify-content: center;
        z-index: 2000;
    }

    .overlay-backdrop {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(4px);
    }

    .overlay-panel {
        position: relative;
        z-index: 2001;
        background: linear-gradient(135deg, rgba(42, 36, 30, 0.98) 0%, rgba(26, 22, 18, 0.98) 100%);
        border: 4px solid;
        border-image: linear-gradient(135deg, #5C4A3A, #8B7355, #D4AF37, #8B7355, #5C4A3A) 1;
        border-radius: 12px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.95), inset 0 0 30px rgba(0, 0, 0, 0.7);
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .inventory-panel {
        width: 1200px;
        max-height: 85vh;
    }

    .overlay-header {
        background: linear-gradient(90deg, #8B7355, #D4AF37, #8B7355);
        padding: 15px 25px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 3px solid #5C4A3A;
        flex-shrink: 0;
    }

    .overlay-title {
        font-family: 'Cinzel', serif;
        font-size: 28px;
        font-weight: 700;
        color: #2A1810;
        text-transform: uppercase;
        letter-spacing: 2px;
    }

    .capacity-info {
        display: flex;
        align-items: center;
        gap: 10px;
        font-family: 'Cinzel', serif;
        font-size: 16px;
        color: #2A1810;
        font-weight: 600;
    }

    .capacity-label {
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .capacity-value {
        font-size: 18px;
        font-weight: 700;
    }

    .close-btn {
        width: 36px;
        height: 36px;
        background: rgba(0, 0, 0, 0.3);
        border: 2px solid #2A1810;
        border-radius: 50%;
        font-size: 28px;
        color: #2A1810;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
    }

    .close-btn:hover {
        background: rgba(255, 215, 0, 0.3);
        border-color: #FFD700;
        transform: rotate(90deg);
    }

    /* Inventory Filters */
    .inventory-filters {
        display: flex;
        gap: 10px;
        padding: 15px 20px;
        background: rgba(0, 0, 0, 0.3);
        border-bottom: 2px solid #8B7355;
        flex-shrink: 0;
    }

    .filter-btn {
        padding: 8px 16px;
        background: linear-gradient(135deg, rgba(42, 36, 30, 0.8) 0%, rgba(26, 22, 18, 0.8) 100%);
        border: 2px solid #8B7355;
        border-radius: 6px;
        color: #D4AF37;
        font-family: 'Cinzel', serif;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .filter-btn:hover {
        border-color: #D4AF37;
        background: linear-gradient(135deg, rgba(212, 175, 55, 0.3) 0%, rgba(139, 115, 85, 0.3) 100%);
        color: #FFD700;
    }

    .filter-btn.active {
        border-color: #FFD700;
        background: linear-gradient(135deg, rgba(212, 175, 55, 0.4) 0%, rgba(139, 115, 85, 0.4) 100%);
        color: #FFD700;
        box-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
    }

    /* Inventory Content */
    .inventory-content {
        display: flex;
        gap: 20px;
        padding: 20px;
        flex: 1;
        overflow-y: auto;
    }

    /* Equipment Section */
    .equipment-section {
        display: flex;
        flex-direction: column;
        gap: 15px;
        min-width: 250px;
    }

    .equipment-header {
        font-family: 'Cinzel', serif;
        font-size: 16px;
        font-weight: 700;
        color: #FFD700;
        text-transform: uppercase;
        letter-spacing: 2px;
        padding-bottom: 10px;
        border-bottom: 2px solid #8B7355;
    }

    .equipment-slots {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }

    .equipment-slot {
        display: flex;
        flex-direction: column;
        gap: 6px;
        align-items: center;
    }

    .slot-label {
        font-family: 'Cinzel', serif;
        font-size: 12px;
        color: #8B7355;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
    }

    .slot-item {
        width: 100%;
        aspect-ratio: 1;
        background: linear-gradient(135deg, rgba(42, 36, 30, 0.9) 0%, rgba(26, 22, 18, 0.9) 100%);
        border: 3px solid #8B7355;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 32px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
    }

    .slot-item.equipped {
        border-color: #D4AF37;
        box-shadow: 0 0 15px rgba(212, 175, 55, 0.4), inset 0 0 10px rgba(212, 175, 55, 0.1);
    }

    .slot-item:hover {
        border-color: #D4AF37;
        background: linear-gradient(135deg, rgba(212, 175, 55, 0.2) 0%, rgba(139, 115, 85, 0.2) 100%);
        transform: scale(1.05);
    }

    /* Grid Section */
    .grid-section {
        display: flex;
        flex-direction: column;
        gap: 12px;
        flex: 1;
        min-width: 600px;
    }

    .grid-header {
        font-family: 'Cinzel', serif;
        font-size: 16px;
        font-weight: 700;
        color: #FFD700;
        text-transform: uppercase;
        letter-spacing: 2px;
        padding-bottom: 10px;
        border-bottom: 2px solid #8B7355;
    }

    .inventory-grid {
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        gap: 10px;
        flex: 1;
    }

    .inventory-slot {
        aspect-ratio: 1;
        background: linear-gradient(135deg, rgba(42, 36, 30, 0.85) 0%, rgba(26, 22, 18, 0.85) 100%);
        border: 2px solid #8B7355;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        min-height: 60px;
    }

    .inventory-slot:hover {
        border-color: #D4AF37;
        background: linear-gradient(135deg, rgba(212, 175, 55, 0.2) 0%, rgba(139, 115, 85, 0.2) 100%);
        transform: scale(1.08);
        box-shadow: 0 0 12px rgba(212, 175, 55, 0.3);
    }

    .grid-item {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        position: relative;
        cursor: grab;
        user-select: none;
    }

    .grid-item:active {
        cursor: grabbing;
    }

    .item-quantity {
        position: absolute;
        bottom: 2px;
        right: 4px;
        background: rgba(212, 175, 55, 0.9);
        color: #2A1810;
        font-family: 'Cinzel', serif;
        font-size: 10px;
        font-weight: 700;
        padding: 2px 4px;
        border-radius: 3px;
        min-width: 16px;
        text-align: center;
    }

    /* Item Details Panel */
    .item-details {
        background: rgba(0, 0, 0, 0.3);
        border-top: 2px solid #8B7355;
        padding: 15px 20px;
        min-height: 100px;
        flex-shrink: 0;
    }

    .details-title {
        font-family: 'Cinzel', serif;
        font-size: 14px;
        font-weight: 700;
        color: #FFD700;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 10px;
    }

    .details-content {
        font-size: 14px;
        color: #D4AF37;
        line-height: 1.6;
    }

    .details-placeholder {
        color: #8B7355;
        font-style: italic;
    }

    /* Tooltip/Hover Details */
    [data-tooltip] {
        position: relative;
    }

    [data-tooltip]:hover::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 120%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.95);
        color: #D4AF37;
        padding: 8px 12px;
        border: 2px solid #8B7355;
        border-radius: 6px;
        font-family: 'Yrsa', serif;
        font-size: 12px;
        white-space: nowrap;
        z-index: 3000;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.8);
    }

    /* Inventory Scrollbar */
    .inventory-content::-webkit-scrollbar {
        width: 8px;
    }

    .inventory-content::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.5);
        border-radius: 4px;
    }

    .inventory-content::-webkit-scrollbar-thumb {
        background: #8B7355;
        border-radius: 4px;
    }

    .inventory-content::-webkit-scrollbar-thumb:hover {
        background: #D4AF37;
    }

    /* ========================================
/* ========================================
   THE ARCANE CODEX - ENHANCED OVERLAY STYLES
   Dark Fantasy UI Visual Overhaul
   ======================================== */

/* ========================================
   GLOBAL OVERLAY ENHANCEMENTS
   ======================================== */

/* Fix display states */
.overlay, .game-overlay {
    display: none !important;
    position: fixed;
    inset: 0;
    z-index: 200;
    animation: fadeIn 0.3s ease;
}

.overlay.active, .game-overlay.active {
    display: flex !important;
    align-items: center;
    justify-content: center;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        backdrop-filter: blur(0px);
    }
    to {
        opacity: 1;
        backdrop-filter: blur(8px);
    }
}

.overlay-backdrop {
    background: radial-gradient(circle at center, rgba(10, 9, 8, 0.85), rgba(0, 0, 0, 0.95));
    backdrop-filter: blur(8px);
    animation: backdropFade 0.3s ease;
}

.overlay-content, .overlay-panel, .inventory-panel {
    background:
        linear-gradient(135deg, rgba(0, 0, 0, 0.9) 0%, transparent 30%),
        linear-gradient(225deg, rgba(139, 115, 85, 0.1) 0%, transparent 30%),
        linear-gradient(180deg, rgba(42, 36, 30, 0.98) 0%, rgba(26, 22, 18, 0.98) 100%);
    border: 3px solid transparent;
    border-image: linear-gradient(135deg, #3E342A, #8B7355, #D4AF37, #FFD700, #D4AF37, #8B7355, #3E342A) 1;
    box-shadow:
        0 0 80px rgba(212, 175, 55, 0.2),
        0 30px 90px rgba(0, 0, 0, 0.9),
        inset 0 0 60px rgba(0, 0, 0, 0.5),
        inset 0 0 120px rgba(212, 175, 55, 0.05);
    position: relative;
    overflow: hidden;
}

.overlay-content::before, .overlay-panel::before {
    content: '';
    position: absolute;
    top: -2px;
    left: -2px;
    right: -2px;
    bottom: -2px;
    background: linear-gradient(45deg, transparent, #D4AF37, transparent);
    opacity: 0;
    z-index: -1;
    animation: borderGlow 3s ease-in-out infinite;
}

@keyframes borderGlow {
    0%, 100% { opacity: 0; }
    50% { opacity: 0.3; }
}

.overlay-header {
    background:
        linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.1), transparent),
        linear-gradient(90deg, #3E342A, #8B7355, #D4AF37, #FFD700, #D4AF37, #8B7355, #3E342A);
    box-shadow:
        0 5px 20px rgba(0, 0, 0, 0.8),
        inset 0 1px 0 rgba(255, 215, 0, 0.3),
        inset 0 -1px 0 rgba(0, 0, 0, 0.5);
    position: relative;
    overflow: hidden;
}

.overlay-header::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    animation: headerShine 4s ease-in-out infinite;
}

@keyframes headerShine {
    0% { left: -100%; }
    50%, 100% { left: 100%; }
}

.overlay-header h2, .overlay-title {
    font-family: 'Cinzel', serif;
    font-weight: 900;
    background: linear-gradient(180deg, #FFD700, #FFA500, #FFD700);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-shadow:
        0 0 30px rgba(255, 215, 0, 0.5),
        0 2px 4px rgba(0, 0, 0, 0.8);
    animation: titlePulse 2s ease-in-out infinite;
}

@keyframes titlePulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.02); }
}

.close-btn {
    background:
        radial-gradient(circle at 30% 30%, rgba(255, 215, 0, 0.2), transparent),
        linear-gradient(135deg, #2A1810, #3E342A);
    border: 2px solid #8B7355;
    box-shadow:
        0 4px 10px rgba(0, 0, 0, 0.5),
        inset 0 1px 0 rgba(255, 215, 0, 0.2);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.close-btn:hover {
    background:
        radial-gradient(circle at 30% 30%, rgba(255, 215, 0, 0.4), transparent),
        linear-gradient(135deg, #D4AF37, #FFD700);
    border-color: #FFD700;
    box-shadow:
        0 0 20px rgba(255, 215, 0, 0.6),
        0 6px 12px rgba(0, 0, 0, 0.6),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
    transform: rotate(90deg) scale(1.1);
}

/* Enhanced Scrollbar */
.overlay-body::-webkit-scrollbar {
    width: 12px;
}

.overlay-body::-webkit-scrollbar-track {
    background: linear-gradient(180deg, rgba(0, 0, 0, 0.8), rgba(42, 36, 30, 0.4));
    border: 1px solid #3E342A;
    border-radius: 6px;
    box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.5);
}

.overlay-body::-webkit-scrollbar-thumb {
    background: linear-gradient(180deg, #8B7355, #5C4A3A);
    border: 1px solid #D4AF37;
    border-radius: 6px;
    box-shadow:
        0 0 10px rgba(212, 175, 55, 0.3),
        inset 0 0 4px rgba(255, 215, 0, 0.2);
}

.overlay-body::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(180deg, #D4AF37, #8B7355);
    box-shadow:
        0 0 15px rgba(255, 215, 0, 0.5),
        inset 0 0 6px rgba(255, 255, 255, 0.3);
}

/* ========================================
   CHARACTER SHEET ENHANCEMENTS
   ======================================== */

.character-sheet-content {
    max-width: 750px;
}

.character-portrait-large {
    background:
        radial-gradient(circle at 30% 30%, rgba(255, 215, 0, 0.4), transparent 50%),
        radial-gradient(circle at 70% 70%, rgba(139, 115, 85, 0.3), transparent 50%),
        linear-gradient(135deg, #8B7355 0%, #2A1810 100%);
    border: 4px solid transparent;
    border-image: linear-gradient(45deg, #3E342A, #8B7355, #D4AF37, #FFD700) 1;
    box-shadow:
        0 0 40px rgba(212, 175, 55, 0.4),
        inset 0 0 30px rgba(0, 0, 0, 0.6),
        0 10px 30px rgba(0, 0, 0, 0.8);
    animation: portraitFloat 3s ease-in-out infinite;
}

@keyframes portraitFloat {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
}

.character-name {
    background: linear-gradient(90deg, #B8860B, #FFD700, #FFA500, #FFD700, #B8860B);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: nameShimmer 3s linear infinite;
    background-size: 200% auto;
}

@keyframes nameShimmer {
    0% { background-position: 0% center; }
    100% { background-position: 200% center; }
}

/* Attributes Section */
.attributes-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin: 20px 0;
}

.attribute-item {
    background:
        linear-gradient(135deg, rgba(139, 115, 85, 0.1), transparent),
        linear-gradient(180deg, rgba(0, 0, 0, 0.6), rgba(42, 36, 30, 0.4));
    border: 2px solid #5C4A3A;
    border-radius: 12px;
    padding: 12px;
    text-align: center;
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
}

.attribute-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 2px;
    background: linear-gradient(90deg, transparent, #FFD700, transparent);
    animation: attributeScan 3s ease-in-out infinite;
    animation-delay: var(--delay, 0s);
}

@keyframes attributeScan {
    0% { left: -100%; }
    50%, 100% { left: 100%; }
}

.attribute-item:hover {
    border-color: #D4AF37;
    background:
        linear-gradient(135deg, rgba(255, 215, 0, 0.15), transparent),
        linear-gradient(180deg, rgba(0, 0, 0, 0.7), rgba(42, 36, 30, 0.5));
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(212, 175, 55, 0.3);
}

.attribute-value {
    font-family: 'Cinzel', serif;
    font-size: 28px;
    font-weight: 700;
    background: linear-gradient(180deg, #FFD700, #D4AF37);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
}

/* Divine Favor Section */
.divine-favor-section {
    background:
        radial-gradient(circle at center, rgba(123, 90, 139, 0.1), transparent),
        linear-gradient(135deg, rgba(0, 0, 0, 0.7), rgba(42, 36, 30, 0.5));
    border: 2px solid #7B5A8B;
    border-radius: 15px;
    padding: 20px;
    margin: 20px 0;
    position: relative;
}

.divine-favor-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

.god-favor {
    background:
        radial-gradient(circle at center, rgba(255, 215, 0, 0.05), transparent),
        linear-gradient(135deg, rgba(0, 0, 0, 0.8), rgba(139, 115, 85, 0.2));
    border: 2px solid #5C4A3A;
    border-radius: 10px;
    padding: 10px;
    text-align: center;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.god-favor::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: var(--favor-height, 0%);
    background: linear-gradient(180deg, rgba(255, 215, 0, 0.3), rgba(212, 175, 55, 0.1));
    transition: height 0.5s ease;
}

.god-favor:hover {
    border-color: #D4AF37;
    transform: scale(1.05);
    box-shadow: 0 0 20px rgba(212, 175, 55, 0.4);
}

.god-icon {
    font-size: 28px;
    margin-bottom: 5px;
    filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.5));
    animation: godIconPulse 2s ease-in-out infinite;
    animation-delay: calc(var(--index, 0) * 0.2s);
}

@keyframes godIconPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

/* XP Bar Enhancement */
.xp-bar-container {
    background: linear-gradient(180deg, rgba(0, 0, 0, 0.8), rgba(42, 36, 30, 0.4));
    border: 2px solid #5C4A3A;
    border-radius: 15px;
    padding: 15px;
    margin: 20px 0;
}

.xp-bar {
    height: 30px;
    background: linear-gradient(180deg, rgba(0, 0, 0, 0.9), rgba(0, 0, 0, 0.6));
    border: 2px solid #3E342A;
    border-radius: 15px;
    overflow: hidden;
    position: relative;
    box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.8);
}

.xp-fill {
    height: 100%;
    background:
        linear-gradient(90deg, #8B7355, #D4AF37, #FFD700, #D4AF37, #8B7355);
    background-size: 200% 100%;
    animation: xpFlow 2s linear infinite;
    box-shadow:
        0 0 20px rgba(255, 215, 0, 0.6),
        inset 0 2px 4px rgba(255, 255, 255, 0.3);
    position: relative;
}

@keyframes xpFlow {
    0% { background-position: 0% 50%; }
    100% { background-position: 200% 50%; }
}

.xp-fill::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 50%;
    background: linear-gradient(180deg, rgba(255, 255, 255, 0.3), transparent);
}

/* ========================================
   INVENTORY OVERLAY ENHANCEMENTS
   ======================================== */

.inventory-panel {
    width: 1200px;
    max-width: 90vw;
}

.equipment-section {
    background:
        radial-gradient(circle at top left, rgba(139, 115, 85, 0.1), transparent),
        linear-gradient(135deg, rgba(0, 0, 0, 0.6), rgba(42, 36, 30, 0.3));
    border: 2px solid #5C4A3A;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
}

.equipment-header {
    font-family: 'Cinzel', serif;
    font-size: 18px;
    font-weight: 700;
    color: #FFD700;
    text-transform: uppercase;
    letter-spacing: 2px;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid #8B7355;
    text-shadow: 0 2px 10px rgba(255, 215, 0, 0.3);
}

.equipment-slot {
    background:
        radial-gradient(circle at center, rgba(0, 0, 0, 0.8), rgba(42, 36, 30, 0.6));
    border: 3px solid #5C4A3A;
    border-radius: 12px;
    padding: 12px;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.equipment-slot::before {
    content: '';
    position: absolute;
    inset: -3px;
    background: linear-gradient(45deg, transparent, #8B7355, transparent);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.equipment-slot:hover::before {
    opacity: 1;
    animation: slotRotate 2s linear infinite;
}

@keyframes slotRotate {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.equipment-slot:hover {
    border-color: #D4AF37;
    transform: scale(1.02);
    box-shadow:
        0 0 30px rgba(212, 175, 55, 0.4),
        inset 0 0 15px rgba(255, 215, 0, 0.1);
}

.slot-item {
    width: 80px;
    height: 80px;
    background:
        radial-gradient(circle at 30% 30%, rgba(255, 215, 0, 0.1), transparent),
        linear-gradient(135deg, #2A1810, #3E342A);
    border: 2px solid #8B7355;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 36px;
    transition: all 0.3s ease;
    position: relative;
    cursor: pointer;
}

.slot-item.equipped {
    background:
        radial-gradient(circle at 30% 30%, rgba(255, 215, 0, 0.3), transparent),
        linear-gradient(135deg, #5C4A3A, #8B7355);
    border-color: #D4AF37;
    box-shadow:
        0 0 20px rgba(212, 175, 55, 0.5),
        inset 0 0 10px rgba(255, 215, 0, 0.2);
    animation: equippedPulse 2s ease-in-out infinite;
}

@keyframes equippedPulse {
    0%, 100% {
        box-shadow:
            0 0 20px rgba(212, 175, 55, 0.5),
            inset 0 0 10px rgba(255, 215, 0, 0.2);
    }
    50% {
        box-shadow:
            0 0 30px rgba(255, 215, 0, 0.7),
            inset 0 0 15px rgba(255, 215, 0, 0.3);
    }
}

/* Rarity Colors */
.slot-item.common {
    border-color: #888;
}

.slot-item.uncommon {
    border-color: #4CAF50;
    box-shadow: 0 0 15px rgba(76, 175, 80, 0.4);
}

.slot-item.rare {
    border-color: #2196F3;
    box-shadow: 0 0 20px rgba(33, 150, 243, 0.5);
}

.slot-item.epic {
    border-color: #9C27B0;
    box-shadow: 0 0 25px rgba(156, 39, 176, 0.6);
}

.slot-item.legendary {
    border-color: #FF9800;
    box-shadow: 0 0 30px rgba(255, 152, 0, 0.7);
    animation: legendaryGlow 1.5s ease-in-out infinite;
}

@keyframes legendaryGlow {
    0%, 100% {
        box-shadow:
            0 0 30px rgba(255, 152, 0, 0.7),
            inset 0 0 20px rgba(255, 152, 0, 0.3);
    }
    50% {
        box-shadow:
            0 0 50px rgba(255, 152, 0, 1),
            inset 0 0 30px rgba(255, 152, 0, 0.5);
    }
}

/* Item Grid Enhancement */
.item-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 12px;
    padding: 15px;
    background:
        linear-gradient(135deg, rgba(0, 0, 0, 0.4), transparent),
        rgba(26, 22, 18, 0.3);
    border: 1px solid #3E342A;
    border-radius: 10px;
}

.item-slot {
    aspect-ratio: 1;
    background:
        radial-gradient(circle at center, rgba(0, 0, 0, 0.6), rgba(42, 36, 30, 0.4));
    border: 2px solid #3E342A;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    overflow: hidden;
}

.item-slot::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(circle at center, transparent, rgba(212, 175, 55, 0.2));
    opacity: 0;
    transition: opacity 0.3s ease;
}

.item-slot:hover::before {
    opacity: 1;
}

.item-slot:hover {
    border-color: #8B7355;
    transform: scale(1.05);
    z-index: 10;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
}

.item-slot.has-item:hover {
    border-color: #D4AF37;
    box-shadow:
        0 0 20px rgba(212, 175, 55, 0.4),
        0 5px 15px rgba(0, 0, 0, 0.6);
}

/* Tooltips Enhancement */
.item-tooltip {
    position: fixed;
    z-index: 1000;
    background:
        linear-gradient(135deg, rgba(0, 0, 0, 0.95), rgba(42, 36, 30, 0.95));
    border: 2px solid #D4AF37;
    border-radius: 10px;
    padding: 12px;
    min-width: 200px;
    box-shadow:
        0 0 30px rgba(212, 175, 55, 0.3),
        0 10px 30px rgba(0, 0, 0, 0.8);
    pointer-events: none;
    opacity: 0;
    transform: scale(0.9);
    transition: all 0.2s ease;
}

.item-tooltip.active {
    opacity: 1;
    transform: scale(1);
}

.tooltip-header {
    font-family: 'Cinzel', serif;
    font-size: 16px;
    font-weight: 700;
    color: #FFD700;
    margin-bottom: 8px;
    padding-bottom: 6px;
    border-bottom: 1px solid #8B7355;
}

.tooltip-stats {
    display: flex;
    flex-direction: column;
    gap: 4px;
    font-size: 14px;
    color: #D4AF37;
}

/* ========================================
   SKILLS OVERLAY ENHANCEMENTS
   ======================================== */

.skills-tree {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    padding: 20px;
}

.skill-branch {
    background:
        linear-gradient(135deg, rgba(139, 115, 85, 0.05), transparent),
        linear-gradient(180deg, rgba(0, 0, 0, 0.6), rgba(42, 36, 30, 0.3));
    border: 2px solid #5C4A3A;
    border-radius: 12px;
    padding: 15px;
    position: relative;
}

.branch-header {
    font-family: 'Cinzel', serif;
    font-size: 18px;
    font-weight: 700;
    color: #FFD700;
    text-align: center;
    margin-bottom: 15px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    text-shadow: 0 2px 10px rgba(255, 215, 0, 0.3);
}

.skill-node {
    width: 80px;
    height: 80px;
    margin: 10px auto;
    background:
        radial-gradient(circle at 30% 30%, rgba(255, 215, 0, 0.1), transparent),
        linear-gradient(135deg, #2A1810, #3E342A);
    border: 3px solid #5C4A3A;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 32px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
}

.skill-node::before {
    content: '';
    position: absolute;
    width: 2px;
    height: 30px;
    background: linear-gradient(180deg, transparent, #8B7355, transparent);
    top: -30px;
    left: 50%;
    transform: translateX(-50%);
}

.skill-node:first-child::before {
    display: none;
}

.skill-node.unlocked {
    background:
        radial-gradient(circle at 30% 30%, rgba(255, 215, 0, 0.3), transparent),
        linear-gradient(135deg, #5C4A3A, #8B7355);
    border-color: #D4AF37;
    box-shadow:
        0 0 25px rgba(212, 175, 55, 0.5),
        inset 0 0 15px rgba(255, 215, 0, 0.2);
}

.skill-node.active {
    animation: skillActive 1.5s ease-in-out infinite;
}

@keyframes skillActive {
    0%, 100% {
        box-shadow:
            0 0 25px rgba(212, 175, 55, 0.5),
            inset 0 0 15px rgba(255, 215, 0, 0.2);
        transform: scale(1);
    }
    50% {
        box-shadow:
            0 0 40px rgba(255, 215, 0, 0.8),
            inset 0 0 20px rgba(255, 215, 0, 0.4);
        transform: scale(1.05);
    }
}

.skill-node.locked {
    opacity: 0.5;
    filter: grayscale(50%);
}

.skill-node:hover:not(.locked) {
    transform: scale(1.1);
    border-color: #FFD700;
    box-shadow: 0 0 30px rgba(255, 215, 0, 0.6);
}

/* Ability Hotbar */
.ability-hotbar {
    display: flex;
    gap: 10px;
    padding: 15px;
    background:
        linear-gradient(180deg, rgba(0, 0, 0, 0.7), rgba(42, 36, 30, 0.4));
    border: 2px solid #5C4A3A;
    border-radius: 10px;
    margin-top: 20px;
}

.hotbar-slot {
    width: 60px;
    height: 60px;
    background:
        radial-gradient(circle at center, rgba(0, 0, 0, 0.7), rgba(42, 36, 30, 0.5));
    border: 2px solid #3E342A;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    position: relative;
    cursor: pointer;
    transition: all 0.3s ease;
}

.hotbar-slot.filled {
    border-color: #8B7355;
    background:
        radial-gradient(circle at 30% 30%, rgba(212, 175, 55, 0.2), transparent),
        linear-gradient(135deg, #3E342A, #5C4A3A);
}

.hotbar-slot:hover {
    border-color: #D4AF37;
    transform: scale(1.1);
    box-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
}

.cooldown-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #FFD700;
    font-family: 'Cinzel', serif;
    font-weight: 700;
    font-size: 18px;
}

/* ========================================
   QUESTS OVERLAY ENHANCEMENTS
   ======================================== */

.quest-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    padding: 10px;
    background: linear-gradient(180deg, rgba(0, 0, 0, 0.5), transparent);
    border-bottom: 2px solid #5C4A3A;
}

.quest-tab {
    padding: 10px 20px;
    background:
        linear-gradient(135deg, rgba(42, 36, 30, 0.8), rgba(26, 22, 18, 0.8));
    border: 2px solid #5C4A3A;
    border-radius: 8px 8px 0 0;
    cursor: pointer;
    font-family: 'Cinzel', serif;
    font-weight: 600;
    color: #8B7355;
    text-transform: uppercase;
    letter-spacing: 1px;
    transition: all 0.3s ease;
}

.quest-tab.active {
    background:
        linear-gradient(135deg, rgba(139, 115, 85, 0.3), rgba(212, 175, 55, 0.1));
    border-color: #D4AF37;
    color: #FFD700;
    transform: translateY(-2px);
    box-shadow: 0 -5px 15px rgba(212, 175, 55, 0.3);
}

.quest-tab:hover:not(.active) {
    border-color: #8B7355;
    color: #D4AF37;
    background:
        linear-gradient(135deg, rgba(139, 115, 85, 0.1), rgba(42, 36, 30, 0.8));
}

.quest-category {
    margin-bottom: 25px;
}

.category-header {
    font-family: 'Cinzel', serif;
    font-size: 20px;
    font-weight: 700;
    color: #FFD700;
    margin-bottom: 15px;
    padding-bottom: 8px;
    border-bottom: 2px solid #8B7355;
    text-transform: uppercase;
    letter-spacing: 2px;
    text-shadow: 0 2px 10px rgba(255, 215, 0, 0.3);
}

.quest-card {
    background:
        linear-gradient(135deg, rgba(0, 0, 0, 0.6), rgba(42, 36, 30, 0.4));
    border: 2px solid #5C4A3A;
    border-left: 5px solid #D4AF37;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 15px;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.quest-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(212, 175, 55, 0.1), transparent);
    transition: left 0.5s ease;
}

.quest-card:hover::before {
    left: 100%;
}

.quest-card:hover {
    border-color: #8B7355;
    transform: translateX(5px);
    box-shadow:
        -5px 0 15px rgba(212, 175, 55, 0.3),
        0 5px 20px rgba(0, 0, 0, 0.5);
}

.quest-card.completed {
    border-left-color: #4CAF50;
    opacity: 0.7;
}

.quest-objectives {
    margin: 10px 0;
    padding-left: 15px;
}

.objective-item {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 8px 0;
    color: #D4AF37;
    font-size: 14px;
}

.objective-checkbox {
    width: 18px;
    height: 18px;
    border: 2px solid #8B7355;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.objective-checkbox.checked {
    background: #4CAF50;
    border-color: #4CAF50;
}

.objective-checkbox.checked::after {
    content: '';
    color: white;
    font-weight: bold;
}

.quest-progress-bar {
    height: 8px;
    background: linear-gradient(180deg, rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.6));
    border: 1px solid #3E342A;
    border-radius: 4px;
    overflow: hidden;
    margin: 10px 0;
}

.quest-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #8B7355, #D4AF37, #FFD700);
    box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    transition: width 0.5s ease;
}

.quest-rewards {
    display: flex;
    gap: 10px;
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid #5C4A3A;
}

.reward-item {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 5px 10px;
    background: rgba(212, 175, 55, 0.1);
    border: 1px solid #8B7355;
    border-radius: 5px;
    font-size: 12px;
    color: #FFD700;
}

/* ========================================
   MAP OVERLAY ENHANCEMENTS
   ======================================== */

.map-wrapper {
    position: relative;
    width: 100%;
    height: 500px;
    background:
        radial-gradient(circle at center, rgba(139, 115, 85, 0.05), transparent),
        linear-gradient(180deg, #0A0908, #1A1425);
    border: 3px solid #5C4A3A;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: inset 0 0 50px rgba(0, 0, 0, 0.8);
}

.map-canvas {
    width: 100%;
    height: 100%;
    position: relative;
}

/* Fog of War Effect */
.fog-of-war {
    position: absolute;
    inset: 0;
    background: radial-gradient(
        circle at var(--player-x, 50%) var(--player-y, 50%),
        transparent 20%,
        rgba(0, 0, 0, 0.7) 40%,
        rgba(0, 0, 0, 0.9) 60%
    );
    pointer-events: none;
    mix-blend-mode: multiply;
}

.location-marker {
    position: absolute;
    width: 40px;
    height: 40px;
    transform: translate(-50%, -50%);
    cursor: pointer;
    transition: all 0.3s ease;
}

.location-icon {
    width: 100%;
    height: 100%;
    background:
        radial-gradient(circle at center, rgba(212, 175, 55, 0.3), transparent),
        linear-gradient(135deg, #5C4A3A, #8B7355);
    border: 2px solid #D4AF37;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    box-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
    animation: markerPulse 2s ease-in-out infinite;
}

@keyframes markerPulse {
    0%, 100% {
        box-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
        transform: scale(1);
    }
    50% {
        box-shadow: 0 0 30px rgba(255, 215, 0, 0.7);
        transform: scale(1.1);
    }
}

.location-marker:hover .location-icon {
    transform: scale(1.2);
    box-shadow: 0 0 40px rgba(255, 215, 0, 0.8);
    border-color: #FFD700;
}

.location-marker.visited .location-icon {
    opacity: 0.7;
    animation: none;
}

.location-marker.current .location-icon {
    border-color: #4CAF50;
    box-shadow: 0 0 30px rgba(76, 175, 80, 0.6);
}

.map-path {
    position: absolute;
    height: 2px;
    background: linear-gradient(90deg, transparent, #8B7355, transparent);
    transform-origin: left center;
    opacity: 0.5;
}

.map-path.traveled {
    background: linear-gradient(90deg, transparent, #D4AF37, transparent);
    opacity: 1;
}

/* Map Controls */
.map-controls {
    position: absolute;
    bottom: 20px;
    right: 20px;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.map-control-btn {
    width: 40px;
    height: 40px;
    background:
        linear-gradient(135deg, rgba(42, 36, 30, 0.9), rgba(26, 22, 18, 0.9));
    border: 2px solid #8B7355;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: #D4AF37;
    font-size: 20px;
    transition: all 0.3s ease;
}

.map-control-btn:hover {
    border-color: #D4AF37;
    background:
        linear-gradient(135deg, rgba(139, 115, 85, 0.3), rgba(42, 36, 30, 0.9));
    transform: scale(1.1);
    box-shadow: 0 0 15px rgba(212, 175, 55, 0.4);
}

/* Map Legend */
.map-legend {
    position: absolute;
    top: 20px;
    left: 20px;
    background:
        linear-gradient(135deg, rgba(42, 36, 30, 0.95), rgba(26, 22, 18, 0.95));
    border: 2px solid #8B7355;
    border-radius: 8px;
    padding: 10px;
    min-width: 150px;
}

.legend-title {
    font-family: 'Cinzel', serif;
    font-size: 14px;
    font-weight: 700;
    color: #FFD700;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 5px 0;
    font-size: 12px;
    color: #D4AF37;
}

/* ========================================
   SETTINGS OVERLAY ENHANCEMENTS
   ======================================== */

.settings-tabs {
    display: flex;
    gap: 5px;
    margin-bottom: 20px;
    background: linear-gradient(180deg, rgba(0, 0, 0, 0.5), transparent);
    padding: 10px;
    border-bottom: 2px solid #5C4A3A;
}

.settings-tab {
    padding: 8px 16px;
    background:
        linear-gradient(135deg, rgba(42, 36, 30, 0.8), rgba(26, 22, 18, 0.8));
    border: 2px solid #5C4A3A;
    border-radius: 6px 6px 0 0;
    cursor: pointer;
    font-family: 'Cinzel', serif;
    font-weight: 600;
    color: #8B7355;
    text-transform: uppercase;
    letter-spacing: 1px;
    transition: all 0.3s ease;
    font-size: 12px;
}

.settings-tab.active {
    background:
        linear-gradient(135deg, rgba(139, 115, 85, 0.3), rgba(212, 175, 55, 0.1));
    border-color: #D4AF37;
    color: #FFD700;
    transform: translateY(-2px);
}

.settings-group {
    margin-bottom: 25px;
    padding: 15px;
    background:
        linear-gradient(135deg, rgba(0, 0, 0, 0.4), transparent),
        rgba(42, 36, 30, 0.2);
    border: 1px solid #3E342A;
    border-radius: 8px;
}

.settings-group-header {
    font-family: 'Cinzel', serif;
    font-size: 16px;
    font-weight: 700;
    color: #FFD700;
    margin-bottom: 15px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
}

.setting-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px;
    margin: 8px 0;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid #3E342A;
    border-radius: 6px;
    transition: all 0.3s ease;
}

.setting-row:hover {
    background: rgba(139, 115, 85, 0.1);
    border-color: #5C4A3A;
}

.setting-label {
    font-size: 14px;
    color: #D4AF37;
    font-weight: 500;
}

/* Custom Slider */
.custom-slider {
    width: 150px;
    height: 6px;
    background: linear-gradient(180deg, rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.6));
    border: 1px solid #3E342A;
    border-radius: 3px;
    position: relative;
    cursor: pointer;
}

.slider-fill {
    height: 100%;
    background: linear-gradient(90deg, #8B7355, #D4AF37);
    border-radius: 2px;
    width: var(--value, 50%);
    transition: width 0.3s ease;
}

.slider-thumb {
    position: absolute;
    top: 50%;
    left: var(--value, 50%);
    transform: translate(-50%, -50%);
    width: 18px;
    height: 18px;
    background:
        radial-gradient(circle at 30% 30%, rgba(255, 215, 0, 0.4), transparent),
        linear-gradient(135deg, #D4AF37, #8B7355);
    border: 2px solid #FFD700;
    border-radius: 50%;
    box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    cursor: grab;
    transition: all 0.3s ease;
}

.slider-thumb:hover {
    transform: translate(-50%, -50%) scale(1.2);
    box-shadow: 0 0 20px rgba(255, 215, 0, 0.7);
}

/* Custom Toggle */
.custom-toggle {
    width: 50px;
    height: 26px;
    background: linear-gradient(180deg, rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.6));
    border: 2px solid #3E342A;
    border-radius: 13px;
    position: relative;
    cursor: pointer;
    transition: all 0.3s ease;
}

.custom-toggle.active {
    background: linear-gradient(180deg, rgba(139, 115, 85, 0.3), rgba(212, 175, 55, 0.2));
    border-color: #8B7355;
}

.toggle-slider {
    position: absolute;
    top: 2px;
    left: 2px;
    width: 18px;
    height: 18px;
    background:
        radial-gradient(circle at 30% 30%, rgba(255, 215, 0, 0.3), transparent),
        linear-gradient(135deg, #5C4A3A, #8B7355);
    border: 1px solid #D4AF37;
    border-radius: 50%;
    transition: all 0.3s ease;
    box-shadow: 0 0 10px rgba(212, 175, 55, 0.4);
}

.custom-toggle.active .toggle-slider {
    left: calc(100% - 22px);
    background:
        radial-gradient(circle at 30% 30%, rgba(255, 215, 0, 0.5), transparent),
        linear-gradient(135deg, #D4AF37, #FFD700);
    box-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
}

/* Dropdown Enhancement */
.custom-dropdown {
    position: relative;
    width: 150px;
}

.dropdown-selected {
    padding: 8px 12px;
    background:
        linear-gradient(135deg, rgba(42, 36, 30, 0.8), rgba(26, 22, 18, 0.8));
    border: 2px solid #5C4A3A;
    border-radius: 6px;
    cursor: pointer;
    color: #D4AF37;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.3s ease;
}

.dropdown-selected:hover {
    border-color: #8B7355;
    background:
        linear-gradient(135deg, rgba(139, 115, 85, 0.2), rgba(42, 36, 30, 0.8));
}

.dropdown-options {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background:
        linear-gradient(180deg, rgba(42, 36, 30, 0.98), rgba(26, 22, 18, 0.98));
    border: 2px solid #8B7355;
    border-radius: 6px;
    margin-top: 5px;
    overflow: hidden;
    opacity: 0;
    transform: scaleY(0);
    transform-origin: top;
    transition: all 0.3s ease;
    z-index: 100;
}

.dropdown-options.open {
    opacity: 1;
    transform: scaleY(1);
}

.dropdown-option {
    padding: 8px 12px;
    color: #D4AF37;
    cursor: pointer;
    transition: all 0.2s ease;
}

.dropdown-option:hover {
    background: rgba(212, 175, 55, 0.2);
    color: #FFD700;
    padding-left: 16px;
}

/* Button Styles */
.settings-button {
    padding: 12px 24px;
    background:
        linear-gradient(135deg, rgba(139, 115, 85, 0.3), rgba(212, 175, 55, 0.1));
    border: 2px solid #8B7355;
    border-radius: 8px;
    color: #FFD700;
    font-family: 'Cinzel', serif;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.settings-button::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.3), transparent);
    transition: left 0.5s ease;
}

.settings-button:hover::before {
    left: 100%;
}

.settings-button:hover {
    border-color: #D4AF37;
    background:
        linear-gradient(135deg, rgba(212, 175, 55, 0.3), rgba(255, 215, 0, 0.2));
    transform: translateY(-2px);
    box-shadow:
        0 5px 20px rgba(212, 175, 55, 0.4),
        0 10px 30px rgba(0, 0, 0, 0.6);
}

.settings-button:active {
    transform: translateY(0);
}

/* ========================================
   RESPONSIVE ADJUSTMENTS
   ======================================== */

@media (max-width: 768px) {
    .overlay-content, .overlay-panel {
        width: 95%;
        max-height: 90vh;
    }

    .inventory-panel {
        width: 95vw;
    }

    .equipment-slots {
        grid-template-columns: 1fr;
    }

    .skills-tree {
        grid-template-columns: 1fr;
    }

    .map-legend {
        display: none;
    }
}       ENHANCED OVERLAY STYLES FROM OPUS 4.1
       ======================================== */
    
        /* === Loading States (Phase B) === */
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap');

        /* Mystical Loading Spinner */
        .loading-container {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }

        .arcane-spinner {
            width: 120px;
            height: 120px;
            position: relative;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .spinner-ring {
            position: absolute;
            inset: 0;
            border: 3px solid transparent;
            border-top-color: #FFD700;
            border-radius: 50%;
            animation: spin 1.5s linear infinite;
        }

        .spinner-ring:nth-child(2) {
            inset: 10px;
            border-top-color: #D4AF37;
            animation-duration: 1.2s;
            animation-direction: reverse;
        }

        .spinner-ring:nth-child(3) {
            inset: 20px;
            border-top-color: #B8860B;
            animation-duration: 1s;
        }

        .spinner-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            background: radial-gradient(circle, #FFD700, #D4AF37);
            border-radius: 50%;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.8; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
        }

        .loading-text {
            margin-top: 30px;
            font-size: 20px;
            letter-spacing: 2px;
            text-transform: uppercase;
            animation: fadeInOut 2s ease-in-out infinite;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        .loading-tips {
            position: absolute;
            bottom: 60px;
            text-align: center;
            max-width: 400px;
        }

        .tip-label {
            font-size: 12px;
            color: #8B7355;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .tip-text {
            font-size: 16px;
            color: #D4AF37;
            font-style: italic;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Inline Progress Bar */
        .inline-loader {
            display: inline-flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            background: rgba(42, 36, 30, 0.9);
            border: 2px solid #8B7355;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }

        .loader-icon {
            width: 24px;
            height: 24px;
            border: 2px solid transparent;
            border-top-color: #FFD700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loader-text {
            font-size: 14px;
            color: #D4AF37;
        }

        /* Skeleton Loading for Content */
        .skeleton-container {
            background: rgba(26, 22, 18, 0.95);
            border: 3px solid #8B7355;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .skeleton {
            background: linear-gradient(90deg,
                rgba(139, 115, 85, 0.1) 0%,
                rgba(212, 175, 55, 0.2) 50%,
                rgba(139, 115, 85, 0.1) 100%);
            background-size: 200% 100%;
            animation: shimmer 1.5s ease-in-out infinite;
            border-radius: 4px;
        }

        @keyframes shimmer {
            0% { background-position: -200% center; }
            100% { background-position: 200% center; }
        }

        .skeleton-title {
            height: 24px;
            width: 60%;
            margin-bottom: 15px;
        }

        .skeleton-text {
            height: 16px;
            margin-bottom: 10px;
        }

        .skeleton-text:last-child {
            width: 80%;
        }

        /* Success Animation */
        .success-pulse {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            pointer-events: none;
            z-index: 10000;
        }

        .success-ring {
            position: absolute;
            inset: 0;
            border: 3px solid #00FF00;
            border-radius: 50%;
            opacity: 0;
            animation: successPulse 1s ease-out;
        }

        @keyframes successPulse {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }
            50% {
                opacity: 1;
            }
            100% {
                transform: scale(2);
                opacity: 0;
            }
        }

        .success-check {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 60px;
            color: #00FF00;
            animation: checkmark 0.5s ease-out 0.3s both;
        }

        @keyframes checkmark {
            0% {
                transform: translate(-50%, -50%) scale(0) rotate(-45deg);
                opacity: 0;
            }
            100% {
                transform: translate(-50%, -50%) scale(1) rotate(0deg);
                opacity: 1;
            }
        }
    
        /* === Celebration Animations (Phase B) === */
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&display=swap');

        /* Level Up Animation */
        .level-up-burst {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10000;
            pointer-events: none;
        }

        .burst-rays {
            position: absolute;
            width: 600px;
            height: 600px;
            top: -300px;
            left: -300px;
            background: conic-gradient(
                from 0deg,
                transparent 0deg,
                rgba(255, 215, 0, 0.3) 15deg,
                transparent 30deg,
                transparent 60deg,
                rgba(255, 215, 0, 0.3) 75deg,
                transparent 90deg,
                transparent 120deg,
                rgba(255, 215, 0, 0.3) 135deg,
                transparent 150deg,
                transparent 180deg,
                rgba(255, 215, 0, 0.3) 195deg,
                transparent 210deg,
                transparent 240deg,
                rgba(255, 215, 0, 0.3) 255deg,
                transparent 270deg,
                transparent 300deg,
                rgba(255, 215, 0, 0.3) 315deg,
                transparent 330deg
            );
            animation: spinRays 2s linear infinite;
        }

        @keyframes spinRays {
            0% { transform: rotate(0deg) scale(0); opacity: 0; }
            10% { transform: rotate(36deg) scale(1); opacity: 1; }
            90% { transform: rotate(360deg) scale(1); opacity: 1; }
            100% { transform: rotate(396deg) scale(1.5); opacity: 0; }
        }

        .level-up-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 4px;
            color: #FFD700;
            text-shadow:
                0 0 20px rgba(255, 215, 0, 0.8),
                0 0 40px rgba(255, 215, 0, 0.6),
                0 0 60px rgba(255, 215, 0, 0.4);
            animation: levelUpPop 1s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes levelUpPop {
            0% {
                transform: translate(-50%, -50%) scale(0) rotate(-180deg);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.2) rotate(10deg);
            }
            100% {
                transform: translate(-50%, -50%) scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        /* Quest Complete Animation */
        .quest-complete {
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10000;
            animation: slideDown 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes slideDown {
            0% { transform: translateX(-50%) translateY(-100px); opacity: 0; }
            100% { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        .quest-banner {
            background: linear-gradient(135deg, #8B7355 0%, #D4AF37 50%, #8B7355 100%);
            padding: 20px 40px;
            border-radius: 10px;
            box-shadow:
                0 10px 40px rgba(0, 0, 0, 0.8),
                inset 0 2px 4px rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
        }

        .quest-banner::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg,
                transparent 30%,
                rgba(255, 255, 255, 0.3) 50%,
                transparent 70%);
            animation: shine 1s ease-in-out;
        }

        @keyframes shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .quest-text {
            font-size: 24px;
            font-weight: 700;
            color: #2A1810;
            text-transform: uppercase;
            letter-spacing: 2px;
            position: relative;
            z-index: 1;
        }

        /* Divine Favor Pulse */
        .divine-favor-gain {
            position: fixed;
            top: 100px;
            right: 50px;
            z-index: 9999;
        }

        .favor-orb {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: radial-gradient(circle, #FFD700, #D4AF37);
            box-shadow:
                0 0 40px rgba(255, 215, 0, 0.8),
                0 0 80px rgba(255, 215, 0, 0.6);
            animation: favorPulse 1.5s ease-out;
            position: relative;
        }

        @keyframes favorPulse {
            0% {
                transform: scale(0);
                opacity: 0;
            }
            50% {
                transform: scale(1.2);
                opacity: 1;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .favor-amount {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 32px;
            font-weight: 700;
            color: #00FF00;
            text-shadow: 0 2px 10px rgba(0, 255, 0, 0.5);
            animation: floatUp 2s ease-out;
        }

        @keyframes floatUp {
            0% {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
            100% {
                transform: translateX(-50%) translateY(-60px);
                opacity: 0;
            }
        }

        /* Damage Numbers */
        .damage-number {
            position: absolute;
            font-size: 36px;
            font-weight: 900;
            pointer-events: none;
            z-index: 9999;
            animation: damageFloat 1s ease-out forwards;
        }

        .damage-number.critical {
            color: #FF0000;
            font-size: 48px;
            text-shadow:
                0 0 10px rgba(255, 0, 0, 0.8),
                0 0 20px rgba(255, 0, 0, 0.6);
        }

        .damage-number.heal {
            color: #00FF00;
            text-shadow:
                0 0 10px rgba(0, 255, 0, 0.8),
                0 0 20px rgba(0, 255, 0, 0.6);
        }

        .damage-number.normal {
            color: #FFD700;
            text-shadow:
                0 0 10px rgba(255, 215, 0, 0.8),
                0 0 20px rgba(255, 215, 0, 0.6);
        }

        @keyframes damageFloat {
            0% {
                transform: translateY(0) scale(0.5);
                opacity: 0;
            }
            20% {
                transform: translateY(-20px) scale(1.2);
                opacity: 1;
            }
            100% {
                transform: translateY(-80px) scale(0.8);
                opacity: 0;
            }
        }

        /* Streak Counter */
        .streak-counter {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, rgba(42, 36, 30, 0.95), rgba(26, 22, 18, 0.95));
            border: 3px solid #D4AF37;
            border-radius: 10px;
            padding: 15px 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.8);
            animation: bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes bounceIn {
            0% { transform: scale(0); }
            80% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .streak-fire {
            display: inline-block;
            font-size: 32px;
            animation: flameDance 1s ease-in-out infinite;
        }

        @keyframes flameDance {
            0%, 100% { transform: translateY(0) scale(1); }
            25% { transform: translateY(-3px) scale(1.1); }
            75% { transform: translateY(2px) scale(0.95); }
        }

        .streak-number {
            display: inline-block;
            margin-left: 10px;
            font-size: 28px;
            font-weight: 700;
            color: #FFD700;
            text-shadow: 0 2px 10px rgba(255, 215, 0, 0.5);
        }

        .streak-label {
            display: block;
            font-size: 12px;
            color: #8B7355;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 5px;
        }

        /* Particle Effects */
        .particle {
            position: absolute;
            pointer-events: none;
            width: 4px;
            height: 4px;
            background: #FFD700;
            border-radius: 50%;
            box-shadow: 0 0 6px rgba(255, 215, 0, 0.8);
        }

        @keyframes particleFloat {
            0% {
                transform: translateY(0) translateX(0);
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) translateX(var(--drift));
                opacity: 0;
            }
        }

        /* XP Bar Fill Animation */
        .xp-bar-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 400px;
            height: 30px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #8B7355;
            border-radius: 15px;
            overflow: hidden;
        }

        .xp-fill {
            height: 100%;
            background: linear-gradient(90deg, #9370DB, #DDA0DD, #9370DB);
            background-size: 200% 100%;
            animation: xpGlow 2s ease-in-out infinite;
            transition: width 0.5s ease-out;
        }

        @keyframes xpGlow {
            0% { background-position: 0% center; }
            100% { background-position: 200% center; }
        }

        .xp-text {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
            color: white;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
        }
    
        /* === Mobile Optimizations (Phase B) === */
        /* =============================================
   MOBILE-FIRST RESPONSIVE DESIGN
   The Arcane Codex - Touch Optimized
   ============================================= */

/* Mobile Touch Targets (minimum 44x44px) */
:root {
    --touch-target-min: 44px;
    --safe-area-inset: env(safe-area-inset-top, 0px);
    --thumb-reach: 60px; /* Bottom area easily reached by thumb */
}

/* Prevent iOS bounce and improve scrolling */
html {
    -webkit-overflow-scrolling: touch;
    overflow: hidden;
    position: fixed;
    width: 100%;
    height: 100%;
}

body {
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
    touch-action: manipulation;
    overscroll-behavior: none;
}

/* =============================================
   RESPONSIVE BREAKPOINTS
   ============================================= */

/* Extra Small Devices (phones, 375px and below) */
@media only screen and (max-width: 375px) {
    .game-container {
        padding-top: var(--safe-area-inset);
    }

    .top-hud {
        height: 60px;
        padding: 0 10px;
    }

    .game-title {
        font-size: 20px;
        letter-spacing: 1px;
    }

    .player-bars {
        display: none; /* Show in expandable drawer */
    }

    .portrait-frame {
        width: 48px;
        height: 48px;
    }
}

/* Small Devices (phones, 376px to 667px) */
@media only screen and (min-width: 376px) and (max-width: 667px) {
    /* Collapsible side panel */
    .left-sidebar {
        position: fixed;
        left: -60px;
        transition: left 0.3s ease;
        z-index: 101;
    }

    .left-sidebar.open {
        left: 0;
    }

    .menu-toggle {
        display: block;
        position: fixed;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        width: 40px;
        height: 80px;
        background: linear-gradient(90deg, rgba(212, 175, 55, 0.3), transparent);
        border-radius: 0 10px 10px 0;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
        animation: pulseHint 2s ease-in-out infinite;
    }

    @keyframes pulseHint {
        0%, 100% { opacity: 0.5; }
        50% { opacity: 1; }
    }

    /* Bottom action bar optimization */
    .bottom-hud {
        height: 80px;
        padding-bottom: env(safe-area-inset-bottom, 0px);
    }

    .action-slot {
        width: var(--touch-target-min);
        height: var(--touch-target-min);
        font-size: 20px;
    }

    /* Overlays full screen on mobile */
    .overlay-content,
    .overlay-panel {
        width: 100vw !important;
        height: 100vh !important;
        max-width: none !important;
        max-height: none !important;
        border-radius: 0 !important;
        margin: 0 !important;
    }

    .overlay-header {
        position: sticky;
        top: 0;
        z-index: 202;
        border-radius: 0 !important;
    }

    /* Right panel as bottom drawer */
    .party-panel {
        position: fixed;
        bottom: -300px;
        left: 0;
        right: 0;
        width: 100%;
        transition: bottom 0.3s ease;
        z-index: 99;
        border-radius: 20px 20px 0 0;
        box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.5);
    }

    .party-panel.expanded {
        bottom: 0;
    }

    .drawer-handle {
        position: absolute;
        top: -30px;
        left: 50%;
        transform: translateX(-50%);
        width: 60px;
        height: 30px;
        background: rgba(212, 175, 55, 0.3);
        border-radius: 30px 30px 0 0;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }

    .drawer-handle::after {
        content: '';
        width: 30px;
        height: 4px;
        background: #D4AF37;
        border-radius: 2px;
    }

    /* Touch-friendly choice buttons */
    .choice-btn {
        min-height: var(--touch-target-min);
        padding: 12px 16px;
        font-size: 16px;
        margin-bottom: 12px;
    }

    /* Swipe gestures for navigation */
    .swipe-indicator {
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 8px;
        z-index: 90;
    }

    .swipe-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: rgba(139, 115, 85, 0.5);
        transition: all 0.3s ease;
    }

    .swipe-dot.active {
        width: 24px;
        background: #D4AF37;
        border-radius: 4px;
    }
}

/* Medium Devices (tablets, 668px to 1024px) */
@media only screen and (min-width: 668px) and (max-width: 1024px) {
    .game-board {
        flex-direction: column;
    }

    .left-sidebar {
        width: 100%;
        height: auto;
        flex-direction: row;
        justify-content: center;
        padding: 5px;
    }

    .scenario-container {
        height: 60vh;
    }

    .party-panel {
        width: 100%;
        height: 40vh;
        flex-direction: row;
        overflow-x: auto;
        overflow-y: hidden;
        gap: 15px;
    }

    .panel-section {
        min-width: 300px;
        flex-shrink: 0;
    }

    /* Floating action buttons */
    .fab-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 100;
    }

    .fab-main {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: linear-gradient(135deg, #8B7355, #D4AF37);
        border: none;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        cursor: pointer;
        transition: transform 0.3s ease;
    }

    .fab-main:active {
        transform: scale(0.95);
    }

    .fab-options {
        position: absolute;
        bottom: 70px;
        right: 0;
        display: flex;
        flex-direction: column;
        gap: 10px;
        opacity: 0;
        pointer-events: none;
        transition: all 0.3s ease;
    }

    .fab-options.open {
        opacity: 1;
        pointer-events: all;
    }

    .fab-option {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: rgba(42, 36, 30, 0.95);
        border: 2px solid #8B7355;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        cursor: pointer;
        transform: scale(0);
        transition: transform 0.3s ease;
    }

    .fab-options.open .fab-option {
        transform: scale(1);
    }

    .fab-options.open .fab-option:nth-child(1) { transition-delay: 0.05s; }
    .fab-options.open .fab-option:nth-child(2) { transition-delay: 0.1s; }
    .fab-options.open .fab-option:nth-child(3) { transition-delay: 0.15s; }
    .fab-options.open .fab-option:nth-child(4) { transition-delay: 0.2s; }
    .fab-options.open .fab-option:nth-child(5) { transition-delay: 0.25s; }
}

/* =============================================
   TOUCH GESTURES & INTERACTIONS
   ============================================= */

/* Long press effect */
.long-press {
    position: relative;
}

.long-press::after {
    content: '';
    position: absolute;
    inset: -5px;
    border: 2px solid #FFD700;
    border-radius: inherit;
    opacity: 0;
    animation: longPressRing 1s ease-out;
    pointer-events: none;
}

@keyframes longPressRing {
    0% {
        transform: scale(0.8);
        opacity: 0;
    }
    50% {
        opacity: 1;
    }
    100% {
        transform: scale(1.2);
        opacity: 0;
    }
}

/* Pull to refresh indicator */
.pull-refresh {
    position: fixed;
    top: -60px;
    left: 50%;
    transform: translateX(-50%);
    width: 40px;
    height: 40px;
    background: rgba(212, 175, 55, 0.1);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: top 0.3s ease;
    z-index: 10000;
}

.pull-refresh.visible {
    top: 20px;
}

.pull-refresh.loading {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: translateX(-50%) rotate(0deg); }
    100% { transform: translateX(-50%) rotate(360deg); }
}

/* Haptic feedback visual */
.haptic-pulse {
    position: absolute;
    width: 100px;
    height: 100px;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(255, 215, 0, 0.5), transparent);
    pointer-events: none;
    transform: translate(-50%, -50%);
    animation: hapticPulse 0.4s ease-out;
}

@keyframes hapticPulse {
    0% {
        transform: translate(-50%, -50%) scale(0);
        opacity: 1;
    }
    100% {
        transform: translate(-50%, -50%) scale(2);
        opacity: 0;
    }
}

/* =============================================
   LANDSCAPE MODE OPTIMIZATIONS
   ============================================= */

@media only screen and (orientation: landscape) and (max-height: 500px) {
    .top-hud {
        height: 50px;
    }

    .bottom-hud {
        height: 60px;
    }

    .game-title {
        display: none;
    }

    .left-panel,
    .party-panel {
        position: fixed;
        transform: scale(0.8);
        transform-origin: top left;
    }

    .scenario-container {
        margin: 0 auto;
        max-width: 70%;
    }

    /* Compact overlay mode */
    .overlay-content {
        max-height: 90vh !important;
        overflow-y: auto;
    }

    .overlay-header {
        padding: 10px 15px;
    }

    .overlay-header h2 {
        font-size: 20px;
    }
}

/* =============================================
   TOUCH-SPECIFIC ENHANCEMENTS
   ============================================= */

/* iOS Safe Areas */
@supports (padding: max(0px)) {
    .game-container {
        padding-left: max(0px, env(safe-area-inset-left));
        padding-right: max(0px, env(safe-area-inset-right));
        padding-top: max(0px, env(safe-area-inset-top));
    }

    .bottom-hud {
        padding-bottom: max(15px, env(safe-area-inset-bottom));
    }
}

/* Disable text selection on interactive elements */
.side-btn,
.action-slot,
.choice-btn,
.party-member,
.character-card {
    -webkit-user-select: none;
    user-select: none;
    -webkit-user-drag: none;
}

/* Improve scrolling performance */
.scene-narrative-panel,
.objectives-list,
.overlay-body {
    -webkit-overflow-scrolling: touch;
    scroll-behavior: smooth;
    will-change: scroll-position;
}

/* Virtual keyboard adjustments */
@media (max-height: 500px) {
    .overlay-content {
        position: fixed;
        top: 0 !important;
        transform: none !important;
    }
}

/* Thumb-friendly bottom navigation */
.mobile-nav {
    display: none;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 56px;
    background: linear-gradient(180deg, rgba(26, 22, 18, 0.95), rgba(42, 36, 30, 0.98));
    border-top: 2px solid #8B7355;
    padding-bottom: env(safe-area-inset-bottom, 0px);
    z-index: 100;
}

@media (max-width: 667px) {
    .mobile-nav {
        display: flex;
        justify-content: space-around;
        align-items: center;
    }

    .bottom-hud {
        display: none;
    }
}

.mobile-nav-item {
    flex: 1;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: none;
    color: #8B7355;
    transition: all 0.3s ease;
    position: relative;
}

.mobile-nav-item.active {
    color: #FFD700;
}

.mobile-nav-item.active::before {
    content: '';
    position: absolute;
    top: 0;
    left: 20%;
    right: 20%;
    height: 3px;
    background: #FFD700;
    border-radius: 0 0 3px 3px;
}

.mobile-nav-icon {
    font-size: 20px;
    margin-bottom: 4px;
}

.mobile-nav-label {
    font-size: 10px;
    font-family: 'Cinzel', serif;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
    
        /* === Design System Improvements (Phase B) === */
        /**
 * The Arcane Codex Design System
 * 07. Recommended Improvements
 * =============================
 * Critical enhancements for AAA dark fantasy experience
 */

/* ==========================================
   ENHANCED COLOR TOKENS
   ========================================== */

:root {
  /* Blood & Combat Palette */
  --color-blood-50: #fef2f2;
  --color-blood-100: #fee2e2;
  --color-blood-200: #fecaca;
  --color-blood-300: #fca5a5;
  --color-blood-400: #f87171;
  --color-blood-500: #ef4444;
  --color-blood-600: #dc2626;
  --color-blood-700: #b91c1c;
  --color-blood-800: #991b1b;
  --color-blood-900: #7f1d1d;
  --color-blood-950: #450a0a;

  /* Void & Shadow Magic Palette */
  --color-void-50: #f5f3ff;
  --color-void-100: #ede9fe;
  --color-void-200: #ddd6fe;
  --color-void-300: #c4b5fd;
  --color-void-400: #a78bfa;
  --color-void-500: #8b5cf6;
  --color-void-600: #7c3aed;
  --color-void-700: #6d28d9;
  --color-void-800: #5b21b6;
  --color-void-900: #4c1d95;
  --color-void-950: #1e0033;

  /* Corruption & Decay Palette */
  --color-corruption-50: #f7fee7;
  --color-corruption-100: #ecfccb;
  --color-corruption-200: #d9f99d;
  --color-corruption-300: #bef264;
  --color-corruption-400: #a3e635;
  --color-corruption-500: #84cc16;
  --color-corruption-600: #65a30d;
  --color-corruption-700: #4d7c0f;
  --color-corruption-800: #3f6212;
  --color-corruption-900: #365314;
  --color-corruption-950: #1a2e05;

  /* Frost & Ice Magic Palette */
  --color-frost-50: #f0f9ff;
  --color-frost-100: #e0f2fe;
  --color-frost-200: #bae6fd;
  --color-frost-300: #7dd3fc;
  --color-frost-400: #38bdf8;
  --color-frost-500: #0ea5e9;
  --color-frost-600: #0284c7;
  --color-frost-700: #0369a1;
  --color-frost-800: #075985;
  --color-frost-900: #0c4a6e;
  --color-frost-950: #082f49;

  /* Ember & Fire Magic Palette */
  --color-ember-50: #fff7ed;
  --color-ember-100: #ffedd5;
  --color-ember-200: #fed7aa;
  --color-ember-300: #fdba74;
  --color-ember-400: #fb923c;
  --color-ember-500: #f97316;
  --color-ember-600: #ea580c;
  --color-ember-700: #c2410c;
  --color-ember-800: #9a3412;
  --color-ember-900: #7c2d12;
  --color-ember-950: #431407;

  /* Enhanced Shadow Effects */
  --shadow-mystical: 0 0 30px rgba(139, 31, 255, 0.4),
                     0 0 60px rgba(139, 31, 255, 0.2),
                     inset 0 0 30px rgba(139, 31, 255, 0.1);

  --shadow-divine-aura: 0 0 40px rgba(245, 158, 11, 0.6),
                        0 0 80px rgba(245, 158, 11, 0.3),
                        0 0 120px rgba(245, 158, 11, 0.1);

  --shadow-corruption: 0 10px 40px rgba(132, 204, 22, 0.3),
                       0 0 80px rgba(132, 204, 22, 0.2),
                       inset 0 0 20px rgba(0, 0, 0, 0.8);

  /* Text Shadow Effects */
  --text-shadow-glow: 0 0 10px currentColor,
                      0 0 20px currentColor,
                      0 0 30px currentColor;

  --text-shadow-divine: 0 2px 4px rgba(0, 0, 0, 0.8),
                        0 0 20px rgba(245, 158, 11, 0.8),
                        0 0 40px rgba(245, 158, 11, 0.4);

  --text-shadow-mystical: 0 2px 4px rgba(0, 0, 0, 0.8),
                          0 0 15px rgba(139, 31, 255, 0.8),
                          0 0 30px rgba(139, 31, 255, 0.4);

  /* Performance Budgets */
  --animation-budget-micro: 16ms;     /* 60fps target */
  --animation-budget-small: 100ms;    /* Quick transitions */
  --animation-budget-medium: 250ms;   /* Standard animations */
  --animation-budget-large: 500ms;    /* Complex sequences */
  --animation-budget-epic: 1000ms;    /* Celebration effects */
}

/* ==========================================
   COMBAT ANIMATION SEQUENCES
   ========================================== */

@keyframes slashAttack {
  0% {
    clip-path: polygon(0 0, 0 0, 0 100%, 0 100%);
    opacity: 0;
  }
  20% {
    clip-path: polygon(0 0, 30% 0, 20% 100%, 0 100%);
    opacity: 1;
  }
  40% {
    clip-path: polygon(0 0, 70% 0, 60% 100%, 0 100%);
  }
  60% {
    clip-path: polygon(20% 0, 100% 0, 100% 100%, 80% 100%);
  }
  80% {
    clip-path: polygon(70% 0, 100% 0, 100% 100%, 100% 100%);
    opacity: 1;
  }
  100% {
    clip-path: polygon(100% 0, 100% 0, 100% 100%, 100% 100%);
    opacity: 0;
  }
}

@keyframes magicCast {
  0% {
    transform: scale(0) rotate(0deg);
    opacity: 0;
    filter: brightness(2) hue-rotate(0deg);
  }
  25% {
    transform: scale(1.2) rotate(90deg);
    opacity: 0.8;
  }
  50% {
    transform: scale(1) rotate(180deg);
    opacity: 1;
    filter: brightness(1.5) hue-rotate(180deg);
  }
  75% {
    transform: scale(1.1) rotate(270deg);
    opacity: 0.9;
  }
  100% {
    transform: scale(2) rotate(360deg);
    opacity: 0;
    filter: brightness(3) hue-rotate(360deg);
  }
}

@keyframes shieldBlock {
  0%, 100% {
    transform: scale(1) translateX(0);
    opacity: 0.3;
  }
  30% {
    transform: scale(1.3) translateX(-10px);
    opacity: 1;
  }
  50% {
    transform: scale(1.5) translateX(0);
    opacity: 0.8;
  }
  70% {
    transform: scale(1.2) translateX(5px);
    opacity: 0.6;
  }
}

@keyframes criticalHit {
  0% {
    transform: scale(1);
    filter: brightness(1);
  }
  10% {
    transform: scale(1.5);
    filter: brightness(2) contrast(2);
  }
  20% {
    transform: scale(1.2) rotate(5deg);
    filter: brightness(1.5) contrast(1.5) hue-rotate(10deg);
  }
  30% {
    transform: scale(1.3) rotate(-5deg);
  }
  40% {
    transform: scale(1.1) rotate(3deg);
  }
  50% {
    transform: scale(1.2) rotate(-3deg);
  }
  100% {
    transform: scale(1) rotate(0);
    filter: brightness(1) contrast(1);
  }
}

/* ==========================================
   ENHANCED GAME COMPONENTS
   ========================================== */

/* Health Bar Component */
.health-bar {
  position: relative;
  width: 100%;
  height: 24px;
  background: linear-gradient(180deg,
    rgba(0, 0, 0, 0.9) 0%,
    rgba(69, 10, 10, 0.8) 100%);
  border: 2px solid var(--color-blood-700);
  border-radius: 12px;
  overflow: hidden;
  box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.8),
              0 0 20px rgba(185, 28, 28, 0.3);
}

.health-bar-fill {
  height: 100%;
  background: linear-gradient(90deg,
    var(--color-blood-600) 0%,
    var(--color-blood-500) 50%,
    var(--color-blood-400) 100%);
  position: relative;
  transition: width var(--duration-slow) var(--ease-out);
  box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.2);
}

.health-bar-fill::after {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 50%;
  background: linear-gradient(180deg,
    rgba(255, 255, 255, 0.3) 0%,
    transparent 100%);
  border-radius: 10px 10px 0 0;
}

.health-bar-damage {
  position: absolute;
  top: 0;
  right: 0;
  height: 100%;
  background: rgba(255, 0, 0, 0.6);
  animation: healthDamage 0.5s ease-out forwards;
}

@keyframes healthDamage {
  0% {
    opacity: 1;
    transform: scaleY(1);
  }
  100% {
    opacity: 0;
    transform: scaleY(0.8);
  }
}

/* Mana Bar Component */
.mana-bar {
  position: relative;
  width: 100%;
  height: 20px;
  background: linear-gradient(180deg,
    rgba(0, 0, 0, 0.9) 0%,
    rgba(8, 47, 73, 0.8) 100%);
  border: 2px solid var(--color-frost-700);
  border-radius: 10px;
  overflow: hidden;
  box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.8),
              0 0 15px rgba(14, 165, 233, 0.3);
}

.mana-bar-fill {
  height: 100%;
  background: linear-gradient(90deg,
    var(--color-frost-600) 0%,
    var(--color-frost-500) 50%,
    var(--color-frost-400) 100%);
  position: relative;
  transition: width var(--duration-slow) var(--ease-out);
  box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.3);
}

.mana-bar-fill::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(90deg,
    transparent 0%,
    rgba(255, 255, 255, 0.3) 50%,
    transparent 100%);
  animation: manaFlow 3s linear infinite;
}

@keyframes manaFlow {
  0% {
    transform: translateX(-100%);
  }
  100% {
    transform: translateX(100%);
  }
}

/* Character Portrait Frame */
.character-portrait {
  position: relative;
  width: 96px;
  height: 96px;
  border-radius: 50%;
  padding: 4px;
  background: linear-gradient(135deg,
    var(--color-divine-600) 0%,
    var(--color-bronze-dark) 50%,
    var(--color-divine-600) 100%);
  box-shadow: 0 0 30px rgba(212, 175, 55, 0.5),
              inset 0 0 20px rgba(0, 0, 0, 0.5);
}

.character-portrait-inner {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  background: var(--color-shadow-950);
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  position: relative;
}

.character-portrait-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.character-portrait-level {
  position: absolute;
  bottom: -4px;
  right: -4px;
  width: 32px;
  height: 32px;
  background: radial-gradient(circle,
    var(--color-divine-500) 0%,
    var(--color-divine-700) 100%);
  border: 3px solid var(--color-shadow-950);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: var(--font-display);
  font-weight: var(--font-weight-bold);
  font-size: var(--font-size-sm);
  color: var(--color-shadow-950);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.6);
}

/* Spell/Ability Icon */
.ability-icon {
  position: relative;
  width: 64px;
  height: 64px;
  background: linear-gradient(135deg,
    var(--color-shadow-900) 0%,
    var(--color-shadow-800) 100%);
  border: 2px solid var(--color-shadow-700);
  border-radius: var(--radius-lg);
  cursor: pointer;
  transition: all var(--duration-base) var(--ease-out);
  overflow: hidden;
}

.ability-icon::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg,
    transparent 0%,
    rgba(139, 31, 255, 0.3) 100%);
  opacity: 0;
  transition: opacity var(--duration-base) var(--ease-out);
}

.ability-icon:hover {
  transform: translateY(-2px);
  border-color: var(--color-arcane-500);
  box-shadow: 0 5px 20px rgba(139, 31, 255, 0.4);
}

.ability-icon:hover::before {
  opacity: 1;
}

.ability-icon-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.ability-icon-cooldown {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: var(--font-display);
  font-size: var(--font-size-2xl);
  font-weight: var(--font-weight-bold);
  color: var(--color-shadow-400);
}

/* Enhanced Glass Morphism Card */
.card-glass {
  background: rgba(26, 22, 18, 0.4);
  backdrop-filter: blur(10px) saturate(180%);
  -webkit-backdrop-filter: blur(10px) saturate(180%);
  border: 1px solid rgba(212, 175, 55, 0.3);
  border-radius: var(--radius-xl);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4),
              inset 0 0 0 1px rgba(255, 255, 255, 0.1);
  position: relative;
  overflow: hidden;
}

.card-glass::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 1px;
  background: linear-gradient(90deg,
    transparent 0%,
    rgba(212, 175, 55, 0.5) 50%,
    transparent 100%);
}

/* ==========================================
   OPTIMIZED LOADING STATES
   ========================================== */

.skeleton-enhanced {
  position: relative;
  overflow: hidden;
  background: linear-gradient(90deg,
    var(--color-shadow-900) 0%,
    var(--color-shadow-800) 25%,
    var(--color-shadow-800) 50%,
    var(--color-shadow-800) 75%,
    var(--color-shadow-900) 100%);
  background-size: 400% 100%;
  animation: skeletonWave 2s linear infinite;
}

@keyframes skeletonWave {
  0% {
    background-position: 100% 0;
  }
  100% {
    background-position: -100% 0;
  }
}

/* ==========================================
   PERFORMANCE OPTIMIZATIONS
   ========================================== */

/* GPU-accelerated layers for complex animations */
.gpu-accelerated {
  transform: translateZ(0);
  will-change: transform;
  backface-visibility: hidden;
  perspective: 1000px;
}

/* Containment for layout optimization */
.contain-layout {
  contain: layout;
}

.contain-paint {
  contain: paint;
}

.contain-strict {
  contain: strict;
}

/* Reduce paint areas */
.isolate {
  isolation: isolate;
}

/* ==========================================
   RESPONSIVE ENHANCEMENTS
   ========================================== */

/* Touch-friendly hit targets */
@media (pointer: coarse) {
  .btn,
  .ability-icon,
  .side-btn {
    min-width: 44px;
    min-height: 44px;
  }
}

/* Landscape optimizations */
@media (orientation: landscape) and (max-height: 600px) {
  .top-hud {
    height: 60px;
  }

  .game-board {
    padding: 10px;
  }
}

/* Desktop and Large Screens (1025px and above) */
@media only screen and (min-width: 1025px) {
    .game-board {
        display: flex !important;
        flex-direction: row !important;
    }

    .left-sidebar {
        display: flex !important;
        flex-direction: column !important;
        visibility: visible !important;
        opacity: 1 !important;
        width: 80px !important;
        position: relative !important;
        left: auto !important;
    }

    .party-panel {
        display: flex !important;
        flex-direction: column !important;
        visibility: visible !important;
        opacity: 1 !important;
        width: 350px !important;
        position: relative !important;
        bottom: auto !important;
        height: auto !important;
    }

    .scenario-container {
        flex: 1 !important;
        height: auto !important;
    }
}

/* High DPI displays */
@media (-webkit-min-device-pixel-ratio: 2),
       (min-resolution: 192dpi) {
  .character-portrait,
  .ability-icon {
    image-rendering: crisp-edges;
    image-rendering: -webkit-optimize-contrast;
  }
}

/* ==========================================
   ACCESSIBILITY ENHANCEMENTS
   ========================================== */

/* Focus indicators for keyboard navigation */
.focus-visible:focus-visible {
  outline: 3px solid var(--color-arcane-400);
  outline-offset: 3px;
  box-shadow: 0 0 0 6px rgba(139, 31, 255, 0.2);
}

/* High contrast mode support */
@media (prefers-contrast: high) {
  :root {
    --color-text-primary: #ffffff;
    --color-text-secondary: #e5e5e5;
    --color-background: #000000;
    --color-surface: #1a1a1a;
  }

  .btn,
  .card {
    border-width: 2px;
  }
}

/* Reduced transparency for better readability */
@media (prefers-reduced-transparency) {
  .card-glass {
    background: rgba(26, 22, 18, 0.95);
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
  }
}
    
        /* === Onboarding System (Phase B) === */
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&family=Yrsa:wght@300;400;500;600&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Onboarding Overlay */
        .onboarding-overlay {
            position: fixed;
            inset: 0;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(5px);
        }

        /* Welcome Screen */
        .welcome-screen {
            display: none; /* Hide by default for testing */
            width: 90%;
            max-width: 600px;
            background: linear-gradient(135deg, rgba(42, 36, 30, 0.98) 0%, rgba(26, 22, 18, 0.98) 100%);
            border: 3px solid #D4AF37;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            animation: fadeInScale 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes fadeInScale {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .welcome-title {
            font-family: 'Cinzel', serif;
            font-size: 48px;
            font-weight: 900;
            background: linear-gradient(180deg, #FFD700, #B8860B, #FFD700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
            animation: glow 2s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% { filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.5)); }
            50% { filter: drop-shadow(0 0 30px rgba(255, 215, 0, 0.8)); }
        }

        .welcome-subtitle {
            font-size: 20px;
            color: #8B7355;
            margin-bottom: 30px;
            font-style: italic;
        }

        .character-selection {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 30px 0;
        }

        .character-card {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #8B7355;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .character-card:hover {
            border-color: #D4AF37;
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(212, 175, 55, 0.3);
        }

        .character-card.selected {
            border-color: #FFD700;
            background: rgba(212, 175, 55, 0.2);
        }

        .character-card.selected::before {
            content: '';
            position: absolute;
            top: 5px;
            right: 10px;
            color: #FFD700;
            font-size: 24px;
            font-weight: bold;
        }

        .character-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .character-name {
            font-family: 'Cinzel', serif;
            font-size: 16px;
            font-weight: 600;
            color: #FFD700;
            margin-bottom: 5px;
        }

        .character-class {
            font-size: 14px;
            color: #8B7355;
        }

        /* Tutorial Spotlight */
        .tutorial-spotlight {
            position: fixed;
            inset: 0;
            z-index: 9998;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .tutorial-spotlight.active {
            opacity: 1;
            pointer-events: all;
        }

        .spotlight-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
        }

        .spotlight-hole {
            position: absolute;
            border-radius: 10px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.8);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.8), 0 0 40px rgba(255, 215, 0, 0.5); }
            50% { box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.8), 0 0 60px rgba(255, 215, 0, 0.8); }
        }

        .tutorial-tooltip {
            position: absolute;
            background: linear-gradient(135deg, rgba(42, 36, 30, 0.98) 0%, rgba(26, 22, 18, 0.98) 100%);
            border: 2px solid #D4AF37;
            border-radius: 10px;
            padding: 20px;
            max-width: 350px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
            animation: fadeIn 0.3s ease;
        }

        .tutorial-tooltip::before {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: inherit;
            border: inherit;
            border-right: none;
            border-top: none;
            transform: rotate(45deg);
        }

        .tutorial-tooltip.top::before {
            bottom: -12px;
            left: 50%;
            transform: translateX(-50%) rotate(45deg);
        }

        .tutorial-tooltip.bottom::before {
            top: -12px;
            left: 50%;
            transform: translateX(-50%) rotate(225deg);
        }

        .tutorial-tooltip.left::before {
            right: -12px;
            top: 50%;
            transform: translateY(-50%) rotate(315deg);
        }

        .tutorial-tooltip.right::before {
            left: -12px;
            top: 50%;
            transform: translateY(-50%) rotate(135deg);
        }

        .tutorial-title {
            font-family: 'Cinzel', serif;
            font-size: 20px;
            font-weight: 700;
            color: #FFD700;
            margin-bottom: 10px;
        }

        .tutorial-text {
            font-size: 16px;
            line-height: 1.5;
            color: #D4AF37;
            margin-bottom: 15px;
        }

        .tutorial-progress {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 20px;
        }

        .progress-dots {
            display: flex;
            gap: 8px;
        }

        .progress-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #8B7355;
            transition: all 0.3s ease;
        }

        .progress-dot.active {
            background: #FFD700;
            transform: scale(1.3);
        }

        .tutorial-buttons {
            display: flex;
            gap: 10px;
        }

        .tutorial-btn {
            background: linear-gradient(135deg, #8B7355 0%, #D4AF37 100%);
            border: none;
            border-radius: 5px;
            padding: 8px 20px;
            font-family: 'Cinzel', serif;
            font-size: 14px;
            font-weight: 600;
            color: #2A1810;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tutorial-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(212, 175, 55, 0.4);
        }

        .tutorial-btn.skip {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #8B7355;
            color: #8B7355;
        }

        /* Interactive Hints */
        .hint-beacon {
            position: absolute;
            width: 20px;
            height: 20px;
            background: #FFD700;
            border-radius: 50%;
            animation: beaconPulse 2s ease-in-out infinite;
            cursor: help;
        }

        @keyframes beaconPulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 0 0 20px rgba(255, 215, 0, 0);
            }
        }

        .hint-popup {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #D4AF37;
            border-radius: 5px;
            padding: 10px 15px;
            font-size: 14px;
            color: #D4AF37;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 10001;
        }

        .hint-beacon:hover + .hint-popup {
            opacity: 1;
        }

        /* First Time User Experience */
        .ftue-checklist {
            position: fixed;
            top: 20px;
            left: 20px;
            background: linear-gradient(135deg, rgba(42, 36, 30, 0.95) 0%, rgba(26, 22, 18, 0.95) 100%);
            border: 2px solid #D4AF37;
            border-radius: 10px;
            padding: 20px;
            max-width: 300px;
            z-index: 1000;
            animation: slideInLeft 0.5s ease;
        }

        @keyframes slideInLeft {
            0% { transform: translateX(-100%); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }

        .ftue-title {
            font-family: 'Cinzel', serif;
            font-size: 18px;
            font-weight: 700;
            color: #FFD700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ftue-progress {
            width: 100%;
            height: 6px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .ftue-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #D4AF37, #FFD700);
            transition: width 0.5s ease;
        }

        .ftue-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(139, 115, 85, 0.3);
            transition: all 0.3s ease;
        }

        .ftue-item:last-child {
            border-bottom: none;
        }

        .ftue-item.completed {
            opacity: 0.5;
        }

        .ftue-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #8B7355;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .ftue-item.completed .ftue-checkbox {
            background: #FFD700;
            border-color: #FFD700;
        }

        .ftue-item.completed .ftue-checkbox::after {
            content: '';
            color: #2A1810;
            font-weight: bold;
        }

        .ftue-text {
            flex: 1;
            font-size: 14px;
            color: #D4AF37;
        }

        .ftue-item.completed .ftue-text {
            text-decoration: line-through;
            color: #8B7355;
        }

        /* Animated Arrow Pointer */
        .pointer-arrow {
            position: absolute;
            width: 40px;
            height: 40px;
            animation: point 1s ease-in-out infinite;
            z-index: 10002;
            pointer-events: none;
        }

        @keyframes point {
            0%, 100% { transform: translate(0, 0) rotate(45deg); }
            50% { transform: translate(-10px, 10px) rotate(45deg); }
        }

        .pointer-arrow svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.8));
        }

        /* Start Button */
        .start-adventure-btn {
            background: linear-gradient(135deg, #8B7355 0%, #FFD700 50%, #8B7355 100%);
            background-size: 200% 100%;
            border: none;
            border-radius: 8px;
            padding: 15px 40px;
            font-family: 'Cinzel', serif;
            font-size: 20px;
            font-weight: 700;
            color: #2A1810;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0% { background-position: 0% center; }
            50% { background-position: 100% center; }
            100% { background-position: 0% center; }
        }

        .start-adventure-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.5);
        }

        .start-adventure-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            animation: none;
        }
    
        /* === Retention System (Phase B) === */
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&family=Yrsa:wght@300;400;500;600&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Daily Login Rewards */
        .daily-rewards-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
        }

        .daily-rewards-content {
            background: linear-gradient(135deg, rgba(42, 36, 30, 0.98) 0%, rgba(26, 22, 18, 0.98) 100%);
            border: 3px solid #D4AF37;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            animation: bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes bounceIn {
            0% { transform: scale(0); opacity: 0; }
            60% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        .daily-rewards-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .daily-rewards-title {
            font-family: 'Cinzel', serif;
            font-size: 32px;
            font-weight: 900;
            background: linear-gradient(180deg, #FFD700, #B8860B);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .streak-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 20px;
            color: #FFD700;
        }

        .streak-flame {
            font-size: 28px;
            animation: flame 1s ease-in-out infinite;
        }

        @keyframes flame {
            0%, 100% { transform: scale(1) translateY(0); }
            50% { transform: scale(1.1) translateY(-2px); }
        }

        .daily-calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .day-slot {
            aspect-ratio: 1;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #8B7355;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .day-slot.claimed {
            background: rgba(0, 255, 0, 0.1);
            border-color: #00FF00;
        }

        .day-slot.today {
            border-color: #FFD700;
            animation: todayPulse 2s ease-in-out infinite;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        @keyframes todayPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .day-slot.future {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .day-label {
            font-family: 'Cinzel', serif;
            font-size: 10px;
            color: #8B7355;
            margin-bottom: 5px;
        }

        .day-reward {
            font-size: 24px;
        }

        .day-amount {
            font-size: 12px;
            color: #D4AF37;
            margin-top: 5px;
        }

        .claim-button {
            background: linear-gradient(135deg, #8B7355, #FFD700, #8B7355);
            background-size: 200% 100%;
            border: none;
            border-radius: 8px;
            padding: 12px 30px;
            font-family: 'Cinzel', serif;
            font-size: 18px;
            font-weight: 700;
            color: #2A1810;
            cursor: pointer;
            animation: shimmer 2s ease-in-out infinite;
            transition: transform 0.3s ease;
        }

        @keyframes shimmer {
            0% { background-position: 0% center; }
            100% { background-position: 200% center; }
        }

        .claim-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.5);
        }

        .claim-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            animation: none;
        }

        /* Battle Pass System */
        .battle-pass-container {
            background: linear-gradient(135deg, rgba(42, 36, 30, 0.95) 0%, rgba(26, 22, 18, 0.95) 100%);
            border: 3px solid #8B7355;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
        }

        .battle-pass-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .season-title {
            font-family: 'Cinzel', serif;
            font-size: 24px;
            font-weight: 700;
            color: #FFD700;
        }

        .season-timer {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 15px;
            border-radius: 5px;
        }

        .timer-icon {
            color: #FFD700;
        }

        .timer-text {
            font-size: 14px;
            color: #D4AF37;
        }

        .tier-progress {
            margin-bottom: 25px;
        }

        .tier-bar {
            height: 30px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #3E342A;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .tier-fill {
            height: 100%;
            background: linear-gradient(90deg, #9370DB, #DDA0DD, #FFD700);
            width: 35%;
            transition: width 0.5s ease;
            position: relative;
            overflow: hidden;
        }

        .tier-fill::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shine 2s ease-in-out infinite;
        }

        @keyframes shine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .tier-info {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Cinzel', serif;
            font-size: 14px;
            font-weight: 700;
            color: white;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
        }

        .reward-track {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding: 10px 0;
        }

        .reward-tier {
            min-width: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .tier-node {
            width: 60px;
            height: 60px;
            background: rgba(0, 0, 0, 0.5);
            border: 3px solid #8B7355;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            position: relative;
            transition: all 0.3s ease;
        }

        .tier-node.unlocked {
            background: rgba(255, 215, 0, 0.2);
            border-color: #FFD700;
            animation: unlockPop 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes unlockPop {
            0% { transform: scale(0); }
            60% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .tier-node.premium {
            border-color: #9370DB;
            background: rgba(147, 112, 219, 0.2);
        }

        .tier-number {
            position: absolute;
            bottom: -20px;
            font-family: 'Cinzel', serif;
            font-size: 12px;
            color: #8B7355;
        }

        /* Achievement System */
        .achievement-popup {
            position: fixed;
            top: 20px;
            right: -400px;
            width: 350px;
            background: linear-gradient(135deg, rgba(42, 36, 30, 0.98) 0%, rgba(26, 22, 18, 0.98) 100%);
            border: 3px solid #FFD700;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
            transition: right 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 10001;
        }

        .achievement-popup.show {
            right: 20px;
        }

        .achievement-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .achievement-icon {
            width: 50px;
            height: 50px;
            background: radial-gradient(circle, #FFD700, #B8860B);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .achievement-label {
            font-family: 'Cinzel', serif;
            font-size: 12px;
            color: #8B7355;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .achievement-title {
            font-family: 'Cinzel', serif;
            font-size: 18px;
            font-weight: 700;
            color: #FFD700;
        }

        .achievement-desc {
            font-size: 14px;
            color: #D4AF37;
            margin-top: 10px;
        }

        .achievement-reward {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #8B7355;
        }

        /* Leaderboard Widget */
        .leaderboard-widget {
            position: fixed;
            left: 20px;
            top: 100px;
            width: 250px;
            background: linear-gradient(135deg, rgba(42, 36, 30, 0.95) 0%, rgba(26, 22, 18, 0.95) 100%);
            border: 2px solid #D4AF37;
            border-radius: 10px;
            padding: 15px;
            z-index: 100;
        }

        .leaderboard-title {
            font-family: 'Cinzel', serif;
            font-size: 16px;
            font-weight: 700;
            color: #FFD700;
            text-align: center;
            margin-bottom: 15px;
        }

        .leaderboard-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .leaderboard-item.self {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid #FFD700;
        }

        .leaderboard-rank {
            font-family: 'Cinzel', serif;
            font-weight: 700;
            width: 25px;
            text-align: center;
        }

        .rank-1 { color: #FFD700; }
        .rank-2 { color: #C0C0C0; }
        .rank-3 { color: #CD7F32; }

        .leaderboard-name {
            flex: 1;
            font-size: 14px;
        }

        .leaderboard-score {
            font-family: 'Cinzel', serif;
            font-size: 12px;
            color: #D4AF37;
        }

        /* Event Banner */
        .event-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(90deg, #8B0000, #DC143C, #8B0000);
            background-size: 200% 100%;
            animation: eventPulse 3s ease-in-out infinite;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            box-shadow: 0 5px 20px rgba(220, 20, 60, 0.5);
        }

        @keyframes eventPulse {
            0%, 100% { background-position: 0% center; }
            50% { background-position: 100% center; }
        }

        .event-content {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .event-icon {
            font-size: 32px;
            animation: bounce 1s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .event-text {
            font-family: 'Cinzel', serif;
            font-size: 18px;
            font-weight: 700;
            color: #FFD700;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .event-timer {
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            color: #FFD700;
        }
    </style>
    <script src="quest_map_implementation.js" defer></script>
}</head>
<body>
    <div class="game-container">
        <!-- Game Area -->
        <div class="game-area">
            <!-- Left Side Panel -->
            <div class="left-panel">
                <div class="side-btn">
                    
                    <div class="tooltip">Character (C)</div>
                </div>
                <div class="side-btn">
                    
                    <div class="tooltip">Inventory (I)</div>
                </div>
                <div class="side-btn">
                    
                    <div class="tooltip">Skills (K)</div>
                </div>
                <div class="side-btn">
                    
                    <div class="tooltip">Quests (J)</div>
                </div>
                <div class="side-btn">
                    
                    <div class="tooltip">Map (M)</div>
                </div>
                <div class="side-btn">
                    
                    <div class="tooltip">Settings (ESC)</div>
                </div>
            </div>

            <!-- Game Board -->
            <div class="game-board">
                <!-- Left Sidebar -->
                <div class="left-sidebar">
                    <div class="sidebar-btn" data-action="inventory">
                        <span class="sidebar-icon"></span>
                        <span class="sidebar-label">Inventory</span>
                    </div>
                    <div class="sidebar-btn" data-action="map">
                        <span class="sidebar-icon"></span>
                        <span class="sidebar-label">Map</span>
                    </div>
                    <div class="sidebar-btn" data-action="journal">
                        <span class="sidebar-icon"></span>
                        <span class="sidebar-label">Journal</span>
                    </div>
                    <div class="sidebar-btn" data-action="settings">
                        <span class="sidebar-icon"></span>
                        <span class="sidebar-label">Settings</span>
                    </div>
                </div>

                <!-- Main Scenario Scene -->
                <div class="scenario-container">
                    <div class="scenario-scene">
                        <!-- Narrative Panel (Full Width) -->
                        <div class="scene-narrative-panel">
                            <div class="act-header"> Act 1: The Warehouse</div>
                            <div style="text-align: center; margin-bottom: 20px;">
                                <img src="images/arcane_codex_logo.svg" alt="The Arcane Codex" style="max-width: 400px; width: 100%; height: auto;">
                            </div>

                            <div class="narrative-text">
                                Rain hammers the cobblestones as you arrive at the Duke's warehouse.
                                Grimsby whispers urgently: <em>"The medicine for my daughter is inside.
                                We need to move fast."</em>
                            </div>

                            <div class="narrative-text">
                                The guards appear distracted, their attention focused on a dice game
                                near the entrance. The warehouse door is unlocked, swinging gently
                                in the wind.
                            </div>

                            <div class="whisper-box">
                                <div class="whisper-header">
                                    <img src="images/rune_symbol_1.svg" alt="Rune" class="rune-icon">
                                     Fighter Whisper
                                </div>
                                <div class="whisper-text">
                                    Your combat training reveals this is a <strong>TRAP</strong>.
                                    The "distracted" guards are professionalstheir stance is combat-ready,
                                    swords positioned for quick draw. This feels like an ambush.
                                </div>
                            </div>

                            <div class="choice-section">
                                <div class="choice-label"> Available Actions</div>
                                <div class="choice-btn"> Enter through front door<div class="tooltip">Risky - Might trigger trap</div></div>
                                <div class="choice-btn"> Search for alternate entrance<div class="tooltip">Safer but takes time</div></div>
                                <div class="choice-btn"> Confront the guards directly<div class="tooltip">Honest approach - May start combat</div></div>
                                <div class="choice-btn"> Warn party about the trap<div class="tooltip">Share your whisper - Builds trust</div></div>
                            </div>

                            <!-- Divine Council Comments (hidden for gameplay testing) -->
                            <!-- Will be shown dynamically after player makes a choice -->
                            <!--
                            <div class="act-header" style="margin-top: 25px;"> Divine Council Convenes</div>

                            <div class="god-speech valdris">
                                <img src="images/god_valdris.svg" alt="Valdris" class="god-icon">
                                <div class="god-content">
                                    <div class="god-name"> VALDRIS SPEAKS</div>
                                    <div class="god-text">"ORDER DEMANDS ACCOUNTABILITY. This theft, however noble in intent, violates the Duke's law. I vote OPPOSE."</div>
                                </div>
                            </div>

                            <div class="god-speech kaitha">
                                <img src="images/god_kaitha.svg" alt="Kaitha" class="god-icon">
                                <div class="god-content">
                                    <div class="god-name"> KAITHA SPEAKS</div>
                                    <div class="god-text">"Break the chains of unjust law! The child's life matters more than the Duke's gold. I vote SUPPORT!"</div>
                                </div>
                            </div>

                            ... (additional god speeches will be added via JavaScript following this pattern)
                            -->
                        </div>
                    </div>
                </div>

                <!-- Party Panel (Right Side) -->
                <div class="party-panel">
                    <!-- Party & Trust Panel -->
                    <div class="panel-section">
                        <div class="panel-header"> Party</div>
                        <div class="panel-content">

                            <!-- Party Members -->
                            <div class="party-members">
                                <div class="party-member">
                                    <div class="member-portrait"></div>
                                    <div class="member-info">
                                        <div class="member-name">Lyra</div>
                                        <div class="member-class">Mage  Level 11</div>
                                        <div class="member-hp">HP: 420/600</div>
                                    </div>
                                </div>

                                <div class="party-member">
                                    <div class="member-portrait"></div>
                                    <div class="member-info">
                                        <div class="member-name">Grimsby</div>
                                        <div class="member-class">NPC Companion</div>
                                        <div class="member-hp">Approval: 45/100</div>
                                    </div>
                                </div>

                                <div class="party-member">
                                    <div class="member-portrait"></div>
                                    <div class="member-info">
                                        <div class="member-name">Renna</div>
                                        <div class="member-class">NPC Companion</div>
                                        <div class="member-hp">Approval: 60/100</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quest/Objectives Panel -->
                    <div class="panel-section" style="flex: 2;">
                        <div class="panel-header"> Objectives</div>
                        <div class="panel-content">
                            <div class="objectives-list">
                                <div class="objective-item">
                                    <div class="objective-title"> Primary: The Medicine Heist</div>
                                    <div class="objective-desc">
                                        Obtain medicine from Duke's warehouse for Grimsby's daughter
                                    </div>
                                </div>

                                <div class="objective-item">
                                    <div class="objective-title"> Optional: Investigate the Guards</div>
                                    <div class="objective-desc">
                                        Determine if the "distracted" guards are truly unaware
                                    </div>
                                </div>

                                <div class="objective-item">
                                    <div class="objective-title"> Optional: Examine the Medicine</div>
                                    <div class="objective-desc">
                                        Use arcane knowledge to check for curses or dark magic
                                    </div>
                                </div>

                                <div class="objective-item completed">
                                    <div class="objective-title"> Enter Valdria Safely</div>
                                    <div class="objective-desc">
                                        Reach the safe town hub without incident
                                    </div>
                                </div>
                            </div>

                            <div class="turn-counter">
                                Turn 3  Act 1
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Bottom Action Bar -->
        <div class="bottom-hud">
            <!-- Left Player Stats -->
            <div class="player-status">
                <div class="portrait-frame">
                    
                    <div class="level-badge">12</div>
                </div>
            </div>
                <div class="player-bars">
                    <div class="resource-bar">
                        <div class="health-fill"></div>
                        <div class="bar-text">850 / 1000</div>
                    </div>
                    <div class="resource-bar">
                        <div class="mana-fill"></div>
                        <div class="bar-text">420 / 700</div>
                    </div>
                </div>

            <div class="action-slots">
                <div class="action-slot">
                    <span class="slot-key">1</span>
                    
                    <div class="tooltip">Melee Attack (Hotkey: 1)</div>
                </div>
                <div class="action-slot">
                    <span class="slot-key">2</span>
                    
                    <div class="tooltip">Defensive Stance (Hotkey: 2)</div>
                </div>
                <div class="action-slot">
                    <span class="slot-key">3</span>
                    
                    <div class="tooltip">Fireball Spell (Hotkey: 3)</div>
                </div>
                <div class="action-slot">
                    <span class="slot-key">4</span>
                    
                    <div class="tooltip">Lightning Bolt (Hotkey: 4)</div>
                </div>
                <div class="action-slot">
                    <span class="slot-key">5</span>
                    
                    <div class="tooltip">Health Potion (Hotkey: 5)</div>
                </div>
                <div class="action-slot">
                    <span class="slot-key">6</span>
                    
                    <div class="tooltip">Mana Potion (Hotkey: 6)</div>
                </div>
                <div class="action-slot">
                    <span class="slot-key">7</span>
                    
                    <div class="tooltip">Scroll of Teleport (Hotkey: 7)</div>
                </div>
                <div class="action-slot">
                    <span class="slot-key">8</span>
                    
                    <div class="tooltip">Precision Shot (Hotkey: 8)</div>
                </div>
            </div>

        </div>
        <!-- Overlay Elements - All 6 Integrated Overlays -->

        <!-- 1. Character Sheet Overlay -->
        <div id="character-overlay" class="overlay character-sheet-overlay">
    <div class="overlay-backdrop"></div>
    <div class="overlay-content character-sheet-content">
        <div class="overlay-header">
            <h2> Character Sheet</h2>
            <button class="close-btn">&times;</button>
        </div>
        <div class="overlay-body character-sheet-body">
            <!-- CHARACTER INFO SECTION -->
            <div class="character-info-section">
                <div class="character-portrait-large">
                    
                </div>
                <div class="character-header">
                    <div class="character-name">Aldric</div>
                    <div class="character-class-title">Fighter  Level 12</div>
                </div>
            </div>

            <!-- XP BAR -->
            <div class="xp-bar-container">
                <div class="xp-bar-label">Experience</div>
                <div class="xp-bar">
                    <div class="xp-fill" style="width: 65%;"></div>
                    <div class="xp-text">6,500 / 10,000 (65%)</div>
                </div>
            </div>

            <!-- STATS SECTION -->
            <div class="stats-section">
                <div class="stats-header">Attributes</div>
                <div class="stats-grid">
                    <!-- Row 1: Strength, Dexterity, Constitution -->
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-name">Strength</div>
                        <div class="stat-value">18</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-name">Dexterity</div>
                        <div class="stat-value">14</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-name">Constitution</div>
                        <div class="stat-value">16</div>
                    </div>

                    <!-- Row 2: Intelligence, Wisdom, Charisma -->
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-name">Intelligence</div>
                        <div class="stat-value">10</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-name">Wisdom</div>
                        <div class="stat-value">12</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-name">Charisma</div>
                        <div class="stat-value">13</div>
                    </div>
                </div>
            </div>

            <!-- DIVINE FAVOR SECTION -->
            <div class="divine-favor-section">
                <div class="divine-favor-header">Divine Favor</div>

                <!-- VALDRIS - Order/Law (Blue) -->
                <div class="divine-god">
                    <img src="images/god_valdris.svg" alt="Valdris" class="divine-icon" title="Valdris - Order/Law">
                    <div class="divine-name valdris-name">VALDRIS</div>
                    <div class="divine-bar">
                        <div class="divine-fill valdris-bar" style="width: 60%;"></div>
                        <div class="divine-value">+15</div>
                    </div>
                </div>

                <!-- KAITHA - Chaos/Freedom (Orange-Red) -->
                <div class="divine-god">
                    <img src="images/god_kaitha.svg" alt="Kaitha" class="divine-icon" title="Kaitha - Chaos/Freedom">
                    <div class="divine-name kaitha-name">KAITHA</div>
                    <div class="divine-bar">
                        <div class="divine-fill kaitha-bar" style="width: 40%;"></div>
                        <div class="divine-value negative">-10</div>
                    </div>
                </div>

                <!-- MORVANE - Survival/Pragmatism (Grey) -->
                <div class="divine-god">
                    <img src="images/god_morvane.svg" alt="Morvane" class="divine-icon" title="Morvane - Survival/Pragmatism">
                    <div class="divine-name morvane-name">MORVANE</div>
                    <div class="divine-bar">
                        <div class="divine-fill morvane-bar" style="width: 80%;"></div>
                        <div class="divine-value">+20</div>
                    </div>
                </div>

                <!-- SYLARA - Nature/Life (Green) -->
                <div class="divine-god">
                    <img src="images/god_sylara.svg" alt="Sylara" class="divine-icon" title="Sylara - Nature/Life">
                    <div class="divine-name sylara-name">SYLARA</div>
                    <div class="divine-bar">
                        <div class="divine-fill sylara-bar" style="width: 50%;"></div>
                        <div class="divine-value">+5</div>
                    </div>
                </div>

                <!-- KORVAN - War/Courage (Crimson) -->
                <div class="divine-god">
                    <img src="images/god_korvan.svg" alt="Korvan" class="divine-icon" title="Korvan - War/Courage">
                    <div class="divine-name korvan-name">KORVAN</div>
                    <div class="divine-bar">
                        <div class="divine-fill korvan-bar" style="width: 100%;"></div>
                        <div class="divine-value">+25</div>
                    </div>
                </div>

                <!-- ATHENA - Wisdom/Knowledge (Purple) -->
                <div class="divine-god">
                    <img src="images/god_athena.svg" alt="Athena" class="divine-icon" title="Athena - Wisdom/Knowledge">
                    <div class="divine-name athena-name">ATHENA</div>
                    <div class="divine-bar">
                        <div class="divine-fill athena-bar" style="width: 67%;"></div>
                        <div class="divine-value">+10</div>
                    </div>
                </div>

                <!-- MERCUS - Commerce/Value (Gold) -->
                <div class="divine-god">
                    <img src="images/god_mercus.svg" alt="Mercus" class="divine-icon" title="Mercus - Commerce/Value">
                    <div class="divine-name mercus-name">MERCUS</div>
                    <div class="divine-bar">
                        <div class="divine-fill mercus-bar" style="width: 33%;"></div>
                        <div class="divine-value negative">-5</div>
                    </div>
                </div>
            </div>

            <!-- ABILITIES SECTION -->
            <div class="abilities-section">
                <div class="abilities-header">Passive Abilities</div>
                <div class="abilities-list">
                    <div class="ability-item">
                        <div class="ability-icon"></div>
                        <div class="ability-info">
                            <div class="ability-name">Iron Skin</div>
                            <div class="ability-desc">Reduce all incoming damage by 10%</div>
                        </div>
                    </div>
                    <div class="ability-item">
                        <div class="ability-icon"></div>
                        <div class="ability-info">
                            <div class="ability-name">Veteran's Resolve</div>
                            <div class="ability-desc">Gain +2 to all saves after each combat encounter</div>
                        </div>
                    </div>
                    <div class="ability-item">
                        <div class="ability-icon"></div>
                        <div class="ability-info">
                            <div class="ability-name">Weapon Mastery</div>
                            <div class="ability-desc">Increase damage with melee weapons by 15%</div>
                        </div>
                    </div>
                    <div class="ability-item">
                        <div class="ability-icon"></div>
                        <div class="ability-info">
                            <div class="ability-name">Fortified Mind</div>
                            <div class="ability-desc">Immunity to fear and charm effects</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

        <!-- 2. Inventory Overlay -->
        <div id="inventory-overlay" class="game-overlay">
    <div class="overlay-backdrop"></div>
    <div class="overlay-panel inventory-panel">
        <div class="overlay-header">
            <div class="overlay-title">Inventory</div>
            <div class="capacity-info">
                <span class="capacity-label">Weight:</span>
                <span class="capacity-value">45 / 100</span>
            </div>
            <button class="close-btn">x</button>
        </div>

        <!-- Filters -->
        <div class="inventory-filters">
            <button class="filter-btn active" data-filter="all">All Items</button>
            <button class="filter-btn" data-filter="weapons">Weapons</button>
            <button class="filter-btn" data-filter="armor">Armor</button>
            <button class="filter-btn" data-filter="consumables">Consumables</button>
        </div>

        <div class="inventory-content">
            <!-- Equipment Slots Section -->
            <div class="equipment-section">
                <div class="equipment-header">EQUIPPED ITEMS</div>
                <div class="equipment-slots">
                    <!-- Main Hand Slot -->
                    <div class="equipment-slot main-hand" data-slot="main-hand">
                        <div class="slot-label">Main Hand</div>
                        <div class="slot-item equipped" data-item-id="weapon-001" data-tooltip="Blade of the Fallen King | Damage: 15-22 | Rare">
                            x
                        </div>
                    </div>

                    <!-- Off Hand Slot -->
                    <div class="equipment-slot off-hand" data-slot="off-hand">
                        <div class="slot-label">Off-Hand</div>
                        <div class="slot-item equipped" data-item-id="shield-001" data-tooltip="Iron Kite Shield | Defense: 8 | Common">
                            x
                        </div>
                    </div>

                    <!-- Armor Slot -->
                    <div class="equipment-slot armor" data-slot="armor">
                        <div class="slot-label">Armor</div>
                        <div class="slot-item equipped" data-item-id="armor-001" data-tooltip="Plate Armor | Defense: 12 | Uncommon">
                            x
                        </div>
                    </div>

                    <!-- Helmet Slot -->
                    <div class="equipment-slot helmet" data-slot="helmet">
                        <div class="slot-label">Helmet</div>
                        <div class="slot-item equipped" data-item-id="helmet-001" data-tooltip="Ornate Helm | Defense: 5 | Uncommon">
                            x
                        </div>
                    </div>

                    <!-- Gloves Slot -->
                    <div class="equipment-slot gloves" data-slot="gloves">
                        <div class="slot-label">Gloves</div>
                        <div class="slot-item" data-slot-empty="true">
                            -
                        </div>
                    </div>

                    <!-- Boots Slot -->
                    <div class="equipment-slot boots" data-slot="boots">
                        <div class="slot-label">Boots</div>
                        <div class="slot-item" data-slot-empty="true">
                            -
                        </div>
                    </div>

                    <!-- Accessory Slot 1 -->
                    <div class="equipment-slot accessory-1" data-slot="accessory-1">
                        <div class="slot-label">Amulet</div>
                        <div class="slot-item equipped" data-item-id="amulet-001" data-tooltip="Amulet of Warding | Magic Defense: 4 | Uncommon">
                            x
                        </div>
                    </div>

                    <!-- Accessory Slot 2 -->
                    <div class="equipment-slot accessory-2" data-slot="accessory-2">
                        <div class="slot-label">Ring</div>
                        <div class="slot-item" data-slot-empty="true">
                            -
                        </div>
                    </div>
                </div>
            </div>

            <!-- Inventory Grid Section -->
            <div class="grid-section">
                <div class="grid-header">INVENTORY GRID (8x6)</div>
                <div class="inventory-grid">
                    <!-- Row 1 -->
                    <div class="inventory-slot" data-slot-id="slot-0">
                        <div class="grid-item" data-item-id="potion-001" data-tooltip="Health Potion | Restores 100 HP | Common">
                            x
                            <span class="item-quantity">3</span>
                        </div>
                    </div>
                    <div class="inventory-slot" data-slot-id="slot-1">
                        <div class="grid-item" data-item-id="potion-002" data-tooltip="Mana Potion | Restores 80 Mana | Common">
                            x
                            <span class="item-quantity">2</span>
                        </div>
                    </div>
                    <div class="inventory-slot" data-slot-id="slot-2">
                        <div class="grid-item" data-item-id="key-001" data-tooltip="Copper Key | Unlocks warehouse door | Quest Item">
                            x
                            <span class="item-quantity">1</span>
                        </div>
                    </div>
                    <div class="inventory-slot" data-slot-id="slot-3">
                        <div class="grid-item" data-item-id="scroll-001" data-tooltip="Scroll of Fireball | Spell Scroll | Uncommon">
                            x
                            <span class="item-quantity">1</span>
                        </div>
                    </div>
                    <div class="inventory-slot" data-slot-id="slot-4">
                        <div class="grid-item" data-item-id="vial-001" data-tooltip="Alchemical Vial | Restores 50 HP | Rare">
                            x
                            <span class="item-quantity">5</span>
                        </div>
                    </div>
                    <div class="inventory-slot" data-slot-id="slot-5"></div>
                    <div class="inventory-slot" data-slot-id="slot-6"></div>
                    <div class="inventory-slot" data-slot-id="slot-7"></div>

                    <!-- Row 2 -->
                    <div class="inventory-slot" data-slot-id="slot-8"></div>
                    <div class="inventory-slot" data-slot-id="slot-9"></div>
                    <div class="inventory-slot" data-slot-id="slot-10"></div>
                    <div class="inventory-slot" data-slot-id="slot-11"></div>
                    <div class="inventory-slot" data-slot-id="slot-12"></div>
                    <div class="inventory-slot" data-slot-id="slot-13"></div>
                    <div class="inventory-slot" data-slot-id="slot-14"></div>
                    <div class="inventory-slot" data-slot-id="slot-15"></div>

                    <!-- Row 3 -->
                    <div class="inventory-slot" data-slot-id="slot-16"></div>
                    <div class="inventory-slot" data-slot-id="slot-17"></div>
                    <div class="inventory-slot" data-slot-id="slot-18"></div>
                    <div class="inventory-slot" data-slot-id="slot-19"></div>
                    <div class="inventory-slot" data-slot-id="slot-20"></div>
                    <div class="inventory-slot" data-slot-id="slot-21"></div>
                    <div class="inventory-slot" data-slot-id="slot-22"></div>
                    <div class="inventory-slot" data-slot-id="slot-23"></div>

                    <!-- Row 4 -->
                    <div class="inventory-slot" data-slot-id="slot-24"></div>
                    <div class="inventory-slot" data-slot-id="slot-25"></div>
                    <div class="inventory-slot" data-slot-id="slot-26"></div>
                    <div class="inventory-slot" data-slot-id="slot-27"></div>
                    <div class="inventory-slot" data-slot-id="slot-28"></div>
                    <div class="inventory-slot" data-slot-id="slot-29"></div>
                    <div class="inventory-slot" data-slot-id="slot-30"></div>
                    <div class="inventory-slot" data-slot-id="slot-31"></div>

                    <!-- Row 5 -->
                    <div class="inventory-slot" data-slot-id="slot-32"></div>
                    <div class="inventory-slot" data-slot-id="slot-33"></div>
                    <div class="inventory-slot" data-slot-id="slot-34"></div>
                    <div class="inventory-slot" data-slot-id="slot-35"></div>
                    <div class="inventory-slot" data-slot-id="slot-36"></div>
                    <div class="inventory-slot" data-slot-id="slot-37"></div>
                    <div class="inventory-slot" data-slot-id="slot-38"></div>
                    <div class="inventory-slot" data-slot-id="slot-39"></div>

                    <!-- Row 6 -->
                    <div class="inventory-slot" data-slot-id="slot-40"></div>
                    <div class="inventory-slot" data-slot-id="slot-41"></div>
                    <div class="inventory-slot" data-slot-id="slot-42"></div>
                    <div class="inventory-slot" data-slot-id="slot-43"></div>
                    <div class="inventory-slot" data-slot-id="slot-44"></div>
                    <div class="inventory-slot" data-slot-id="slot-45"></div>
                    <div class="inventory-slot" data-slot-id="slot-46"></div>
                    <div class="inventory-slot" data-slot-id="slot-47"></div>
                </div>
            </div>
        </div>

        <!-- Item Details Panel -->
        <div class="item-details">
            <div class="details-title">Item Details</div>
            <div class="details-content">
                <p class="details-placeholder">Hover over an item to view details</p>
            </div>
        </div>
    </div>
</div>

        <!-- 3. Skills Overlay -->
        <div id="skills-overlay" class="overlay">
    <div class="overlay-backdrop"></div>
    <div class="overlay-content">
        <div class="overlay-header">
            <h2> Skills & Abilities</h2>
            <button class="close-btn">&times;</button>
        </div>
        <div class="overlay-body">
            <!-- Skill Points Display -->
            <div class="skill-points-display">
                <div class="skill-points-label">Skill Points Available</div>
                <div class="skill-points-value">3</div>
            </div>

            <!-- Skills Grid -->
            <div class="skills-grid">
                <div class="skill-card">
                    <div class="skill-icon"></div>
                    <div class="skill-name">Melee Attack</div>
                    <div class="skill-level">Rank 5</div>
                    <div class="skill-hotkey">Hotkey: 1</div>
                </div>

                <div class="skill-card">
                    <div class="skill-icon"></div>
                    <div class="skill-name">Power Strike</div>
                    <div class="skill-level">Rank 3</div>
                    <div class="skill-hotkey">Hotkey: 2</div>
                </div>

                <div class="skill-card">
                    <div class="skill-icon"></div>
                    <div class="skill-name">Defensive Stance</div>
                    <div class="skill-level">Rank 4</div>
                    <div class="skill-hotkey">Hotkey: 3</div>
                </div>

                <div class="skill-card">
                    <div class="skill-icon"></div>
                    <div class="skill-name">Fireball</div>
                    <div class="skill-level">Rank 2</div>
                    <div class="skill-hotkey">Hotkey: 4</div>
                </div>

                <div class="skill-card">
                    <div class="skill-icon"></div>
                    <div class="skill-name">Lightning Bolt</div>
                    <div class="skill-level">Rank 3</div>
                    <div class="skill-hotkey">Hotkey: 5</div>
                </div>

                <div class="skill-card">
                    <div class="skill-icon"></div>
                    <div class="skill-name">Healing Potion</div>
                    <div class="skill-level">Rank 4</div>
                    <div class="skill-hotkey">Hotkey: 6</div>
                </div>

                <div class="skill-card">
                    <div class="skill-icon"></div>
                    <div class="skill-name">Arcane Mastery</div>
                    <div class="skill-level">Rank 2</div>
                    <div class="skill-hotkey">Assign: Click</div>
                </div>

                <div class="skill-card">
                    <div class="skill-icon"></div>
                    <div class="skill-name">Scroll Craft</div>
                    <div class="skill-level">Rank 1</div>
                    <div class="skill-hotkey">Assign: Click</div>
                </div>
            </div>

            <div class="skill-hint">
                 Click a skill to assign it to your hotbar, or use existing hotkeys (1-8) to execute abilities.
            </div>
        </div>
    </div>
</div>

        <!-- 4. Quests Overlay -->
        <div id="quests-overlay" class="overlay">
    <div class="overlay-backdrop"></div>
    <div class="overlay-content">
        <div class="overlay-header">
            <h2> Quest Log</h2>
            <button class="close-btn">&times;</button>
        </div>
        <div class="overlay-body">
            <!-- Quest Tabs -->
            <div class="quest-tabs">
                <div class="quest-tab active" data-tab="active">
                    <span class="tab-icon"></span>
                    <span class="tab-label">Active</span>
                    <span class="tab-count">3</span>
                </div>
                <div class="quest-tab" data-tab="completed">
                    <span class="tab-icon"></span>
                    <span class="tab-label">Completed</span>
                    <span class="tab-count">12</span>
                </div>
            </div>

            <!-- Active Quests -->
            <div class="quest-list-container" id="active-quests">
                <div class="quest-item">
                    <div class="quest-header">
                        <div class="quest-title">The Medicine Heist</div>
                        <div class="quest-giver">from Grimsby</div>
                    </div>
                    <div class="quest-description">
                        Obtain medicine from the Duke's warehouse for Grimsby's daughter who is gravely ill.
                    </div>
                    <div class="quest-objectives">
                        <div class="quest-objective">
                            <span class="objective-checkbox"></span>
                            <span class="objective-text">Locate the medicine in the warehouse</span>
                        </div>
                        <div class="quest-objective">
                            <span class="objective-checkbox"></span>
                            <span class="objective-text">Escape the warehouse without getting caught</span>
                        </div>
                        <div class="quest-objective">
                            <span class="objective-checkbox"></span>
                            <span class="objective-text">Return medicine to Grimsby</span>
                        </div>
                    </div>
                    <div class="quest-rewards">
                         Rewards: 500 XP, 100 gold, Grimsby's Approval +30
                    </div>
                </div>

                <div class="quest-item">
                    <div class="quest-header">
                        <div class="quest-title">Investigate the Guards</div>
                        <div class="quest-giver">Optional</div>
                    </div>
                    <div class="quest-description">
                        Determine if the warehouse guards are truly unaware or part of a trap.
                    </div>
                    <div class="quest-objectives">
                        <div class="quest-objective">
                            <span class="objective-checkbox"></span>
                            <span class="objective-text">Observe guard behavior</span>
                        </div>
                        <div class="quest-objective">
                            <span class="objective-checkbox"></span>
                            <span class="objective-text">Report findings to party</span>
                        </div>
                    </div>
                    <div class="quest-rewards">
                         Rewards: 200 XP, 25 gold
                    </div>
                </div>

                <div class="quest-item">
                    <div class="quest-header">
                        <div class="quest-title">Examine the Medicine</div>
                        <div class="quest-giver">Optional</div>
                    </div>
                    <div class="quest-description">
                        Use arcane knowledge to check the medicine for curses or dark magic.
                    </div>
                    <div class="quest-objectives">
                        <div class="quest-objective">
                            <span class="objective-checkbox"></span>
                            <span class="objective-text">Inspect the medicine with Arcane Mastery</span>
                        </div>
                    </div>
                    <div class="quest-rewards">
                         Rewards: 150 XP, 50 gold
                    </div>
                </div>
            </div>

            <!-- Completed Quests (Hidden by default) -->
            <div class="quest-list-container hidden" id="completed-quests">
                <div class="quest-item completed">
                    <div class="quest-header">
                        <div class="quest-title">Enter Valdria Safely</div>
                        <div class="quest-giver">Tutorial</div>
                    </div>
                    <div class="quest-description">
                        Reach the safe town hub without incident.
                    </div>
                    <div class="quest-rewards">
                         Completed - 100 XP earned
                    </div>
                </div>
                <div style="text-align: center; color: #8B7355; padding: 20px;">
                    ... and 11 more completed quests
                </div>
            </div>
        </div>
    </div>
</div>

        <!-- 5. Map Overlay - COMPLETELY REBUILT FROM SCRATCH -->
<div id="map-overlay" class="overlay">
    <style>
        /* ======================== */
        /* COMPLETELY NEW MAP DESIGN */
        /* ======================== */

        #map-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            z-index: 9999;
            background: radial-gradient(ellipse at center, #1a1612 0%, #0d0b08 100%);
        }

        #map-overlay.active {
            display: flex !important;
            flex-direction: column;
            animation: mapReveal 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes mapReveal {
            from {
                opacity: 0;
                transform: scale(1.05);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Minimal Elegant Header */
        #map-overlay .map-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px 30px;
            background: linear-gradient(180deg, rgba(26, 22, 18, 0.9) 0%, transparent 100%);
            pointer-events: none;
        }

        #map-overlay .map-title {
            font-family: 'Cinzel', serif;
            font-size: 24px;
            font-weight: 600;
            color: #D4AF37;
            text-transform: uppercase;
            letter-spacing: 4px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.8);
            opacity: 0.9;
        }

        #map-overlay .map-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: rgba(26, 22, 18, 0.8);
            border: 1px solid rgba(212, 175, 55, 0.5);
            border-radius: 50%;
            color: #D4AF37;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            pointer-events: all;
        }

        #map-overlay .map-close:hover {
            background: rgba(212, 175, 55, 0.2);
            border-color: #FFD700;
            transform: rotate(90deg);
        }

        /* Full Canvas Container */
        #map-overlay .map-viewport {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        #map-overlay #world-map-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: grab;
        }

        #map-overlay #world-map-canvas:active {
            cursor: grabbing;
        }

        /* Top-Left Filter Panel (Translucent) */
        #map-overlay .filter-panel {
            position: absolute;
            top: 70px;
            left: 20px;
            background: rgba(26, 22, 18, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            padding: 10px;
            z-index: 500;
        }

        #map-overlay .filter-btn {
            display: block;
            width: 140px;
            padding: 8px 12px;
            margin: 4px 0;
            background: rgba(139, 115, 85, 0.2);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 4px;
            color: #D4C4B0;
            font-size: 12px;
            font-family: 'Yrsa', serif;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
        }

        #map-overlay .filter-btn:hover {
            background: rgba(212, 175, 55, 0.3);
            border-color: #D4AF37;
            color: #FFD700;
            transform: translateX(3px);
        }

        #map-overlay .filter-btn.active {
            background: rgba(212, 175, 55, 0.5);
            border-color: #FFD700;
            color: #FFD700;
        }

        /* Top-Right Zoom Controls (Translucent) */
        #map-overlay .zoom-panel {
            position: absolute;
            top: 70px;
            right: 20px;
            background: rgba(26, 22, 18, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            padding: 10px;
            z-index: 500;
        }

        #map-overlay .zoom-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 120px;
            padding: 8px;
            margin: 4px 0;
            background: rgba(139, 115, 85, 0.2);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 4px;
            color: #D4C4B0;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        #map-overlay .zoom-btn:hover {
            background: rgba(212, 175, 55, 0.3);
            border-color: #D4AF37;
            color: #FFD700;
        }

        /* Bottom-Right Minimap (Compact) */
        #map-overlay .minimap {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 200px;
            height: 150px;
            background: rgba(26, 22, 18, 0.9);
            border: 2px solid rgba(212, 175, 55, 0.5);
            border-radius: 8px;
            overflow: hidden;
            z-index: 500;
        }

        #map-overlay #minimap-canvas {
            width: 100%;
            height: 100%;
        }

        /* Bottom-Left Legend (Compact) */
        #map-overlay .legend-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(26, 22, 18, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            padding: 12px;
            z-index: 500;
        }

        #map-overlay .legend-title {
            color: #D4AF37;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 8px;
            opacity: 0.9;
        }

        #map-overlay .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #D4C4B0;
            font-size: 11px;
            margin: 4px 0;
            opacity: 0.8;
        }

        #map-overlay .legend-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }

        /* Location Tooltip */
        #map-overlay .location-tooltip {
            position: absolute;
            padding: 8px 12px;
            background: rgba(26, 22, 18, 0.95);
            border: 1px solid #D4AF37;
            border-radius: 4px;
            color: #FFD700;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 1500;
            white-space: nowrap;
        }

        #map-overlay .location-tooltip.visible {
            opacity: 1;
        }
    
        /* === Loading States (Phase B) === */
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap');

        /* Mystical Loading Spinner */
        .loading-container {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }

        .arcane-spinner {
            width: 120px;
            height: 120px;
            position: relative;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .spinner-ring {
            position: absolute;
            inset: 0;
            border: 3px solid transparent;
            border-top-color: #FFD700;
            border-radius: 50%;
            animation: spin 1.5s linear infinite;
        }

        .spinner-ring:nth-child(2) {
            inset: 10px;
            border-top-color: #D4AF37;
            animation-duration: 1.2s;
            animation-direction: reverse;
        }

        .spinner-ring:nth-child(3) {
            inset: 20px;
            border-top-color: #B8860B;
            animation-duration: 1s;
        }

        .spinner-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            background: radial-gradient(circle, #FFD700, #D4AF37);
            border-radius: 50%;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.8; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
        }

        .loading-text {
            margin-top: 30px;
            font-size: 20px;
            letter-spacing: 2px;
            text-transform: uppercase;
            animation: fadeInOut 2s ease-in-out infinite;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        .loading-tips {
            position: absolute;
            bottom: 60px;
            text-align: center;
            max-width: 400px;
        }

        .tip-label {
            font-size: 12px;
            color: #8B7355;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .tip-text {
            font-size: 16px;
            color: #D4AF37;
            font-style: italic;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Inline Progress Bar */
        .inline-loader {
            display: inline-flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            background: rgba(42, 36, 30, 0.9);
            border: 2px solid #8B7355;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }

        .loader-icon {
            width: 24px;
            height: 24px;
            border: 2px solid transparent;
            border-top-color: #FFD700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loader-text {
            font-size: 14px;
            color: #D4AF37;
        }

        /* Skeleton Loading for Content */
        .skeleton-container {
            background: rgba(26, 22, 18, 0.95);
            border: 3px solid #8B7355;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .skeleton {
            background: linear-gradient(90deg,
                rgba(139, 115, 85, 0.1) 0%,
                rgba(212, 175, 55, 0.2) 50%,
                rgba(139, 115, 85, 0.1) 100%);
            background-size: 200% 100%;
            animation: shimmer 1.5s ease-in-out infinite;
            border-radius: 4px;
        }

        @keyframes shimmer {
            0% { background-position: -200% center; }
            100% { background-position: 200% center; }
        }

        .skeleton-title {
            height: 24px;
            width: 60%;
            margin-bottom: 15px;
        }

        .skeleton-text {
            height: 16px;
            margin-bottom: 10px;
        }

        .skeleton-text:last-child {
            width: 80%;
        }

        /* Success Animation */
        .success-pulse {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            pointer-events: none;
            z-index: 10000;
        }

        .success-ring {
            position: absolute;
            inset: 0;
            border: 3px solid #00FF00;
            border-radius: 50%;
            opacity: 0;
            animation: successPulse 1s ease-out;
        }

        @keyframes successPulse {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }
            50% {
                opacity: 1;
            }
            100% {
                transform: scale(2);
                opacity: 0;
            }
        }

        .success-check {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 60px;
            color: #00FF00;
            animation: checkmark 0.5s ease-out 0.3s both;
        }

        @keyframes checkmark {
            0% {
                transform: translate(-50%, -50%) scale(0) rotate(-45deg);
                opacity: 0;
            }
            100% {
                transform: translate(-50%, -50%) scale(1) rotate(0deg);
                opacity: 1;
            }
        }
    
        /* === Celebration Animations (Phase B) === */
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&display=swap');

        /* Level Up Animation */
        .level-up-burst {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10000;
            pointer-events: none;
        }

        .burst-rays {
            position: absolute;
            width: 600px;
            height: 600px;
            top: -300px;
            left: -300px;
            background: conic-gradient(
                from 0deg,
                transparent 0deg,
                rgba(255, 215, 0, 0.3) 15deg,
                transparent 30deg,
                transparent 60deg,
                rgba(255, 215, 0, 0.3) 75deg,
                transparent 90deg,
                transparent 120deg,
                rgba(255, 215, 0, 0.3) 135deg,
                transparent 150deg,
                transparent 180deg,
                rgba(255, 215, 0, 0.3) 195deg,
                transparent 210deg,
                transparent 240deg,
                rgba(255, 215, 0, 0.3) 255deg,
                transparent 270deg,
                transparent 300deg,
                rgba(255, 215, 0, 0.3) 315deg,
                transparent 330deg
            );
            animation: spinRays 2s linear infinite;
        }

        @keyframes spinRays {
            0% { transform: rotate(0deg) scale(0); opacity: 0; }
            10% { transform: rotate(36deg) scale(1); opacity: 1; }
            90% { transform: rotate(360deg) scale(1); opacity: 1; }
            100% { transform: rotate(396deg) scale(1.5); opacity: 0; }
        }

        .level-up-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 4px;
            color: #FFD700;
            text-shadow:
                0 0 20px rgba(255, 215, 0, 0.8),
                0 0 40px rgba(255, 215, 0, 0.6),
                0 0 60px rgba(255, 215, 0, 0.4);
            animation: levelUpPop 1s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes levelUpPop {
            0% {
                transform: translate(-50%, -50%) scale(0) rotate(-180deg);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.2) rotate(10deg);
            }
            100% {
                transform: translate(-50%, -50%) scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        /* Quest Complete Animation */
        .quest-complete {
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10000;
            animation: slideDown 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes slideDown {
            0% { transform: translateX(-50%) translateY(-100px); opacity: 0; }
            100% { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        .quest-banner {
            background: linear-gradient(135deg, #8B7355 0%, #D4AF37 50%, #8B7355 100%);
            padding: 20px 40px;
            border-radius: 10px;
            box-shadow:
                0 10px 40px rgba(0, 0, 0, 0.8),
                inset 0 2px 4px rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
        }

        .quest-banner::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg,
                transparent 30%,
                rgba(255, 255, 255, 0.3) 50%,
                transparent 70%);
            animation: shine 1s ease-in-out;
        }

        @keyframes shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .quest-text {
            font-size: 24px;
            font-weight: 700;
            color: #2A1810;
            text-transform: uppercase;
            letter-spacing: 2px;
            position: relative;
            z-index: 1;
        }

        /* Divine Favor Pulse */
        .divine-favor-gain {
            position: fixed;
            top: 100px;
            right: 50px;
            z-index: 9999;
        }

        .favor-orb {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: radial-gradient(circle, #FFD700, #D4AF37);
            box-shadow:
                0 0 40px rgba(255, 215, 0, 0.8),
                0 0 80px rgba(255, 215, 0, 0.6);
            animation: favorPulse 1.5s ease-out;
            position: relative;
        }

        @keyframes favorPulse {
            0% {
                transform: scale(0);
                opacity: 0;
            }
            50% {
                transform: scale(1.2);
                opacity: 1;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .favor-amount {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 32px;
            font-weight: 700;
            color: #00FF00;
            text-shadow: 0 2px 10px rgba(0, 255, 0, 0.5);
            animation: floatUp 2s ease-out;
        }

        @keyframes floatUp {
            0% {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
            100% {
                transform: translateX(-50%) translateY(-60px);
                opacity: 0;
            }
        }

        /* Damage Numbers */
        .damage-number {
            position: absolute;
            font-size: 36px;
            font-weight: 900;
            pointer-events: none;
            z-index: 9999;
            animation: damageFloat 1s ease-out forwards;
        }

        .damage-number.critical {
            color: #FF0000;
            font-size: 48px;
            text-shadow:
                0 0 10px rgba(255, 0, 0, 0.8),
                0 0 20px rgba(255, 0, 0, 0.6);
        }

        .damage-number.heal {
            color: #00FF00;
            text-shadow:
                0 0 10px rgba(0, 255, 0, 0.8),
                0 0 20px rgba(0, 255, 0, 0.6);
        }

        .damage-number.normal {
            color: #FFD700;
            text-shadow:
                0 0 10px rgba(255, 215, 0, 0.8),
                0 0 20px rgba(255, 215, 0, 0.6);
        }

        @keyframes damageFloat {
            0% {
                transform: translateY(0) scale(0.5);
                opacity: 0;
            }
            20% {
                transform: translateY(-20px) scale(1.2);
                opacity: 1;
            }
            100% {
                transform: translateY(-80px) scale(0.8);
                opacity: 0;
            }
        }

        /* Streak Counter */
        .streak-counter {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, rgba(42, 36, 30, 0.95), rgba(26, 22, 18, 0.95));
            border: 3px solid #D4AF37;
            border-radius: 10px;
            padding: 15px 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.8);
            animation: bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes bounceIn {
            0% { transform: scale(0); }
            80% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .streak-fire {
            display: inline-block;
            font-size: 32px;
            animation: flameDance 1s ease-in-out infinite;
        }

        @keyframes flameDance {
            0%, 100% { transform: translateY(0) scale(1); }
            25% { transform: translateY(-3px) scale(1.1); }
            75% { transform: translateY(2px) scale(0.95); }
        }

        .streak-number {
            display: inline-block;
            margin-left: 10px;
            font-size: 28px;
            font-weight: 700;
            color: #FFD700;
            text-shadow: 0 2px 10px rgba(255, 215, 0, 0.5);
        }

        .streak-label {
            display: block;
            font-size: 12px;
            color: #8B7355;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 5px;
        }

        /* Particle Effects */
        .particle {
            position: absolute;
            pointer-events: none;
            width: 4px;
            height: 4px;
            background: #FFD700;
            border-radius: 50%;
            box-shadow: 0 0 6px rgba(255, 215, 0, 0.8);
        }

        @keyframes particleFloat {
            0% {
                transform: translateY(0) translateX(0);
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) translateX(var(--drift));
                opacity: 0;
            }
        }

        /* XP Bar Fill Animation */
        .xp-bar-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 400px;
            height: 30px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #8B7355;
            border-radius: 15px;
            overflow: hidden;
        }

        .xp-fill {
            height: 100%;
            background: linear-gradient(90deg, #9370DB, #DDA0DD, #9370DB);
            background-size: 200% 100%;
            animation: xpGlow 2s ease-in-out infinite;
            transition: width 0.5s ease-out;
        }

        @keyframes xpGlow {
            0% { background-position: 0% center; }
            100% { background-position: 200% center; }
        }

        .xp-text {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
            color: white;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
        }
    
        /* === Mobile Optimizations (Phase B) === */
        /* =============================================
   MOBILE-FIRST RESPONSIVE DESIGN
   The Arcane Codex - Touch Optimized
   ============================================= */

/* Mobile Touch Targets (minimum 44x44px) */
:root {
    --touch-target-min: 44px;
    --safe-area-inset: env(safe-area-inset-top, 0px);
    --thumb-reach: 60px; /* Bottom area easily reached by thumb */
}

/* Prevent iOS bounce and improve scrolling */
html {
    -webkit-overflow-scrolling: touch;
    overflow: hidden;
    position: fixed;
    width: 100%;
    height: 100%;
}

body {
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
    touch-action: manipulation;
    overscroll-behavior: none;
}

/* =============================================
   RESPONSIVE BREAKPOINTS
   ============================================= */

/* Extra Small Devices (phones, 375px and below) */
@media only screen and (max-width: 375px) {
    .game-container {
        padding-top: var(--safe-area-inset);
    }

    .top-hud {
        height: 60px;
        padding: 0 10px;
    }

    .game-title {
        font-size: 20px;
        letter-spacing: 1px;
    }

    .player-bars {
        display: none; /* Show in expandable drawer */
    }

    .portrait-frame {
        width: 48px;
        height: 48px;
    }
}

/* Small Devices (phones, 376px to 667px) */
@media only screen and (min-width: 376px) and (max-width: 667px) {
    /* Collapsible side panel */
    .left-sidebar {
        position: fixed;
        left: -60px;
        transition: left 0.3s ease;
        z-index: 101;
    }

    .left-sidebar.open {
        left: 0;
    }

    .menu-toggle {
        display: block;
        position: fixed;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        width: 40px;
        height: 80px;
        background: linear-gradient(90deg, rgba(212, 175, 55, 0.3), transparent);
        border-radius: 0 10px 10px 0;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
        animation: pulseHint 2s ease-in-out infinite;
    }

    @keyframes pulseHint {
        0%, 100% { opacity: 0.5; }
        50% { opacity: 1; }
    }

    /* Bottom action bar optimization */
    .bottom-hud {
        height: 80px;
        padding-bottom: env(safe-area-inset-bottom, 0px);
    }

    .action-slot {
        width: var(--touch-target-min);
        height: var(--touch-target-min);
        font-size: 20px;
    }

    /* Overlays full screen on mobile */
    .overlay-content,
    .overlay-panel {
        width: 100vw !important;
        height: 100vh !important;
        max-width: none !important;
        max-height: none !important;
        border-radius: 0 !important;
        margin: 0 !important;
    }

    .overlay-header {
        position: sticky;
        top: 0;
        z-index: 202;
        border-radius: 0 !important;
    }

    /* Right panel as bottom drawer */
    .party-panel {
        position: fixed;
        bottom: -300px;
        left: 0;
        right: 0;
        width: 100%;
        transition: bottom 0.3s ease;
        z-index: 99;
        border-radius: 20px 20px 0 0;
        box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.5);
    }

    .party-panel.expanded {
        bottom: 0;
    }

    .drawer-handle {
        position: absolute;
        top: -30px;
        left: 50%;
        transform: translateX(-50%);
        width: 60px;
        height: 30px;
        background: rgba(212, 175, 55, 0.3);
        border-radius: 30px 30px 0 0;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }

    .drawer-handle::after {
        content: '';
        width: 30px;
        height: 4px;
        background: #D4AF37;
        border-radius: 2px;
    }

    /* Touch-friendly choice buttons */
    .choice-btn {
        min-height: var(--touch-target-min);
        padding: 12px 16px;
        font-size: 16px;
        margin-bottom: 12px;
    }

    /* Swipe gestures for navigation */
    .swipe-indicator {
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 8px;
        z-index: 90;
    }

    .swipe-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: rgba(139, 115, 85, 0.5);
        transition: all 0.3s ease;
    }

    .swipe-dot.active {
        width: 24px;
        background: #D4AF37;
        border-radius: 4px;
    }
}

/* Medium Devices (tablets, 668px to 1024px) */
@media only screen and (min-width: 668px) and (max-width: 1024px) {
    .game-board {
        flex-direction: column;
    }

    .left-sidebar {
        width: 100%;
        height: auto;
        flex-direction: row;
        justify-content: center;
        padding: 5px;
    }

    .scenario-container {
        height: 60vh;
    }

    .party-panel {
        width: 100%;
        height: 40vh;
        flex-direction: row;
        overflow-x: auto;
        overflow-y: hidden;
        gap: 15px;
    }

    .panel-section {
        min-width: 300px;
        flex-shrink: 0;
    }

    /* Floating action buttons */
    .fab-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 100;
    }

    .fab-main {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: linear-gradient(135deg, #8B7355, #D4AF37);
        border: none;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        cursor: pointer;
        transition: transform 0.3s ease;
    }

    .fab-main:active {
        transform: scale(0.95);
    }

    .fab-options {
        position: absolute;
        bottom: 70px;
        right: 0;
        display: flex;
        flex-direction: column;
        gap: 10px;
        opacity: 0;
        pointer-events: none;
        transition: all 0.3s ease;
    }

    .fab-options.open {
        opacity: 1;
        pointer-events: all;
    }

    .fab-option {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: rgba(42, 36, 30, 0.95);
        border: 2px solid #8B7355;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        cursor: pointer;
        transform: scale(0);
        transition: transform 0.3s ease;
    }

    .fab-options.open .fab-option {
        transform: scale(1);
    }

    .fab-options.open .fab-option:nth-child(1) { transition-delay: 0.05s; }
    .fab-options.open .fab-option:nth-child(2) { transition-delay: 0.1s; }
    .fab-options.open .fab-option:nth-child(3) { transition-delay: 0.15s; }
    .fab-options.open .fab-option:nth-child(4) { transition-delay: 0.2s; }
    .fab-options.open .fab-option:nth-child(5) { transition-delay: 0.25s; }
}

/* =============================================
   TOUCH GESTURES & INTERACTIONS
   ============================================= */

/* Long press effect */
.long-press {
    position: relative;
}

.long-press::after {
    content: '';
    position: absolute;
    inset: -5px;
    border: 2px solid #FFD700;
    border-radius: inherit;
    opacity: 0;
    animation: longPressRing 1s ease-out;
    pointer-events: none;
}

@keyframes longPressRing {
    0% {
        transform: scale(0.8);
        opacity: 0;
    }
    50% {
        opacity: 1;
    }
    100% {
        transform: scale(1.2);
        opacity: 0;
    }
}

/* Pull to refresh indicator */
.pull-refresh {
    position: fixed;
    top: -60px;
    left: 50%;
    transform: translateX(-50%);
    width: 40px;
    height: 40px;
    background: rgba(212, 175, 55, 0.1);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: top 0.3s ease;
    z-index: 10000;
}

.pull-refresh.visible {
    top: 20px;
}

.pull-refresh.loading {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: translateX(-50%) rotate(0deg); }
    100% { transform: translateX(-50%) rotate(360deg); }
}

/* Haptic feedback visual */
.haptic-pulse {
    position: absolute;
    width: 100px;
    height: 100px;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(255, 215, 0, 0.5), transparent);
    pointer-events: none;
    transform: translate(-50%, -50%);
    animation: hapticPulse 0.4s ease-out;
}

@keyframes hapticPulse {
    0% {
        transform: translate(-50%, -50%) scale(0);
        opacity: 1;
    }
    100% {
        transform: translate(-50%, -50%) scale(2);
        opacity: 0;
    }
}

/* =============================================
   LANDSCAPE MODE OPTIMIZATIONS
   ============================================= */

@media only screen and (orientation: landscape) and (max-height: 500px) {
    .top-hud {
        height: 50px;
    }

    .bottom-hud {
        height: 60px;
    }

    .game-title {
        display: none;
    }

    .left-panel,
    .party-panel {
        position: fixed;
        transform: scale(0.8);
        transform-origin: top left;
    }

    .scenario-container {
        margin: 0 auto;
        max-width: 70%;
    }

    /* Compact overlay mode */
    .overlay-content {
        max-height: 90vh !important;
        overflow-y: auto;
    }

    .overlay-header {
        padding: 10px 15px;
    }

    .overlay-header h2 {
        font-size: 20px;
    }
}

/* =============================================
   TOUCH-SPECIFIC ENHANCEMENTS
   ============================================= */

/* iOS Safe Areas */
@supports (padding: max(0px)) {
    .game-container {
        padding-left: max(0px, env(safe-area-inset-left));
        padding-right: max(0px, env(safe-area-inset-right));
        padding-top: max(0px, env(safe-area-inset-top));
    }

    .bottom-hud {
        padding-bottom: max(15px, env(safe-area-inset-bottom));
    }
}

/* Disable text selection on interactive elements */
.side-btn,
.action-slot,
.choice-btn,
.party-member,
.character-card {
    -webkit-user-select: none;
    user-select: none;
    -webkit-user-drag: none;
}

/* Improve scrolling performance */
.scene-narrative-panel,
.objectives-list,
.overlay-body {
    -webkit-overflow-scrolling: touch;
    scroll-behavior: smooth;
    will-change: scroll-position;
}

/* Virtual keyboard adjustments */
@media (max-height: 500px) {
    .overlay-content {
        position: fixed;
        top: 0 !important;
        transform: none !important;
    }
}

/* Thumb-friendly bottom navigation */
.mobile-nav {
    display: none;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 56px;
    background: linear-gradient(180deg, rgba(26, 22, 18, 0.95), rgba(42, 36, 30, 0.98));
    border-top: 2px solid #8B7355;
    padding-bottom: env(safe-area-inset-bottom, 0px);
    z-index: 100;
}

@media (max-width: 667px) {
    .mobile-nav {
        display: flex;
        justify-content: space-around;
        align-items: center;
    }

    .bottom-hud {
        display: none;
    }
}

.mobile-nav-item {
    flex: 1;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: none;
    color: #8B7355;
    transition: all 0.3s ease;
    position: relative;
}

.mobile-nav-item.active {
    color: #FFD700;
}

.mobile-nav-item.active::before {
    content: '';
    position: absolute;
    top: 0;
    left: 20%;
    right: 20%;
    height: 3px;
    background: #FFD700;
    border-radius: 0 0 3px 3px;
}

.mobile-nav-icon {
    font-size: 20px;
    margin-bottom: 4px;
}

.mobile-nav-label {
    font-size: 10px;
    font-family: 'Cinzel', serif;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
    
        /* === Design System Improvements (Phase B) === */
        /**
 * The Arcane Codex Design System
 * 07. Recommended Improvements
 * =============================
 * Critical enhancements for AAA dark fantasy experience
 */

/* ==========================================
   ENHANCED COLOR TOKENS
   ========================================== */

:root {
  /* Blood & Combat Palette */
  --color-blood-50: #fef2f2;
  --color-blood-100: #fee2e2;
  --color-blood-200: #fecaca;
  --color-blood-300: #fca5a5;
  --color-blood-400: #f87171;
  --color-blood-500: #ef4444;
  --color-blood-600: #dc2626;
  --color-blood-700: #b91c1c;
  --color-blood-800: #991b1b;
  --color-blood-900: #7f1d1d;
  --color-blood-950: #450a0a;

  /* Void & Shadow Magic Palette */
  --color-void-50: #f5f3ff;
  --color-void-100: #ede9fe;
  --color-void-200: #ddd6fe;
  --color-void-300: #c4b5fd;
  --color-void-400: #a78bfa;
  --color-void-500: #8b5cf6;
  --color-void-600: #7c3aed;
  --color-void-700: #6d28d9;
  --color-void-800: #5b21b6;
  --color-void-900: #4c1d95;
  --color-void-950: #1e0033;

  /* Corruption & Decay Palette */
  --color-corruption-50: #f7fee7;
  --color-corruption-100: #ecfccb;
  --color-corruption-200: #d9f99d;
  --color-corruption-300: #bef264;
  --color-corruption-400: #a3e635;
  --color-corruption-500: #84cc16;
  --color-corruption-600: #65a30d;
  --color-corruption-700: #4d7c0f;
  --color-corruption-800: #3f6212;
  --color-corruption-900: #365314;
  --color-corruption-950: #1a2e05;

  /* Frost & Ice Magic Palette */
  --color-frost-50: #f0f9ff;
  --color-frost-100: #e0f2fe;
  --color-frost-200: #bae6fd;
  --color-frost-300: #7dd3fc;
  --color-frost-400: #38bdf8;
  --color-frost-500: #0ea5e9;
  --color-frost-600: #0284c7;
  --color-frost-700: #0369a1;
  --color-frost-800: #075985;
  --color-frost-900: #0c4a6e;
  --color-frost-950: #082f49;

  /* Ember & Fire Magic Palette */
  --color-ember-50: #fff7ed;
  --color-ember-100: #ffedd5;
  --color-ember-200: #fed7aa;
  --color-ember-300: #fdba74;
  --color-ember-400: #fb923c;
  --color-ember-500: #f97316;
  --color-ember-600: #ea580c;
  --color-ember-700: #c2410c;
  --color-ember-800: #9a3412;
  --color-ember-900: #7c2d12;
  --color-ember-950: #431407;

  /* Enhanced Shadow Effects */
  --shadow-mystical: 0 0 30px rgba(139, 31, 255, 0.4),
                     0 0 60px rgba(139, 31, 255, 0.2),
                     inset 0 0 30px rgba(139, 31, 255, 0.1);

  --shadow-divine-aura: 0 0 40px rgba(245, 158, 11, 0.6),
                        0 0 80px rgba(245, 158, 11, 0.3),
                        0 0 120px rgba(245, 158, 11, 0.1);

  --shadow-corruption: 0 10px 40px rgba(132, 204, 22, 0.3),
                       0 0 80px rgba(132, 204, 22, 0.2),
                       inset 0 0 20px rgba(0, 0, 0, 0.8);

  /* Text Shadow Effects */
  --text-shadow-glow: 0 0 10px currentColor,
                      0 0 20px currentColor,
                      0 0 30px currentColor;

  --text-shadow-divine: 0 2px 4px rgba(0, 0, 0, 0.8),
                        0 0 20px rgba(245, 158, 11, 0.8),
                        0 0 40px rgba(245, 158, 11, 0.4);

  --text-shadow-mystical: 0 2px 4px rgba(0, 0, 0, 0.8),
                          0 0 15px rgba(139, 31, 255, 0.8),
                          0 0 30px rgba(139, 31, 255, 0.4);

  /* Performance Budgets */
  --animation-budget-micro: 16ms;     /* 60fps target */
  --animation-budget-small: 100ms;    /* Quick transitions */
  --animation-budget-medium: 250ms;   /* Standard animations */
  --animation-budget-large: 500ms;    /* Complex sequences */
  --animation-budget-epic: 1000ms;    /* Celebration effects */
}

/* ==========================================
   COMBAT ANIMATION SEQUENCES
   ========================================== */

@keyframes slashAttack {
  0% {
    clip-path: polygon(0 0, 0 0, 0 100%, 0 100%);
    opacity: 0;
  }
  20% {
    clip-path: polygon(0 0, 30% 0, 20% 100%, 0 100%);
    opacity: 1;
  }
  40% {
    clip-path: polygon(0 0, 70% 0, 60% 100%, 0 100%);
  }
  60% {
    clip-path: polygon(20% 0, 100% 0, 100% 100%, 80% 100%);
  }
  80% {
    clip-path: polygon(70% 0, 100% 0, 100% 100%, 100% 100%);
    opacity: 1;
  }
  100% {
    clip-path: polygon(100% 0, 100% 0, 100% 100%, 100% 100%);
    opacity: 0;
  }
}

@keyframes magicCast {
  0% {
    transform: scale(0) rotate(0deg);
    opacity: 0;
    filter: brightness(2) hue-rotate(0deg);
  }
  25% {
    transform: scale(1.2) rotate(90deg);
    opacity: 0.8;
  }
  50% {
    transform: scale(1) rotate(180deg);
    opacity: 1;
    filter: brightness(1.5) hue-rotate(180deg);
  }
  75% {
    transform: scale(1.1) rotate(270deg);
    opacity: 0.9;
  }
  100% {
    transform: scale(2) rotate(360deg);
    opacity: 0;
    filter: brightness(3) hue-rotate(360deg);
  }
}

@keyframes shieldBlock {
  0%, 100% {
    transform: scale(1) translateX(0);
    opacity: 0.3;
  }
  30% {
    transform: scale(1.3) translateX(-10px);
    opacity: 1;
  }
  50% {
    transform: scale(1.5) translateX(0);
    opacity: 0.8;
  }
  70% {
    transform: scale(1.2) translateX(5px);
    opacity: 0.6;
  }
}

@keyframes criticalHit {
  0% {
    transform: scale(1);
    filter: brightness(1);
  }
  10% {
    transform: scale(1.5);
    filter: brightness(2) contrast(2);
  }
  20% {
    transform: scale(1.2) rotate(5deg);
    filter: brightness(1.5) contrast(1.5) hue-rotate(10deg);
  }
  30% {
    transform: scale(1.3) rotate(-5deg);
  }
  40% {
    transform: scale(1.1) rotate(3deg);
  }
  50% {
    transform: scale(1.2) rotate(-3deg);
  }
  100% {
    transform: scale(1) rotate(0);
    filter: brightness(1) contrast(1);
  }
}

/* ==========================================
   ENHANCED GAME COMPONENTS
   ========================================== */

/* Health Bar Component */
.health-bar {
  position: relative;
  width: 100%;
  height: 24px;
  background: linear-gradient(180deg,
    rgba(0, 0, 0, 0.9) 0%,
    rgba(69, 10, 10, 0.8) 100%);
  border: 2px solid var(--color-blood-700);
  border-radius: 12px;
  overflow: hidden;
  box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.8),
              0 0 20px rgba(185, 28, 28, 0.3);
}

.health-bar-fill {
  height: 100%;
  background: linear-gradient(90deg,
    var(--color-blood-600) 0%,
    var(--color-blood-500) 50%,
    var(--color-blood-400) 100%);
  position: relative;
  transition: width var(--duration-slow) var(--ease-out);
  box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.2);
}

.health-bar-fill::after {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 50%;
  background: linear-gradient(180deg,
    rgba(255, 255, 255, 0.3) 0%,
    transparent 100%);
  border-radius: 10px 10px 0 0;
}

.health-bar-damage {
  position: absolute;
  top: 0;
  right: 0;
  height: 100%;
  background: rgba(255, 0, 0, 0.6);
  animation: healthDamage 0.5s ease-out forwards;
}

@keyframes healthDamage {
  0% {
    opacity: 1;
    transform: scaleY(1);
  }
  100% {
    opacity: 0;
    transform: scaleY(0.8);
  }
}

/* Mana Bar Component */
.mana-bar {
  position: relative;
  width: 100%;
  height: 20px;
  background: linear-gradient(180deg,
    rgba(0, 0, 0, 0.9) 0%,
    rgba(8, 47, 73, 0.8) 100%);
  border: 2px solid var(--color-frost-700);
  border-radius: 10px;
  overflow: hidden;
  box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.8),
              0 0 15px rgba(14, 165, 233, 0.3);
}

.mana-bar-fill {
  height: 100%;
  background: linear-gradient(90deg,
    var(--color-frost-600) 0%,
    var(--color-frost-500) 50%,
    var(--color-frost-400) 100%);
  position: relative;
  transition: width var(--duration-slow) var(--ease-out);
  box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.3);
}

.mana-bar-fill::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(90deg,
    transparent 0%,
    rgba(255, 255, 255, 0.3) 50%,
    transparent 100%);
  animation: manaFlow 3s linear infinite;
}

@keyframes manaFlow {
  0% {
    transform: translateX(-100%);
  }
  100% {
    transform: translateX(100%);
  }
}

/* Character Portrait Frame */
.character-portrait {
  position: relative;
  width: 96px;
  height: 96px;
  border-radius: 50%;
  padding: 4px;
  background: linear-gradient(135deg,
    var(--color-divine-600) 0%,
    var(--color-bronze-dark) 50%,
    var(--color-divine-600) 100%);
  box-shadow: 0 0 30px rgba(212, 175, 55, 0.5),
              inset 0 0 20px rgba(0, 0, 0, 0.5);
}

.character-portrait-inner {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  background: var(--color-shadow-950);
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  position: relative;
}

.character-portrait-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.character-portrait-level {
  position: absolute;
  bottom: -4px;
  right: -4px;
  width: 32px;
  height: 32px;
  background: radial-gradient(circle,
    var(--color-divine-500) 0%,
    var(--color-divine-700) 100%);
  border: 3px solid var(--color-shadow-950);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: var(--font-display);
  font-weight: var(--font-weight-bold);
  font-size: var(--font-size-sm);
  color: var(--color-shadow-950);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.6);
}

/* Spell/Ability Icon */
.ability-icon {
  position: relative;
  width: 64px;
  height: 64px;
  background: linear-gradient(135deg,
    var(--color-shadow-900) 0%,
    var(--color-shadow-800) 100%);
  border: 2px solid var(--color-shadow-700);
  border-radius: var(--radius-lg);
  cursor: pointer;
  transition: all var(--duration-base) var(--ease-out);
  overflow: hidden;
}

.ability-icon::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg,
    transparent 0%,
    rgba(139, 31, 255, 0.3) 100%);
  opacity: 0;
  transition: opacity var(--duration-base) var(--ease-out);
}

.ability-icon:hover {
  transform: translateY(-2px);
  border-color: var(--color-arcane-500);
  box-shadow: 0 5px 20px rgba(139, 31, 255, 0.4);
}

.ability-icon:hover::before {
  opacity: 1;
}

.ability-icon-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.ability-icon-cooldown {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: var(--font-display);
  font-size: var(--font-size-2xl);
  font-weight: var(--font-weight-bold);
  color: var(--color-shadow-400);
}

/* Enhanced Glass Morphism Card */
.card-glass {
  background: rgba(26, 22, 18, 0.4);
  backdrop-filter: blur(10px) saturate(180%);
  -webkit-backdrop-filter: blur(10px) saturate(180%);
  border: 1px solid rgba(212, 175, 55, 0.3);
  border-radius: var(--radius-xl);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4),
              inset 0 0 0 1px rgba(255, 255, 255, 0.1);
  position: relative;
  overflow: hidden;
}

.card-glass::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 1px;
  background: linear-gradient(90deg,
    transparent 0%,
    rgba(212, 175, 55, 0.5) 50%,
    transparent 100%);
}

/* ==========================================
   OPTIMIZED LOADING STATES
   ========================================== */

.skeleton-enhanced {
  position: relative;
  overflow: hidden;
  background: linear-gradient(90deg,
    var(--color-shadow-900) 0%,
    var(--color-shadow-800) 25%,
    var(--color-shadow-800) 50%,
    var(--color-shadow-800) 75%,
    var(--color-shadow-900) 100%);
  background-size: 400% 100%;
  animation: skeletonWave 2s linear infinite;
}

@keyframes skeletonWave {
  0% {
    background-position: 100% 0;
  }
  100% {
    background-position: -100% 0;
  }
}

/* ==========================================
   PERFORMANCE OPTIMIZATIONS
   ========================================== */

/* GPU-accelerated layers for complex animations */
.gpu-accelerated {
  transform: translateZ(0);
  will-change: transform;
  backface-visibility: hidden;
  perspective: 1000px;
}

/* Containment for layout optimization */
.contain-layout {
  contain: layout;
}

.contain-paint {
  contain: paint;
}

.contain-strict {
  contain: strict;
}

/* Reduce paint areas */
.isolate {
  isolation: isolate;
}

/* ==========================================
   RESPONSIVE ENHANCEMENTS
   ========================================== */

/* Touch-friendly hit targets */
@media (pointer: coarse) {
  .btn,
  .ability-icon,
  .side-btn {
    min-width: 44px;
    min-height: 44px;
  }
}

/* Landscape optimizations */
@media (orientation: landscape) and (max-height: 600px) {
  .top-hud {
    height: 60px;
  }

  .game-board {
    padding: 10px;
  }
}

/* Desktop and Large Screens (1025px and above) */
@media only screen and (min-width: 1025px) {
    .game-board {
        display: flex !important;
        flex-direction: row !important;
    }

    .left-sidebar {
        display: flex !important;
        flex-direction: column !important;
        visibility: visible !important;
        opacity: 1 !important;
        width: 80px !important;
        position: relative !important;
        left: auto !important;
    }

    .party-panel {
        display: flex !important;
        flex-direction: column !important;
        visibility: visible !important;
        opacity: 1 !important;
        width: 350px !important;
        position: relative !important;
        bottom: auto !important;
        height: auto !important;
    }

    .scenario-container {
        flex: 1 !important;
        height: auto !important;
    }
}

/* High DPI displays */
@media (-webkit-min-device-pixel-ratio: 2),
       (min-resolution: 192dpi) {
  .character-portrait,
  .ability-icon {
    image-rendering: crisp-edges;
    image-rendering: -webkit-optimize-contrast;
  }
}

/* ==========================================
   ACCESSIBILITY ENHANCEMENTS
   ========================================== */

/* Focus indicators for keyboard navigation */
.focus-visible:focus-visible {
  outline: 3px solid var(--color-arcane-400);
  outline-offset: 3px;
  box-shadow: 0 0 0 6px rgba(139, 31, 255, 0.2);
}

/* High contrast mode support */
@media (prefers-contrast: high) {
  :root {
    --color-text-primary: #ffffff;
    --color-text-secondary: #e5e5e5;
    --color-background: #000000;
    --color-surface: #1a1a1a;
  }

  .btn,
  .card {
    border-width: 2px;
  }
}

/* Reduced transparency for better readability */
@media (prefers-reduced-transparency) {
  .card-glass {
    background: rgba(26, 22, 18, 0.95);
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
  }
}
    
        /* === Onboarding System (Phase B) === */
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&family=Yrsa:wght@300;400;500;600&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Onboarding Overlay */
        .onboarding-overlay {
            position: fixed;
            inset: 0;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(5px);
        }

        /* Welcome Screen */
        .welcome-screen {
            display: none; /* Hide by default for testing */
            width: 90%;
            max-width: 600px;
            background: linear-gradient(135deg, rgba(42, 36, 30, 0.98) 0%, rgba(26, 22, 18, 0.98) 100%);
            border: 3px solid #D4AF37;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            animation: fadeInScale 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes fadeInScale {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .welcome-title {
            font-family: 'Cinzel', serif;
            font-size: 48px;
            font-weight: 900;
            background: linear-gradient(180deg, #FFD700, #B8860B, #FFD700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
            animation: glow 2s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% { filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.5)); }
            50% { filter: drop-shadow(0 0 30px rgba(255, 215, 0, 0.8)); }
        }

        .welcome-subtitle {
            font-size: 20px;
            color: #8B7355;
            margin-bottom: 30px;
            font-style: italic;
        }

        .character-selection {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 30px 0;
        }

        .character-card {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #8B7355;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .character-card:hover {
            border-color: #D4AF37;
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(212, 175, 55, 0.3);
        }

        .character-card.selected {
            border-color: #FFD700;
            background: rgba(212, 175, 55, 0.2);
        }

        .character-card.selected::before {
            content: '';
            position: absolute;
            top: 5px;
            right: 10px;
            color: #FFD700;
            font-size: 24px;
            font-weight: bold;
        }

        .character-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .character-name {
            font-family: 'Cinzel', serif;
            font-size: 16px;
            font-weight: 600;
            color: #FFD700;
            margin-bottom: 5px;
        }

        .character-class {
            font-size: 14px;
            color: #8B7355;
        }

        /* Tutorial Spotlight */
        .tutorial-spotlight {
            position: fixed;
            inset: 0;
            z-index: 9998;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .tutorial-spotlight.active {
            opacity: 1;
            pointer-events: all;
        }

        .spotlight-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
        }

        .spotlight-hole {
            position: absolute;
            border-radius: 10px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.8);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.8), 0 0 40px rgba(255, 215, 0, 0.5); }
            50% { box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.8), 0 0 60px rgba(255, 215, 0, 0.8); }
        }

        .tutorial-tooltip {
            position: absolute;
            background: linear-gradient(135deg, rgba(42, 36, 30, 0.98) 0%, rgba(26, 22, 18, 0.98) 100%);
            border: 2px solid #D4AF37;
            border-radius: 10px;
            padding: 20px;
            max-width: 350px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
            animation: fadeIn 0.3s ease;
        }

        .tutorial-tooltip::before {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: inherit;
            border: inherit;
            border-right: none;
            border-top: none;
            transform: rotate(45deg);
        }

        .tutorial-tooltip.top::before {
            bottom: -12px;
            left: 50%;
            transform: translateX(-50%) rotate(45deg);
        }

        .tutorial-tooltip.bottom::before {
            top: -12px;
            left: 50%;
            transform: translateX(-50%) rotate(225deg);
        }

        .tutorial-tooltip.left::before {
            right: -12px;
            top: 50%;
            transform: translateY(-50%) rotate(315deg);
        }

        .tutorial-tooltip.right::before {
            left: -12px;
            top: 50%;
            transform: translateY(-50%) rotate(135deg);
        }

        .tutorial-title {
            font-family: 'Cinzel', serif;
            font-size: 20px;
            font-weight: 700;
            color: #FFD700;
            margin-bottom: 10px;
        }

        .tutorial-text {
            font-size: 16px;
            line-height: 1.5;
            color: #D4AF37;
            margin-bottom: 15px;
        }

        .tutorial-progress {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 20px;
        }

        .progress-dots {
            display: flex;
            gap: 8px;
        }

        .progress-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #8B7355;
            transition: all 0.3s ease;
        }

        .progress-dot.active {
            background: #FFD700;
            transform: scale(1.3);
        }

        .tutorial-buttons {
            display: flex;
            gap: 10px;
        }

        .tutorial-btn {
            background: linear-gradient(135deg, #8B7355 0%, #D4AF37 100%);
            border: none;
            border-radius: 5px;
            padding: 8px 20px;
            font-family: 'Cinzel', serif;
            font-size: 14px;
            font-weight: 600;
            color: #2A1810;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tutorial-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(212, 175, 55, 0.4);
        }

        .tutorial-btn.skip {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #8B7355;
            color: #8B7355;
        }

        /* Interactive Hints */
        .hint-beacon {
            position: absolute;
            width: 20px;
            height: 20px;
            background: #FFD700;
            border-radius: 50%;
            animation: beaconPulse 2s ease-in-out infinite;
            cursor: help;
        }

        @keyframes beaconPulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 0 0 20px rgba(255, 215, 0, 0);
            }
        }

        .hint-popup {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #D4AF37;
            border-radius: 5px;
            padding: 10px 15px;
            font-size: 14px;
            color: #D4AF37;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 10001;
        }

        .hint-beacon:hover + .hint-popup {
            opacity: 1;
        }

        /* First Time User Experience */
        .ftue-checklist {
            position: fixed;
            top: 20px;
            left: 20px;
            background: linear-gradient(135deg, rgba(42, 36, 30, 0.95) 0%, rgba(26, 22, 18, 0.95) 100%);
            border: 2px solid #D4AF37;
            border-radius: 10px;
            padding: 20px;
            max-width: 300px;
            z-index: 1000;
            animation: slideInLeft 0.5s ease;
        }

        @keyframes slideInLeft {
            0% { transform: translateX(-100%); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }

        .ftue-title {
            font-family: 'Cinzel', serif;
            font-size: 18px;
            font-weight: 700;
            color: #FFD700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ftue-progress {
            width: 100%;
            height: 6px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .ftue-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #D4AF37, #FFD700);
            transition: width 0.5s ease;
        }

        .ftue-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(139, 115, 85, 0.3);
            transition: all 0.3s ease;
        }

        .ftue-item:last-child {
            border-bottom: none;
        }

        .ftue-item.completed {
            opacity: 0.5;
        }

        .ftue-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #8B7355;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .ftue-item.completed .ftue-checkbox {
            background: #FFD700;
            border-color: #FFD700;
        }

        .ftue-item.completed .ftue-checkbox::after {
            content: '';
            color: #2A1810;
            font-weight: bold;
        }

        .ftue-text {
            flex: 1;
            font-size: 14px;
            color: #D4AF37;
        }

        .ftue-item.completed .ftue-text {
            text-decoration: line-through;
            color: #8B7355;
        }

        /* Animated Arrow Pointer */
        .pointer-arrow {
            position: absolute;
            width: 40px;
            height: 40px;
            animation: point 1s ease-in-out infinite;
            z-index: 10002;
            pointer-events: none;
        }

        @keyframes point {
            0%, 100% { transform: translate(0, 0) rotate(45deg); }
            50% { transform: translate(-10px, 10px) rotate(45deg); }
        }

        .pointer-arrow svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.8));
        }

        /* Start Button */
        .start-adventure-btn {
            background: linear-gradient(135deg, #8B7355 0%, #FFD700 50%, #8B7355 100%);
            background-size: 200% 100%;
            border: none;
            border-radius: 8px;
            padding: 15px 40px;
            font-family: 'Cinzel', serif;
            font-size: 20px;
            font-weight: 700;
            color: #2A1810;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0% { background-position: 0% center; }
            50% { background-position: 100% center; }
            100% { background-position: 0% center; }
        }

        .start-adventure-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.5);
        }

        .start-adventure-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            animation: none;
        }
    
        /* === Retention System (Phase B) === */
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&family=Yrsa:wght@300;400;500;600&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Daily Login Rewards */
        .daily-rewards-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
        }

        .daily-rewards-content {
            background: linear-gradient(135deg, rgba(42, 36, 30, 0.98) 0%, rgba(26, 22, 18, 0.98) 100%);
            border: 3px solid #D4AF37;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            animation: bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes bounceIn {
            0% { transform: scale(0); opacity: 0; }
            60% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        .daily-rewards-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .daily-rewards-title {
            font-family: 'Cinzel', serif;
            font-size: 32px;
            font-weight: 900;
            background: linear-gradient(180deg, #FFD700, #B8860B);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .streak-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 20px;
            color: #FFD700;
        }

        .streak-flame {
            font-size: 28px;
            animation: flame 1s ease-in-out infinite;
        }

        @keyframes flame {
            0%, 100% { transform: scale(1) translateY(0); }
            50% { transform: scale(1.1) translateY(-2px); }
        }

        .daily-calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .day-slot {
            aspect-ratio: 1;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #8B7355;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .day-slot.claimed {
            background: rgba(0, 255, 0, 0.1);
            border-color: #00FF00;
        }

        .day-slot.today {
            border-color: #FFD700;
            animation: todayPulse 2s ease-in-out infinite;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        @keyframes todayPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .day-slot.future {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .day-label {
            font-family: 'Cinzel', serif;
            font-size: 10px;
            color: #8B7355;
            margin-bottom: 5px;
        }

        .day-reward {
            font-size: 24px;
        }

        .day-amount {
            font-size: 12px;
            color: #D4AF37;
            margin-top: 5px;
        }

        .claim-button {
            background: linear-gradient(135deg, #8B7355, #FFD700, #8B7355);
            background-size: 200% 100%;
            border: none;
            border-radius: 8px;
            padding: 12px 30px;
            font-family: 'Cinzel', serif;
            font-size: 18px;
            font-weight: 700;
            color: #2A1810;
            cursor: pointer;
            animation: shimmer 2s ease-in-out infinite;
            transition: transform 0.3s ease;
        }

        @keyframes shimmer {
            0% { background-position: 0% center; }
            100% { background-position: 200% center; }
        }

        .claim-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.5);
        }

        .claim-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            animation: none;
        }

        /* Battle Pass System */
        .battle-pass-container {
            background: linear-gradient(135deg, rgba(42, 36, 30, 0.95) 0%, rgba(26, 22, 18, 0.95) 100%);
            border: 3px solid #8B7355;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
        }

        .battle-pass-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .season-title {
            font-family: 'Cinzel', serif;
            font-size: 24px;
            font-weight: 700;
            color: #FFD700;
        }

        .season-timer {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 15px;
            border-radius: 5px;
        }

        .timer-icon {
            color: #FFD700;
        }

        .timer-text {
            font-size: 14px;
            color: #D4AF37;
        }

        .tier-progress {
            margin-bottom: 25px;
        }

        .tier-bar {
            height: 30px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #3E342A;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .tier-fill {
            height: 100%;
            background: linear-gradient(90deg, #9370DB, #DDA0DD, #FFD700);
            width: 35%;
            transition: width 0.5s ease;
            position: relative;
            overflow: hidden;
        }

        .tier-fill::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shine 2s ease-in-out infinite;
        }

        @keyframes shine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .tier-info {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Cinzel', serif;
            font-size: 14px;
            font-weight: 700;
            color: white;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
        }

        .reward-track {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding: 10px 0;
        }

        .reward-tier {
            min-width: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .tier-node {
            width: 60px;
            height: 60px;
            background: rgba(0, 0, 0, 0.5);
            border: 3px solid #8B7355;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            position: relative;
            transition: all 0.3s ease;
        }

        .tier-node.unlocked {
            background: rgba(255, 215, 0, 0.2);
            border-color: #FFD700;
            animation: unlockPop 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes unlockPop {
            0% { transform: scale(0); }
            60% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .tier-node.premium {
            border-color: #9370DB;
            background: rgba(147, 112, 219, 0.2);
        }

        .tier-number {
            position: absolute;
            bottom: -20px;
            font-family: 'Cinzel', serif;
            font-size: 12px;
            color: #8B7355;
        }

        /* Achievement System */
        .achievement-popup {
            position: fixed;
            top: 20px;
            right: -400px;
            width: 350px;
            background: linear-gradient(135deg, rgba(42, 36, 30, 0.98) 0%, rgba(26, 22, 18, 0.98) 100%);
            border: 3px solid #FFD700;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
            transition: right 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 10001;
        }

        .achievement-popup.show {
            right: 20px;
        }

        .achievement-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .achievement-icon {
            width: 50px;
            height: 50px;
            background: radial-gradient(circle, #FFD700, #B8860B);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .achievement-label {
            font-family: 'Cinzel', serif;
            font-size: 12px;
            color: #8B7355;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .achievement-title {
            font-family: 'Cinzel', serif;
            font-size: 18px;
            font-weight: 700;
            color: #FFD700;
        }

        .achievement-desc {
            font-size: 14px;
            color: #D4AF37;
            margin-top: 10px;
        }

        .achievement-reward {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #8B7355;
        }

        /* Leaderboard Widget */
        .leaderboard-widget {
            position: fixed;
            left: 20px;
            top: 100px;
            width: 250px;
            background: linear-gradient(135deg, rgba(42, 36, 30, 0.95) 0%, rgba(26, 22, 18, 0.95) 100%);
            border: 2px solid #D4AF37;
            border-radius: 10px;
            padding: 15px;
            z-index: 100;
        }

        .leaderboard-title {
            font-family: 'Cinzel', serif;
            font-size: 16px;
            font-weight: 700;
            color: #FFD700;
            text-align: center;
            margin-bottom: 15px;
        }

        .leaderboard-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .leaderboard-item.self {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid #FFD700;
        }

        .leaderboard-rank {
            font-family: 'Cinzel', serif;
            font-weight: 700;
            width: 25px;
            text-align: center;
        }

        .rank-1 { color: #FFD700; }
        .rank-2 { color: #C0C0C0; }
        .rank-3 { color: #CD7F32; }

        .leaderboard-name {
            flex: 1;
            font-size: 14px;
        }

        .leaderboard-score {
            font-family: 'Cinzel', serif;
            font-size: 12px;
            color: #D4AF37;
        }

        /* Event Banner */
        .event-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(90deg, #8B0000, #DC143C, #8B0000);
            background-size: 200% 100%;
            animation: eventPulse 3s ease-in-out infinite;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            box-shadow: 0 5px 20px rgba(220, 20, 60, 0.5);
        }

        @keyframes eventPulse {
            0%, 100% { background-position: 0% center; }
            50% { background-position: 100% center; }
        }

        .event-content {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .event-icon {
            font-size: 32px;
            animation: bounce 1s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .event-text {
            font-family: 'Cinzel', serif;
            font-size: 18px;
            font-weight: 700;
            color: #FFD700;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .event-timer {
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            color: #FFD700;
        }
    </style>

    <!-- Clean Minimal Header -->
    <div class="map-header">
        <div class="map-title">Realm of Arcanum</div>
        <button class="map-close" onclick="closeAllOverlays()"></button>
    </div>

    <!-- Full Viewport Canvas -->
    <div class="map-viewport">
        <canvas id="world-map-canvas"></canvas>

        <!-- Translucent UI Overlays -->

        <!-- Filter Panel (Top-Left) - Simplified -->
        <div class="filter-panel">
            <button class="filter-btn active" data-filter="all"> All</button>
            <button class="filter-btn" data-filter="quests"> Quests</button>
            <button class="filter-btn" data-filter="cities"> Cities</button>
        </div>

        <!-- Zoom Controls (Top-Right) -->
        <div class="zoom-panel">
            <button class="zoom-btn" id="zoom-in">+ Zoom In</button>
            <button class="zoom-btn" id="zoom-out"> Zoom Out</button>
            <button class="zoom-btn" id="reset-zoom"> Reset View</button>
        </div>

        <!-- Minimap (Bottom-Right) -->
        <div class="minimap">
            <canvas id="minimap-canvas"></canvas>
        </div>

        <!-- Legend (Bottom-Left) -->
        <div class="legend-panel">
            <div class="legend-title">Legend</div>
            <div class="legend-item">
                <div class="legend-icon" style="background: #D4AF37;"></div>
                <span>Major City</span>
            </div>
            <div class="legend-item">
                <div class="legend-icon" style="background: #FFD700;"></div>
                <span>Quest Location</span>
            </div>
            <div class="legend-item">
                <div class="legend-icon" style="background: #8B7355;"></div>
                <span>Merchant</span>
            </div>
            <div class="legend-item">
                <div class="legend-icon" style="background: #CD5C5C;"></div>
                <span>Dungeon</span>
            </div>
        </div>

        <!-- Dynamic Tooltip -->
        <div class="location-tooltip"></div>
    </div>
</div>

<script>
    // ===================================
    // COMPLETELY NEW FANTASY MAP SYSTEM
    // ===================================
    const fantasyMapSystem = {
        // Map Configuration
        canvas: null,
        ctx: null,
        minimapCanvas: null,
        minimapCtx: null,
        tooltip: null,

        // Viewport state
        viewportWidth: 0,
        viewportHeight: 0,
        scale: 1,
        offsetX: 0,
        offsetY: 0,
        isDragging: false,
        lastX: 0,
        lastY: 0,

        // Animation
        animationId: null,
        time: 0,

        // Filters
        activeFilter: 'all',

        // World locations with enhanced data - SIMPLIFIED FOR ACCESSIBILITY
        locations: [
            // MAJOR CITIES (Only most important visible by default)
            {
                id: 'valdria',
                name: 'Valdria',
                type: 'city',
                x: 0.5, y: 0.5, // Central position
                icon: '',
                color: '#D4AF37',
                description: 'The grand capital city',
                discovered: true,
                visited: true,
                current: true,
                priority: 1, // High priority - always visible
                connections: ['warehouse', 'trading_post', 'northgate', 'eastport', 'westkeep']
            },
            {
                id: 'northgate',
                name: 'Northgate Keep',
                type: 'city',
                x: 0.5, y: 0.25,
                icon: '',
                color: '#D4AF37',
                description: 'Northern fortress city',
                discovered: true,
                visited: false,
                priority: 2, // Medium priority - visible at medium zoom
                connections: ['valdria', 'mountains', 'frostholm', 'crystal_mine']
            },
            {
                id: 'eastport',
                name: 'Eastport Harbor',
                type: 'city',
                x: 0.75, y: 0.45,
                icon: '',
                color: '#4A90E2',
                description: 'Major trading port',
                discovered: true,
                visited: true,
                priority: 2, // Medium priority
                connections: ['valdria', 'lighthouse', 'market', 'forest']
            },
            {
                id: 'westkeep',
                name: 'Westkeep Citadel',
                type: 'city',
                x: 0.25, y: 0.4,
                icon: '',
                color: '#8B4513',
                description: 'Western military stronghold',
                discovered: true,
                visited: false,
                priority: 3, // Low priority - only visible when zoomed in
                connections: ['valdria', 'village', 'iron_mine', 'battlefield']
            },
            {
                id: 'frostholm',
                name: 'Frostholm',
                type: 'city',
                x: 0.35, y: 0.15,
                icon: '',
                color: '#87CEEB',
                description: 'Snow-covered northern town',
                discovered: true,
                visited: false,
                priority: 3, // Low priority
                connections: ['northgate', 'ice_caves', 'mountains']
            },

            // QUEST OBJECTIVES (High priority - always visible)
            {
                id: 'warehouse',
                name: "Duke's Warehouse",
                type: 'quest',
                x: 0.58, y: 0.48,
                icon: '',
                color: '#FFD700',
                description: 'Current quest: Investigate warehouse',
                discovered: true,
                visited: false,
                quest: true,
                priority: 1, // High priority - quest location
                connections: ['valdria', 'forest', 'abandoned_mill']
            },
            {
                id: 'abandoned_mill',
                name: 'Abandoned Mill',
                type: 'quest',
                x: 0.62, y: 0.38,
                icon: '',
                color: '#FFD700',
                description: 'Quest: Find missing villagers',
                discovered: true,
                visited: false,
                quest: true,
                priority: 1, // High priority - quest location
                connections: ['warehouse', 'eastport']
            },
            {
                id: 'lighthouse',
                name: 'Haunted Lighthouse',
                type: 'quest',
                x: 0.85, y: 0.35,
                icon: '',
                color: '#FF6B6B',
                description: 'Quest: Stop the ghost ship',
                discovered: true,
                visited: false,
                quest: true,
                priority: 2, // Medium priority - secondary quest
                connections: ['eastport', 'ruins']
            },

            // SHOPS & TRADING POSTS (Low priority - visible when zoomed in)
            {
                id: 'trading_post',
                name: 'Southern Trading Post',
                type: 'shop',
                x: 0.45, y: 0.65,
                icon: '',
                color: '#8B7355',
                description: 'General goods and supplies',
                discovered: true,
                visited: true,
                priority: 2, // Medium priority - visited location
                connections: ['valdria', 'village', 'crossroads']
            },
            {
                id: 'market',
                name: 'Grand Bazaar',
                type: 'shop',
                x: 0.68, y: 0.52,
                icon: '',
                color: '#FFB347',
                description: 'Exotic items and rare artifacts',
                discovered: true,
                visited: false,
                priority: 3, // Low priority
                connections: ['eastport', 'valdria', 'forest']
            },
            {
                id: 'crossroads',
                name: 'Crossroads Inn',
                type: 'shop',
                x: 0.4, y: 0.55,
                icon: '',
                color: '#8B4513',
                description: 'Rest and resupply point',
                discovered: true,
                visited: true,
                priority: 3, // Low priority
                connections: ['trading_post', 'valdria', 'westkeep']
            },

            // DUNGEONS & DANGEROUS AREAS (Mix of discovered/undiscovered)
            {
                id: 'forest',
                name: 'Forest of Whispers',
                type: 'dungeon',
                x: 0.72, y: 0.58,
                icon: '',
                color: '#4A6741',
                description: 'Ancient dark forest - Level 5-8',
                discovered: true,
                visited: false,
                priority: 3, // Low priority - only visible when zoomed
                connections: ['warehouse', 'ruins', 'market', 'spider_cave']
            },
            {
                id: 'ruins',
                name: 'Ancient Ruins',
                type: 'dungeon',
                x: 0.82, y: 0.28,
                icon: '',
                color: '#CD5C5C',
                description: 'Forgotten temple - Level 10-15',
                discovered: true,
                visited: false,
                priority: 3, // Low priority - only visible when zoomed
                connections: ['forest', 'mountains', 'lighthouse']
            },
            {
                id: 'mountains',
                name: "Dragon's Peak",
                type: 'dungeon',
                x: 0.65, y: 0.15,
                icon: '',
                color: '#6B5745',
                description: 'Dragon lair - Level 15-20',
                discovered: false,
                visited: false,
                priority: 3, // Low priority - only visible when zoomed
                connections: ['northgate', 'ruins', 'frostholm']
            },
            {
                id: 'spider_cave',
                name: 'Spider Cave',
                type: 'dungeon',
                x: 0.78, y: 0.65,
                icon: '',
                color: '#4B0082',
                description: 'Giant spider nest - Level 3-5',
                discovered: true,
                visited: false,
                priority: 3, // Low priority - only visible when zoomed
                connections: ['forest', 'swamp']
            },
            {
                id: 'ice_caves',
                name: 'Frozen Caverns',
                type: 'dungeon',
                x: 0.3, y: 0.08,
                icon: '',
                color: '#00CED1',
                description: 'Ice elemental domain - Level 8-12',
                discovered: false,
                visited: false,
                priority: 3, // Low priority - only visible when zoomed
                connections: ['frostholm']
            },

            // VILLAGES & SETTLEMENTS (All discovered)
            {
                id: 'village',
                name: 'Riverside Village',
                type: 'city',
                x: 0.3, y: 0.58,
                icon: '',
                color: '#4A90E2',
                description: 'Peaceful fishing village',
                discovered: true,
                visited: false,
                priority: 3, // Low priority - only visible when zoomed
                connections: ['trading_post', 'westkeep', 'farm']
            },
            {
                id: 'farm',
                name: 'Greenhill Farm',
                type: 'city',
                x: 0.35, y: 0.7,
                icon: '',
                color: '#90EE90',
                description: 'Agricultural settlement',
                discovered: true,
                visited: false,
                priority: 3, // Low priority - only visible when zoomed
                connections: ['village', 'trading_post']
            },

            // SPECIAL LOCATIONS & LANDMARKS (Mix of discovered/undiscovered)
            {
                id: 'crystal_mine',
                name: 'Crystal Mine',
                type: 'dungeon',
                x: 0.55, y: 0.32,
                icon: '',
                color: '#9370DB',
                description: 'Magical crystal deposits',
                discovered: true,
                visited: false,
                priority: 3, // Low priority - only visible when zoomed
                connections: ['northgate', 'valdria']
            },
            {
                id: 'iron_mine',
                name: 'Iron Mine',
                type: 'dungeon',
                x: 0.18, y: 0.35,
                icon: '',
                color: '#696969',
                description: 'Dwarven mining operation',
                discovered: true,
                visited: false,
                priority: 3, // Low priority - only visible when zoomed
                connections: ['westkeep']
            },
            {
                id: 'battlefield',
                name: 'Ancient Battlefield',
                type: 'dungeon',
                x: 0.15, y: 0.48,
                icon: '',
                color: '#8B0000',
                description: 'Haunted war grounds',
                discovered: true,
                visited: false,
                priority: 3, // Low priority - only visible when zoomed
                connections: ['westkeep']
            },
            {
                id: 'swamp',
                name: 'Murky Swamp',
                type: 'dungeon',
                x: 0.85, y: 0.72,
                icon: '',
                color: '#556B2F',
                description: 'Toxic marshlands - Level 6-9',
                discovered: false,
                visited: false,
                priority: 3, // Low priority - only visible when zoomed
                connections: ['spider_cave']
            },
            {
                id: 'tower',
                name: "Wizard's Tower",
                type: 'quest',
                x: 0.42, y: 0.35,
                icon: '',
                color: '#9932CC',
                description: 'Mysterious magical tower',
                discovered: true,
                visited: false,
                priority: 3, // Low priority - only visible when zoomed
                connections: ['valdria', 'crystal_mine']
            }
        ],

        // Initialize the new fantasy map system
        init() {
            console.log('Initializing Fantasy Map System...');

            this.canvas = document.getElementById('world-map-canvas');
            this.minimapCanvas = document.getElementById('minimap-canvas');
            this.tooltip = document.querySelector('.location-tooltip');

            if (!this.canvas || !this.minimapCanvas) {
                console.error('Canvas elements not found');
                return;
            }

            this.ctx = this.canvas.getContext('2d');
            this.minimapCtx = this.minimapCanvas.getContext('2d');

            // Setup canvas dimensions
            this.resizeCanvas();

            // Setup event listeners
            this.setupEventListeners();

            // Set initial view - centered on Valdria with zoom
            this.scale = 1.2;  // Initial zoom to show detail
            this.offsetX = -100;  // Center adjustment
            this.offsetY = -50;   // Center adjustment

            // Start animation loop
            this.startAnimation();

            // Initial render
            this.render();
        },

        // Resize canvas to fill viewport
        resizeCanvas() {
            // Get the actual viewport dimensions
            const viewport = this.canvas.parentElement;
            const rect = viewport.getBoundingClientRect();

            this.viewportWidth = Math.max(800, rect.width || window.innerWidth);
            this.viewportHeight = Math.max(600, rect.height || window.innerHeight);

            // Set canvas dimensions
            this.canvas.width = this.viewportWidth;
            this.canvas.height = this.viewportHeight;

            // Ensure canvas fills its container
            this.canvas.style.width = '100%';
            this.canvas.style.height = '100%';

            // Setup minimap
            this.minimapCanvas.width = 200;
            this.minimapCanvas.height = 150;

            console.log(`Canvas resized to: ${this.canvas.width}x${this.canvas.height}`);
        },

        // Setup event listeners
        setupEventListeners() {
            // Canvas interactions
            this.canvas.addEventListener('mousedown', (e) => this.onMouseDown(e));
            this.canvas.addEventListener('mousemove', (e) => this.onMouseMove(e));
            this.canvas.addEventListener('mouseup', () => this.onMouseUp());
            this.canvas.addEventListener('mouseleave', () => this.onMouseUp());
            this.canvas.addEventListener('wheel', (e) => this.onWheel(e));

            // Filter buttons
            document.querySelectorAll('.filter-btn[data-filter]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn[data-filter]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    this.activeFilter = btn.dataset.filter;
                    this.render();
                });
            });

            // Zoom controls
            document.getElementById('zoom-in')?.addEventListener('click', () => {
                this.scale = Math.min(this.scale * 1.2, 3);
                this.render();
            });

            document.getElementById('zoom-out')?.addEventListener('click', () => {
                this.scale = Math.max(this.scale / 1.2, 0.5);
                this.render();
            });

            document.getElementById('reset-zoom')?.addEventListener('click', () => {
                this.scale = 1;
                this.offsetX = 0;
                this.offsetY = 0;
                this.render();
            });

            // Window resize
            window.addEventListener('resize', () => this.resizeCanvas());
        },

        // Mouse event handlers
        onMouseDown(e) {
            // Check if clicking on a quest location first
            const rect = this.canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) / this.scale - this.offsetX;
            const y = (e.clientY - rect.top) / this.scale - this.offsetY;

            const clickedLocation = this.getLocationAt(x, y);
            if (clickedLocation && clickedLocation.type === 'quest') {
                // Check if quest map system is loaded
                if (window.questMapRenderer && window.questMaps && window.questMaps[clickedLocation.id]) {
                    window.questMapRenderer.open(clickedLocation.id);
                    return; // Don't start dragging if clicking a quest
                }
            }

            // Normal drag behavior
            this.isDragging = true;
            this.lastX = e.clientX;
            this.lastY = e.clientY;
            this.canvas.style.cursor = 'grabbing';
        },

        onMouseMove(e) {
            const rect = this.canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            if (this.isDragging) {
                const dx = e.clientX - this.lastX;
                const dy = e.clientY - this.lastY;
                this.offsetX += dx;
                this.offsetY += dy;
                this.lastX = e.clientX;
                this.lastY = e.clientY;
                this.render();
            } else {
                // Check for location hover
                const hoveredLoc = this.getLocationAt(x, y);
                if (hoveredLoc) {
                    this.canvas.style.cursor = 'pointer';
                    this.showTooltip(hoveredLoc, x, y);
                } else {
                    this.canvas.style.cursor = 'grab';
                    this.hideTooltip();
                }
            }
        },

        onMouseUp() {
            this.isDragging = false;
            this.canvas.style.cursor = 'grab';
        },

        onWheel(e) {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            const newScale = this.scale * delta;

            if (newScale >= 0.5 && newScale <= 3) {
                this.scale = newScale;
                this.render();
            }
        },

        // Get location at coordinates
        getLocationAt(x, y) {
            for (const loc of this.locations) {
                if (!this.shouldShowLocation(loc)) continue;

                const locX = loc.x * this.viewportWidth * this.scale + this.offsetX;
                const locY = loc.y * this.viewportHeight * this.scale + this.offsetY;
                const dist = Math.sqrt((x - locX) ** 2 + (y - locY) ** 2);

                if (dist < 25 * this.scale) {
                    return loc;
                }
            }
            return null;
        },

        // Tooltip management
        showTooltip(location, x, y) {
            if (this.tooltip) {
                this.tooltip.textContent = `${location.name} - ${location.description}`;
                this.tooltip.style.left = x + 'px';
                this.tooltip.style.top = (y - 30) + 'px';
                this.tooltip.classList.add('visible');
            }
        },

        hideTooltip() {
            if (this.tooltip) {
                this.tooltip.classList.remove('visible');
            }
        },

        // Check if location should be shown - SIMPLIFIED FOR ACCESSIBILITY
        shouldShowLocation(loc) {
            // Never show undiscovered locations
            if (!loc.discovered) return false;

            // Apply filter first
            if (this.activeFilter && this.activeFilter !== 'all') {
                if (this.activeFilter === 'cities' && loc.type !== 'city') return false;
                if (this.activeFilter === 'quests' && !loc.quest) return false;
                if (this.activeFilter === 'shops' && loc.type !== 'shop') return false;
                if (this.activeFilter === 'dungeons' && loc.type !== 'dungeon') return false;
            }

            // Priority-based visibility (for reducing clutter)
            const priority = loc.priority || 3; // Default to low priority

            // At default zoom (1.0-1.2), show only high priority locations
            if (this.scale <= 1.2) {
                return priority === 1; // Only show priority 1 (8-10 locations)
            }
            // At medium zoom (1.2-2.0), show high and medium priority
            else if (this.scale <= 2.0) {
                return priority <= 2; // Show priority 1 and 2
            }
            // At high zoom (>2.0), show all locations
            else {
                return true; // Show all discovered locations
            }
        },

        // Main render method
        render() {
            const ctx = this.ctx;
            const width = this.canvas.width;
            const height = this.canvas.height;

            // Clear canvas
            ctx.clearRect(0, 0, width, height);

            // Draw parchment background
            this.drawParchmentBackground(ctx, width, height);

            // Apply transformations
            ctx.save();
            ctx.translate(this.offsetX, this.offsetY);
            ctx.scale(this.scale, this.scale);

            // Draw map elements
            this.drawTerrain(ctx, width, height);
            this.drawPaths(ctx, width, height);
            this.drawLocations(ctx, width, height);
            this.drawFogOfWar(ctx, width, height);

            ctx.restore();

            // Draw minimap
            this.renderMinimap();
        },

        // Draw beautiful parchment background with enhanced details
        drawParchmentBackground(ctx, width, height) {
            // Create gradient background
            const gradient = ctx.createRadialGradient(
                width/2, height/2, 0,
                width/2, height/2, Math.max(width, height) * 0.8
            );
            gradient.addColorStop(0, '#F4E9DC');
            gradient.addColorStop(0.3, '#E8D7C3');
            gradient.addColorStop(0.6, '#D4C4B0');
            gradient.addColorStop(0.9, '#C8B49C');
            gradient.addColorStop(1, '#B8A08C');

            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, width, height);

            // Add grid lines for map feel
            ctx.strokeStyle = 'rgba(139, 115, 85, 0.1)';
            ctx.lineWidth = 1;
            for (let x = 0; x < width; x += 50) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, height);
                ctx.stroke();
            }
            for (let y = 0; y < height; y += 50) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
                ctx.stroke();
            }

            // Add parchment texture and aging spots
            ctx.globalAlpha = 0.15;
            for (let i = 0; i < 40; i++) {
                const x = Math.random() * width;
                const y = Math.random() * height;
                const r = Math.random() * 60 + 20;
                const grad = ctx.createRadialGradient(x, y, 0, x, y, r);
                grad.addColorStop(0, 'rgba(139, 115, 85, 0.3)');
                grad.addColorStop(1, 'transparent');
                ctx.fillStyle = grad;
                ctx.beginPath();
                ctx.arc(x, y, r, 0, Math.PI * 2);
                ctx.fill();
            }

            // Draw decorative border frame
            ctx.globalAlpha = 1;
            ctx.strokeStyle = '#8B7355';
            ctx.lineWidth = 8;
            ctx.strokeRect(10, 10, width - 20, height - 20);

            // Inner border
            ctx.lineWidth = 2;
            ctx.strokeRect(20, 20, width - 40, height - 40);

            // Draw compass rose in corner
            this.drawCompass(ctx, width - 120, height - 120, 40);

            ctx.globalAlpha = 1;
        },

        // Draw decorative compass rose
        drawCompass(ctx, x, y, size) {
            ctx.save();
            ctx.translate(x, y);

            // Outer circle
            ctx.strokeStyle = '#8B7355';
            ctx.fillStyle = 'rgba(244, 233, 220, 0.8)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(0, 0, size, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // N, S, E, W points
            const directions = ['N', 'E', 'S', 'W'];
            const angles = [0, Math.PI/2, Math.PI, Math.PI * 1.5];

            ctx.fillStyle = '#8B7355';
            ctx.font = `bold ${size/3}px serif`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            directions.forEach((dir, i) => {
                const angle = angles[i];
                const px = Math.sin(angle) * (size * 0.7);
                const py = -Math.cos(angle) * (size * 0.7);
                ctx.fillText(dir, px, py);
            });

            // Center decoration
            ctx.fillStyle = '#D4AF37';
            ctx.beginPath();
            ctx.arc(0, 0, size/5, 0, Math.PI * 2);
            ctx.fill();

            ctx.restore();
        },

        // Draw terrain features - SIMPLIFIED for less visual clutter
        drawTerrain(ctx, width, height) {
            ctx.globalAlpha = 0.1; // Even more subtle

            // Fewer, simpler mountain ranges
            ctx.fillStyle = 'rgba(107, 87, 69, 0.5)';
            const mountainCoords = [
                [0.65, 0.15, 60],
                [0.35, 0.10, 50],
                [0.82, 0.25, 45]
            ];
            mountainCoords.forEach(([x, y, size]) => {
                this.drawMountain(ctx, x * width, y * height, size * this.scale);
            });

            // Fewer, simpler forests
            ctx.fillStyle = 'rgba(74, 103, 65, 0.3)'; // More transparent
            const forestCoords = [
                [0.72, 0.58, 70],
                [0.15, 0.45, 50],
                [0.35, 0.65, 40]
            ];
            forestCoords.forEach(([x, y, size]) => {
                this.drawForest(ctx, x * width, y * height, size * this.scale);
            });

            // Main river system
            ctx.strokeStyle = '#4A90E2';
            ctx.lineWidth = 4 * this.scale;
            ctx.globalAlpha = 0.3;

            // Main river
            ctx.beginPath();
            ctx.moveTo(0.15 * width, 0.2 * height);
            ctx.bezierCurveTo(
                0.25 * width, 0.35 * height,
                0.35 * width, 0.50 * height,
                0.45 * width, 0.75 * height
            );
            ctx.stroke();

            // Tributary
            ctx.lineWidth = 3 * this.scale;
            ctx.beginPath();
            ctx.moveTo(0.35 * width, 0.50 * height);
            ctx.quadraticCurveTo(0.45 * width, 0.55 * height, 0.55 * width, 0.60 * height);
            ctx.stroke();

            // Lakes
            ctx.fillStyle = 'rgba(74, 144, 226, 0.2)';
            ctx.beginPath();
            ctx.arc(0.25 * width, 0.65 * height, 30 * this.scale, 0, Math.PI * 2);
            ctx.fill();

            // Hills
            ctx.fillStyle = 'rgba(139, 115, 85, 0.15)';
            const hillCoords = [
                [0.45, 0.40, 40],
                [0.48, 0.42, 35],
                [0.55, 0.35, 38],
                [0.30, 0.30, 35]
            ];
            hillCoords.forEach(([x, y, size]) => {
                ctx.beginPath();
                ctx.arc(x * width, y * height, size * this.scale, 0, Math.PI * 2);
                ctx.fill();
            });

            ctx.globalAlpha = 1;
        },

        drawMountain(ctx, x, y, size) {
            ctx.beginPath();
            ctx.moveTo(x - size, y + size);
            ctx.lineTo(x, y - size);
            ctx.lineTo(x + size, y + size);
            ctx.closePath();
            ctx.fill();
        },

        drawForest(ctx, x, y, radius) {
            const gradient = ctx.createRadialGradient(x, y, 0, x, y, radius);
            gradient.addColorStop(0, 'rgba(74, 103, 65, 0.4)');
            gradient.addColorStop(1, 'transparent');
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(x, y, radius, 0, Math.PI * 2);
            ctx.fill();
        },

        // Draw paths between locations - ENHANCED with different path types
        drawPaths(ctx, width, height) {
            // Draw all discovered paths first (main roads)
            ctx.strokeStyle = '#8B7355';
            ctx.lineWidth = 4 * this.scale;
            ctx.globalAlpha = 0.4;
            ctx.setLineDash([]);

            // Main roads between cities
            const cityConnections = [
                ['valdria', 'northgate'],
                ['valdria', 'eastport'],
                ['valdria', 'westkeep'],
                ['valdria', 'trading_post']
            ];

            cityConnections.forEach(([fromId, toId]) => {
                const from = this.locations.find(l => l.id === fromId);
                const to = this.locations.find(l => l.id === toId);
                if (from && to && from.discovered && to.discovered) {
                    ctx.strokeStyle = '#8B7355';
                    ctx.lineWidth = 5 * this.scale;
                    ctx.beginPath();
                    ctx.moveTo(from.x * width, from.y * height);
                    ctx.lineTo(to.x * width, to.y * height);
                    ctx.stroke();
                }
            });

            // Secondary paths (dotted)
            ctx.strokeStyle = '#A0826D';
            ctx.lineWidth = 3 * this.scale;
            ctx.globalAlpha = 0.3;
            ctx.setLineDash([8, 4]);

            this.locations.forEach(loc => {
                if (loc.discovered && loc.connections) {
                    loc.connections.forEach(connectionId => {
                        const target = this.locations.find(l => l.id === connectionId);
                        if (target && target.discovered) {
                            // Skip if already drawn as main road
                            const isMainRoad = cityConnections.some(([from, to]) =>
                                (from === loc.id && to === target.id) ||
                                (to === loc.id && from === target.id)
                            );

                            if (!isMainRoad) {
                                ctx.beginPath();
                                ctx.moveTo(loc.x * width, loc.y * height);
                                ctx.lineTo(target.x * width, target.y * height);
                                ctx.stroke();
                            }
                        }
                    });
                }
            });

            ctx.setLineDash([]);
            ctx.globalAlpha = 1;

            // Animated quest paths (golden glow)
            const current = this.locations.find(l => l.current);
            const quests = this.locations.filter(l => l.quest);

            quests.forEach(quest => {
                if (current && quest) {
                    const gradient = ctx.createLinearGradient(
                        current.x * width, current.y * height,
                        quest.x * width, quest.y * height
                    );
                    const offset = (this.time % 100) / 100;
                    gradient.addColorStop(Math.max(0, offset - 0.2), 'transparent');
                    gradient.addColorStop(offset, '#FFD700');
                    gradient.addColorStop(Math.min(1, offset + 0.2), 'transparent');

                    ctx.strokeStyle = gradient;
                    ctx.lineWidth = 6 * this.scale;
                    ctx.shadowColor = 'rgba(255, 215, 0, 0.8)';
                    ctx.shadowBlur = 20;
                    ctx.beginPath();
                    ctx.moveTo(current.x * width, current.y * height);
                    ctx.lineTo(quest.x * width, quest.y * height);
                    ctx.stroke();
                    ctx.shadowBlur = 0;
                }
            });
        },

        // Draw locations - ENHANCED with larger markers and visible names
        drawLocations(ctx, width, height) {
            this.locations.forEach(loc => {
                if (!this.shouldShowLocation(loc)) return;

                const x = loc.x * width;
                const y = loc.y * height;

                ctx.save();
                ctx.translate(x, y);

                // Subtle shadow for depth
                ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
                ctx.shadowBlur = 8;
                ctx.shadowOffsetX = 2;
                ctx.shadowOffsetY = 2;

                // Smaller, less overwhelming markers
                const markerSize = 20 * this.scale; // Reduced from 35
                const gradient = ctx.createRadialGradient(0, 0, 0, 0, 0, markerSize);

                // Calmer colors based on priority
                const locPriority = loc.priority || 3;
                if (locPriority === 1 && loc.quest) {
                    // Quest markers - still bright but smaller
                    gradient.addColorStop(0, '#FFD700');
                    gradient.addColorStop(1, '#D4AF37');
                } else if (locPriority === 1) {
                    // Current location - subtle highlight
                    gradient.addColorStop(0, '#B8A68C');
                    gradient.addColorStop(1, '#8B7355');
                } else {
                    // Other locations - very muted
                    gradient.addColorStop(0, 'rgba(139, 115, 85, 0.6)');
                    gradient.addColorStop(1, 'rgba(107, 87, 69, 0.4)');
                }

                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(0, 0, markerSize, 0, Math.PI * 2);
                ctx.fill();

                // Decorative border
                ctx.shadowBlur = 0;
                ctx.strokeStyle = loc.current ? '#FFD700' : loc.color;
                ctx.lineWidth = (loc.current ? 5 : 3) * this.scale;
                ctx.stroke();

                // Inner circle for icon background
                ctx.fillStyle = 'rgba(244, 233, 220, 0.9)';
                ctx.beginPath();
                ctx.arc(0, 0, markerSize * 0.7, 0, Math.PI * 2);
                ctx.fill();

                // Smaller, less overwhelming icon
                ctx.font = `bold ${18 * this.scale}px serif`; // Reduced from 30
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillStyle = 'rgba(26, 22, 18, 0.8)'; // Slightly transparent
                ctx.fillText(loc.icon, 0, 0);

                // Quest pulse effect - more prominent
                if (loc.quest && locPriority === 1) {
                    const pulseScale = 1 + Math.sin(this.time / 30) * 0.3;
                    ctx.strokeStyle = 'rgba(255, 215, 0, 0.9)';
                    ctx.lineWidth = 4 * this.scale;
                    ctx.setLineDash([5, 3]);
                    ctx.beginPath();
                    ctx.arc(0, 0, markerSize * 1.3 * pulseScale, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.setLineDash([]);

                    // Quest star decoration
                    ctx.fillStyle = '#FFD700';
                    for (let i = 0; i < 4; i++) {
                        const angle = (Math.PI / 2) * i + this.time / 50;
                        const starX = Math.cos(angle) * markerSize * 1.5;
                        const starY = Math.sin(angle) * markerSize * 1.5;
                        ctx.beginPath();
                        ctx.arc(starX, starY, 3 * this.scale, 0, Math.PI * 2);
                        ctx.fill();
                    }
                }

                // Current location indicator
                if (loc.current) {
                    ctx.strokeStyle = '#FFD700';
                    ctx.lineWidth = 2 * this.scale;
                    ctx.setLineDash([5, 3]);
                    ctx.beginPath();
                    ctx.arc(0, 0, markerSize * 1.4, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.setLineDash([]);
                }

                ctx.restore();

                // Draw location name below marker (only for high priority or when zoomed)
                const namePriority = loc.priority || 3;
                const showName = (namePriority === 1) || (this.scale > 1.5);

                if (loc.discovered && showName) {
                    ctx.save();
                    ctx.translate(x, y + markerSize + 20 * this.scale); // Reduced spacing

                    // Name background
                    const textMetrics = ctx.measureText(loc.name);
                    const textWidth = textMetrics.width;
                    const padding = 8 * this.scale;

                    ctx.fillStyle = 'rgba(244, 233, 220, 0.9)';
                    ctx.strokeStyle = '#8B7355';
                    ctx.lineWidth = 1.5 * this.scale;

                    // Draw rounded rectangle (compatible version)
                    const rx = -textWidth/2 - padding;
                    const ry = -12 * this.scale;
                    const rw = textWidth + padding * 2;
                    const rh = 24 * this.scale;
                    const radius = 4 * this.scale;

                    ctx.beginPath();
                    ctx.moveTo(rx + radius, ry);
                    ctx.lineTo(rx + rw - radius, ry);
                    ctx.quadraticCurveTo(rx + rw, ry, rx + rw, ry + radius);
                    ctx.lineTo(rx + rw, ry + rh - radius);
                    ctx.quadraticCurveTo(rx + rw, ry + rh, rx + rw - radius, ry + rh);
                    ctx.lineTo(rx + radius, ry + rh);
                    ctx.quadraticCurveTo(rx, ry + rh, rx, ry + rh - radius);
                    ctx.lineTo(rx, ry + radius);
                    ctx.quadraticCurveTo(rx, ry, rx + radius, ry);
                    ctx.closePath();

                    ctx.fill();
                    ctx.stroke();

                    // Location name text
                    ctx.font = `bold ${14 * this.scale}px serif`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillStyle = '#1a1612';
                    ctx.fillText(loc.name, 0, 0);

                    // Level indicator for dungeons
                    if (loc.type === 'dungeon' && loc.description.includes('Level')) {
                        ctx.font = `${11 * this.scale}px serif`;
                        ctx.fillStyle = '#CD5C5C';
                        ctx.fillText(loc.description.match(/Level \d+-\d+/)?.[0] || '', 0, 14 * this.scale);
                    }

                    ctx.restore();
                }
            });
        },

        // Draw fog of war - REDUCED to show more content
        drawFogOfWar(ctx, width, height) {
            // Only apply light fog to undiscovered areas
            ctx.globalAlpha = 0.3;  // Much lighter fog

            this.locations.forEach(loc => {
                if (!loc.discovered) {
                    const gradient = ctx.createRadialGradient(
                        loc.x * width, loc.y * height, 10,
                        loc.x * width, loc.y * height, 60
                    );
                    gradient.addColorStop(0, 'rgba(26, 22, 18, 0.6)');
                    gradient.addColorStop(0.5, 'rgba(26, 22, 18, 0.3)');
                    gradient.addColorStop(1, 'transparent');
                    ctx.fillStyle = gradient;
                    ctx.beginPath();
                    ctx.arc(loc.x * width, loc.y * height, 60, 0, Math.PI * 2);
                    ctx.fill();

                    // Draw question mark for undiscovered locations
                    ctx.save();
                    ctx.translate(loc.x * width, loc.y * height);
                    ctx.font = `bold ${25 * this.scale}px serif`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillStyle = 'rgba(139, 115, 85, 0.5)';
                    ctx.fillText('?', 0, 0);
                    ctx.restore();
                }
            });

            // Add slight overall fog at edges for atmosphere
            const edgeGradient = ctx.createRadialGradient(
                width/2, height/2, Math.min(width, height) * 0.3,
                width/2, height/2, Math.max(width, height) * 0.7
            );
            edgeGradient.addColorStop(0, 'transparent');
            edgeGradient.addColorStop(0.7, 'transparent');
            edgeGradient.addColorStop(1, 'rgba(26, 22, 18, 0.2)');
            ctx.fillStyle = edgeGradient;
            ctx.fillRect(0, 0, width, height);

            ctx.globalAlpha = 1;
        },

        // Render minimap
        renderMinimap() {
            const ctx = this.minimapCtx;
            const canvas = this.minimapCanvas;

            if (!ctx || !canvas) return;

            // Clear
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Background
            ctx.fillStyle = 'rgba(26, 22, 18, 0.9)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw locations
            this.locations.forEach(loc => {
                if (!loc.discovered) return;

                const x = loc.x * canvas.width;
                const y = loc.y * canvas.height;

                // Dot color based on type
                ctx.fillStyle = loc.current ? '#FFD700' :
                               loc.quest ? '#FF6B6B' :
                               loc.visited ? '#D4AF37' : '#8B7355';

                ctx.beginPath();
                ctx.arc(x, y, loc.current ? 4 : 3, 0, Math.PI * 2);
                ctx.fill();
            });

            // Viewport indicator
            ctx.strokeStyle = '#FFD700';
            ctx.lineWidth = 1;
            ctx.globalAlpha = 0.5;
            ctx.setLineDash([3, 2]);

            const viewX = (-this.offsetX / this.scale + canvas.width/2) / this.viewportWidth * canvas.width;
            const viewY = (-this.offsetY / this.scale + canvas.height/2) / this.viewportHeight * canvas.height;
            const viewW = (canvas.width / this.scale) / this.viewportWidth * canvas.width;
            const viewH = (canvas.height / this.scale) / this.viewportHeight * canvas.height;

            ctx.strokeRect(viewX - viewW/2, viewY - viewH/2, viewW, viewH);
            ctx.setLineDash([]);
            ctx.globalAlpha = 1;
        },

        // Start animation loop
        startAnimation() {
            const animate = () => {
                this.time++;
                if (document.getElementById('map-overlay')?.classList.contains('active')) {
                    this.render();
                    if (this.time % 10 === 0) {
                        this.renderMinimap();
                    }
                }
                this.animationId = requestAnimationFrame(animate);
            };
            animate();
        }
    };


                                // === Retention System (Phase B) ===
        // Simulate achievement unlock
        setTimeout(() => {
            const achievementPopup = document.querySelector('.achievement-popup');
            achievementPopup.classList.add('show');

            // Play sound effect (in real implementation)
            // playSound('achievement.mp3');

            setTimeout(() => {
                achievementPopup.classList.remove('show');
            }, 5000);
        }, 2000);

        // Animate battle pass fill
        let battlePassProgress = 35;
        setInterval(() => {
            battlePassProgress = Math.min(battlePassProgress + 5, 100);
            const tierFill = document.querySelector('.tier-fill');
            if (tierFill) {
                tierFill.style.width = `${battlePassProgress}%`;
            }

            if (battlePassProgress === 100) {
                // Unlock next tier
                const nextNode = document.querySelector('.tier-node:not(.unlocked)');
                if (nextNode) {
                    nextNode.classList.add('unlocked');
                    battlePassProgress = 0;
                }
            }
        }, 1000);

        // Claim daily reward - with null check
        const claimButton = document.querySelector('.claim-button');
        if (claimButton) {
            claimButton.addEventListener('click', function() {
                const todaySlot = document.querySelector('.day-slot.today');
                if (todaySlot) {
                    todaySlot.classList.remove('today');
                    todaySlot.classList.add('claimed');
                }
                this.disabled = true;
                this.textContent = 'Claimed!';

                // Show reward animation
                // In real implementation, show reward details
            });
        }

        // Update event timer
        setInterval(() => {
            // In real implementation, calculate actual time remaining
            const timerEl = document.querySelector('.event-timer');
            // Update timer text
        }, 1000);

        // === Onboarding System (Phase B) ===
        // Character selection
        document.querySelectorAll('.character-card').forEach(card => {
            card.addEventListener('click', function() {
                document.querySelectorAll('.character-card').forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');
                document.querySelector('.start-adventure-btn').disabled = false;
            });
        });

        // Tutorial system
        const tutorialSteps1 = [ // RENAMED TO AVOID DUPLICATE
            {
                element: '.character-panel',
                title: 'Character Panel',
                text: 'View your stats, level, and equipment here. Press C to open anytime.',
                position: 'right'
            },
            {
                element: '.inventory-btn',
                title: 'Inventory',
                text: 'Manage your items and equipment. Press I for quick access.',
                position: 'bottom'
            },
            {
                element: '.quest-log',
                title: 'Quest Log',
                text: 'Track your active quests and objectives. Press J to view.',
                position: 'left'
            },
            {
                element: '.action-bar',
                title: 'Action Bar',
                text: 'Use your abilities in combat. Number keys 1-5 activate skills.',
                position: 'top'
            },
            {
                element: '.divine-favor',
                title: 'Divine Favor',
                text: 'The gods watch your actions. Their favor affects your journey.',
                position: 'left'
            }
        ];

        let currentStep = 0;

        function showTutorialStep(step) {
            const tooltip = document.querySelector('.tutorial-tooltip');
            const hole = document.querySelector('.spotlight-hole');
            const dots = document.querySelectorAll('.progress-dot');

            // Update progress dots
            dots.forEach((dot, index) => {
                dot.classList.toggle('active', index <= step);
            });

            // Update content
            tooltip.querySelector('.tutorial-title').textContent = tutorialSteps[step].title;
            tooltip.querySelector('.tutorial-text').textContent = tutorialSteps[step].text;

            // Position spotlight and tooltip
            // (In real implementation, position based on actual element coordinates)
        }

        // Start button
        document.querySelector('.start-adventure-btn').addEventListener('click', function() {
            // Fade out welcome screen
            const welcomeScreen = document.querySelector('.onboarding-overlay');
            welcomeScreen.style.animation = 'fadeOut 0.5s ease';
            setTimeout(() => {
                welcomeScreen.style.display = 'none';
                // Start tutorial
                document.querySelector('.tutorial-spotlight').classList.add('active');
                document.querySelector('.ftue-checklist').style.display = 'block';
            }, 500);
        });

        // Tutorial navigation
        document.querySelector('.tutorial-btn:not(.skip)').addEventListener('click', function() {
            currentStep++;
            if (currentStep < tutorialSteps.length) {
                showTutorialStep(currentStep);
            } else {
                document.querySelector('.tutorial-spotlight').classList.remove('active');
            }
        });

        // Skip tutorial
        document.querySelector('.tutorial-btn.skip').addEventListener('click', function() {
            document.querySelector('.tutorial-spotlight').classList.remove('active');
        });

        // Simulate FTUE progress
        let ftueProgress = 20;
        setInterval(() => {
            if (ftueProgress < 100) {
                ftueProgress += 20;
                document.querySelector('.ftue-progress-fill').style.width = `${ftueProgress}%`;

                // Mark items as completed
                const items = document.querySelectorAll('.ftue-item');
                const itemIndex = Math.floor((ftueProgress / 100) * items.length) - 1;
                if (itemIndex >= 0) {
                    items[itemIndex].classList.add('completed');
                }
            }
        }, 3000);

        // === Celebration Animations (Phase B) ===
        // Trigger level up animation
        function triggerLevelUp() {
            const levelUpEl = document.querySelector('.level-up-burst');
            levelUpEl.style.display = 'block';

            // Create particles
            for (let i = 0; i < 30; i++) {
                createParticle(window.innerWidth / 2, window.innerHeight / 2);
            }

            setTimeout(() => {
                levelUpEl.style.display = 'none';
            }, 2000);
        }

        // Trigger quest complete
        function triggerQuestComplete() {
            const questEl = document.querySelector('.quest-complete');
            questEl.style.display = 'block';

            setTimeout(() => {
                questEl.style.display = 'none';
            }, 3000);
        }

        // Trigger divine favor
        function triggerDivineFavor(amount) {
            const favorEl = document.querySelector('.divine-favor-gain');
            const amountEl = favorEl.querySelector('.favor-amount');
            amountEl.textContent = `+${amount}`;
            favorEl.style.display = 'block';

            setTimeout(() => {
                favorEl.style.display = 'none';
            }, 2000);
        }

        // Create floating damage numbers
        function createDamageNumber(x, y, value, type = 'normal') {
            const damageEl = document.createElement('div');
            damageEl.className = `damage-number ${type}`;
            damageEl.textContent = type === 'heal' ? `+${value}` : `-${value}`;
            damageEl.style.left = `${x}px`;
            damageEl.style.top = `${y}px`;
            document.body.appendChild(damageEl);

            setTimeout(() => {
                damageEl.remove();
            }, 1000);
        }

        // Create particle effect
        function createParticle(x, y) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.left = `${x}px`;
            particle.style.top = `${y}px`;
            particle.style.setProperty('--drift', `${(Math.random() - 0.5) * 60}px`);
            particle.style.animation = `particleFloat ${1 + Math.random()}s ease-out`;
            document.body.appendChild(particle);

            setTimeout(() => {
                particle.remove();
            }, 2000);
        }

        // Demo animations - DISABLED for normal gameplay
        // setTimeout(() => triggerLevelUp(), 1000);
        // setTimeout(() => triggerQuestComplete(), 3000);
        // setTimeout(() => triggerDivineFavor(15), 5000);

        // Create some damage numbers
        setInterval(() => {
            const x = Math.random() * window.innerWidth;
            const y = Math.random() * window.innerHeight;
            const types = ['normal', 'critical', 'heal'];
            const type = types[Math.floor(Math.random() * types.length)];
            const value = Math.floor(Math.random() * 100) + 20;
            createDamageNumber(x, y, value, type);
        }, 2000);

        // Animate XP bar
        let xpProgress = 65; // Renamed from currentXP to avoid duplicate declaration
        setInterval(() => {
            xpProgress = Math.min(xpProgress + 5, 100);
            document.querySelector('.xp-fill').style.width = `${xpProgress}%`;

            if (xpProgress === 100) {
                triggerLevelUp();
                xpProgress = 0;
            }
        }, 3000);

        // === Loading States (Phase B) ===
        // Rotate loading tips (no duplicates)

        // Example: Show success animation
        function showSuccess() {
            const successEl = document.querySelector('.success-pulse');
            successEl.style.display = 'block';
            setTimeout(() => {
                successEl.style.display = 'none';
            }, 1000);
        }

        // Demo success after 5 seconds
        setTimeout(showSuccess, 5000);
    
        
        // === PHASE D: Backend Integration ===

        // API helper function with error handling
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetchWithCSRF(endpoint, options);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                return await response.json();
            } catch (error) {
                console.error(`API Error [${endpoint}]:`, error);
                throw error;
            }
        }

        // Load character stats for character sheet overlay
        async function loadCharacterStats() {
            try {
                gameUX.showLoading('Loading character data...');

                const data = await apiCall('/api/character/stats');

                // Update character sheet UI
                const charOverlay = document.getElementById('character-overlay');
                if (!charOverlay) return;

                // Update stats
                const stats = data.stats;
                for (const [stat, value] of Object.entries(stats)) {
                    const statElement = charOverlay.querySelector(`[data-stat="${stat}"]`);
                    if (statElement) {
                        statElement.textContent = value;
                    }
                }

                // Update level
                const levelBadge = charOverlay.querySelector('.level-badge');
                if (levelBadge) levelBadge.textContent = `Level ${data.level}`;

                // Update XP bar
                const xpBar = charOverlay.querySelector('.xp-fill');
                if (xpBar) {
                    const xpPercent = (data.xp / data.xp_to_next) * 100;
                    xpBar.style.width = `${xpPercent}%`;
                }

                // Update HP
                const hpText = charOverlay.querySelector('.hp-text');
                if (hpText) hpText.textContent = `${data.hp} / ${data.max_hp}`;

                // Update class
                const className = charOverlay.querySelector('.character-class');
                if (className) className.textContent = data.class;

                gameUX.hideLoading();
                console.log('[Phase D] Character stats loaded');

            } catch (error) {
                gameUX.hideLoading();
                console.error('Failed to load character stats:', error);
            }
        }

        // Load divine favor for character sheet
        async function loadDivineFavor() {
            try {
                const data = await apiCall('/api/character/divine_favor');

                const charOverlay = document.getElementById('character-overlay');
                if (!charOverlay) return;

                // Update favor bars for each god
                const favor = data.favor;
                for (const [godName, favorValue] of Object.entries(favor)) {
                    const favorBar = charOverlay.querySelector(`[data-god="${godName}"] .favor-bar-fill`);
                    if (favorBar) {
                        // Favor ranges from -100 to 100, normalize to 0-100%
                        const favorPercent = ((favorValue + 100) / 200) * 100;
                        favorBar.style.width = `${favorPercent}%`;

                        // Color based on favor level
                        if (favorValue > 50) favorBar.style.background = '#4CAF50'; // Green
                        else if (favorValue < -50) favorBar.style.background = '#F44336'; // Red
                        else favorBar.style.background = '#FFC107'; // Amber
                    }

                    const favorText = charOverlay.querySelector(`[data-god="${godName}"] .favor-value`);
                    if (favorText) favorText.textContent = favorValue;
                }

                console.log('[Phase D] Divine favor loaded');

            } catch (error) {
                console.error('Failed to load divine favor:', error);
            }
        }

        // Load inventory for inventory overlay
        async function loadInventory() {
            try {
                gameUX.showLoading('Loading inventory...');

                const data = await apiCall('/api/inventory/all');

                const invOverlay = document.getElementById('inventory-overlay');
                if (!invOverlay) return;

                // Update inventory grid
                const inventoryGrid = invOverlay.querySelector('.inventory-grid');
                if (inventoryGrid) {
                    inventoryGrid.innerHTML = ''; // Clear existing

                    // Add items
                    data.items.forEach(item => {
                        const slot = document.createElement('div');
                        slot.className = 'inventory-slot';
                        if (item.equipped) slot.classList.add('equipped');
                        slot.setAttribute('data-item-id', item.id);
                        slot.setAttribute('data-tooltip', item.description);

                        slot.innerHTML = `
                            <div class="item-icon">${getItemIcon(item.type)}</div>
                            ${item.quantity > 1 ? `<div class="item-quantity">${item.quantity}</div>` : ''}
                        `;

                        inventoryGrid.appendChild(slot);
                    });

                    // Fill empty slots
                    const emptySlots = 48 - data.items.length;
                    for (let i = 0; i < emptySlots; i++) {
                        const emptySlot = document.createElement('div');
                        emptySlot.className = 'inventory-slot empty';
                        inventoryGrid.appendChild(emptySlot);
                    }
                }

                // Update gold
                const goldDisplay = invOverlay.querySelector('.gold-amount');
                if (goldDisplay) goldDisplay.textContent = data.gold;

                // Update weight
                const weightDisplay = invOverlay.querySelector('.weight-display');
                if (weightDisplay) {
                    weightDisplay.textContent = `${data.weight} / ${data.max_weight}`;
                }

                gameUX.hideLoading();
                console.log('[Phase D] Inventory loaded');

            } catch (error) {
                gameUX.hideLoading();
                console.error('Failed to load inventory:', error);
            }
        }

        // Helper function to get item icon emoji
        function getItemIcon(itemType) {
            const icons = {
                'weapon': '',
                'armor': '',
                'potion': '',
                'scroll': '',
                'food': '',
                'quest': '',
                'treasure': '',
                'default': ''
            };
            return icons[itemType] || icons.default;
        }

        // Load quests for quest overlay
        async function loadQuests(type = 'active') {
            try {
                gameUX.showLoading(`Loading ${type} quests...`);

                const endpoint = type === 'active' ? '/api/quests/active' : '/api/quests/completed';
                const data = await apiCall(endpoint);

                const questOverlay = document.getElementById('quests-overlay');
                if (!questOverlay) return;

                const questList = questOverlay.querySelector('.quest-list');
                if (questList) {
                    questList.innerHTML = ''; // Clear existing

                    if (data.quests.length === 0) {
                        questList.innerHTML = `<div class="no-quests">No ${type} quests</div>`;
                    } else {
                        data.quests.forEach(quest => {
                            const questItem = document.createElement('div');
                            questItem.className = 'quest-item';
                            questItem.setAttribute('data-quest-id', quest.id);

                            questItem.innerHTML = `
                                <div class="quest-title">${quest.name}</div>
                                <div class="quest-description">${quest.description}</div>
                                ${quest.progress !== undefined ? `
                                    <div class="quest-progress-bar">
                                        <div class="quest-progress-fill" style="width: ${quest.progress}%"></div>
                                    </div>
                                ` : ''}
                            `;

                            questList.appendChild(questItem);
                        });
                    }
                }

                gameUX.hideLoading();
                console.log(`[Phase D] ${type} quests loaded`);

            } catch (error) {
                gameUX.hideLoading();
                console.error(`Failed to load ${type} quests:`, error);
            }
        }

        // Load current scenario
        async function loadCurrentScenario() {
            try {
                gameUX.showLoading('Loading scenario...');

                const data = await apiCall('/api/current_scenario');

                // Update scenario title
                const titleElement = document.querySelector('.scenario-title');
                if (titleElement) titleElement.textContent = data.title || 'The Adventure Begins';

                // Update scenario description
                const descElement = document.querySelector('.scenario-description');
                if (descElement) descElement.textContent = data.description || 'Your journey awaits...';

                // Update choices
                const choicesContainer = document.querySelector('.choices-container');
                if (choicesContainer && data.choices) {
                    choicesContainer.innerHTML = '';

                    data.choices.forEach((choice, index) => {
                        const button = document.createElement('button');
                        button.className = 'choice-button';
                        button.textContent = choice.text;
                        button.onclick = () => submitChoice(choice.id);
                        choicesContainer.appendChild(button);
                    });
                }

                gameUX.hideLoading();
                console.log('[Phase D] Current scenario loaded');

            } catch (error) {
                gameUX.hideLoading();
                console.error('Failed to load scenario:', error);
            }
        }

        // Submit player choice
        async function submitChoice(choiceId) {
            try {
                gameUX.showLoading('Processing your choice...');

                const data = await apiCall('/api/make_choice', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ choice: choiceId })
                });

                // Show consequences
                if (data.consequence) {
                    const narrativePanel = document.querySelector('.scene-narrative-panel');
                    if (narrativePanel) {
                        const consequenceDiv = document.createElement('div');
                        consequenceDiv.className = 'narrative-text consequence';
                        consequenceDiv.textContent = data.consequence;
                        narrativePanel.appendChild(consequenceDiv);
                    }
                }

                // Check for level up
                if (data.level_up) {
                    gameUX.celebrate('levelup', { level: data.new_level });
                }

                // Check for quest completion
                if (data.quest_completed) {
                    gameUX.celebrate('quest', { quest: data.quest_name });
                }

                // Reload scenario for next turn
                await loadCurrentScenario();

                gameUX.hideLoading();
                console.log('[Phase D] Choice submitted successfully');

            } catch (error) {
                gameUX.hideLoading();
                console.error('Failed to submit choice:', error);
            }
        }

        // Auto-refresh game state periodically
        function startGameStatePolling() {
            setInterval(async () => {
                try {
                    const data = await apiCall('/api/game_state');

                    // Update health bar
                    const hpBar = document.querySelector('.hp-bar-fill');
                    if (hpBar && data.character) {
                        const hpPercent = (data.character.hp / data.character.max_hp) * 100;
                        hpBar.style.width = `${hpPercent}%`;
                    }

                    // Update level display
                    const levelDisplay = document.querySelector('.player-level');
                    if (levelDisplay && data.character) {
                        levelDisplay.textContent = `Lv. ${data.character.level}`;
                    }

                } catch (error) {
                    // Silent fail for polling errors
                }
            }, 5000); // Poll every 5 seconds
        }

        // Hook into overlay open events
        document.addEventListener('DOMContentLoaded', () => {
            // Load character data when character overlay opens
            const charButton = document.querySelector('[data-overlay="character-overlay"]');
            if (charButton) {
                charButton.addEventListener('click', () => {
                    loadCharacterStats();
                    loadDivineFavor();
                });
            }

            // Load inventory when inventory overlay opens
            const invButton = document.querySelector('[data-overlay="inventory-overlay"]');
            if (invButton) {
                invButton.addEventListener('click', loadInventory);
            }

            // Load quests when quest overlay opens
            const questButton = document.querySelector('[data-overlay="quests-overlay"]');
            if (questButton) {
                questButton.addEventListener('click', () => loadQuests('active'));
            }

            // Quest tab switching
            const activeTab = document.querySelector('.quest-tab[data-tab="active"]');
            const completedTab = document.querySelector('.quest-tab[data-tab="completed"]');

            if (activeTab) activeTab.addEventListener('click', () => loadQuests('active'));
            if (completedTab) completedTab.addEventListener('click', () => loadQuests('completed'));

            // Load initial scenario
            loadCurrentScenario();

            // Start polling for game state updates
            startGameStatePolling();

            console.log('[Phase D] Frontend connected to backend');
        });

        // === UX System Initialization (Phase B) ===
        class GameUX {
            constructor() {
                this.loadingShown = false;
                this.celebrationsEnabled = true;
            }

            showLoading(message = 'Loading...') {
                if (this.loadingShown) return;
                this.loadingShown = true;

                const loadingContainer = document.querySelector('.loading-container');
                if (loadingContainer) {
                    loadingContainer.classList.add('active');
                    const loadingText = loadingContainer.querySelector('.loading-text');
                    if (loadingText) loadingText.textContent = message;
                }
            }

            hideLoading() {
                this.loadingShown = false;
                const loadingContainer = document.querySelector('.loading-container');
                if (loadingContainer) {
                    loadingContainer.classList.remove('active');
                }
            }

            celebrate(type, data = {}) {
                if (!this.celebrationsEnabled) return;

                switch(type) {
                    case 'levelup':
                        if (typeof showLevelUp !== 'undefined') showLevelUp(data.level || 1);
                        break;
                    case 'quest':
                        if (typeof showQuestComplete !== 'undefined') showQuestComplete(data.quest || '');
                        break;
                    case 'achievement':
                        if (typeof showAchievement !== 'undefined') showAchievement(data.title || '', data.description || '');
                        break;
                }
            }

            vibrate(pattern = [50]) {
                if (window.navigator.vibrate) {
                    window.navigator.vibrate(pattern);
                }
            }
        }

        // Initialize global UX controller
        const gameUX = new GameUX();
        console.log('[Phase B] UX improvements initialized');

    </script>
        <!-- 6. Settings Overlay -->
        <div id="settings-overlay" class="overlay">
    <div class="overlay-backdrop"></div>
    <div class="overlay-content">
        <div class="overlay-header">
            <h2> Settings</h2>
            <button class="close-btn">&times;</button>
        </div>
        <div class="overlay-body">
            <!-- Settings Tabs -->
            <div class="settings-tabs">
                <div class="settings-tab active" data-tab="audio">
                    <span class="tab-icon"></span>
                    <span class="tab-label">Audio</span>
                </div>
                <div class="settings-tab" data-tab="display">
                    <span class="tab-icon"></span>
                    <span class="tab-label">Display</span>
                </div>
                <div class="settings-tab" data-tab="controls">
                    <span class="tab-icon"></span>
                    <span class="tab-label">Controls</span>
                </div>
                <div class="settings-tab" data-tab="game">
                    <span class="tab-icon"></span>
                    <span class="tab-label">Game</span>
                </div>
            </div>

            <!-- Audio Settings Tab -->
            <div class="settings-tab-content" id="audio-settings">
                <div class="setting-group">
                    <div class="setting-label">Master Volume</div>
                    <div class="slider-container">
                        <input type="range" min="0" max="100" value="80" class="volume-slider master-volume">
                        <span class="volume-value">80%</span>
                    </div>
                </div>

                <div class="setting-group">
                    <div class="setting-label">Music Volume</div>
                    <div class="slider-container">
                        <input type="range" min="0" max="100" value="70" class="volume-slider music-volume">
                        <span class="volume-value">70%</span>
                    </div>
                </div>

                <div class="setting-group">
                    <div class="setting-label">SFX Volume</div>
                    <div class="slider-container">
                        <input type="range" min="0" max="100" value="85" class="volume-slider sfx-volume">
                        <span class="volume-value">85%</span>
                    </div>
                </div>

                <div class="setting-group">
                    <div class="setting-checkbox">
                        <input type="checkbox" id="ambience-toggle" checked>
                        <label for="ambience-toggle">Enable Ambience Sounds</label>
                    </div>
                </div>
            </div>

            <!-- Display Settings Tab (Hidden) -->
            <div class="settings-tab-content hidden" id="display-settings">
                <div class="setting-group">
                    <div class="setting-label">Brightness</div>
                    <div class="slider-container">
                        <input type="range" min="0" max="100" value="75" class="volume-slider">
                        <span class="volume-value">75%</span>
                    </div>
                </div>

                <div class="setting-group">
                    <div class="setting-label">Contrast</div>
                    <div class="slider-container">
                        <input type="range" min="0" max="100" value="100" class="volume-slider">
                        <span class="volume-value">100%</span>
                    </div>
                </div>

                <div class="setting-group">
                    <div class="setting-checkbox">
                        <input type="checkbox" id="fullscreen-toggle">
                        <label for="fullscreen-toggle">Fullscreen Mode</label>
                    </div>
                </div>

                <div class="setting-group">
                    <div class="setting-checkbox">
                        <input type="checkbox" id="vsync-toggle" checked>
                        <label for="vsync-toggle">Enable V-Sync</label>
                    </div>
                </div>
            </div>

            <!-- Controls Settings Tab (Hidden) -->
            <div class="settings-tab-content hidden" id="controls-settings">
                <div class="setting-group">
                    <div class="setting-label">Mouse Sensitivity</div>
                    <div class="slider-container">
                        <input type="range" min="1" max="10" value="5" class="volume-slider">
                        <span class="volume-value">5/10</span>
                    </div>
                </div>

                <div class="setting-group">
                    <div class="setting-label">Camera Speed</div>
                    <div class="slider-container">
                        <input type="range" min="1" max="10" value="6" class="volume-slider">
                        <span class="volume-value">6/10</span>
                    </div>
                </div>

                <div class="setting-group">
                    <div class="setting-checkbox">
                        <input type="checkbox" id="invert-y-toggle">
                        <label for="invert-y-toggle">Invert Y-Axis</label>
                    </div>
                </div>

                <div class="setting-group">
                    <div class="setting-checkbox">
                        <input type="checkbox" id="controller-toggle">
                        <label for="controller-toggle">Controller Support</label>
                    </div>
                </div>
            </div>

            <!-- Game Settings Tab (Hidden) -->
            <div class="settings-tab-content hidden" id="game-settings">
                <div class="game-actions">
                    <button class="game-action-btn save-btn"> Save Game</button>
                    <button class="game-action-btn load-btn"> Load Game</button>
                    <button class="game-action-btn menu-btn"> Return to Menu</button>
                </div>

                <div class="game-info">
                    <div class="info-item">
                        <span class="info-label">Current Save:</span>
                        <span class="info-value">Valdria - Act 1, Turn 3</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Playtime:</span>
                        <span class="info-value">2 hours 45 minutes</span>
                    </div>
                </div>

                <div class="game-version">
                    v1.0 - The Arcane Codex
                </div>
            </div>
        </div>
    </div>
</div>
    </div>

        <script>
        // CSRF Protection: Fetch and store CSRF token
        let csrfToken = null;

        async function fetchCSRFToken() {
            try {
                const response = await fetch('/api/csrf-token');
                const data = await response.json();
                csrfToken = data.csrf_token;
                console.log('[Security] CSRF token fetched successfully');
            } catch (error) {
                console.error('[Security] Failed to fetch CSRF token:', error);
            }
        }

        // Fetch CSRF token on page load
        fetchCSRFToken();

        // Helper function to add CSRF token to fetch requests
        function fetchWithCSRF(url, options = {}) {
            if (!options.headers) {
                options.headers = {};
            }
            if (csrfToken && (options.method === 'POST' || options.method === 'PUT' || options.method === 'DELETE')) {
                options.headers['X-CSRFToken'] = csrfToken;
            }
            return fetch(url, options);
        }


        // ============================================
        // OVERLAY SYSTEM - All 6 Game Overlays
        // ============================================

        // Overlay IDs mapped to sidebar buttons
        const overlayMap = {
            0: 'character-overlay',  // Character (C)
            1: 'inventory-overlay',  // Inventory (I)
            2: 'skills-overlay',     // Skills (K)
            3: 'quests-overlay',     // Quests (J)
            4: 'map-overlay',        // Map (M)
            5: 'settings-overlay'    // Settings (ESC)
        };

        // Track which overlay is currently active
        let activeOverlay = null;

        /**
         * Opens a specific overlay by ID
         * Closes any previously open overlay
         * Adds .active class to show the overlay
         */
        function openOverlay(overlayId) {
            // Close any existing open overlays
            closeAllOverlays();

            // Get the overlay element
            const overlay = document.getElementById(overlayId);
            if (overlay) {
                overlay.classList.add('active');
                activeOverlay = overlayId;
                console.log(`Opened overlay: ${overlayId}`);

                // Initialize map system when map overlay opens
                if (overlayId === 'map-overlay') {
                    // Give the overlay time to properly render and calculate dimensions
                    requestAnimationFrame(() => {
                        fantasyMapSystem.init();
                        console.log('Fantasy Map System initialized');
                    });
                }
            }
        }

        /**
         * Closes all open overlays
         * Removes .active class from all overlay elements
         */
        function closeAllOverlays() {
            const overlays = document.querySelectorAll('.game-overlay.active, .overlay.active');
            overlays.forEach(overlay => {
                overlay.classList.remove('active');
            });
            activeOverlay = null;
            console.log('Closed all overlays');
        }

        /**
         * Keyboard event handler for overlay shortcuts
         * C = Character, I = Inventory, K = Skills, J = Quests, M = Map
         * ESC = Settings or close active overlay
         */
        document.addEventListener('keydown', function(e) {
            const keyMap = {
                'c': 0,        // Character overlay
                'i': 1,        // Inventory overlay
                'k': 2,        // Skills overlay
                'j': 3,        // Quests overlay
                'm': 4,        // Map overlay
                'escape': 5    // Settings overlay
            };

            const key = e.key.toLowerCase();

            // Check if key matches an overlay shortcut
            if (keyMap[key] !== undefined) {
                e.preventDefault();

                // If ESC is pressed and an overlay is open, close it first
                if (key === 'escape' && activeOverlay) {
                    closeAllOverlays();
                } else if (key === 'escape') {
                    // If no overlay is open, open Settings
                    openOverlay(overlayMap[5]);
                } else {
                    // For other keys, toggle overlay open/close
                    const overlayId = overlayMap[keyMap[key]];
                    if (activeOverlay === overlayId) {
                        closeAllOverlays();
                    } else {
                        openOverlay(overlayId);
                    }
                }
            }
        });

        /**
         * Setup event listeners for overlay backdrops
         * Clicking backdrop closes the overlay
         */
        document.querySelectorAll('.overlay-backdrop').forEach(backdrop => {
            backdrop.addEventListener('click', function() {
                closeAllOverlays();
            });
        });

        /**
         * Setup event listeners for close buttons
         * Clicking X button closes the overlay
         */
        document.querySelectorAll('.close-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                closeAllOverlays();
            });
        });

        /**
         * Setup event listeners for sidebar buttons
         * Maps button clicks to corresponding overlays
         * Button order: Character, Inventory, Skills, Quests, Map, Settings
         */
        document.querySelectorAll('.left-panel .side-btn').forEach((btn, index) => {
            btn.addEventListener('click', function() {
                const overlayId = overlayMap[index];

                // Toggle: if already open, close it; otherwise open it
                if (activeOverlay === overlayId) {
                    closeAllOverlays();
                } else {
                    openOverlay(overlayId);
                }

                // Visual feedback
                this.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    this.style.transform = 'scale(1.1)';
                    setTimeout(() => {
                        this.style.transform = '';
                    }, 100);
                }, 100);
            });
        });

        console.log('Overlay system initialized - Press C/I/K/J/M or ESC to open overlays');

        // === Choice Button Interactions ===
        document.querySelectorAll('.choice-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const choice = this.textContent.trim();
                console.log('Player chose:', choice);

                // Visual feedback
                this.style.background = 'linear-gradient(135deg, rgba(212, 175, 55, 0.5), rgba(139, 115, 85, 0.5))';
                this.style.borderColor = '#FFD700';

                // Disable all choice buttons after selection
                document.querySelectorAll('.choice-btn').forEach(b => {
                    b.style.opacity = '0.5';
                    b.style.pointerEvents = 'none';
                });

                // Submit choice to backend
                submitChoice(choice);
            });
        });

        // Submit choice to API and handle response
        async function submitChoice(choice) {
            try {
                // Show loading state
                const narrativePanel = document.querySelector('.scene-narrative-panel');
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'act-header';
                loadingDiv.style.marginTop = '25px';
                loadingDiv.innerHTML = ' Processing your choice...';
                narrativePanel.appendChild(loadingDiv);

                // POST to API
                const response = await fetchWithCSRF('/api/scenario/choice', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        choice: choice,
                        timestamp: new Date().toISOString()
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                // Remove loading message
                loadingDiv.remove();

                // Display consequences
                displayConsequences(data);

            } catch (error) {
                console.error('Error submitting choice:', error);

                // Show error message to user
                const errorDiv = document.createElement('div');
                errorDiv.className = 'narrative-text';
                errorDiv.style.color = '#CD5C5C';
                errorDiv.style.marginTop = '20px';
                // XSS Fix: Safely construct error message
                const errorIcon = document.createTextNode(' ');
                const errorLabel = document.createElement('strong');
                errorLabel.textContent = 'Connection Error:';
                const errorMessage = document.createTextNode(' Unable to process your choice. ' + error.message);
                errorDiv.appendChild(errorIcon);
                errorDiv.appendChild(errorLabel);
                errorDiv.appendChild(errorMessage);
                document.querySelector('.scene-narrative-panel').appendChild(errorDiv);
            }
        }

        // Display consequences and Divine Council responses
        function displayConsequences(data) {
            const narrativePanel = document.querySelector('.scene-narrative-panel');

            // Add consequence narrative
            if (data.consequence) {
                const consequenceDiv = document.createElement('div');
                consequenceDiv.className = 'narrative-text';
                consequenceDiv.style.marginTop = '20px';
                consequenceDiv.innerHTML = data.consequence;
                narrativePanel.appendChild(consequenceDiv);
            }

            // Add Divine Council header
            if (data.divineCouncil && data.divineCouncil.length > 0) {
                const councilHeader = document.createElement('div');
                councilHeader.className = 'act-header';
                councilHeader.style.marginTop = '25px';
                councilHeader.innerHTML = ' Divine Council Convenes';
                narrativePanel.appendChild(councilHeader);

                // Add each god's speech
                data.divineCouncil.forEach((godSpeech, index) => {
                    setTimeout(() => {
                        const speechDiv = document.createElement('div');
                        speechDiv.className = `god-speech ${godSpeech.god.toLowerCase()}`;
                        // XSS Fix: Safely construct god speech DOM
                        const godImg = document.createElement('img');
                        godImg.src = 'images/god_' + encodeURIComponent(godSpeech.god.toLowerCase()) + '.svg';
                        godImg.alt = godSpeech.god;
                        godImg.className = 'god-icon';

                        const godContent = document.createElement('div');
                        godContent.className = 'god-content';

                        const godName = document.createElement('div');
                        godName.className = 'god-name';
                        godName.textContent = godSpeech.icon + ' ' + godSpeech.god.toUpperCase() + ' SPEAKS';

                        const godText = document.createElement('div');
                        godText.className = 'god-text';
                        godText.textContent = '"' + godSpeech.speech + '"';

                        godContent.appendChild(godName);
                        godContent.appendChild(godText);
                        speechDiv.appendChild(godImg);
                        speechDiv.appendChild(godContent);
                        narrativePanel.appendChild(speechDiv);

                        // Scroll to show new content
                        speechDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }, index * 800); // Stagger speeches for dramatic effect
                });
            }

            // Update game state if provided
            if (data.stateUpdates) {
                updateGameState(data.stateUpdates);
            }
        }

        // Update game state based on API response
        function updateGameState(updates) {
            // Update trust if changed
            if (updates.trust !== undefined) {
                console.log('Trust updated to:', updates.trust);
                // Update trust bar visualization (if implemented)
            }

            // Update divine favor if changed
            if (updates.divineFavor) {
                console.log('Divine favor updated:', updates.divineFavor);
                // Update divine favor bars (if implemented)
            }

            // Update NPC approval if changed
            if (updates.npcApproval) {
                console.log('NPC approval updated:', updates.npcApproval);
                // Update NPC status (if implemented)
            }
        }

        // === Action Slot Handlers ===
        document.querySelectorAll('.action-slot').forEach((slot, index) => {
            slot.addEventListener('click', function() {
                const key = index + 1;
                console.log(`Action slot ${key} activated`);

                // Visual feedback
                this.style.transform = 'scale(0.9) translateY(-3px)';
                setTimeout(() => {
                    this.style.transform = '';
                }, 200);

                // Activate skill/item in slot
                activateSlot(index + 1, this);
            });
        });

        // Action bar slot activation
        function activateSlot(slotNumber, slotElement) {
            // Check if slot is on cooldown
            if (slotElement.classList.contains('on-cooldown')) {
                console.log(`Slot ${slotNumber} is on cooldown`);

                // Shake animation for cooldown feedback
                slotElement.style.animation = 'shake 0.3s';
                setTimeout(() => {
                    slotElement.style.animation = '';
                }, 300);
                return;
            }

            // Get slot data
            const slotEmoji = slotElement.textContent.trim();
            const slotKey = slotElement.dataset.key || slotNumber;

            console.log(`Activating slot ${slotNumber} (${slotEmoji})`);

            // Simulate ability activation
            showAbilityActivation(slotNumber, slotEmoji);

            // Apply cooldown (example: 3 seconds)
            applyCooldown(slotElement, 3000);

            // POST to backend if needed for game state updates
            // fetch('/api/ability/activate', {...})
        }

        // Show ability activation visual feedback
        function showAbilityActivation(slotNumber, abilityName) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, rgba(212, 175, 55, 0.95), rgba(139, 115, 85, 0.95));
                border: 3px solid #FFD700;
                border-radius: 10px;
                padding: 20px 40px;
                font-family: 'Cinzel', serif;
                font-size: 28px;
                color: #000;
                z-index: 9999;
                box-shadow: 0 0 40px rgba(255, 215, 0, 0.8);
                animation: abilityPop 0.6s ease;
            `;
            notification.textContent = `${abilityName} Activated!`;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translate(-50%, -50%) scale(0.5)';
                notification.style.transition = 'all 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 1000);
        }

        // Apply cooldown to slot
        function applyCooldown(slotElement, duration) {
            slotElement.classList.add('on-cooldown');
            slotElement.style.opacity = '0.5';
            slotElement.style.filter = 'grayscale(1)';
            slotElement.style.pointerEvents = 'none';

            // Cooldown overlay
            const cooldownOverlay = document.createElement('div');
            cooldownOverlay.style.cssText = `
                position: absolute;
                inset: 0;
                background: rgba(0, 0, 0, 0.7);
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-family: 'Cinzel', serif;
                font-size: 24px;
                color: #CD5C5C;
                font-weight: 700;
                animation: cooldownFade ${duration}ms linear;
            `;

            let remainingSeconds = Math.ceil(duration / 1000);
            cooldownOverlay.textContent = remainingSeconds;
            slotElement.appendChild(cooldownOverlay);

            // Update countdown every second
            const countdownInterval = setInterval(() => {
                remainingSeconds--;
                if (remainingSeconds > 0) {
                    cooldownOverlay.textContent = remainingSeconds;
                } else {
                    clearInterval(countdownInterval);
                }
            }, 1000);

            // Remove cooldown after duration
            setTimeout(() => {
                slotElement.classList.remove('on-cooldown');
                slotElement.style.opacity = '';
                slotElement.style.filter = '';
                slotElement.style.pointerEvents = '';
                cooldownOverlay.remove();
            }, duration);
        }

        // === Party Member Card Handlers ===
        document.querySelectorAll('.party-member').forEach(member => {
            member.addEventListener('click', function() {
                const name = this.querySelector('.member-name').textContent;
                console.log(`${name} selected`);

                // Highlight selected member
                document.querySelectorAll('.party-member').forEach(m => {
                    m.style.borderColor = '#8B7355';
                    m.style.background = 'rgba(0, 0, 0, 0.4)';
                });
                this.style.borderColor = '#FFD700';
                this.style.background = 'rgba(212, 175, 55, 0.2)';

                // Show member details panel
                const memberData = {
                    name: this.querySelector('.member-name').textContent,
                    emoji: this.textContent.split('\n')[0].trim(),
                    hp: this.querySelector('.member-hp')?.textContent || '100/100',
                    role: this.dataset.role || 'Unknown'
                };
                showMemberDetails(memberData);
            });
        });

        // Show party member details in a modal panel
        function showMemberDetails(memberData) {
            // Remove existing details panel if any
            const existing = document.querySelector('.member-details-modal');
            if (existing) {
                existing.remove();
            }

            // Create modal
            const modal = document.createElement('div');
            modal.className = 'member-details-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.85);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                animation: fadeIn 0.3s ease;
            `;

            // Create panel
            const panel = document.createElement('div');
            panel.style.cssText = `
                background: linear-gradient(135deg, rgba(42, 36, 30, 0.98) 0%, rgba(26, 22, 18, 0.98) 100%);
                border: 3px solid #D4AF37;
                border-radius: 15px;
                padding: 30px;
                max-width: 500px;
                width: 90%;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.9), 0 0 40px rgba(212, 175, 55, 0.3);
                animation: slideUp 0.3s ease;
            `;

            panel.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h2 style="font-family: 'Cinzel', serif; font-size: 32px; color: #D4AF37; margin: 0;">
                        ${memberData.emoji} ${memberData.name}
                    </h2>
                    <button class="close-details-btn" style="
                        background: rgba(205, 92, 92, 0.3);
                        border: 2px solid #CD5C5C;
                        color: #CD5C5C;
                        font-size: 24px;
                        width: 40px;
                        height: 40px;
                        border-radius: 50%;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    "></button>
                </div>

                <div style="margin-bottom: 20px;">
                    <div style="font-family: 'Cinzel', serif; font-size: 14px; color: #8B7355; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">
                        Role
                    </div>
                    <div style="font-family: 'Yrsa', serif; font-size: 20px; color: #D4AF37;">
                        ${memberData.role}
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <div style="font-family: 'Cinzel', serif; font-size: 14px; color: #8B7355; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">
                        Health
                    </div>
                    <div style="
                        background: rgba(0, 0, 0, 0.5);
                        border: 2px solid #8B7355;
                        border-radius: 8px;
                        padding: 8px;
                        font-family: 'Yrsa', serif;
                        font-size: 18px;
                        color: #90EE90;
                    ">
                         ${memberData.hp}
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <div style="font-family: 'Cinzel', serif; font-size: 14px; color: #8B7355; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">
                        Equipment
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                        <div style="background: rgba(0, 0, 0, 0.5); border: 2px solid #8B7355; border-radius: 6px; padding: 10px; text-align: center; color: #D4AF37;">
                             Weapon
                        </div>
                        <div style="background: rgba(0, 0, 0, 0.5); border: 2px solid #8B7355; border-radius: 6px; padding: 10px; text-align: center; color: #D4AF37;">
                             Armor
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <div style="font-family: 'Cinzel', serif; font-size: 14px; color: #8B7355; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">
                        Active Effects
                    </div>
                    <div style="
                        background: rgba(139, 69, 139, 0.2);
                        border: 2px solid #8B458B;
                        border-radius: 6px;
                        padding: 12px;
                        font-family: 'Yrsa', serif;
                        font-size: 16px;
                        color: #DA70D6;
                        font-style: italic;
                    ">
                         No active effects
                    </div>
                </div>
            `;

            modal.appendChild(panel);
            document.body.appendChild(modal);

            // Close button handler
            panel.querySelector('.close-details-btn').addEventListener('click', () => {
                modal.style.opacity = '0';
                setTimeout(() => modal.remove(), 300);
            });

            // Close on backdrop click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.opacity = '0';
                    setTimeout(() => modal.remove(), 300);
                }
            });

            // Close button hover effect
            const closeBtn = panel.querySelector('.close-details-btn');
            closeBtn.addEventListener('mouseenter', () => {
                closeBtn.style.background = 'rgba(205, 92, 92, 0.6)';
                closeBtn.style.transform = 'scale(1.1)';
            });
            closeBtn.addEventListener('mouseleave', () => {
                closeBtn.style.background = 'rgba(205, 92, 92, 0.3)';
                closeBtn.style.transform = 'scale(1)';
            });
        }


        // === Scenario Loading Functions ===
        function loadNewScenario(scenarioData) {
            // Update narrative text
            // Update whispers
            // Update choices
            // Add Divine Council dialogue when choice is made
            console.log('Loading scenario:', scenarioData.theme);
        }

        function showDivineCouncilResponse(councilData) {
            // councilData contains god speeches and judgment
            // Animate god speech boxes appearing one by one
            const speeches = document.querySelectorAll('.god-speech');
            speeches.forEach((speech, index) => {
                setTimeout(() => {
                    speech.style.opacity = '0';
                    speech.style.transform = 'translateY(20px)';
                    speech.style.transition = 'all 0.5s ease';
                    setTimeout(() => {
                        speech.style.opacity = '1';
                        speech.style.transform = 'translateY(0)';
                    }, 50);
                }, index * 200);
            });
        }

        
        // ============================================
        // INVENTORY OVERLAY HANDLERS
        // ============================================

    // Inventory Overlay Management
    const inventoryOverlay = document.getElementById('inventory-overlay');
    const closeBtn = inventoryOverlay.querySelector('.close-btn');
    const filterBtns = inventoryOverlay.querySelectorAll('.filter-btn');
    const detailsContent = inventoryOverlay.querySelector('.details-content');

    // Close button handler
    if (closeBtn) {
        closeBtn.addEventListener('click', () => {
            inventoryOverlay.classList.remove('active');
        });
    }

    // Filter button handlers
    filterBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            filterBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const filter = btn.getAttribute('data-filter');
            console.log('Filter changed to:', filter);
        });
    });

    // Item hover handlers for detail display
    const allItems = inventoryOverlay.querySelectorAll('[data-item-id]');
    allItems.forEach(item => {
        item.addEventListener('mouseenter', (e) => {
            const tooltip = item.getAttribute('data-tooltip');
            if (tooltip) {
                // XSS Fix: Use textContent instead of innerHTML
                const p = document.createElement('p');
                p.textContent = tooltip;
                detailsContent.innerHTML = ''; // Clear first
                detailsContent.appendChild(p);
            }
        });

        item.addEventListener('mouseleave', () => {
            detailsContent.innerHTML = '<p class="details-placeholder">Hover over an item to view details</p>';
        });
    });

    // Keyboard toggle (I key)

        // ============================================
        // ADDITIONAL OVERLAY ENHANCEMENTS
        // ============================================

// Quest Tab Switching
document.querySelectorAll('.quest-tab').forEach(tab => {
    tab.addEventListener('click', function() {
        const tabName = this.getAttribute('data-tab');

        // Update active tab
        document.querySelectorAll('.quest-tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');

        // Update visible content
        document.getElementById('active-quests').classList.toggle('hidden');
        document.getElementById('completed-quests').classList.toggle('hidden');
    });
});

// Settings Tab Switching
document.querySelectorAll('.settings-tab').forEach(tab => {
    tab.addEventListener('click', function() {
        const tabName = this.getAttribute('data-tab');

        // Update active tab
        document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');

        // Update visible content
        document.querySelectorAll('.settings-tab-content').forEach(content => {
            content.classList.add('hidden');
        });

        document.getElementById(`${tabName}-settings`).classList.remove('hidden');
    });
});

// Volume slider handlers
document.querySelectorAll('.volume-slider').forEach(slider => {
    slider.addEventListener('input', function() {
        const valueDisplay = this.parentElement.querySelector('.volume-value');
        if (valueDisplay) {
            valueDisplay.textContent = this.value + '%';
        }
    });
});

console.log('Overlay enhancements loaded successfully');


        
        
        // QUEST/SETTINGS TAB SWITCHING - INTEGRATED
        // ============================================
// Quest Tab Switching
document.querySelectorAll('.quest-tab').forEach(tab => {
    tab.addEventListener('click', function() {
        const tabName = this.getAttribute('data-tab');

        // Update active tab
        document.querySelectorAll('.quest-tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');

        // Update visible content
        document.getElementById('active-quests').classList.toggle('hidden');
        document.getElementById('completed-quests').classList.toggle('hidden');
    });
});

// Settings Tab Switching
document.querySelectorAll('.settings-tab').forEach(tab => {
    tab.addEventListener('click', function() {
        const tabName = this.getAttribute('data-tab');

        // Update active tab
        document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');

        // Update visible content
        document.querySelectorAll('.settings-tab-content').forEach(content => {
            content.classList.add('hidden');
        });

        document.getElementById(`${tabName}-settings`).classList.remove('hidden');
    });
});

// Volume slider handlers
document.querySelectorAll('.volume-slider').forEach(slider => {
    slider.addEventListener('input', function() {
        const valueDisplay = this.parentElement.querySelector('.volume-value');
        if (valueDisplay) {
            valueDisplay.textContent = this.value + '%';
        }
    });
});

console.log('Overlay enhancements loaded successfully');

        // ========================================
        // PHASE 3A: DYNAMIC DATA LOADING
        // ========================================

        /**
         * Load all game data from backend APIs
         * Call this on page load and after major game events
         */
        async function loadGameData() {
            console.log('Loading game data from backend...');

            try {
                // Load all data in parallel for performance
                await Promise.all([
                    loadCharacterStats(),
                    loadInventoryData(),
                    loadDivineFavor(),
                    loadPartyTrust(),
                    loadNPCData(),
                    loadQuestData()
                ]);

                console.log('All game data loaded successfully');
            } catch (error) {
                console.error('Error loading game data:', error);
            }
        }

        /**
         * Load character stats from /api/character/stats
         * Updates Character overlay with current stats
         */
        async function loadCharacterStats() {
            try {
                // TODO: Uncomment when backend ready
                // const response = await fetch('/api/character/stats');
                // const data = await response.json();

                // Mock data for now
                const data = {
                    name: 'Aldric',
                    class: 'Fighter',
                    level: 5,
                    stats: {
                        strength: 16,
                        dexterity: 14,
                        constitution: 15,
                        intelligence: 10,
                        wisdom: 12,
                        charisma: 8
                    },
                    hp: { current: 45, max: 50 }
                };

                // Update UI elements
                updateCharacterDisplay(data);

                return data;
            } catch (error) {
                console.error('Failed to load character stats:', error);
                throw error;
            }
        }

        /**
         * Update character display elements with loaded data
         */
        function updateCharacterDisplay(data) {
            // Update character name
            const nameElements = document.querySelectorAll('.character-name');
            nameElements.forEach(el => el.textContent = data.name);

            // Update stat values
            if (data.stats) {
                const statMap = {
                    'strength': data.stats.strength,
                    'dexterity': data.stats.dexterity,
                    'constitution': data.stats.constitution,
                    'intelligence': data.stats.intelligence,
                    'wisdom': data.stats.wisdom,
                    'charisma': data.stats.charisma
                };

                Object.keys(statMap).forEach(stat => {
                    const statElement = document.querySelector(`.stat-${stat} .stat-value`);
                    if (statElement) {
                        statElement.textContent = statMap[stat];
                    }
                });
            }

            // Update HP display
            if (data.hp) {
                const hpElements = document.querySelectorAll('.hp-value');
                hpElements.forEach(el => {
                    el.textContent = `${data.hp.current}/${data.hp.max}`;
                });
            }

            console.log('Character display updated');
        }

        /**
         * Load inventory data from /api/inventory
         * Updates Inventory overlay with current items
         */
        async function loadInventoryData() {
            try {
                // TODO: Uncomment when backend ready
                // const response = await fetch('/api/inventory');
                // const data = await response.json();

                // Mock data for now
                const data = {
                    items: [
                        { name: 'Potion of Healing', quantity: 3, rarity: 'common' },
                        { name: 'Ancient Scroll', quantity: 1, rarity: 'rare' }
                    ],
                    gold: 150
                };

                updateInventoryDisplay(data);

                return data;
            } catch (error) {
                console.error('Failed to load inventory:', error);
                throw error;
            }
        }

        /**
         * Update inventory display elements
         */
        function updateInventoryDisplay(data) {
            // Update inventory grid (when implemented)
            console.log('Inventory data loaded:', data);

            // Update gold display
            if (data.gold !== undefined) {
                const goldElements = document.querySelectorAll('.gold-amount');
                goldElements.forEach(el => el.textContent = data.gold);
            }

            console.log('Inventory display updated');
        }

        /**
         * Load divine favor values from /api/divine-favor
         * Updates Character overlay Divine Favor bars
         */
        async function loadDivineFavor() {
            try {
                // TODO: Uncomment when backend ready
                // const response = await fetch('/api/divine-favor');
                // const data = await response.json();

                // Mock data for now
                const data = {
                    valdris: 15,
                    kaitha: -10,
                    morvane: 20,
                    sylara: 5,
                    korvan: 25,
                    athena: 10,
                    mercus: -5
                };

                updateDivineFavorDisplay(data);

                return data;
            } catch (error) {
                console.error('Failed to load divine favor:', error);
                throw error;
            }
        }

        /**
         * Update divine favor bar displays
         */
        function updateDivineFavorDisplay(favorData) {
            Object.keys(favorData).forEach(god => {
                const value = favorData[god];
                const percentage = Math.max(0, Math.min(100, ((value + 50) / 100) * 100));

                // Update bar width
                const barElement = document.querySelector(`.${god}-bar`);
                if (barElement) {
                    barElement.style.width = `${percentage}%`;
                }

                // Update value display
                const valueElement = barElement?.parentElement?.querySelector('.divine-value');
                if (valueElement) {
                    valueElement.textContent = value > 0 ? `+${value}` : value;
                    valueElement.classList.toggle('negative', value < 0);
                }
            });

            console.log('Divine favor display updated');
        }

        /**
         * Load party trust from /api/party/trust
         * Updates trust meter visualization
         */
        async function loadPartyTrust() {
            try {
                // TODO: Uncomment when backend ready
                // const response = await fetch('/api/party/trust');
                // const data = await response.json();

                // Mock data for now
                const data = {
                    trust: 65,
                    tier: 'Professional'
                };

                updateTrustDisplay(data);

                return data;
            } catch (error) {
                console.error('Failed to load party trust:', error);
                throw error;
            }
        }

        /**
         * Update trust meter display
         */
        function updateTrustDisplay(trustData) {
            // Update trust bar (when implemented in UI)
            console.log('Trust data loaded:', trustData);

            // This would update a trust bar visualization
            const trustElements = document.querySelectorAll('.trust-value');
            trustElements.forEach(el => {
                el.textContent = `${trustData.trust}%`;
            });

            console.log('Trust display updated');
        }

        /**
         * Load NPC data from /api/npcs
         * Updates party member cards
         */
        async function loadNPCData() {
            try {
                // TODO: Uncomment when backend ready
                // const response = await fetch('/api/npcs');
                // const data = await response.json();

                // Mock data for now
                const data = {
                    npcs: [
                        { name: 'Grimsby', approval: 75, hp: { current: 30, max: 40 } },
                        { name: 'Renna', approval: 50, hp: { current: 25, max: 35 } }
                    ]
                };

                updateNPCDisplay(data);

                return data;
            } catch (error) {
                console.error('Failed to load NPC data:', error);
                throw error;
            }
        }

        /**
         * Update NPC/party member displays
         */
        function updateNPCDisplay(npcData) {
            console.log('NPC data loaded:', npcData);

            // This would update party member cards in the UI
            npcData.npcs.forEach((npc, index) => {
                const memberCard = document.querySelectorAll('.party-member')[index];
                if (memberCard) {
                    const hpElement = memberCard.querySelector('.member-hp');
                    if (hpElement) {
                        hpElement.textContent = `${npc.hp.current}/${npc.hp.max}`;
                    }
                }
            });

            console.log('NPC display updated');
        }

        /**
         * Load quest data from /api/quests
         * Updates Quest overlay
         */
        async function loadQuestData() {
            try {
                // TODO: Uncomment when backend ready
                // const response = await fetch('/api/quests');
                // const data = await response.json();

                // Mock data for now
                const data = {
                    quests: [
                        {
                            title: "The Warehouse Heist",
                            status: 'active',
                            objectives: [
                                { text: 'Infiltrate warehouse', completed: false },
                                { text: 'Find medicine', completed: false }
                            ]
                        }
                    ]
                };

                updateQuestDisplay(data);

                return data;
            } catch (error) {
                console.error('Failed to load quest data:', error);
                throw error;
            }
        }

        /**
         * Update quest display
         */
        function updateQuestDisplay(questData) {
            console.log('Quest data loaded:', questData);
            // This would populate the quest overlay with active quests
            console.log('Quest display updated');
        }

        // Load all game data on page load
        // Uncomment this when backend APIs are ready
        // loadGameData();


        console.log('The Arcane Codex UI loaded - All interactive elements ready');
    
                                // === Retention System (Phase B) ===
        // Simulate achievement unlock
        setTimeout(() => {
            const achievementPopup = document.querySelector('.achievement-popup');
            achievementPopup.classList.add('show');

            // Play sound effect (in real implementation)
            // playSound('achievement.mp3');

            setTimeout(() => {
                achievementPopup.classList.remove('show');
            }, 5000);
        }, 2000);

        // Animate battle pass fill
        let battlePassProgress = 35;
        setInterval(() => {
            battlePassProgress = Math.min(battlePassProgress + 5, 100);
            const tierFill = document.querySelector('.tier-fill');
            if (tierFill) {
                tierFill.style.width = `${battlePassProgress}%`;
            }

            if (battlePassProgress === 100) {
                // Unlock next tier
                const nextNode = document.querySelector('.tier-node:not(.unlocked)');
                if (nextNode) {
                    nextNode.classList.add('unlocked');
                    battlePassProgress = 0;
                }
            }
        }, 1000);

        // Claim daily reward - with null check
        const claimButton = document.querySelector('.claim-button');
        if (claimButton) {
            claimButton.addEventListener('click', function() {
                const todaySlot = document.querySelector('.day-slot.today');
                if (todaySlot) {
                    todaySlot.classList.remove('today');
                    todaySlot.classList.add('claimed');
                }
                this.disabled = true;
                this.textContent = 'Claimed!';

                // Show reward animation
                // In real implementation, show reward details
            });
        }

        // Update event timer
        setInterval(() => {
            // In real implementation, calculate actual time remaining
            const timerEl = document.querySelector('.event-timer');
            // Update timer text
        }, 1000);

        // === Onboarding System (Phase B) ===
        // Character selection
        document.querySelectorAll('.character-card').forEach(card => {
            card.addEventListener('click', function() {
                document.querySelectorAll('.character-card').forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');
                document.querySelector('.start-adventure-btn').disabled = false;
            });
        });

        // Tutorial system
        const tutorialSteps1 = [ // RENAMED TO AVOID DUPLICATE
            {
                element: '.character-panel',
                title: 'Character Panel',
                text: 'View your stats, level, and equipment here. Press C to open anytime.',
                position: 'right'
            },
            {
                element: '.inventory-btn',
                title: 'Inventory',
                text: 'Manage your items and equipment. Press I for quick access.',
                position: 'bottom'
            },
            {
                element: '.quest-log',
                title: 'Quest Log',
                text: 'Track your active quests and objectives. Press J to view.',
                position: 'left'
            },
            {
                element: '.action-bar',
                title: 'Action Bar',
                text: 'Use your abilities in combat. Number keys 1-5 activate skills.',
                position: 'top'
            },
            {
                element: '.divine-favor',
                title: 'Divine Favor',
                text: 'The gods watch your actions. Their favor affects your journey.',
                position: 'left'
            }
        ];

        let currentStep = 0;

        function showTutorialStep(step) {
            const tooltip = document.querySelector('.tutorial-tooltip');
            const hole = document.querySelector('.spotlight-hole');
            const dots = document.querySelectorAll('.progress-dot');

            // Update progress dots
            dots.forEach((dot, index) => {
                dot.classList.toggle('active', index <= step);
            });

            // Update content
            tooltip.querySelector('.tutorial-title').textContent = tutorialSteps[step].title;
            tooltip.querySelector('.tutorial-text').textContent = tutorialSteps[step].text;

            // Position spotlight and tooltip
            // (In real implementation, position based on actual element coordinates)
        }

        // Start button
        document.querySelector('.start-adventure-btn').addEventListener('click', function() {
            // Fade out welcome screen
            const welcomeScreen = document.querySelector('.onboarding-overlay');
            welcomeScreen.style.animation = 'fadeOut 0.5s ease';
            setTimeout(() => {
                welcomeScreen.style.display = 'none';
                // Start tutorial
                document.querySelector('.tutorial-spotlight').classList.add('active');
                document.querySelector('.ftue-checklist').style.display = 'block';
            }, 500);
        });

        // Tutorial navigation
        document.querySelector('.tutorial-btn:not(.skip)').addEventListener('click', function() {
            currentStep++;
            if (currentStep < tutorialSteps.length) {
                showTutorialStep(currentStep);
            } else {
                document.querySelector('.tutorial-spotlight').classList.remove('active');
            }
        });

        // Skip tutorial
        document.querySelector('.tutorial-btn.skip').addEventListener('click', function() {
            document.querySelector('.tutorial-spotlight').classList.remove('active');
        });

        // Simulate FTUE progress
        let ftueProgress = 20;
        setInterval(() => {
            if (ftueProgress < 100) {
                ftueProgress += 20;
                document.querySelector('.ftue-progress-fill').style.width = `${ftueProgress}%`;

                // Mark items as completed
                const items = document.querySelectorAll('.ftue-item');
                const itemIndex = Math.floor((ftueProgress / 100) * items.length) - 1;
                if (itemIndex >= 0) {
                    items[itemIndex].classList.add('completed');
                }
            }
        }, 3000);

        // === Celebration Animations (Phase B) ===
        // Trigger level up animation
        function triggerLevelUp() {
            const levelUpEl = document.querySelector('.level-up-burst');
            levelUpEl.style.display = 'block';

            // Create particles
            for (let i = 0; i < 30; i++) {
                createParticle(window.innerWidth / 2, window.innerHeight / 2);
            }

            setTimeout(() => {
                levelUpEl.style.display = 'none';
            }, 2000);
        }

        // Trigger quest complete
        function triggerQuestComplete() {
            const questEl = document.querySelector('.quest-complete');
            questEl.style.display = 'block';

            setTimeout(() => {
                questEl.style.display = 'none';
            }, 3000);
        }

        // Trigger divine favor
        function triggerDivineFavor(amount) {
            const favorEl = document.querySelector('.divine-favor-gain');
            const amountEl = favorEl.querySelector('.favor-amount');
            amountEl.textContent = `+${amount}`;
            favorEl.style.display = 'block';

            setTimeout(() => {
                favorEl.style.display = 'none';
            }, 2000);
        }

        // Create floating damage numbers
        function createDamageNumber(x, y, value, type = 'normal') {
            const damageEl = document.createElement('div');
            damageEl.className = `damage-number ${type}`;
            damageEl.textContent = type === 'heal' ? `+${value}` : `-${value}`;
            damageEl.style.left = `${x}px`;
            damageEl.style.top = `${y}px`;
            document.body.appendChild(damageEl);

            setTimeout(() => {
                damageEl.remove();
            }, 1000);
        }

        // Create particle effect
        function createParticle(x, y) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.left = `${x}px`;
            particle.style.top = `${y}px`;
            particle.style.setProperty('--drift', `${(Math.random() - 0.5) * 60}px`);
            particle.style.animation = `particleFloat ${1 + Math.random()}s ease-out`;
            document.body.appendChild(particle);

            setTimeout(() => {
                particle.remove();
            }, 2000);
        }

        // Demo animations - DISABLED for normal gameplay
        // setTimeout(() => triggerLevelUp(), 1000);
        // setTimeout(() => triggerQuestComplete(), 3000);
        // setTimeout(() => triggerDivineFavor(15), 5000);

        // Create some damage numbers
        setInterval(() => {
            const x = Math.random() * window.innerWidth;
            const y = Math.random() * window.innerHeight;
            const types = ['normal', 'critical', 'heal'];
            const type = types[Math.floor(Math.random() * types.length)];
            const value = Math.floor(Math.random() * 100) + 20;
            createDamageNumber(x, y, value, type);
        }, 2000);

        // Animate XP bar
        let xpProgress = 65; // Renamed from currentXP to avoid duplicate declaration
        setInterval(() => {
            xpProgress = Math.min(xpProgress + 5, 100);
            document.querySelector('.xp-fill').style.width = `${xpProgress}%`;

            if (xpProgress === 100) {
                triggerLevelUp();
                xpProgress = 0;
            }
        }, 3000);

        // === Loading States (Phase B) ===
        // Rotate loading tips (no duplicates)

        // Example: Show success animation
        function showSuccess() {
            const successEl = document.querySelector('.success-pulse');
            successEl.style.display = 'block';
            setTimeout(() => {
                successEl.style.display = 'none';
            }, 1000);
        }

        // Demo success after 5 seconds
        setTimeout(showSuccess, 5000);
    
        
        // === PHASE D: Backend Integration ===

        // API helper function with error handling
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetchWithCSRF(endpoint, options);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                return await response.json();
            } catch (error) {
                console.error(`API Error [${endpoint}]:`, error);
                throw error;
            }
        }

        // Load character stats for character sheet overlay
        async function loadCharacterStats() {
            try {
                gameUX.showLoading('Loading character data...');

                const data = await apiCall('/api/character/stats');

                // Update character sheet UI
                const charOverlay = document.getElementById('character-overlay');
                if (!charOverlay) return;

                // Update stats
                const stats = data.stats;
                for (const [stat, value] of Object.entries(stats)) {
                    const statElement = charOverlay.querySelector(`[data-stat="${stat}"]`);
                    if (statElement) {
                        statElement.textContent = value;
                    }
                }

                // Update level
                const levelBadge = charOverlay.querySelector('.level-badge');
                if (levelBadge) levelBadge.textContent = `Level ${data.level}`;

                // Update XP bar
                const xpBar = charOverlay.querySelector('.xp-fill');
                if (xpBar) {
                    const xpPercent = (data.xp / data.xp_to_next) * 100;
                    xpBar.style.width = `${xpPercent}%`;
                }

                // Update HP
                const hpText = charOverlay.querySelector('.hp-text');
                if (hpText) hpText.textContent = `${data.hp} / ${data.max_hp}`;

                // Update class
                const className = charOverlay.querySelector('.character-class');
                if (className) className.textContent = data.class;

                gameUX.hideLoading();
                console.log('[Phase D] Character stats loaded');

            } catch (error) {
                gameUX.hideLoading();
                console.error('Failed to load character stats:', error);
            }
        }

        // Load divine favor for character sheet
        async function loadDivineFavor() {
            try {
                const data = await apiCall('/api/character/divine_favor');

                const charOverlay = document.getElementById('character-overlay');
                if (!charOverlay) return;

                // Update favor bars for each god
                const favor = data.favor;
                for (const [godName, favorValue] of Object.entries(favor)) {
                    const favorBar = charOverlay.querySelector(`[data-god="${godName}"] .favor-bar-fill`);
                    if (favorBar) {
                        // Favor ranges from -100 to 100, normalize to 0-100%
                        const favorPercent = ((favorValue + 100) / 200) * 100;
                        favorBar.style.width = `${favorPercent}%`;

                        // Color based on favor level
                        if (favorValue > 50) favorBar.style.background = '#4CAF50'; // Green
                        else if (favorValue < -50) favorBar.style.background = '#F44336'; // Red
                        else favorBar.style.background = '#FFC107'; // Amber
                    }

                    const favorText = charOverlay.querySelector(`[data-god="${godName}"] .favor-value`);
                    if (favorText) favorText.textContent = favorValue;
                }

                console.log('[Phase D] Divine favor loaded');

            } catch (error) {
                console.error('Failed to load divine favor:', error);
            }
        }

        // Load inventory for inventory overlay
        async function loadInventory() {
            try {
                gameUX.showLoading('Loading inventory...');

                const data = await apiCall('/api/inventory/all');

                const invOverlay = document.getElementById('inventory-overlay');
                if (!invOverlay) return;

                // Update inventory grid
                const inventoryGrid = invOverlay.querySelector('.inventory-grid');
                if (inventoryGrid) {
                    inventoryGrid.innerHTML = ''; // Clear existing

                    // Add items
                    data.items.forEach(item => {
                        const slot = document.createElement('div');
                        slot.className = 'inventory-slot';
                        if (item.equipped) slot.classList.add('equipped');
                        slot.setAttribute('data-item-id', item.id);
                        slot.setAttribute('data-tooltip', item.description);

                        slot.innerHTML = `
                            <div class="item-icon">${getItemIcon(item.type)}</div>
                            ${item.quantity > 1 ? `<div class="item-quantity">${item.quantity}</div>` : ''}
                        `;

                        inventoryGrid.appendChild(slot);
                    });

                    // Fill empty slots
                    const emptySlots = 48 - data.items.length;
                    for (let i = 0; i < emptySlots; i++) {
                        const emptySlot = document.createElement('div');
                        emptySlot.className = 'inventory-slot empty';
                        inventoryGrid.appendChild(emptySlot);
                    }
                }

                // Update gold
                const goldDisplay = invOverlay.querySelector('.gold-amount');
                if (goldDisplay) goldDisplay.textContent = data.gold;

                // Update weight
                const weightDisplay = invOverlay.querySelector('.weight-display');
                if (weightDisplay) {
                    weightDisplay.textContent = `${data.weight} / ${data.max_weight}`;
                }

                gameUX.hideLoading();
                console.log('[Phase D] Inventory loaded');

            } catch (error) {
                gameUX.hideLoading();
                console.error('Failed to load inventory:', error);
            }
        }

        // Helper function to get item icon emoji
        function getItemIcon(itemType) {
            const icons = {
                'weapon': '',
                'armor': '',
                'potion': '',
                'scroll': '',
                'food': '',
                'quest': '',
                'treasure': '',
                'default': ''
            };
            return icons[itemType] || icons.default;
        }

        // Load quests for quest overlay
        async function loadQuests(type = 'active') {
            try {
                gameUX.showLoading(`Loading ${type} quests...`);

                const endpoint = type === 'active' ? '/api/quests/active' : '/api/quests/completed';
                const data = await apiCall(endpoint);

                const questOverlay = document.getElementById('quests-overlay');
                if (!questOverlay) return;

                const questList = questOverlay.querySelector('.quest-list');
                if (questList) {
                    questList.innerHTML = ''; // Clear existing

                    if (data.quests.length === 0) {
                        questList.innerHTML = `<div class="no-quests">No ${type} quests</div>`;
                    } else {
                        data.quests.forEach(quest => {
                            const questItem = document.createElement('div');
                            questItem.className = 'quest-item';
                            questItem.setAttribute('data-quest-id', quest.id);

                            questItem.innerHTML = `
                                <div class="quest-title">${quest.name}</div>
                                <div class="quest-description">${quest.description}</div>
                                ${quest.progress !== undefined ? `
                                    <div class="quest-progress-bar">
                                        <div class="quest-progress-fill" style="width: ${quest.progress}%"></div>
                                    </div>
                                ` : ''}
                            `;

                            questList.appendChild(questItem);
                        });
                    }
                }

                gameUX.hideLoading();
                console.log(`[Phase D] ${type} quests loaded`);

            } catch (error) {
                gameUX.hideLoading();
                console.error(`Failed to load ${type} quests:`, error);
            }
        }

        // Load current scenario
        async function loadCurrentScenario() {
            try {
                gameUX.showLoading('Loading scenario...');

                const data = await apiCall('/api/current_scenario');

                // Update scenario title
                const titleElement = document.querySelector('.scenario-title');
                if (titleElement) titleElement.textContent = data.title || 'The Adventure Begins';

                // Update scenario description
                const descElement = document.querySelector('.scenario-description');
                if (descElement) descElement.textContent = data.description || 'Your journey awaits...';

                // Update choices
                const choicesContainer = document.querySelector('.choices-container');
                if (choicesContainer && data.choices) {
                    choicesContainer.innerHTML = '';

                    data.choices.forEach((choice, index) => {
                        const button = document.createElement('button');
                        button.className = 'choice-button';
                        button.textContent = choice.text;
                        button.onclick = () => submitChoice(choice.id);
                        choicesContainer.appendChild(button);
                    });
                }

                gameUX.hideLoading();
                console.log('[Phase D] Current scenario loaded');

            } catch (error) {
                gameUX.hideLoading();
                console.error('Failed to load scenario:', error);
            }
        }

        // Submit player choice
        async function submitChoice(choiceId) {
            try {
                gameUX.showLoading('Processing your choice...');

                const data = await apiCall('/api/make_choice', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ choice: choiceId })
                });

                // Show consequences
                if (data.consequence) {
                    const narrativePanel = document.querySelector('.scene-narrative-panel');
                    if (narrativePanel) {
                        const consequenceDiv = document.createElement('div');
                        consequenceDiv.className = 'narrative-text consequence';
                        consequenceDiv.textContent = data.consequence;
                        narrativePanel.appendChild(consequenceDiv);
                    }
                }

                // Check for level up
                if (data.level_up) {
                    gameUX.celebrate('levelup', { level: data.new_level });
                }

                // Check for quest completion
                if (data.quest_completed) {
                    gameUX.celebrate('quest', { quest: data.quest_name });
                }

                // Reload scenario for next turn
                await loadCurrentScenario();

                gameUX.hideLoading();
                console.log('[Phase D] Choice submitted successfully');

            } catch (error) {
                gameUX.hideLoading();
                console.error('Failed to submit choice:', error);
            }
        }

        // Auto-refresh game state periodically
        function startGameStatePolling() {
            setInterval(async () => {
                try {
                    const data = await apiCall('/api/game_state');

                    // Update health bar
                    const hpBar = document.querySelector('.hp-bar-fill');
                    if (hpBar && data.character) {
                        const hpPercent = (data.character.hp / data.character.max_hp) * 100;
                        hpBar.style.width = `${hpPercent}%`;
                    }

                    // Update level display
                    const levelDisplay = document.querySelector('.player-level');
                    if (levelDisplay && data.character) {
                        levelDisplay.textContent = `Lv. ${data.character.level}`;
                    }

                } catch (error) {
                    // Silent fail for polling errors
                }
            }, 5000); // Poll every 5 seconds
        }

        // Hook into overlay open events
        document.addEventListener('DOMContentLoaded', () => {
            // Load character data when character overlay opens
            const charButton = document.querySelector('[data-overlay="character-overlay"]');
            if (charButton) {
                charButton.addEventListener('click', () => {
                    loadCharacterStats();
                    loadDivineFavor();
                });
            }

            // Load inventory when inventory overlay opens
            const invButton = document.querySelector('[data-overlay="inventory-overlay"]');
            if (invButton) {
                invButton.addEventListener('click', loadInventory);
            }

            // Load quests when quest overlay opens
            const questButton = document.querySelector('[data-overlay="quests-overlay"]');
            if (questButton) {
                questButton.addEventListener('click', () => loadQuests('active'));
            }

            // Quest tab switching
            const activeTab = document.querySelector('.quest-tab[data-tab="active"]');
            const completedTab = document.querySelector('.quest-tab[data-tab="completed"]');

            if (activeTab) activeTab.addEventListener('click', () => loadQuests('active'));
            if (completedTab) completedTab.addEventListener('click', () => loadQuests('completed'));

            // Load initial scenario
            loadCurrentScenario();

            // Start polling for game state updates
            startGameStatePolling();

            console.log('[Phase D] Frontend connected to backend');
        });

        // === UX System Initialization (Phase B) ===
        class GameUX {
            constructor() {
                this.loadingShown = false;
                this.celebrationsEnabled = true;
            }

            showLoading(message = 'Loading...') {
                if (this.loadingShown) return;
                this.loadingShown = true;

                const loadingContainer = document.querySelector('.loading-container');
                if (loadingContainer) {
                    loadingContainer.classList.add('active');
                    const loadingText = loadingContainer.querySelector('.loading-text');
                    if (loadingText) loadingText.textContent = message;
                }
            }

            hideLoading() {
                this.loadingShown = false;
                const loadingContainer = document.querySelector('.loading-container');
                if (loadingContainer) {
                    loadingContainer.classList.remove('active');
                }
            }

            celebrate(type, data = {}) {
                if (!this.celebrationsEnabled) return;

                switch(type) {
                    case 'levelup':
                        if (typeof showLevelUp !== 'undefined') showLevelUp(data.level || 1);
                        break;
                    case 'quest':
                        if (typeof showQuestComplete !== 'undefined') showQuestComplete(data.quest || '');
                        break;
                    case 'achievement':
                        if (typeof showAchievement !== 'undefined') showAchievement(data.title || '', data.description || '');
                        break;
                }
            }

            vibrate(pattern = [50]) {
                if (window.navigator.vibrate) {
                    window.navigator.vibrate(pattern);
                }
            }
        }

        // Initialize global UX controller
        const gameUX = new GameUX();
        console.log('[Phase B] UX improvements initialized');

    </script>

                <!-- === Retention System (Phase B) === -->
    <!-- Daily Login Rewards -->
    <div class="daily-rewards-modal">
        <div class="daily-rewards-content">
            <div class="daily-rewards-header">
                <h2 class="daily-rewards-title">Daily Rewards</h2>
                <div class="streak-display">
                    <span class="streak-flame"></span>
                    <span>7 Day Streak!</span>
                </div>
            </div>

            <div class="daily-calendar">
                <div class="day-slot claimed">
                    <div class="day-label">Day 1</div>
                    <div class="day-reward"></div>
                    <div class="day-amount">50 Gold</div>
                </div>
                <div class="day-slot claimed">
                    <div class="day-label">Day 2</div>
                    <div class="day-reward"></div>
                    <div class="day-amount">5 Gems</div>
                </div>
                <div class="day-slot claimed">
                    <div class="day-label">Day 3</div>
                    <div class="day-reward"></div>
                    <div class="day-amount">3 Potions</div>
                </div>
                <div class="day-slot claimed">
                    <div class="day-label">Day 4</div>
                    <div class="day-reward"></div>
                    <div class="day-amount">1 Scroll</div>
                </div>
                <div class="day-slot claimed">
                    <div class="day-label">Day 5</div>
                    <div class="day-reward"></div>
                    <div class="day-amount">100 Gold</div>
                </div>
                <div class="day-slot claimed">
                    <div class="day-label">Day 6</div>
                    <div class="day-reward"></div>
                    <div class="day-amount">Rare Item</div>
                </div>
                <div class="day-slot today">
                    <div class="day-label">Day 7</div>
                    <div class="day-reward"></div>
                    <div class="day-amount">Mystery Box</div>
                </div>
                <div class="day-slot future">
                    <div class="day-label">Day 8</div>
                    <div class="day-reward"></div>
                    <div class="day-amount">150 Gold</div>
                </div>
                <div class="day-slot future">
                    <div class="day-label">Day 9</div>
                    <div class="day-reward"></div>
                    <div class="day-amount">10 Gems</div>
                </div>
                <div class="day-slot future">
                    <div class="day-label">Day 10</div>
                    <div class="day-reward"></div>
                    <div class="day-amount">Epic Weapon</div>
                </div>
                <div class="day-slot future">
                    <div class="day-label">Day 11</div>
                    <div class="day-reward"></div>
                    <div class="day-amount">3 Scrolls</div>
                </div>
                <div class="day-slot future">
                    <div class="day-label">Day 12</div>
                    <div class="day-reward"></div>
                    <div class="day-amount">Epic Armor</div>
                </div>
                <div class="day-slot future">
                    <div class="day-label">Day 13</div>
                    <div class="day-reward"></div>
                    <div class="day-amount">200 Gold</div>
                </div>
                <div class="day-slot future">
                    <div class="day-label">Day 14</div>
                    <div class="day-reward"></div>
                    <div class="day-amount">Legendary</div>
                </div>
            </div>

            <div style="text-align: center;">
                <button class="claim-button">Claim Today's Reward</button>
            </div>
        </div>
    </div>

    <!-- Battle Pass -->
    <div class="battle-pass-container">
        <div class="battle-pass-header">
            <div class="season-title">Season of Shadows</div>
            <div class="season-timer">
                <span class="timer-icon"></span>
                <span class="timer-text">28 days remaining</span>
            </div>
        </div>

        <div class="tier-progress">
            <div class="tier-bar">
                <div class="tier-fill"></div>
                <div class="tier-info">Tier 7 - 350/1000 XP</div>
            </div>
        </div>

        <div class="reward-track">
            <div class="reward-tier">
                <div class="tier-node unlocked"></div>
                <div class="tier-number">1</div>
            </div>
            <div class="reward-tier">
                <div class="tier-node unlocked"></div>
                <div class="tier-number">2</div>
            </div>
            <div class="reward-tier">
                <div class="tier-node unlocked premium"></div>
                <div class="tier-number">3</div>
            </div>
            <div class="reward-tier">
                <div class="tier-node unlocked"></div>
                <div class="tier-number">4</div>
            </div>
            <div class="reward-tier">
                <div class="tier-node unlocked"></div>
                <div class="tier-number">5</div>
            </div>
            <div class="reward-tier">
                <div class="tier-node unlocked premium"></div>
                <div class="tier-number">6</div>
            </div>
            <div class="reward-tier">
                <div class="tier-node unlocked"></div>
                <div class="tier-number">7</div>
            </div>
            <div class="reward-tier">
                <div class="tier-node"></div>
                <div class="tier-number">8</div>
            </div>
            <div class="reward-tier">
                <div class="tier-node premium"></div>
                <div class="tier-number">9</div>
            </div>
            <div class="reward-tier">
                <div class="tier-node"></div>
                <div class="tier-number">10</div>
            </div>
        </div>
    </div>

    <!-- Achievement Popup -->
    <div class="achievement-popup">
        <div class="achievement-header">
            <div class="achievement-icon"></div>
            <div>
                <div class="achievement-label">Achievement Unlocked!</div>
                <div class="achievement-title">Dragon Slayer</div>
            </div>
        </div>
        <div class="achievement-desc">Defeat your first dragon in combat</div>
        <div class="achievement-reward">
            <span>Reward:</span>
            <span> 50 Gems</span>
            <span> Title: Dragonbane</span>
        </div>
    </div>

    <!-- Leaderboard Widget -->
    <div class="leaderboard-widget">
        <div class="leaderboard-title"> Weekly Rankings</div>
        <div class="leaderboard-list">
            <div class="leaderboard-item">
                <div class="leaderboard-rank rank-1">1</div>
                <div class="leaderboard-name">Shadowblade</div>
                <div class="leaderboard-score">12,450</div>
            </div>
            <div class="leaderboard-item">
                <div class="leaderboard-rank rank-2">2</div>
                <div class="leaderboard-name">Firemage</div>
                <div class="leaderboard-score">11,200</div>
            </div>
            <div class="leaderboard-item">
                <div class="leaderboard-rank rank-3">3</div>
                <div class="leaderboard-name">Stormlord</div>
                <div class="leaderboard-score">10,890</div>
            </div>
            <div class="leaderboard-item self">
                <div class="leaderboard-rank">47</div>
                <div class="leaderboard-name">You</div>
                <div class="leaderboard-score">5,230</div>
            </div>
        </div>
    </div>

    <!-- Event Banner -->
    <div class="event-banner">
        <div class="event-content">
            <span class="event-icon"></span>
            <span class="event-text">Blood Moon Rising</span>
            <span class="event-timer">2d 14h 32m</span>
        </div>
    </div>

    <script>
        // [DUPLICATE CODE REMOVED - Already exists in main script block]
        // Update event timer
        setInterval(() => {
            // In real implementation, calculate actual time remaining
            const timerEl = document.querySelector('.event-timer');
            // Update timer text
        }, 1000);
    </script>

    <!-- === Onboarding System (Phase B) === -->
    <!-- Welcome Screen -->
    <div class="onboarding-overlay">
        <div class="welcome-screen">
            <h1 class="welcome-title">The Arcane Codex</h1>
            <p class="welcome-subtitle">Choose your destiny, brave adventurer</p>

            <div class="character-selection">
                <div class="character-card" data-class="warrior">
                    <div class="character-icon"></div>
                    <div class="character-name">Warrior</div>
                    <div class="character-class">Master of Combat</div>
                </div>

                <div class="character-card" data-class="mage">
                    <div class="character-icon"></div>
                    <div class="character-name">Mage</div>
                    <div class="character-class">Wielder of Magic</div>
                </div>

                <div class="character-card" data-class="rogue">
                    <div class="character-icon"></div>
                    <div class="character-name">Rogue</div>
                    <div class="character-class">Shadow Dancer</div>
                </div>

                <div class="character-card" data-class="cleric">
                    <div class="character-icon"></div>
                    <div class="character-name">Cleric</div>
                    <div class="character-class">Divine Healer</div>
                </div>

                <div class="character-card" data-class="ranger">
                    <div class="character-icon"></div>
                    <div class="character-name">Ranger</div>
                    <div class="character-class">Nature's Guard</div>
                </div>

                <div class="character-card" data-class="paladin">
                    <div class="character-icon"></div>
                    <div class="character-name">Paladin</div>
                    <div class="character-class">Holy Defender</div>
                </div>
            </div>

            <button class="start-adventure-btn" disabled>Begin Your Journey</button>
        </div>
    </div>

    <!-- Tutorial Spotlight System -->
    <div class="tutorial-spotlight">
        <div class="spotlight-backdrop"></div>
        <div class="spotlight-hole"></div>
        <div class="tutorial-tooltip top">
            <h3 class="tutorial-title">Welcome to The Arcane Codex!</h3>
            <p class="tutorial-text">Let me guide you through the basics of your adventure. This is your character panel where you can view your stats and equipment.</p>

            <div class="tutorial-progress">
                <div class="progress-dots">
                    <div class="progress-dot active"></div>
                    <div class="progress-dot"></div>
                    <div class="progress-dot"></div>
                    <div class="progress-dot"></div>
                    <div class="progress-dot"></div>
                </div>
                <div class="tutorial-buttons">
                    <button class="tutorial-btn skip">Skip Tour</button>
                    <button class="tutorial-btn">Next</button>
                </div>
            </div>
        </div>
    </div>

    <!-- First Time User Experience Checklist -->
    <div class="ftue-checklist" style="display: none;">
        <div class="ftue-title">
            <span></span>
            <span>Getting Started</span>
        </div>
        <div class="ftue-progress">
            <div class="ftue-progress-fill" style="width: 20%;"></div>
        </div>
        <div class="ftue-item completed">
            <div class="ftue-checkbox"></div>
            <div class="ftue-text">Choose your class</div>
        </div>
        <div class="ftue-item">
            <div class="ftue-checkbox"></div>
            <div class="ftue-text">Complete first quest</div>
        </div>
        <div class="ftue-item">
            <div class="ftue-checkbox"></div>
            <div class="ftue-text">Earn divine favor</div>
        </div>
        <div class="ftue-item">
            <div class="ftue-checkbox"></div>
            <div class="ftue-text">Join a party</div>
        </div>
        <div class="ftue-item">
            <div class="ftue-checkbox"></div>
            <div class="ftue-text">Win first battle</div>
        </div>
    </div>

    <!-- Hint Beacons (positioned absolutely on UI elements) -->
    <div class="hint-beacon" style="top: 100px; right: 50px;">
        <div class="hint-popup">Click here to access your inventory (I)</div>
    </div>

    <!-- Animated Pointer -->
    <div class="pointer-arrow" style="top: 200px; left: 300px; display: none;">
        <svg viewBox="0 0 40 40">
            <path d="M 10 10 L 30 20 L 20 20 L 20 30 L 10 30 Z" fill="#FFD700"/>
        </svg>
    </div>

    <!-- Script removed - duplicate of main script block -->

    <!-- === Celebration Animations (Phase B) === -->
    <!-- Level Up Effect -->
    <div class="level-up-burst" style="display: none;">
        <div class="burst-rays"></div>
        <div class="level-up-text">Level Up!</div>
    </div>

    <!-- Quest Complete -->
    <div class="quest-complete" style="display: none;">
        <div class="quest-banner">
            <div class="quest-text">Quest Complete!</div>
        </div>
    </div>

    <!-- Divine Favor Gain -->
    <div class="divine-favor-gain" style="display: none;">
        <div class="favor-orb"></div>
        <div class="favor-amount">+10</div>
    </div>

    <!-- Streak Counter -->
    <div class="streak-counter">
        <span class="streak-fire"></span>
        <span class="streak-number">7</span>
        <span class="streak-label">Day Streak</span>
    </div>

    <!-- XP Bar -->
    <div class="xp-bar-container">
        <div class="xp-fill" style="width: 65%;"></div>
        <div class="xp-text">Level 12 - 3,250 / 5,000 XP</div>
    </div>

    <script>
        // Trigger level up animation
        function triggerLevelUp() {
            const levelUpEl = document.querySelector('.level-up-burst');
            levelUpEl.style.display = 'block';

            // Create particles
            for (let i = 0; i < 30; i++) {
                createParticle(window.innerWidth / 2, window.innerHeight / 2);
            }

            setTimeout(() => {
                levelUpEl.style.display = 'none';
            }, 2000);
        }

        // Trigger quest complete
        function triggerQuestComplete() {
            const questEl = document.querySelector('.quest-complete');
            questEl.style.display = 'block';

            setTimeout(() => {
                questEl.style.display = 'none';
            }, 3000);
        }

        // Trigger divine favor
        function triggerDivineFavor(amount) {
            const favorEl = document.querySelector('.divine-favor-gain');
            const amountEl = favorEl.querySelector('.favor-amount');
            amountEl.textContent = `+${amount}`;
            favorEl.style.display = 'block';

            setTimeout(() => {
                favorEl.style.display = 'none';
            }, 2000);
        }

        // Create floating damage numbers
        function createDamageNumber(x, y, value, type = 'normal') {
            const damageEl = document.createElement('div');
            damageEl.className = `damage-number ${type}`;
            damageEl.textContent = type === 'heal' ? `+${value}` : `-${value}`;
            damageEl.style.left = `${x}px`;
            damageEl.style.top = `${y}px`;
            document.body.appendChild(damageEl);

            setTimeout(() => {
                damageEl.remove();
            }, 1000);
        }

        // Create particle effect
        function createParticle(x, y) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.left = `${x}px`;
            particle.style.top = `${y}px`;
            particle.style.setProperty('--drift', `${(Math.random() - 0.5) * 60}px`);
            particle.style.animation = `particleFloat ${1 + Math.random()}s ease-out`;
            document.body.appendChild(particle);

            setTimeout(() => {
                particle.remove();
            }, 2000);
        }

        // Demo animations - DISABLED for normal gameplay
        // setTimeout(() => triggerLevelUp(), 1000);
        // setTimeout(() => triggerQuestComplete(), 3000);
        // setTimeout(() => triggerDivineFavor(15), 5000);

        // Create some damage numbers
        setInterval(() => {
            const x = Math.random() * window.innerWidth;
            const y = Math.random() * window.innerHeight;
            const types = ['normal', 'critical', 'heal'];
            const type = types[Math.floor(Math.random() * types.length)];
            const value = Math.floor(Math.random() * 100) + 20;
            createDamageNumber(x, y, value, type);
        }, 2000);

        // Animate XP bar
        let xpProgress = 65; // Renamed from currentXP to avoid duplicate declaration
        setInterval(() => {
            xpProgress = Math.min(xpProgress + 5, 100);
            document.querySelector('.xp-fill').style.width = `${xpProgress}%`;

            if (xpProgress === 100) {
                triggerLevelUp();
                xpProgress = 0;
            }
        }, 3000);
    
        
        // === PHASE D: Backend Integration ===

        // API helper function with error handling
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetchWithCSRF(endpoint, options);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                return await response.json();
            } catch (error) {
                console.error(`API Error [${endpoint}]:`, error);
                throw error;
            }
        }

        // Load character stats for character sheet overlay
        async function loadCharacterStats() {
            try {
                gameUX.showLoading('Loading character data...');

                const data = await apiCall('/api/character/stats');

                // Update character sheet UI
                const charOverlay = document.getElementById('character-overlay');
                if (!charOverlay) return;

                // Update stats
                const stats = data.stats;
                for (const [stat, value] of Object.entries(stats)) {
                    const statElement = charOverlay.querySelector(`[data-stat="${stat}"]`);
                    if (statElement) {
                        statElement.textContent = value;
                    }
                }

                // Update level
                const levelBadge = charOverlay.querySelector('.level-badge');
                if (levelBadge) levelBadge.textContent = `Level ${data.level}`;

                // Update XP bar
                const xpBar = charOverlay.querySelector('.xp-fill');
                if (xpBar) {
                    const xpPercent = (data.xp / data.xp_to_next) * 100;
                    xpBar.style.width = `${xpPercent}%`;
                }

                // Update HP
                const hpText = charOverlay.querySelector('.hp-text');
                if (hpText) hpText.textContent = `${data.hp} / ${data.max_hp}`;

                // Update class
                const className = charOverlay.querySelector('.character-class');
                if (className) className.textContent = data.class;

                gameUX.hideLoading();
                console.log('[Phase D] Character stats loaded');

            } catch (error) {
                gameUX.hideLoading();
                console.error('Failed to load character stats:', error);
            }
        }

        // Load divine favor for character sheet
        async function loadDivineFavor() {
            try {
                const data = await apiCall('/api/character/divine_favor');

                const charOverlay = document.getElementById('character-overlay');
                if (!charOverlay) return;

                // Update favor bars for each god
                const favor = data.favor;
                for (const [godName, favorValue] of Object.entries(favor)) {
                    const favorBar = charOverlay.querySelector(`[data-god="${godName}"] .favor-bar-fill`);
                    if (favorBar) {
                        // Favor ranges from -100 to 100, normalize to 0-100%
                        const favorPercent = ((favorValue + 100) / 200) * 100;
                        favorBar.style.width = `${favorPercent}%`;

                        // Color based on favor level
                        if (favorValue > 50) favorBar.style.background = '#4CAF50'; // Green
                        else if (favorValue < -50) favorBar.style.background = '#F44336'; // Red
                        else favorBar.style.background = '#FFC107'; // Amber
                    }

                    const favorText = charOverlay.querySelector(`[data-god="${godName}"] .favor-value`);
                    if (favorText) favorText.textContent = favorValue;
                }

                console.log('[Phase D] Divine favor loaded');

            } catch (error) {
                console.error('Failed to load divine favor:', error);
            }
        }

        // Load inventory for inventory overlay
        async function loadInventory() {
            try {
                gameUX.showLoading('Loading inventory...');

                const data = await apiCall('/api/inventory/all');

                const invOverlay = document.getElementById('inventory-overlay');
                if (!invOverlay) return;

                // Update inventory grid
                const inventoryGrid = invOverlay.querySelector('.inventory-grid');
                if (inventoryGrid) {
                    inventoryGrid.innerHTML = ''; // Clear existing

                    // Add items
                    data.items.forEach(item => {
                        const slot = document.createElement('div');
                        slot.className = 'inventory-slot';
                        if (item.equipped) slot.classList.add('equipped');
                        slot.setAttribute('data-item-id', item.id);
                        slot.setAttribute('data-tooltip', item.description);

                        slot.innerHTML = `
                            <div class="item-icon">${getItemIcon(item.type)}</div>
                            ${item.quantity > 1 ? `<div class="item-quantity">${item.quantity}</div>` : ''}
                        `;

                        inventoryGrid.appendChild(slot);
                    });

                    // Fill empty slots
                    const emptySlots = 48 - data.items.length;
                    for (let i = 0; i < emptySlots; i++) {
                        const emptySlot = document.createElement('div');
                        emptySlot.className = 'inventory-slot empty';
                        inventoryGrid.appendChild(emptySlot);
                    }
                }

                // Update gold
                const goldDisplay = invOverlay.querySelector('.gold-amount');
                if (goldDisplay) goldDisplay.textContent = data.gold;

                // Update weight
                const weightDisplay = invOverlay.querySelector('.weight-display');
                if (weightDisplay) {
                    weightDisplay.textContent = `${data.weight} / ${data.max_weight}`;
                }

                gameUX.hideLoading();
                console.log('[Phase D] Inventory loaded');

            } catch (error) {
                gameUX.hideLoading();
                console.error('Failed to load inventory:', error);
            }
        }

        // Helper function to get item icon emoji
        function getItemIcon(itemType) {
            const icons = {
                'weapon': '',
                'armor': '',
                'potion': '',
                'scroll': '',
                'food': '',
                'quest': '',
                'treasure': '',
                'default': ''
            };
            return icons[itemType] || icons.default;
        }

        // Load quests for quest overlay
        async function loadQuests(type = 'active') {
            try {
                gameUX.showLoading(`Loading ${type} quests...`);

                const endpoint = type === 'active' ? '/api/quests/active' : '/api/quests/completed';
                const data = await apiCall(endpoint);

                const questOverlay = document.getElementById('quests-overlay');
                if (!questOverlay) return;

                const questList = questOverlay.querySelector('.quest-list');
                if (questList) {
                    questList.innerHTML = ''; // Clear existing

                    if (data.quests.length === 0) {
                        questList.innerHTML = `<div class="no-quests">No ${type} quests</div>`;
                    } else {
                        data.quests.forEach(quest => {
                            const questItem = document.createElement('div');
                            questItem.className = 'quest-item';
                            questItem.setAttribute('data-quest-id', quest.id);

                            questItem.innerHTML = `
                                <div class="quest-title">${quest.name}</div>
                                <div class="quest-description">${quest.description}</div>
                                ${quest.progress !== undefined ? `
                                    <div class="quest-progress-bar">
                                        <div class="quest-progress-fill" style="width: ${quest.progress}%"></div>
                                    </div>
                                ` : ''}
                            `;

                            questList.appendChild(questItem);
                        });
                    }
                }

                gameUX.hideLoading();
                console.log(`[Phase D] ${type} quests loaded`);

            } catch (error) {
                gameUX.hideLoading();
                console.error(`Failed to load ${type} quests:`, error);
            }
        }

        // Load current scenario
        async function loadCurrentScenario() {
            try {
                gameUX.showLoading('Loading scenario...');

                const data = await apiCall('/api/current_scenario');

                // Update scenario title
                const titleElement = document.querySelector('.scenario-title');
                if (titleElement) titleElement.textContent = data.title || 'The Adventure Begins';

                // Update scenario description
                const descElement = document.querySelector('.scenario-description');
                if (descElement) descElement.textContent = data.description || 'Your journey awaits...';

                // Update choices
                const choicesContainer = document.querySelector('.choices-container');
                if (choicesContainer && data.choices) {
                    choicesContainer.innerHTML = '';

                    data.choices.forEach((choice, index) => {
                        const button = document.createElement('button');
                        button.className = 'choice-button';
                        button.textContent = choice.text;
                        button.onclick = () => submitChoice(choice.id);
                        choicesContainer.appendChild(button);
                    });
                }

                gameUX.hideLoading();
                console.log('[Phase D] Current scenario loaded');

            } catch (error) {
                gameUX.hideLoading();
                console.error('Failed to load scenario:', error);
            }
        }

        // Submit player choice
        async function submitChoice(choiceId) {
            try {
                gameUX.showLoading('Processing your choice...');

                const data = await apiCall('/api/make_choice', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ choice: choiceId })
                });

                // Show consequences
                if (data.consequence) {
                    const narrativePanel = document.querySelector('.scene-narrative-panel');
                    if (narrativePanel) {
                        const consequenceDiv = document.createElement('div');
                        consequenceDiv.className = 'narrative-text consequence';
                        consequenceDiv.textContent = data.consequence;
                        narrativePanel.appendChild(consequenceDiv);
                    }
                }

                // Check for level up
                if (data.level_up) {
                    gameUX.celebrate('levelup', { level: data.new_level });
                }

                // Check for quest completion
                if (data.quest_completed) {
                    gameUX.celebrate('quest', { quest: data.quest_name });
                }

                // Reload scenario for next turn
                await loadCurrentScenario();

                gameUX.hideLoading();
                console.log('[Phase D] Choice submitted successfully');

            } catch (error) {
                gameUX.hideLoading();
                console.error('Failed to submit choice:', error);
            }
        }

        // Auto-refresh game state periodically
        function startGameStatePolling() {
            setInterval(async () => {
                try {
                    const data = await apiCall('/api/game_state');

                    // Update health bar
                    const hpBar = document.querySelector('.hp-bar-fill');
                    if (hpBar && data.character) {
                        const hpPercent = (data.character.hp / data.character.max_hp) * 100;
                        hpBar.style.width = `${hpPercent}%`;
                    }

                    // Update level display
                    const levelDisplay = document.querySelector('.player-level');
                    if (levelDisplay && data.character) {
                        levelDisplay.textContent = `Lv. ${data.character.level}`;
                    }

                } catch (error) {
                    // Silent fail for polling errors
                }
            }, 5000); // Poll every 5 seconds
        }

        // Hook into overlay open events
        document.addEventListener('DOMContentLoaded', () => {
            // Load character data when character overlay opens
            const charButton = document.querySelector('[data-overlay="character-overlay"]');
            if (charButton) {
                charButton.addEventListener('click', () => {
                    loadCharacterStats();
                    loadDivineFavor();
                });
            }

            // Load inventory when inventory overlay opens
            const invButton = document.querySelector('[data-overlay="inventory-overlay"]');
            if (invButton) {
                invButton.addEventListener('click', loadInventory);
            }

            // Load quests when quest overlay opens
            const questButton = document.querySelector('[data-overlay="quests-overlay"]');
            if (questButton) {
                questButton.addEventListener('click', () => loadQuests('active'));
            }

            // Quest tab switching
            const activeTab = document.querySelector('.quest-tab[data-tab="active"]');
            const completedTab = document.querySelector('.quest-tab[data-tab="completed"]');

            if (activeTab) activeTab.addEventListener('click', () => loadQuests('active'));
            if (completedTab) completedTab.addEventListener('click', () => loadQuests('completed'));

            // Load initial scenario
            loadCurrentScenario();

            // Start polling for game state updates
            startGameStatePolling();

            console.log('[Phase D] Frontend connected to backend');
        });

        // === UX System Initialization (Phase B) ===
        class GameUX {
            constructor() {
                this.loadingShown = false;
                this.celebrationsEnabled = true;
            }

            showLoading(message = 'Loading...') {
                if (this.loadingShown) return;
                this.loadingShown = true;

                const loadingContainer = document.querySelector('.loading-container');
                if (loadingContainer) {
                    loadingContainer.classList.add('active');
                    const loadingText = loadingContainer.querySelector('.loading-text');
                    if (loadingText) loadingText.textContent = message;
                }
            }

            hideLoading() {
                this.loadingShown = false;
                const loadingContainer = document.querySelector('.loading-container');
                if (loadingContainer) {
                    loadingContainer.classList.remove('active');
                }
            }

            celebrate(type, data = {}) {
                if (!this.celebrationsEnabled) return;

                switch(type) {
                    case 'levelup':
                        if (typeof showLevelUp !== 'undefined') showLevelUp(data.level || 1);
                        break;
                    case 'quest':
                        if (typeof showQuestComplete !== 'undefined') showQuestComplete(data.quest || '');
                        break;
                    case 'achievement':
                        if (typeof showAchievement !== 'undefined') showAchievement(data.title || '', data.description || '');
                        break;
                }
            }

            vibrate(pattern = [50]) {
                if (window.navigator.vibrate) {
                    window.navigator.vibrate(pattern);
                }
            }
        }

        // Initialize global UX controller
        const gameUX = new GameUX();
        console.log('[Phase B] UX improvements initialized');

    </script>

    <!-- === Loading States (Phase B) === -->
    <!-- Full Screen Loading -->
    <div class="loading-container">
        <div class="arcane-spinner">
            <div class="spinner-ring"></div>
            <div class="spinner-ring"></div>
            <div class="spinner-ring"></div>
            <div class="spinner-center"></div>
        </div>
        <div class="loading-text">Channeling the Arcane...</div>
        <div class="loading-tips">
            <div class="tip-label">Did you know?</div>
            <div class="tip-text" id="loading-tip">The gods watch your every choice...</div>
        </div>
    </div>

    <!-- Inline Loading Example -->
    <div class="inline-loader">
        <div class="loader-icon"></div>
        <div class="loader-text">Processing divine judgment...</div>
    </div>

    <!-- Skeleton Loading Example -->
    <div class="skeleton-container">
        <div class="skeleton skeleton-title"></div>
        <div class="skeleton skeleton-text"></div>
        <div class="skeleton skeleton-text"></div>
        <div class="skeleton skeleton-text"></div>
    </div>

    <!-- Success Animation -->
    <div class="success-pulse" style="display: none;">
        <div class="success-ring"></div>
        <div class="success-check"></div>
    </div>

    <script>
        // Rotate loading tips - standalone script
        const loadingTips = [
            "The gods watch your every choice...",
            "Divine favor determines your fate...",
            "Trust binds your party together...",
            "Every whisper holds ancient power...",
            "Your choices echo through eternity..."
        ];

        let currentTipIndex = 0;
        setInterval(() => {
            currentTipIndex = (currentTipIndex + 1) % loadingTips.length;
            const tipElement = document.getElementById('loading-tip');
            if (tipElement) {
                tipElement.style.animation = 'none';
                setTimeout(() => {
                    tipElement.textContent = loadingTips[currentTipIndex];
                    tipElement.style.animation = 'fadeIn 0.5s ease';
                }, 50);
            }
        }, 3000);

        // Example: Show success animation
        function showSuccess() {
            const successEl = document.querySelector('.success-pulse');
            successEl.style.display = 'block';
            setTimeout(() => {
                successEl.style.display = 'none';
            }, 1000);
        }

        // Demo success after 5 seconds
        setTimeout(showSuccess, 5000);
    
                                // === Retention System (Phase B) ===
        // Simulate achievement unlock
        setTimeout(() => {
            const achievementPopup = document.querySelector('.achievement-popup');
            achievementPopup.classList.add('show');

            // Play sound effect (in real implementation)
            // playSound('achievement.mp3');

            setTimeout(() => {
                achievementPopup.classList.remove('show');
            }, 5000);
        }, 2000);

        // Animate battle pass fill
        let battlePassProgress = 35;
        setInterval(() => {
            battlePassProgress = Math.min(battlePassProgress + 5, 100);
            const tierFill = document.querySelector('.tier-fill');
            if (tierFill) {
                tierFill.style.width = `${battlePassProgress}%`;
            }

            if (battlePassProgress === 100) {
                // Unlock next tier
                const nextNode = document.querySelector('.tier-node:not(.unlocked)');
                if (nextNode) {
                    nextNode.classList.add('unlocked');
                    battlePassProgress = 0;
                }
            }
        }, 1000);

        // Claim daily reward - with null check
        const claimButton = document.querySelector('.claim-button');
        if (claimButton) {
            claimButton.addEventListener('click', function() {
                const todaySlot = document.querySelector('.day-slot.today');
                if (todaySlot) {
                    todaySlot.classList.remove('today');
                    todaySlot.classList.add('claimed');
                }
                this.disabled = true;
                this.textContent = 'Claimed!';

                // Show reward animation
                // In real implementation, show reward details
            });
        }

        // Update event timer
        setInterval(() => {
            // In real implementation, calculate actual time remaining
            const timerEl = document.querySelector('.event-timer');
            // Update timer text
        }, 1000);

        // === Onboarding System (Phase B) ===
        // Character selection
        document.querySelectorAll('.character-card').forEach(card => {
            card.addEventListener('click', function() {
                document.querySelectorAll('.character-card').forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');
                document.querySelector('.start-adventure-btn').disabled = false;
            });
        });

        // Tutorial system
        const tutorialSteps1 = [ // RENAMED TO AVOID DUPLICATE
            {
                element: '.character-panel',
                title: 'Character Panel',
                text: 'View your stats, level, and equipment here. Press C to open anytime.',
                position: 'right'
            },
            {
                element: '.inventory-btn',
                title: 'Inventory',
                text: 'Manage your items and equipment. Press I for quick access.',
                position: 'bottom'
            },
            {
                element: '.quest-log',
                title: 'Quest Log',
                text: 'Track your active quests and objectives. Press J to view.',
                position: 'left'
            },
            {
                element: '.action-bar',
                title: 'Action Bar',
                text: 'Use your abilities in combat. Number keys 1-5 activate skills.',
                position: 'top'
            },
            {
                element: '.divine-favor',
                title: 'Divine Favor',
                text: 'The gods watch your actions. Their favor affects your journey.',
                position: 'left'
            }
        ];

        let currentStep = 0;

        function showTutorialStep(step) {
            const tooltip = document.querySelector('.tutorial-tooltip');
            const hole = document.querySelector('.spotlight-hole');
            const dots = document.querySelectorAll('.progress-dot');

            // Update progress dots
            dots.forEach((dot, index) => {
                dot.classList.toggle('active', index <= step);
            });

            // Update content
            tooltip.querySelector('.tutorial-title').textContent = tutorialSteps[step].title;
            tooltip.querySelector('.tutorial-text').textContent = tutorialSteps[step].text;

            // Position spotlight and tooltip
            // (In real implementation, position based on actual element coordinates)
        }

        // Start button
        document.querySelector('.start-adventure-btn').addEventListener('click', function() {
            // Fade out welcome screen
            const welcomeScreen = document.querySelector('.onboarding-overlay');
            welcomeScreen.style.animation = 'fadeOut 0.5s ease';
            setTimeout(() => {
                welcomeScreen.style.display = 'none';
                // Start tutorial
                document.querySelector('.tutorial-spotlight').classList.add('active');
                document.querySelector('.ftue-checklist').style.display = 'block';
            }, 500);
        });

        // Tutorial navigation
        document.querySelector('.tutorial-btn:not(.skip)').addEventListener('click', function() {
            currentStep++;
            if (currentStep < tutorialSteps.length) {
                showTutorialStep(currentStep);
            } else {
                document.querySelector('.tutorial-spotlight').classList.remove('active');
            }
        });

        // Skip tutorial
        document.querySelector('.tutorial-btn.skip').addEventListener('click', function() {
            document.querySelector('.tutorial-spotlight').classList.remove('active');
        });

        // Simulate FTUE progress
        let ftueProgress = 20;
        setInterval(() => {
            if (ftueProgress < 100) {
                ftueProgress += 20;
                document.querySelector('.ftue-progress-fill').style.width = `${ftueProgress}%`;

                // Mark items as completed
                const items = document.querySelectorAll('.ftue-item');
                const itemIndex = Math.floor((ftueProgress / 100) * items.length) - 1;
                if (itemIndex >= 0) {
                    items[itemIndex].classList.add('completed');
                }
            }
        }, 3000);

        // === Celebration Animations (Phase B) ===
        // Trigger level up animation
        function triggerLevelUp() {
            const levelUpEl = document.querySelector('.level-up-burst');
            levelUpEl.style.display = 'block';

            // Create particles
            for (let i = 0; i < 30; i++) {
                createParticle(window.innerWidth / 2, window.innerHeight / 2);
            }

            setTimeout(() => {
                levelUpEl.style.display = 'none';
            }, 2000);
        }

        // Trigger quest complete
        function triggerQuestComplete() {
            const questEl = document.querySelector('.quest-complete');
            questEl.style.display = 'block';

            setTimeout(() => {
                questEl.style.display = 'none';
            }, 3000);
        }

        // Trigger divine favor
        function triggerDivineFavor(amount) {
            const favorEl = document.querySelector('.divine-favor-gain');
            const amountEl = favorEl.querySelector('.favor-amount');
            amountEl.textContent = `+${amount}`;
            favorEl.style.display = 'block';

            setTimeout(() => {
                favorEl.style.display = 'none';
            }, 2000);
        }

        // Create floating damage numbers
        function createDamageNumber(x, y, value, type = 'normal') {
            const damageEl = document.createElement('div');
            damageEl.className = `damage-number ${type}`;
            damageEl.textContent = type === 'heal' ? `+${value}` : `-${value}`;
            damageEl.style.left = `${x}px`;
            damageEl.style.top = `${y}px`;
            document.body.appendChild(damageEl);

            setTimeout(() => {
                damageEl.remove();
            }, 1000);
        }

        // Create particle effect
        function createParticle(x, y) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.left = `${x}px`;
            particle.style.top = `${y}px`;
            particle.style.setProperty('--drift', `${(Math.random() - 0.5) * 60}px`);
            particle.style.animation = `particleFloat ${1 + Math.random()}s ease-out`;
            document.body.appendChild(particle);

            setTimeout(() => {
                particle.remove();
            }, 2000);
        }

        // Demo animations - DISABLED for normal gameplay
        // setTimeout(() => triggerLevelUp(), 1000);
        // setTimeout(() => triggerQuestComplete(), 3000);
        // setTimeout(() => triggerDivineFavor(15), 5000);

        // Create some damage numbers
        setInterval(() => {
            const x = Math.random() * window.innerWidth;
            const y = Math.random() * window.innerHeight;
            const types = ['normal', 'critical', 'heal'];
            const type = types[Math.floor(Math.random() * types.length)];
            const value = Math.floor(Math.random() * 100) + 20;
            createDamageNumber(x, y, value, type);
        }, 2000);

        // Animate XP bar
        let xpProgress = 65; // Renamed from currentXP to avoid duplicate declaration
        setInterval(() => {
            xpProgress = Math.min(xpProgress + 5, 100);
            document.querySelector('.xp-fill').style.width = `${xpProgress}%`;

            if (xpProgress === 100) {
                triggerLevelUp();
                xpProgress = 0;
            }
        }, 3000);

        // === Loading States (Phase B) ===
        // Rotate loading tips (no duplicates)

        // Example: Show success animation
        function showSuccess() {
            const successEl = document.querySelector('.success-pulse');
            successEl.style.display = 'block';
            setTimeout(() => {
                successEl.style.display = 'none';
            }, 1000);
        }

        // Demo success after 5 seconds
        setTimeout(showSuccess, 5000);
    
        
        // === PHASE D: Backend Integration ===

        // API helper function with error handling
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetchWithCSRF(endpoint, options);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                return await response.json();
            } catch (error) {
                console.error(`API Error [${endpoint}]:`, error);
                throw error;
            }
        }

        // Load character stats for character sheet overlay
        async function loadCharacterStats() {
            try {
                gameUX.showLoading('Loading character data...');

                const data = await apiCall('/api/character/stats');

                // Update character sheet UI
                const charOverlay = document.getElementById('character-overlay');
                if (!charOverlay) return;

                // Update stats
                const stats = data.stats;
                for (const [stat, value] of Object.entries(stats)) {
                    const statElement = charOverlay.querySelector(`[data-stat="${stat}"]`);
                    if (statElement) {
                        statElement.textContent = value;
                    }
                }

                // Update level
                const levelBadge = charOverlay.querySelector('.level-badge');
                if (levelBadge) levelBadge.textContent = `Level ${data.level}`;

                // Update XP bar
                const xpBar = charOverlay.querySelector('.xp-fill');
                if (xpBar) {
                    const xpPercent = (data.xp / data.xp_to_next) * 100;
                    xpBar.style.width = `${xpPercent}%`;
                }

                // Update HP
                const hpText = charOverlay.querySelector('.hp-text');
                if (hpText) hpText.textContent = `${data.hp} / ${data.max_hp}`;

                // Update class
                const className = charOverlay.querySelector('.character-class');
                if (className) className.textContent = data.class;

                gameUX.hideLoading();
                console.log('[Phase D] Character stats loaded');

            } catch (error) {
                gameUX.hideLoading();
                console.error('Failed to load character stats:', error);
            }
        }

        // Load divine favor for character sheet
        async function loadDivineFavor() {
            try {
                const data = await apiCall('/api/character/divine_favor');

                const charOverlay = document.getElementById('character-overlay');
                if (!charOverlay) return;

                // Update favor bars for each god
                const favor = data.favor;
                for (const [godName, favorValue] of Object.entries(favor)) {
                    const favorBar = charOverlay.querySelector(`[data-god="${godName}"] .favor-bar-fill`);
                    if (favorBar) {
                        // Favor ranges from -100 to 100, normalize to 0-100%
                        const favorPercent = ((favorValue + 100) / 200) * 100;
                        favorBar.style.width = `${favorPercent}%`;

                        // Color based on favor level
                        if (favorValue > 50) favorBar.style.background = '#4CAF50'; // Green
                        else if (favorValue < -50) favorBar.style.background = '#F44336'; // Red
                        else favorBar.style.background = '#FFC107'; // Amber
                    }

                    const favorText = charOverlay.querySelector(`[data-god="${godName}"] .favor-value`);
                    if (favorText) favorText.textContent = favorValue;
                }

                console.log('[Phase D] Divine favor loaded');

            } catch (error) {
                console.error('Failed to load divine favor:', error);
            }
        }

        // Load inventory for inventory overlay
        async function loadInventory() {
            try {
                gameUX.showLoading('Loading inventory...');

                const data = await apiCall('/api/inventory/all');

                const invOverlay = document.getElementById('inventory-overlay');
                if (!invOverlay) return;

                // Update inventory grid
                const inventoryGrid = invOverlay.querySelector('.inventory-grid');
                if (inventoryGrid) {
                    inventoryGrid.innerHTML = ''; // Clear existing

                    // Add items
                    data.items.forEach(item => {
                        const slot = document.createElement('div');
                        slot.className = 'inventory-slot';
                        if (item.equipped) slot.classList.add('equipped');
                        slot.setAttribute('data-item-id', item.id);
                        slot.setAttribute('data-tooltip', item.description);

                        slot.innerHTML = `
                            <div class="item-icon">${getItemIcon(item.type)}</div>
                            ${item.quantity > 1 ? `<div class="item-quantity">${item.quantity}</div>` : ''}
                        `;

                        inventoryGrid.appendChild(slot);
                    });

                    // Fill empty slots
                    const emptySlots = 48 - data.items.length;
                    for (let i = 0; i < emptySlots; i++) {
                        const emptySlot = document.createElement('div');
                        emptySlot.className = 'inventory-slot empty';
                        inventoryGrid.appendChild(emptySlot);
                    }
                }

                // Update gold
                const goldDisplay = invOverlay.querySelector('.gold-amount');
                if (goldDisplay) goldDisplay.textContent = data.gold;

                // Update weight
                const weightDisplay = invOverlay.querySelector('.weight-display');
                if (weightDisplay) {
                    weightDisplay.textContent = `${data.weight} / ${data.max_weight}`;
                }

                gameUX.hideLoading();
                console.log('[Phase D] Inventory loaded');

            } catch (error) {
                gameUX.hideLoading();
                console.error('Failed to load inventory:', error);
            }
        }

        // Helper function to get item icon emoji
        function getItemIcon(itemType) {
            const icons = {
                'weapon': '',
                'armor': '',
                'potion': '',
                'scroll': '',
                'food': '',
                'quest': '',
                'treasure': '',
                'default': ''
            };
            return icons[itemType] || icons.default;
        }

        // Load quests for quest overlay
        async function loadQuests(type = 'active') {
            try {
                gameUX.showLoading(`Loading ${type} quests...`);

                const endpoint = type === 'active' ? '/api/quests/active' : '/api/quests/completed';
                const data = await apiCall(endpoint);

                const questOverlay = document.getElementById('quests-overlay');
                if (!questOverlay) return;

                const questList = questOverlay.querySelector('.quest-list');
                if (questList) {
                    questList.innerHTML = ''; // Clear existing

                    if (data.quests.length === 0) {
                        questList.innerHTML = `<div class="no-quests">No ${type} quests</div>`;
                    } else {
                        data.quests.forEach(quest => {
                            const questItem = document.createElement('div');
                            questItem.className = 'quest-item';
                            questItem.setAttribute('data-quest-id', quest.id);

                            questItem.innerHTML = `
                                <div class="quest-title">${quest.name}</div>
                                <div class="quest-description">${quest.description}</div>
                                ${quest.progress !== undefined ? `
                                    <div class="quest-progress-bar">
                                        <div class="quest-progress-fill" style="width: ${quest.progress}%"></div>
                                    </div>
                                ` : ''}
                            `;

                            questList.appendChild(questItem);
                        });
                    }
                }

                gameUX.hideLoading();
                console.log(`[Phase D] ${type} quests loaded`);

            } catch (error) {
                gameUX.hideLoading();
                console.error(`Failed to load ${type} quests:`, error);
            }
        }

        // Load current scenario
        async function loadCurrentScenario() {
            try {
                gameUX.showLoading('Loading scenario...');

                const data = await apiCall('/api/current_scenario');

                // Update scenario title
                const titleElement = document.querySelector('.scenario-title');
                if (titleElement) titleElement.textContent = data.title || 'The Adventure Begins';

                // Update scenario description
                const descElement = document.querySelector('.scenario-description');
                if (descElement) descElement.textContent = data.description || 'Your journey awaits...';

                // Update choices
                const choicesContainer = document.querySelector('.choices-container');
                if (choicesContainer && data.choices) {
                    choicesContainer.innerHTML = '';

                    data.choices.forEach((choice, index) => {
                        const button = document.createElement('button');
                        button.className = 'choice-button';
                        button.textContent = choice.text;
                        button.onclick = () => submitChoice(choice.id);
                        choicesContainer.appendChild(button);
                    });
                }

                gameUX.hideLoading();
                console.log('[Phase D] Current scenario loaded');

            } catch (error) {
                gameUX.hideLoading();
                console.error('Failed to load scenario:', error);
            }
        }

        // Submit player choice
        async function submitChoice(choiceId) {
            try {
                gameUX.showLoading('Processing your choice...');

                const data = await apiCall('/api/make_choice', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ choice: choiceId })
                });

                // Show consequences
                if (data.consequence) {
                    const narrativePanel = document.querySelector('.scene-narrative-panel');
                    if (narrativePanel) {
                        const consequenceDiv = document.createElement('div');
                        consequenceDiv.className = 'narrative-text consequence';
                        consequenceDiv.textContent = data.consequence;
                        narrativePanel.appendChild(consequenceDiv);
                    }
                }

                // Check for level up
                if (data.level_up) {
                    gameUX.celebrate('levelup', { level: data.new_level });
                }

                // Check for quest completion
                if (data.quest_completed) {
                    gameUX.celebrate('quest', { quest: data.quest_name });
                }

                // Reload scenario for next turn
                await loadCurrentScenario();

                gameUX.hideLoading();
                console.log('[Phase D] Choice submitted successfully');

            } catch (error) {
                gameUX.hideLoading();
                console.error('Failed to submit choice:', error);
            }
        }

        // Auto-refresh game state periodically
        function startGameStatePolling() {
            setInterval(async () => {
                try {
                    const data = await apiCall('/api/game_state');

                    // Update health bar
                    const hpBar = document.querySelector('.hp-bar-fill');
                    if (hpBar && data.character) {
                        const hpPercent = (data.character.hp / data.character.max_hp) * 100;
                        hpBar.style.width = `${hpPercent}%`;
                    }

                    // Update level display
                    const levelDisplay = document.querySelector('.player-level');
                    if (levelDisplay && data.character) {
                        levelDisplay.textContent = `Lv. ${data.character.level}`;
                    }

                } catch (error) {
                    // Silent fail for polling errors
                }
            }, 5000); // Poll every 5 seconds
        }

        // Hook into overlay open events
        document.addEventListener('DOMContentLoaded', () => {
            // Load character data when character overlay opens
            const charButton = document.querySelector('[data-overlay="character-overlay"]');
            if (charButton) {
                charButton.addEventListener('click', () => {
                    loadCharacterStats();
                    loadDivineFavor();
                });
            }

            // Load inventory when inventory overlay opens
            const invButton = document.querySelector('[data-overlay="inventory-overlay"]');
            if (invButton) {
                invButton.addEventListener('click', loadInventory);
            }

            // Load quests when quest overlay opens
            const questButton = document.querySelector('[data-overlay="quests-overlay"]');
            if (questButton) {
                questButton.addEventListener('click', () => loadQuests('active'));
            }

            // Quest tab switching
            const activeTab = document.querySelector('.quest-tab[data-tab="active"]');
            const completedTab = document.querySelector('.quest-tab[data-tab="completed"]');

            if (activeTab) activeTab.addEventListener('click', () => loadQuests('active'));
            if (completedTab) completedTab.addEventListener('click', () => loadQuests('completed'));

            // Load initial scenario
            loadCurrentScenario();

            // Start polling for game state updates
            startGameStatePolling();

            console.log('[Phase D] Frontend connected to backend');
        });

        // === UX System Initialization (Phase B) ===
        class GameUX {
            constructor() {
                this.loadingShown = false;
                this.celebrationsEnabled = true;
            }

            showLoading(message = 'Loading...') {
                if (this.loadingShown) return;
                this.loadingShown = true;

                const loadingContainer = document.querySelector('.loading-container');
                if (loadingContainer) {
                    loadingContainer.classList.add('active');
                    const loadingText = loadingContainer.querySelector('.loading-text');
                    if (loadingText) loadingText.textContent = message;
                }
            }

            hideLoading() {
                this.loadingShown = false;
                const loadingContainer = document.querySelector('.loading-container');
                if (loadingContainer) {
                    loadingContainer.classList.remove('active');
                }
            }

            celebrate(type, data = {}) {
                if (!this.celebrationsEnabled) return;

                switch(type) {
                    case 'levelup':
                        if (typeof showLevelUp !== 'undefined') showLevelUp(data.level || 1);
                        break;
                    case 'quest':
                        if (typeof showQuestComplete !== 'undefined') showQuestComplete(data.quest || '');
                        break;
                    case 'achievement':
                        if (typeof showAchievement !== 'undefined') showAchievement(data.title || '', data.description || '');
                        break;
                }
            }

            vibrate(pattern = [50]) {
                if (window.navigator.vibrate) {
                    window.navigator.vibrate(pattern);
                }
            }
        }

        // Initialize global UX controller
        const gameUX = new GameUX();
        console.log('[Phase B] UX improvements initialized');

    </script>
</body>
</html>
