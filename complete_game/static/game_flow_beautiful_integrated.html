<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Arcane Codex - Complete Game</title>
    <link rel="stylesheet" href="css/battle_scene_animations.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&family=Yrsa:wght@300;400;500;600;700&family=Spectral:ital,wght@0,300;0,400;0,600;1,400;1,600&display=swap');

        :root {
            /* Color Palettes by Context */
            --bg-dark: #09090b;
            --bg-elevated: #18181b;

            /* Default/Exploration Theme */
            --theme-primary: #D4AF37;
            --theme-secondary: #8B7355;
            --theme-accent: #FFD700;
            --theme-bg: linear-gradient(180deg, #0A0812 0%, #1A1425 100%);

            /* Battle Theme (Red) */
            --battle-primary: #FF4444;
            --battle-secondary: #CC0000;
            --battle-accent: #FF6666;
            --battle-bg: linear-gradient(180deg, #1A0000 0%, #0A0000 100%);

            /* Divine Theme (Gold/Purple) */
            --divine-primary: #FFD700;
            --divine-secondary: #8B1FFF;
            --divine-accent: #D4AF37;
            --divine-bg: radial-gradient(circle at top, #1A0033 0%, #09090b 100%);

            /* Victory Theme (Green/Gold) */
            --victory-primary: #4CAF50;
            --victory-secondary: #2E7D32;
            --victory-accent: #81C784;
            --victory-bg: radial-gradient(circle, #0A1A0A 0%, #09090b 100%);

            /* Typography Scale */
            --text-xs: 12px;
            --text-sm: 14px;
            --text-base: 16px;
            --text-lg: 18px;
            --text-xl: 20px;
            --text-2xl: 24px;
            --text-3xl: 30px;
            --text-4xl: 36px;
            --text-5xl: 48px;
            --text-6xl: 60px;
            --text-7xl: 72px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Spectral', serif;
            background: var(--theme-bg);
            color: var(--theme-primary);
            overflow-x: hidden;
            transition: background 1s ease;
        }

        /* Theme Modifiers */
        body.battle-theme {
            background: var(--battle-bg);
            --theme-primary: var(--battle-primary);
            --theme-secondary: var(--battle-secondary);
            --theme-accent: var(--battle-accent);
        }

        body.divine-theme {
            background: var(--divine-bg);
            --theme-primary: var(--divine-primary);
            --theme-secondary: var(--divine-secondary);
            --theme-accent: var(--divine-accent);
        }

        body.victory-theme {
            background: var(--victory-bg);
            --theme-primary: var(--victory-primary);
            --theme-secondary: var(--victory-secondary);
            --theme-accent: var(--victory-accent);
        }

        /* === GAME CONTAINER === */
        .game-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
            min-height: 100vh;
        }

        /* === TYPOGRAPHY === */
        .main-title {
            font-family: 'Cinzel', serif;
            font-size: var(--text-6xl);
            font-weight: 900;
            color: var(--theme-accent);
            text-align: center;
            margin-bottom: 40px;
            text-shadow: 0 0 30px currentColor, 0 0 60px currentColor;
            letter-spacing: 3px;
        }

        .section-title {
            font-family: 'Cinzel', serif;
            font-size: var(--text-4xl);
            font-weight: 700;
            color: var(--theme-primary);
            text-align: center;
            margin-bottom: 30px;
        }

        .subtitle {
            font-family: 'Yrsa', serif;
            font-size: var(--text-xl);
            color: var(--theme-secondary);
            text-align: center;
            font-style: italic;
            margin-bottom: 20px;
        }

        /* === SCREENS === */
        .screen {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* === MAIN MENU === */
        .menu-card {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid var(--theme-secondary);
            border-radius: 15px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
        }

        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 30px;
        }

        .btn {
            background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary));
            color: var(--bg-dark);
            border: none;
            padding: 18px 40px;
            font-size: var(--text-lg);
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Cinzel', serif;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(212, 175, 55, 0.4);
        }

        .btn.secondary {
            background: linear-gradient(135deg, #555, #333);
            color: var(--theme-primary);
        }

        /* === CHARACTER CREATION === */
        .character-form {
            background: rgba(0, 0, 0, 0.5);
            padding: 40px;
            border-radius: 15px;
            border: 2px solid var(--theme-secondary);
            margin: 30px auto;
            max-width: 600px;
        }

        .input-group {
            margin-bottom: 25px;
        }

        .input-label {
            display: block;
            margin-bottom: 10px;
            color: var(--theme-accent);
            font-size: var(--text-lg);
            font-family: 'Cinzel', serif;
        }

        .input-field {
            width: 100%;
            padding: 12px 20px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid var(--theme-secondary);
            border-radius: 8px;
            color: var(--theme-primary);
            font-size: var(--text-base);
            font-family: 'Spectral', serif;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--theme-accent);
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
        }

        /* === DIVINE INTERROGATION === */
        .interrogation-container {
            background: rgba(0, 0, 0, 0.6);
            border: 3px solid var(--divine-primary);
            border-radius: 20px;
            padding: 40px;
            margin: 30px auto;
            max-width: 900px;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.2);
        }

        .progress-bar {
            background: rgba(0, 0, 0, 0.4);
            height: 8px;
            border-radius: 10px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--divine-primary), var(--divine-secondary));
            transition: width 0.5s ease;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .god-speaker {
            font-family: 'Cinzel', serif;
            font-size: var(--text-2xl);
            color: var(--divine-primary);
            font-weight: 700;
            text-shadow: 0 0 20px currentColor;
        }

        .question-number {
            color: var(--theme-secondary);
            font-style: italic;
        }

        .question-text {
            font-size: var(--text-xl);
            line-height: 1.8;
            margin-bottom: 40px;
            color: #ffffff;
            text-align: center;
            padding: 20px;
            background: rgba(139, 31, 255, 0.1);
            border-left: 4px solid var(--divine-secondary);
            border-radius: 8px;
        }

        .options-grid {
            display: grid;
            gap: 20px;
        }

        .option-button {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid var(--theme-secondary);
            border-radius: 10px;
            padding: 20px;
            color: var(--theme-primary);
            font-size: var(--text-lg);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
            z-index: 100;
            pointer-events: auto;
        }

        .option-button:hover {
            background: rgba(212, 175, 55, 0.1);
            border-color: var(--theme-accent);
            transform: translateX(10px);
            z-index: 101;
        }

        .option-button:active {
            transform: translateX(10px) scale(0.98);
        }

        .option-letter {
            background: var(--theme-accent);
            color: var(--bg-dark);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-family: 'Cinzel', serif;
        }

        /* === GAME HUD === */
        .game-hud {
            background: rgba(0, 0, 0, 0.7);
            border-bottom: 2px solid var(--theme-secondary);
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 10px;
        }

        .hud-stats {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            color: var(--theme-secondary);
            font-size: var(--text-sm);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-value {
            color: var(--theme-accent);
            font-size: var(--text-2xl);
            font-weight: bold;
            font-family: 'Cinzel', serif;
        }

        /* === BATTLE SCREEN === */
        .battle-container {
            background: rgba(0, 0, 0, 0.8);
            border: 3px solid var(--battle-primary);
            border-radius: 20px;
            padding: 40px;
            margin: 30px auto;
            max-width: 1000px;
        }

        /* === LOADING OVERLAY === */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .loading-spinner {
            width: 80px;
            height: 80px;
            border: 4px solid var(--theme-secondary);
            border-top: 4px solid var(--theme-accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 20px;
            font-size: var(--text-xl);
            color: var(--theme-primary);
            font-family: 'Cinzel', serif;
        }

        /* === TOAST NOTIFICATIONS === */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }

        .toast {
            background: rgba(0, 0, 0, 0.9);
            border-left: 4px solid var(--theme-accent);
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: 5px;
            color: white;
            min-width: 300px;
            animation: slideIn 0.3s ease;
        }

        .toast.success {
            border-color: #4CAF50;
        }

        .toast.error {
            border-color: #FF4444;
        }

        .toast.info {
            border-color: #2196F3;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            .main-title {
                font-size: var(--text-4xl);
            }

            .game-container {
                padding: 20px 10px;
            }

            .menu-card, .character-form, .interrogation-container {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Awakening the Arcane Codex...</div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Main Game Container -->
    <div class="game-container">
        <!-- Main Menu Screen -->
        <div id="mainMenu" class="screen active">
            <h1 class="main-title">THE ARCANE CODEX</h1>
            <p class="subtitle">Where the Seven Gods Judge Your Soul</p>

            <div class="menu-card">
                <h2 class="section-title">Choose Your Path</h2>
                <div class="menu-buttons">
                    <button class="btn" onclick="gameManager.showCharacterCreation()">
                        Create Game
                    </button>
                    <button class="btn" onclick="gameManager.showJoinGame()">
                        Join Game
                    </button>
                    <button class="btn secondary" onclick="gameManager.showAbout()">
                        About the Codex
                    </button>
                </div>
            </div>
        </div>

        <!-- Join Game Screen -->
        <div id="joinGameScreen" class="screen">
            <h1 class="main-title">JOIN GAME</h1>
            <div class="character-form">
                <div class="input-group">
                    <label class="input-label">Enter Game Code</label>
                    <input type="text" id="gameCodeInput" class="input-field"
                           placeholder="e.g., ABC123" maxlength="6">
                </div>
                <div class="input-group">
                    <label class="input-label">Your Name</label>
                    <input type="text" id="joinPlayerNameInput" class="input-field"
                           placeholder="Enter your name..." maxlength="20">
                </div>
                <div class="menu-buttons">
                    <button class="btn" onclick="(async () => { try { await gameManager.joinGame(); } catch(e) { console.error('Failed to join game:', e); ToastManager.show('Failed to join game', 'error'); } })()">
                        Join Party
                    </button>
                    <button class="btn secondary" onclick="gameManager.showScreen('mainMenu')">
                        Back
                    </button>
                </div>
            </div>
        </div>

        <!-- About Screen -->
        <div id="aboutScreen" class="screen">
            <h1 class="main-title">THE ARCANE CODEX</h1>
            <div class="menu-card">
                <h2 class="section-title">The Legend</h2>
                <p style="line-height: 1.8; margin-bottom: 20px;">
                    In the realm of Elysia, seven divine beings watch over mortals,
                    each embodying fundamental aspects of existence. When heroes emerge,
                    they must face the Divine Interrogation - a sacred trial where the
                    gods peer into their souls and determine their destiny.
                </p>
                <p style="line-height: 1.8; margin-bottom: 20px;">
                    Your choices shape not just your class, but your very essence.
                    Will you earn the favor of Valdris the Just? Will Kaitha's chaos
                    mark your path? Or will another god claim your allegiance?
                </p>
                <div class="menu-buttons">
                    <button class="btn secondary" onclick="gameManager.showScreen('mainMenu')">
                        Return
                    </button>
                </div>
            </div>
        </div>

        <!-- Character Creation Screen -->
        <div id="characterCreation" class="screen">
            <h1 class="main-title">CREATE YOUR HERO</h1>
            <div class="character-form">
                <!-- Game Code Display -->
                <div id="gameCodeDisplay" style="display: none; text-align: center; margin-bottom: 30px; padding: 20px; background: rgba(212, 175, 55, 0.1); border: 2px solid var(--theme-primary); border-radius: 10px;">
                    <div style="font-family: 'Cinzel', serif; font-size: 14px; color: var(--theme-secondary); margin-bottom: 10px;">
                        GAME CODE - Share with friends to join
                    </div>
                    <div id="gameCodeText" style="font-family: 'Cinzel', serif; font-size: 32px; font-weight: bold; color: var(--theme-primary); letter-spacing: 8px;">
                    </div>
                    <button onclick="navigator.clipboard.writeText(document.getElementById('gameCodeText').textContent); ToastManager.show('Game code copied!', 'success')"
                            style="margin-top: 15px; padding: 8px 16px; background: rgba(212, 175, 55, 0.2); border: 1px solid var(--theme-primary); border-radius: 5px; color: var(--theme-primary); cursor: pointer; font-size: 14px;">
                        ðŸ“‹ Copy Code
                    </button>
                </div>

                <div class="input-group">
                    <label class="input-label">Your Name, Mortal</label>
                    <input type="text" id="playerNameInput" class="input-field"
                           placeholder="Enter your name..." maxlength="20">
                </div>
                <div class="menu-buttons">
                    <button class="btn" onclick="(async () => { try { await gameManager.startInterrogation(); } catch(e) { console.error('Failed to start interrogation:', e); ToastManager.show('Failed to start interrogation', 'error'); } })()">
                        Face the Gods
                    </button>
                    <button class="btn secondary" onclick="gameManager.showScreen('mainMenu')">
                        Back
                    </button>
                </div>
            </div>
        </div>

        <!-- Divine Interrogation Screen -->
        <div id="divineInterrogation" class="screen">
            <h1 class="main-title">DIVINE INTERROGATION</h1>

            <!-- Game Code Display for Multiplayer -->
            <div id="interrogationGameCodeDisplay" style="display: none; text-align: center; margin: 0 auto 20px; max-width: 600px; padding: 15px; background: rgba(212, 175, 55, 0.1); border: 2px solid var(--theme-primary); border-radius: 10px;">
                <div style="font-family: 'Cinzel', serif; font-size: 12px; color: var(--theme-secondary); margin-bottom: 8px;">
                    ðŸŽ® MULTIPLAYER GAME CODE
                </div>
                <div id="interrogationGameCodeText" style="font-family: 'Cinzel', serif; font-size: 24px; font-weight: bold; color: var(--theme-primary); letter-spacing: 6px; margin-bottom: 8px;">
                </div>
                <button onclick="navigator.clipboard.writeText(document.getElementById('interrogationGameCodeText').textContent); ToastManager.show('Game code copied!', 'success')"
                        style="padding: 6px 12px; background: rgba(212, 175, 55, 0.2); border: 1px solid var(--theme-primary); border-radius: 5px; color: var(--theme-primary); cursor: pointer; font-size: 12px; font-family: 'Cinzel', serif;">
                    ðŸ“‹ Copy Code
                </button>
            </div>

            <div class="interrogation-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>

                <div class="question-header">
                    <div class="god-speaker" id="godSpeaker">VALDRIS</div>
                    <div class="question-number" id="questionNumber">Question 1 of 10</div>
                </div>

                <div class="question-text" id="questionText">
                    Loading divine wisdom...
                </div>

                <div class="options-grid" id="optionsContainer">
                    <!-- Options will be dynamically added -->
                </div>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="gameScreen" class="screen">
            <div class="game-hud">
                <div class="hud-stats">
                    <div class="stat-item">
                        <div class="stat-label">Location</div>
                        <div class="stat-value" id="currentLocation">Valdria</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Health</div>
                        <div class="stat-value" id="playerHealth">100</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Trust</div>
                        <div class="stat-value" id="partyTrust">50</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Turn</div>
                        <div class="stat-value" id="turnCount">1</div>
                    </div>
                </div>
            </div>

            <div class="menu-card">
                <h2 class="section-title" id="locationTitle">Welcome to Valdria</h2>
                <p id="locationDescription" style="margin: 20px 0;">
                    The adventure begins...
                </p>
                <div class="menu-buttons">
                    <button class="btn" onclick="gameManager.triggerBattle()">
                        Test Battle System
                    </button>
                    <button class="btn secondary" onclick="gameManager.showScreen('mainMenu')">
                        Main Menu
                    </button>
                </div>
            </div>
        </div>

        <!-- Battle Screen -->
        <div id="battleScreen" class="screen">
            <div class="battle-container">
                <h2 class="section-title">BATTLE!</h2>
                <div id="battleContent">
                    <!-- Battle content will be dynamically added -->
                </div>
            </div>
        </div>
    </div>

    <!-- SocketIO -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <!-- Battle System Scripts -->
    <script src="js/battle_scene_animations.js"></script>
    <script src="js/battle_manager_enhanced.js"></script>

    <!-- Main Game Logic -->
    <script>
        // Game Configuration
        const API_URL = window.location.origin;

        // Game State
        const gameState = {
            playerId: 'player_' + Math.random().toString(36).substr(2, 9),
            playerName: null,
            playerCount: 1,
            gameCode: null,
            currentQuestion: 0,
            interrogationAnswers: [],
            characterClass: null,
            socket: null,
            csrfToken: null
        };

        // Theme Management
        class ThemeManager {
            static setTheme(theme) {
                document.body.className = theme + '-theme';
                console.log('Theme changed to:', theme);
            }

            static resetTheme() {
                document.body.className = '';
            }
        }

        // Toast Notifications
        class ToastManager {
            static show(message, type = 'info', duration = 3000) {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;

                container.appendChild(toast);

                setTimeout(() => {
                    toast.style.animation = 'slideIn 0.3s ease reverse';
                    setTimeout(() => container.removeChild(toast), 300);
                }, duration);
            }
        }

        // API Manager
        class APIManager {
            static async getCsrfToken() {
                try {
                    const response = await fetch(`${API_URL}/api/csrf-token`);
                    const data = await response.json();
                    gameState.csrfToken = data.csrf_token;
                    console.log('CSRF token obtained');
                    return gameState.csrfToken;
                } catch (error) {
                    console.error('Failed to get CSRF token:', error);
                    return null;
                }
            }

            static async call(endpoint, method = 'GET', data = null) {
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin'
                };

                if (method === 'POST' && gameState.csrfToken) {
                    options.headers['X-CSRFToken'] = gameState.csrfToken;
                }

                if (data) {
                    options.body = JSON.stringify(data);
                }

                try {
                    const response = await fetch(`${API_URL}${endpoint}`, options);
                    const contentType = response.headers.get("content-type");

                    if (contentType && contentType.includes("application/json")) {
                        return await response.json();
                    } else {
                        console.error('Non-JSON response received');
                        return null;
                    }
                } catch (error) {
                    console.error('API call failed:', error);
                    ToastManager.show('Connection error. Please check if the server is running.', 'error');
                    return null;
                }
            }
        }

        // Socket Manager
        class SocketManager {
            static connect() {
                if (gameState.socket) {
                    return;
                }

                gameState.socket = io(API_URL, {
                    transports: ['websocket', 'polling']
                });

                gameState.socket.on('connect', () => {
                    console.log('Connected to server via SocketIO');
                    ToastManager.show('Connected to server', 'success');
                });

                gameState.socket.on('disconnect', () => {
                    console.log('Disconnected from server');
                    ToastManager.show('Disconnected from server', 'error');
                });

                gameState.socket.on('player_joined', (data) => {
                    ToastManager.show(`${data.player_name} joined the game`, 'info');
                });

                gameState.socket.on('game_started', (data) => {
                    ToastManager.show('All players ready! Game starting...', 'success');
                    setTimeout(() => {
                        gameManager.showScreen('gameScreen');
                    }, 2000);
                });

                gameState.socket.on('battle_started', (data) => {
                    console.log('Battle event received:', data);
                    ThemeManager.setTheme('battle');
                    // Trigger battle animations
                    if (window.battleManager) {
                        window.battleManager.handleBattleEvent(data);
                    }
                });
            }

            static emit(event, data) {
                if (gameState.socket) {
                    gameState.socket.emit(event, data);
                }
            }
        }

        // Game Manager
        class GameManager {
            constructor() {
                this.currentScreen = 'mainMenu';
            }

            showScreen(screenId) {
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.remove('active');
                });

                const screen = document.getElementById(screenId);
                if (screen) {
                    screen.classList.add('active');
                    this.currentScreen = screenId;
                }
            }

            async showCharacterCreation() {
                // Show the character creation screen
                this.showScreen('characterCreation');

                // Clear any previous game state to allow new game creation
                gameState.gameCode = null;
                gameState.currentQuestion = 0;
                gameState.answers = {};
                gameState.godFavor = {};
                gameState.playerName = null;

                // Hide any previous game code displays
                document.getElementById('gameCodeDisplay').style.display = 'none';
                document.getElementById('interrogationGameCodeDisplay').style.display = 'none';

                // Clear server session to allow creating new game
                await APIManager.call('/api/clear_session', 'POST', {});

                console.log('Starting new game - previous session cleared');
            }

            showJoinGame() {
                this.showScreen('joinGameScreen');
            }

            showAbout() {
                this.showScreen('aboutScreen');
            }

            async joinGame() {
                const gameCode = document.getElementById('gameCodeInput').value.trim().toUpperCase();
                if (!gameCode) {
                    ToastManager.show('Please enter a game code', 'error');
                    return;
                }

                const playerName = document.getElementById('joinPlayerNameInput').value.trim();
                if (!playerName) {
                    ToastManager.show('Please enter your name', 'error');
                    return;
                }

                gameState.playerName = playerName;
                gameState.gameCode = gameCode;

                // Set username FIRST before any other API calls
                const usernameResult = await APIManager.call('/api/set_username', 'POST', { username: playerName });
                if (!usernameResult || !usernameResult.success) {
                    ToastManager.show('Failed to set username', 'error');
                    return;
                }

                // Join game
                const result = await APIManager.call('/api/join_game', 'POST', { game_code: gameCode });

                if (result && result.status === 'success') {
                    ToastManager.show('Joined game successfully!', 'success');

                    // Connect socket and join room if available
                    if (window.SocketManager && SocketManager.connect) {
                        SocketManager.connect();
                        SocketManager.emit('join_game', {
                            game_code: gameCode,
                            player_name: playerName
                        });
                    }

                    // Start interrogation directly (skip character creation since we already have the name)
                    const interrogationResult = await APIManager.call('/api/start_interrogation', 'POST', {});

                    if (interrogationResult && interrogationResult.status === 'success' && interrogationResult.question) {
                        this.showScreen('divineInterrogation');
                        ThemeManager.setTheme('divine');
                        this.displayQuestion(interrogationResult.question);
                    } else {
                        ToastManager.show(interrogationResult?.message || 'Failed to start interrogation', 'error');
                    }
                } else {
                    ToastManager.show(result?.message || 'Failed to join game', 'error');
                }
            }

            async startInterrogation() {
                const playerName = document.getElementById('playerNameInput').value.trim();

                if (!playerName) {
                    ToastManager.show('Please enter your name', 'error');
                    return;
                }

                gameState.playerName = playerName;

                // Set username FIRST before any other API calls
                const usernameResult = await APIManager.call('/api/set_username', 'POST', { username: playerName });
                if (!usernameResult || !usernameResult.success) {
                    ToastManager.show('Failed to set username', 'error');
                    return;
                }

                // Create game (only if not already in a game)
                if (!gameState.gameCode) {
                    const createResult = await APIManager.call('/api/create_game', 'POST', {});
                    if (createResult && createResult.success) {
                        gameState.gameCode = createResult.game_code;

                        // Display the game code before starting interrogation
                        document.getElementById('gameCodeText').textContent = gameState.gameCode;
                        document.getElementById('gameCodeDisplay').style.display = 'block';

                        console.log('Game created with code:', gameState.gameCode);
                        ToastManager.show(`Game created! Code: ${gameState.gameCode}`, 'success');

                        // Give user time to see and copy the code
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    } else if (createResult && createResult.error === 'Already in a game') {
                        // Player is already in a game session - clear and retry OR just proceed
                        console.log('Player already in a game session, proceeding with interrogation...');
                        ToastManager.show('Continuing previous game session', 'info');
                    } else {
                        ToastManager.show(createResult?.error || 'Failed to create game', 'error');
                        return;
                    }
                }

                // Start interrogation
                const result = await APIManager.call('/api/start_interrogation', 'POST', {});

                if (result && result.success && result.question) {
                    this.showScreen('divineInterrogation');
                    ThemeManager.setTheme('divine');

                    // Show game code on interrogation screen if in multiplayer
                    if (gameState.gameCode) {
                        document.getElementById('interrogationGameCodeText').textContent = gameState.gameCode;
                        document.getElementById('interrogationGameCodeDisplay').style.display = 'block';
                    }

                    this.displayQuestion(result.question);
                } else {
                    ToastManager.show(result?.message || 'Failed to start interrogation', 'error');
                }
            }

            displayQuestion(questionData) {
                console.log('[DIVINE] Displaying question:', questionData.question_number);
                gameState.currentQuestion = questionData.question_number;

                // Reset answer lock
                this.isAnswering = false;

                // Update progress
                const progress = (questionData.question_number / 10) * 100;
                document.getElementById('progressFill').style.width = `${progress}%`;

                // Update question header
                document.getElementById('godSpeaker').textContent = this.getGodName();
                document.getElementById('questionNumber').textContent = `Question ${questionData.question_number} of 10`;

                // Update question text
                document.getElementById('questionText').textContent = questionData.question_text;

                // Update options
                const container = document.getElementById('optionsContainer');
                container.innerHTML = '';

                questionData.options.forEach((option, index) => {
                    if (!option || !option.id) {
                        console.error('[DIVINE] Invalid option:', option);
                        return;
                    }

                    const optionBtn = document.createElement('button');
                    optionBtn.className = 'option-button';
                    optionBtn.setAttribute('data-option-id', option.id);
                    optionBtn.innerHTML = `
                        <div class="option-letter">${option.letter || String.fromCharCode(65 + index)}</div>
                        <div>${option.text}</div>
                    `;
                    optionBtn.onclick = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('[DIVINE] Button clicked:', option.id);
                        this.answerQuestion(option.id);
                    };
                    container.appendChild(optionBtn);
                });

                console.log('[DIVINE] Created', questionData.options.length, 'option buttons');
            }

            async answerQuestion(answerId) {
                // Prevent multiple simultaneous submissions
                if (this.isAnswering) {
                    console.log('[DIVINE] Already answering, ignoring click');
                    return;
                }

                this.isAnswering = true;
                console.log('[DIVINE] Submitting answer:', answerId);

                // Disable all buttons immediately
                document.querySelectorAll('.option-button').forEach(btn => {
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                    btn.style.cursor = 'not-allowed';
                });

                const result = await APIManager.call('/api/answer_question', 'POST', {
                    question_number: gameState.currentQuestion,
                    answer_id: answerId
                });

                if (result && result.success) {
                    if (!result.completed && result.next_question) {
                        // Display next question
                        console.log('[DIVINE] Moving to next question');
                        this.displayQuestion(result.next_question);
                    } else if (result.completed) {
                        // Interrogation complete
                        console.log('[DIVINE] Interrogation complete');
                        this.handleInterrogationComplete(result);
                    }
                } else {
                    // Re-enable buttons if request failed
                    this.isAnswering = false;
                    document.querySelectorAll('.option-button').forEach(btn => {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                        btn.style.cursor = 'pointer';
                    });
                }
            }

            handleInterrogationComplete(result) {
                gameState.characterClass = result.character_class;

                ToastManager.show(`You have been chosen as a ${result.character_class}!`, 'success');

                // Transition to game
                setTimeout(() => {
                    ThemeManager.setTheme('victory');
                    setTimeout(() => {
                        ThemeManager.resetTheme();
                        this.showScreen('gameScreen');
                        this.updateGameHUD();
                    }, 2000);
                }, 1000);
            }

            updateGameHUD() {
                // Update HUD with current game state
                document.getElementById('currentLocation').textContent = 'Valdria';
                document.getElementById('playerHealth').textContent = '100';
                document.getElementById('partyTrust').textContent = '50';
                document.getElementById('turnCount').textContent = '1';
            }

            triggerBattle() {
                // Test battle system integration
                console.log('Triggering test battle...');

                // Set theme
                ThemeManager.setTheme('battle');

                // Use battle manager if available
                if (window.battleManager && window.battleManager.startTestBattle) {
                    window.battleManager.startTestBattle();
                } else {
                    // Fallback animation
                    if (window.playBattleIntro) {
                        window.playBattleIntro({
                            enemyName: 'CRYPT GUARDIAN',
                            enemyIcon: 'ðŸ’€',
                            flavorText: 'An ancient evil awakens!',
                            battleType: 'boss',
                            onComplete: () => {
                                ThemeManager.setTheme('victory');
                                ToastManager.show('Victory achieved!', 'success');
                                setTimeout(() => {
                                    ThemeManager.resetTheme();
                                }, 3000);
                            }
                        });
                    }
                }
            }

            getGodName() {
                const gods = ['VALDRIS', 'KAITHA', 'MORVANE', 'SYLARA', 'KORVAN', 'ATHENA', 'MERCUS'];
                return gods[Math.floor(Math.random() * gods.length)];
            }
        }

        // Initialize Game
        const gameManager = new GameManager();

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('Initializing Arcane Codex...');

            // Get CSRF token
            await APIManager.getCsrfToken();

            // Hide loading overlay after a short delay
            setTimeout(() => {
                document.getElementById('loadingOverlay').classList.add('hidden');
                ToastManager.show('Welcome to the Arcane Codex', 'info');
            }, 1500);

            // Check for stored game state
            const storedGameCode = localStorage.getItem('game_code');
            if (storedGameCode) {
                gameState.gameCode = storedGameCode;
                console.log('Found stored game code:', storedGameCode);
            }

            // Initialize battle manager integration
            if (window.battleManager) {
                window.battleManager.onVictory = () => {
                    ThemeManager.setTheme('victory');
                    ToastManager.show('Victory! The battle is won!', 'success');
                    setTimeout(() => {
                        ThemeManager.resetTheme();
                        gameManager.showScreen('gameScreen');
                    }, 3000);
                };

                window.battleManager.onDefeat = () => {
                    ToastManager.show('Defeated... Try again!', 'error');
                    setTimeout(() => {
                        ThemeManager.resetTheme();
                        gameManager.showScreen('gameScreen');
                    }, 3000);
                };
            }

            console.log('Arcane Codex ready!');
        });

        // Export for debugging
        window.gameState = gameState;
        window.gameManager = gameManager;
        window.ThemeManager = ThemeManager;
    </script>
</body>
</html>